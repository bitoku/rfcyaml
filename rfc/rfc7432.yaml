- title: __initial_text__
  contents:
  - '                      BGP MPLS-Based Ethernet VPN

    '
- title: Abstract
  contents:
  - "Abstract\n   This document describes procedures for BGP MPLS-based Ethernet VPNs\n\
    \   (EVPN).  The procedures described here meet the requirements\n   specified\
    \ in RFC 7209 -- \"Requirements for Ethernet VPN (EVPN)\".\n"
- title: Status of This Memo
  contents:
  - "Status of This Memo\n   This is an Internet Standards Track document.\n   This\
    \ document is a product of the Internet Engineering Task Force\n   (IETF).  It\
    \ represents the consensus of the IETF community.  It has\n   received public\
    \ review and has been approved for publication by the\n   Internet Engineering\
    \ Steering Group (IESG).  Further information on\n   Internet Standards is available\
    \ in Section 2 of RFC 5741.\n   Information about the current status of this document,\
    \ any errata,\n   and how to provide feedback on it may be obtained at\n   http://www.rfc-editor.org/info/rfc7432.\n"
- title: Copyright Notice
  contents:
  - "Copyright Notice\n   Copyright (c) 2015 IETF Trust and the persons identified\
    \ as the\n   document authors.  All rights reserved.\n   This document is subject\
    \ to BCP 78 and the IETF Trust's Legal\n   Provisions Relating to IETF Documents\n\
    \   (http://trustee.ietf.org/license-info) in effect on the date of\n   publication\
    \ of this document.  Please review these documents\n   carefully, as they describe\
    \ your rights and restrictions with respect\n   to this document.  Code Components\
    \ extracted from this document must\n   include Simplified BSD License text as\
    \ described in Section 4.e of\n   the Trust Legal Provisions and are provided\
    \ without warranty as\n   described in the Simplified BSD License.\n"
- title: Table of Contents
  contents:
  - "Table of Contents\n   1. Introduction ....................................................4\n\
    \   2. Specification of Requirements ...................................4\n  \
    \ 3. Terminology .....................................................4\n   4.\
    \ BGP MPLS-Based EVPN Overview ....................................6\n   5. Ethernet\
    \ Segment ................................................7\n   6. Ethernet Tag\
    \ ID ................................................10\n      6.1. VLAN-Based\
    \ Service Interface ..............................11\n      6.2. VLAN Bundle Service\
    \ Interface .............................11\n           6.2.1. Port-Based Service\
    \ Interface .......................11\n      6.3. VLAN-Aware Bundle Service Interface\
    \ .......................11\n           6.3.1. Port-Based VLAN-Aware Service Interface\
    \ ............12\n   7. BGP EVPN Routes ................................................13\n\
    \      7.1. Ethernet Auto-discovery Route .............................14\n  \
    \    7.2. MAC/IP Advertisement Route ................................14\n    \
    \  7.3. Inclusive Multicast Ethernet Tag Route ....................15\n      7.4.\
    \ Ethernet Segment Route ....................................16\n      7.5. ESI\
    \ Label Extended Community ..............................16\n      7.6. ES-Import\
    \ Route Target ....................................17\n      7.7. MAC Mobility\
    \ Extended Community ...........................18\n      7.8. Default Gateway\
    \ Extended Community ........................18\n      7.9. Route Distinguisher\
    \ Assignment per EVI ....................18\n      7.10. Route Targets ............................................19\n\
    \           7.10.1. Auto-derivation from the Ethernet Tag ID ..........19\n  \
    \ 8. Multihoming Functions ..........................................19\n    \
    \  8.1. Multihomed Ethernet Segment Auto-discovery ................19\n      \
    \     8.1.1. Constructing the Ethernet Segment Route ............19\n      8.2.\
    \ Fast Convergence ..........................................20\n           8.2.1.\
    \ Constructing Ethernet A-D per Ethernet\n                  Segment Route ......................................21\n\
    \                  8.2.1.1. Ethernet A-D Route Targets ................21\n  \
    \    8.3. Split Horizon .............................................22\n    \
    \       8.3.1. ESI Label Assignment ...............................22\n      \
    \            8.3.1.1. Ingress Replication .......................22\n        \
    \          8.3.1.2. P2MP MPLS LSPs ............................24\n      8.4.\
    \ Aliasing and Backup Path ..................................25\n           8.4.1.\
    \ Constructing Ethernet A-D per EVPN Instance Route ..26\n      8.5. Designated\
    \ Forwarder Election .............................27\n      8.6. Interoperability\
    \ with Single-Homing PEs ...................29\n   9. Determining Reachability\
    \ to Unicast MAC Addresses ..............30\n      9.1. Local Learning ............................................30\n\
    \      9.2. Remote Learning ...........................................30\n  \
    \         9.2.1. Constructing MAC/IP Address Advertisement ..........31\n    \
    \       9.2.2. Route Resolution ...................................32\n   10.\
    \ ARP and ND ....................................................33\n      10.1.\
    \ Default Gateway ..........................................34\n   11. Handling\
    \ of Multi-destination Traffic .........................36\n      11.1. Constructing\
    \ Inclusive Multicast Ethernet Tag Route ......36\n      11.2. P-Tunnel Identification\
    \ ..................................37\n   12. Processing of Unknown Unicast Packets\
    \ .........................38\n      12.1. Ingress Replication ......................................38\n\
    \      12.2. P2MP MPLS LSPs ...........................................39\n  \
    \ 13. Forwarding Unicast Packets ....................................39\n    \
    \  13.1. Forwarding Packets Received from a CE ....................39\n      13.2.\
    \ Forwarding Packets Received from a Remote PE .............41\n           13.2.1.\
    \ Unknown Unicast Forwarding ........................41\n           13.2.2. Known\
    \ Unicast Forwarding ..........................41\n   14. Load Balancing of Unicast\
    \ Packets .............................41\n      14.1. Load Balancing of Traffic\
    \ from a PE to Remote CEs ........41\n           14.1.1. Single-Active Redundancy\
    \ Mode .....................42\n           14.1.2. All-Active Redundancy Mode\
    \ ........................42\n      14.2. Load Balancing of Traffic between a\
    \ PE and a Local CE ....44\n           14.2.1. Data-Plane Learning ...............................44\n\
    \           14.2.2. Control-Plane Learning ............................44\n  \
    \ 15. MAC Mobility ..................................................45\n    \
    \  15.1. MAC Duplication Issue ....................................47\n      15.2.\
    \ Sticky MAC Addresses .....................................47\n   16. Multicast\
    \ and Broadcast .......................................47\n      16.1. Ingress\
    \ Replication ......................................47\n      16.2. P2MP LSPs\
    \ ................................................48\n           16.2.1. Inclusive\
    \ Trees ...................................48\n   17. Convergence ...................................................49\n\
    \      17.1. Transit Link and Node Failures between PEs ...............49\n  \
    \    17.2. PE Failures ..............................................49\n    \
    \  17.3. PE-to-CE Network Failures ................................49\n   18.\
    \ Frame Ordering ................................................50\n   19. Security\
    \ Considerations .......................................50\n   20. IANA Considerations\
    \ ...........................................52\n   21. References ....................................................52\n\
    \      21.1. Normative References .....................................52\n  \
    \    21.2. Informative References ...................................53\n   Acknowledgements\
    \ ..................................................55\n   Contributors ......................................................55\n\
    \   Authors' Addresses ................................................56\n"
- title: 1.  Introduction
  contents:
  - "1.  Introduction\n   Virtual Private LAN Service (VPLS), as defined in [RFC4664],\n\
    \   [RFC4761], and [RFC4762], is a proven and widely deployed technology.\n  \
    \ However, the existing solution has a number of limitations when it\n   comes\
    \ to multihoming and redundancy, multicast optimization,\n   provisioning simplicity,\
    \ flow-based load balancing, and multipathing;\n   these limitations are important\
    \ considerations for Data Center (DC)\n   deployments.  [RFC7209] describes the\
    \ motivation for a new solution\n   to address these limitations.  It also outlines\
    \ a set of requirements\n   that the new solution must address.\n   This document\
    \ describes procedures for a BGP MPLS-based solution\n   called Ethernet VPN (EVPN)\
    \ to address the requirements specified in\n   [RFC7209].  Please refer to [RFC7209]\
    \ for the detailed requirements\n   and motivation.  EVPN requires extensions\
    \ to existing IP/MPLS\n   protocols as described in this document.  In addition\
    \ to these\n   extensions, EVPN uses several building blocks from existing MPLS\n\
    \   technologies.\n"
- title: 2.  Specification of Requirements
  contents:
  - "2.  Specification of Requirements\n   The key words \"MUST\", \"MUST NOT\", \"\
    REQUIRED\", \"SHALL\", \"SHALL NOT\",\n   \"SHOULD\", \"SHOULD NOT\", \"RECOMMENDED\"\
    , \"MAY\", and \"OPTIONAL\" in this\n   document are to be interpreted as described\
    \ in [RFC2119].\n"
- title: 3.  Terminology
  contents:
  - "3.  Terminology\n   Broadcast Domain: In a bridged network, the broadcast domain\n\
    \      corresponds to a Virtual LAN (VLAN), where a VLAN is typically\n      represented\
    \ by a single VLAN ID (VID) but can be represented\n      by several VIDs where\
    \ Shared VLAN Learning (SVL) is used\n      per [802.1Q].\n   Bridge Table: An\
    \ instantiation of a broadcast domain on a MAC-VRF.\n   CE: Customer Edge device,\
    \ e.g., a host, router, or switch.\n   EVI: An EVPN instance spanning the Provider\
    \ Edge (PE) devices\n      participating in that EVPN.\n   MAC-VRF: A Virtual\
    \ Routing and Forwarding table for Media Access\n      Control (MAC) addresses\
    \ on a PE.\n   Ethernet Segment (ES): When a customer site (device or network)\
    \ is\n      connected to one or more PEs via a set of Ethernet links, then\n \
    \     that set of links is referred to as an 'Ethernet segment'.\n   Ethernet\
    \ Segment Identifier (ESI): A unique non-zero identifier that\n      identifies\
    \ an Ethernet segment is called an 'Ethernet Segment\n      Identifier'.\n   Ethernet\
    \ Tag: An Ethernet tag identifies a particular broadcast\n      domain, e.g.,\
    \ a VLAN.  An EVPN instance consists of one or more\n      broadcast domains.\n\
    \   LACP: Link Aggregation Control Protocol.\n   MP2MP: Multipoint to Multipoint.\n\
    \   MP2P: Multipoint to Point.\n   P2MP: Point to Multipoint.\n   P2P: Point to\
    \ Point.\n   PE: Provider Edge device.\n   Single-Active Redundancy Mode: When\
    \ only a single PE, among all the\n      PEs attached to an Ethernet segment,\
    \ is allowed to forward traffic\n      to/from that Ethernet segment for a given\
    \ VLAN, then the Ethernet\n      segment is defined to be operating in Single-Active\
    \ redundancy\n      mode.\n   All-Active Redundancy Mode: When all PEs attached\
    \ to an Ethernet\n      segment are allowed to forward known unicast traffic to/from\
    \ that\n      Ethernet segment for a given VLAN, then the Ethernet segment is\n\
    \      defined to be operating in All-Active redundancy mode.\n"
- title: 4.  BGP MPLS-Based EVPN Overview
  contents:
  - "4.  BGP MPLS-Based EVPN Overview\n   This section provides an overview of EVPN.\
    \  An EVPN instance\n   comprises Customer Edge devices (CEs) that are connected\
    \ to Provider\n   Edge devices (PEs) that form the edge of the MPLS infrastructure.\
    \  A\n   CE may be a host, a router, or a switch.  The PEs provide virtual\n \
    \  Layer 2 bridged connectivity between the CEs.  There may be multiple\n   EVPN\
    \ instances in the provider's network.\n   The PEs may be connected by an MPLS\
    \ Label Switched Path (LSP)\n   infrastructure, which provides the benefits of\
    \ MPLS technology, such\n   as fast reroute, resiliency, etc.  The PEs may also\
    \ be connected by\n   an IP infrastructure, in which case IP/GRE (Generic Routing\n\
    \   Encapsulation) tunneling or other IP tunneling can be used between\n   the\
    \ PEs.  The detailed procedures in this document are specified only\n   for MPLS\
    \ LSPs as the tunneling technology.  However, these procedures\n   are designed\
    \ to be extensible to IP tunneling as the Packet Switched\n   Network (PSN) tunneling\
    \ technology.\n   In an EVPN, MAC learning between PEs occurs not in the data\
    \ plane (as\n   happens with traditional bridging in VPLS [RFC4761] [RFC4762])\
    \ but in\n   the control plane.  Control-plane learning offers greater control\n\
    \   over the MAC learning process, such as restricting who learns what,\n   and\
    \ the ability to apply policies.  Furthermore, the control plane\n   chosen for\
    \ advertising MAC reachability information is multi-protocol\n   (MP) BGP (similar\
    \ to IP VPNs [RFC4364]).  This provides flexibility\n   and the ability to preserve\
    \ the \"virtualization\" or isolation of\n   groups of interacting agents (hosts,\
    \ servers, virtual machines) from\n   each other.  In EVPN, PEs advertise the\
    \ MAC addresses learned from\n   the CEs that are connected to them, along with\
    \ an MPLS label, to\n   other PEs in the control plane using Multiprotocol BGP\
    \ (MP-BGP).\n   Control-plane learning enables load balancing of traffic to and\
    \ from\n   CEs that are multihomed to multiple PEs.  This is in addition to load\n\
    \   balancing across the MPLS core via multiple LSPs between the same\n   pair\
    \ of PEs.  In other words, it allows CEs to connect to multiple\n   active points\
    \ of attachment.  It also improves convergence times in\n   the event of certain\
    \ network failures.\n   However, learning between PEs and CEs is done by the method\
    \ best\n   suited to the CE: data-plane learning, IEEE 802.1x, the Link Layer\n\
    \   Discovery Protocol (LLDP), IEEE 802.1aq, Address Resolution Protocol\n   (ARP),\
    \ management plane, or other protocols.\n   It is a local decision as to whether\
    \ the Layer 2 forwarding table on\n   a PE is populated with all the MAC destination\
    \ addresses known to the\n   control plane, or whether the PE implements a cache-based\
    \ scheme.\n   For instance, the MAC forwarding table may be populated only with\
    \ the\n   MAC destinations of the active flows transiting a specific PE.\n   The\
    \ policy attributes of EVPN are very similar to those of IP-VPN.\n   An EVPN instance\
    \ requires a Route Distinguisher (RD) that is unique\n   per MAC-VRF and one or\
    \ more globally unique Route Targets (RTs).  A\n   CE attaches to a MAC-VRF on\
    \ a PE, on an Ethernet interface that may\n   be configured for one or more Ethernet\
    \ tags, e.g., VLAN IDs.  Some\n   deployment scenarios guarantee uniqueness of\
    \ VLAN IDs across EVPN\n   instances: all points of attachment for a given EVPN\
    \ instance use the\n   same VLAN ID, and no other EVPN instance uses this VLAN\
    \ ID.  This\n   document refers to this case as a \"Unique VLAN EVPN\" and describes\n\
    \   simplified procedures to optimize for it.\n"
- title: 5.  Ethernet Segment
  contents:
  - "5.  Ethernet Segment\n   As indicated in [RFC7209], each Ethernet segment needs\
    \ a unique\n   identifier in an EVPN.  This section defines how such identifiers\
    \ are\n   assigned and how they are encoded for use in EVPN signaling.  Later\n\
    \   sections of this document describe the protocol mechanisms that\n   utilize\
    \ the identifiers.\n   When a customer site is connected to one or more PEs via\
    \ a set of\n   Ethernet links, then this set of Ethernet links constitutes an\n\
    \   \"Ethernet segment\".  For a multihomed site, each Ethernet segment\n   (ES)\
    \ is identified by a unique non-zero identifier called an Ethernet\n   Segment\
    \ Identifier (ESI).  An ESI is encoded as a 10-octet integer in\n   line format\
    \ with the most significant octet sent first.  The\n   following two ESI values\
    \ are reserved:\n   - ESI 0 denotes a single-homed site.\n   - ESI {0xFF} (repeated\
    \ 10 times) is known as MAX-ESI and is reserved.\n   In general, an Ethernet segment\
    \ SHOULD have a non-reserved ESI that\n   is unique network wide (i.e., across\
    \ all EVPN instances on all the\n   PEs).  If the CE(s) constituting an Ethernet\
    \ segment is (are) managed\n   by the network operator, then ESI uniqueness should\
    \ be guaranteed;\n   however, if the CE(s) is (are) not managed, then the operator\
    \ MUST\n   configure a network-wide unique ESI for that Ethernet segment.  This\n\
    \   is required to enable auto-discovery of Ethernet segments and\n   Designated\
    \ Forwarder (DF) election.\n   In a network with managed and non-managed CEs,\
    \ the ESI has the\n   following format:\n               +---+---+---+---+---+---+---+---+---+---+\n\
    \               | T |          ESI Value                |\n               +---+---+---+---+---+---+---+---+---+---+\n\
    \   Where:\n   T (ESI Type) is a 1-octet field (most significant octet) that\n\
    \   specifies the format of the remaining 9 octets (ESI Value).  The\n   following\
    \ six ESI types can be used:\n   - Type 0 (T=0x00) - This type indicates an arbitrary\
    \ 9-octet ESI\n     value, which is managed and configured by the operator.\n\
    \   - Type 1 (T=0x01) - When IEEE 802.1AX LACP is used between the PEs\n     and\
    \ CEs, this ESI type indicates an auto-generated ESI value\n     determined from\
    \ LACP by concatenating the following parameters:\n     + CE LACP System MAC address\
    \ (6 octets).  The CE LACP System MAC\n       address MUST be encoded in the high-order\
    \ 6 octets of the ESI\n       Value field.\n     + CE LACP Port Key (2 octets).\
    \  The CE LACP port key MUST be\n       encoded in the 2 octets next to the System\
    \ MAC address.\n     + The remaining octet will be set to 0x00.\n     As far as\
    \ the CE is concerned, it would treat the multiple PEs that\n     it is connected\
    \ to as the same switch.  This allows the CE to\n     aggregate links that are\
    \ attached to different PEs in the same\n     bundle.\n     This mechanism could\
    \ be used only if it produces ESIs that satisfy\n     the uniqueness requirement\
    \ specified above.\n   - Type 2 (T=0x02) - This type is used in the case of indirectly\n\
    \     connected hosts via a bridged LAN between the CEs and the PEs.  The\n  \
    \   ESI Value is auto-generated and determined based on the Layer 2\n     bridge\
    \ protocol as follows: If the Multiple Spanning Tree Protocol\n     (MSTP) is\
    \ used in the bridged LAN, then the value of the ESI is\n     derived by listening\
    \ to Bridge PDUs (BPDUs) on the Ethernet\n     segment.  To achieve this, the\
    \ PE is not required to run MSTP.\n     However, the PE must learn the Root Bridge\
    \ MAC address and Bridge\n     Priority of the root of the Internal Spanning Tree\
    \ (IST) by\n     listening to the BPDUs.  The ESI Value is constructed as follows:\n\
    \     + Root Bridge MAC address (6 octets).  The Root Bridge MAC address\n   \
    \    MUST be encoded in the high-order 6 octets of the ESI Value\n       field.\n\
    \     + Root Bridge Priority (2 octets).  The CE Root Bridge Priority\n      \
    \ MUST be encoded in the 2 octets next to the Root Bridge MAC\n       address.\n\
    \     + The remaining octet will be set to 0x00.\n     This mechanism could be\
    \ used only if it produces ESIs that satisfy\n     the uniqueness requirement\
    \ specified above.\n   - Type 3 (T=0x03) - This type indicates a MAC-based ESI\
    \ Value that\n     can be auto-generated or configured by the operator.  The ESI\
    \ Value\n     is constructed as follows:\n     + System MAC address (6 octets).\
    \  The PE MAC address MUST be\n       encoded in the high-order 6 octets of the\
    \ ESI Value field.\n     + Local Discriminator value (3 octets).  The Local Discriminator\n\
    \       value MUST be encoded in the low-order 3 octets of the ESI Value.\n  \
    \   This mechanism could be used only if it produces ESIs that satisfy\n     the\
    \ uniqueness requirement specified above.\n   - Type 4 (T=0x04) - This type indicates\
    \ a router-ID ESI Value that\n     can be auto-generated or configured by the\
    \ operator.  The ESI Value\n     is constructed as follows:\n     + Router ID\
    \ (4 octets).  The system router ID MUST be encoded in\n       the high-order\
    \ 4 octets of the ESI Value field.\n     + Local Discriminator value (4 octets).\
    \  The Local Discriminator\n       value MUST be encoded in the 4 octets next\
    \ to the IP address.\n     + The low-order octet of the ESI Value will be set\
    \ to 0x00.\n     This mechanism could be used only if it produces ESIs that satisfy\n\
    \     the uniqueness requirement specified above.\n   - Type 5 (T=0x05) - This\
    \ type indicates an Autonomous System\n     (AS)-based ESI Value that can be auto-generated\
    \ or configured by\n     the operator.  The ESI Value is constructed as follows:\n\
    \     + AS number (4 octets).  This is an AS number owned by the system\n    \
    \   and MUST be encoded in the high-order 4 octets of the ESI Value\n       field.\
    \  If a 2-octet AS number is used, the high-order extra\n       2 octets will\
    \ be 0x0000.\n     + Local Discriminator value (4 octets).  The Local Discriminator\n\
    \       value MUST be encoded in the 4 octets next to the AS number.\n     + The\
    \ low-order octet of the ESI Value will be set to 0x00.\n     This mechanism could\
    \ be used only if it produces ESIs that satisfy\n     the uniqueness requirement\
    \ specified above.\n"
- title: 6.  Ethernet Tag ID
  contents:
  - "6.  Ethernet Tag ID\n   An Ethernet Tag ID is a 32-bit field containing either\
    \ a 12-bit or\n   24-bit identifier that identifies a particular broadcast domain\n\
    \   (e.g., a VLAN) in an EVPN instance.  The 12-bit identifier is called\n   the\
    \ VLAN ID (VID).  An EVPN instance consists of one or more\n   broadcast domains\
    \ (one or more VLANs).  VLANs are assigned to a given\n   EVPN instance by the\
    \ provider of the EVPN service.  A given VLAN can\n   itself be represented by\
    \ multiple VIDs.  In such cases, the PEs\n   participating in that VLAN for a\
    \ given EVPN instance are responsible\n   for performing VLAN ID translation to/from\
    \ locally attached CE\n   devices.\n   If a VLAN is represented by a single VID\
    \ across all PE devices\n   participating in that VLAN for that EVPN instance,\
    \ then there is no\n   need for VID translation at the PEs.  Furthermore, some\
    \ deployment\n   scenarios guarantee uniqueness of VIDs across all EVPN instances;\
    \ all\n   points of attachment for a given EVPN instance use the same VID, and\n\
    \   no other EVPN instances use that VID.  This allows the RT(s) for each\n  \
    \ EVPN instance to be derived automatically from the corresponding VID,\n   as\
    \ described in Section 7.10.1.\n   The following subsections discuss the relationship\
    \ between broadcast\n   domains (e.g., VLANs), Ethernet Tag IDs (e.g., VIDs),\
    \ and MAC-VRFs as\n   well as the setting of the Ethernet Tag ID, in the various\
    \ EVPN BGP\n   routes (defined in Section 8), for the different types of service\n\
    \   interfaces described in [RFC7209].\n   The following Ethernet Tag ID value\
    \ is reserved:\n   - Ethernet Tag ID {0xFFFFFFFF} is known as MAX-ET.\n"
- title: 6.1.  VLAN-Based Service Interface
  contents:
  - "6.1.  VLAN-Based Service Interface\n   With this service interface, an EVPN instance\
    \ consists of only a\n   single broadcast domain (e.g., a single VLAN).  Therefore,\
    \ there is a\n   one-to-one mapping between a VID on this interface and a MAC-VRF.\n\
    \   Since a MAC-VRF corresponds to a single VLAN, it consists of a single\n  \
    \ bridge table corresponding to that VLAN.  If the VLAN is represented\n   by\
    \ multiple VIDs (e.g., a different VID per Ethernet segment per PE),\n   then\
    \ each PE needs to perform VID translation for frames destined to\n   its Ethernet\
    \ segment(s).  In such scenarios, the Ethernet frames\n   transported over an\
    \ MPLS/IP network SHOULD remain tagged with the\n   originating VID, and a VID\
    \ translation MUST be supported in the data\n   path and MUST be performed on\
    \ the disposition PE.  The Ethernet Tag\n   ID in all EVPN routes MUST be set\
    \ to 0.\n"
- title: 6.2.  VLAN Bundle Service Interface
  contents:
  - "6.2.  VLAN Bundle Service Interface\n   With this service interface, an EVPN\
    \ instance corresponds to multiple\n   broadcast domains (e.g., multiple VLANs);\
    \ however, only a single\n   bridge table is maintained per MAC-VRF, which means\
    \ multiple VLANs\n   share the same bridge table.  This implies that MAC addresses\
    \ MUST be\n   unique across all VLANs for that EVI in order for this service to\n\
    \   work.  In other words, there is a many-to-one mapping between VLANs\n   and\
    \ a MAC-VRF, and the MAC-VRF consists of a single bridge table.\n   Furthermore,\
    \ a single VLAN must be represented by a single VID --\n   e.g., no VID translation\
    \ is allowed for this service interface type.\n   The MPLS-encapsulated frames\
    \ MUST remain tagged with the originating\n   VID.  Tag translation is NOT permitted.\
    \  The Ethernet Tag ID in all\n   EVPN routes MUST be set to 0.\n"
- title: 6.2.1.  Port-Based Service Interface
  contents:
  - "6.2.1.  Port-Based Service Interface\n   This service interface is a special\
    \ case of the VLAN bundle service\n   interface, where all of the VLANs on the\
    \ port are part of the same\n   service and map to the same bundle.  The procedures\
    \ are identical to\n   those described in Section 6.2.\n"
- title: 6.3.  VLAN-Aware Bundle Service Interface
  contents:
  - "6.3.  VLAN-Aware Bundle Service Interface\n   With this service interface, an\
    \ EVPN instance consists of multiple\n   broadcast domains (e.g., multiple VLANs)\
    \ with each VLAN having its\n   own bridge table -- i.e., multiple bridge tables\
    \ (one per VLAN) are\n   maintained by a single MAC-VRF corresponding to the EVPN\
    \ instance.\n   Broadcast, unknown unicast, or multicast (BUM) traffic is sent\
    \ only\n   to the CEs in a given broadcast domain; however, the broadcast\n  \
    \ domains within an EVI either MAY each have their own P-Tunnel or MAY\n   share\
    \ P-Tunnels -- e.g., all of the broadcast domains in an EVI MAY\n   share a single\
    \ P-Tunnel.\n   In the case where a single VLAN is represented by a single VID\
    \ and\n   thus no VID translation is required, an MPLS-encapsulated packet MUST\n\
    \   carry that VID.  The Ethernet Tag ID in all EVPN routes MUST be set\n   to\
    \ that VID.  The advertising PE MAY advertise the MPLS Label1 in the\n   MAC/IP\
    \ Advertisement route representing ONLY the EVI or representing\n   both the Ethernet\
    \ Tag ID and the EVI.  This decision is only a local\n   matter by the advertising\
    \ PE (which is also the disposition PE) and\n   doesn't affect any other PEs.\n\
    \   In the case where a single VLAN is represented by different VIDs on\n   different\
    \ CEs and thus VID translation is required, a normalized\n   Ethernet Tag ID (VID)\
    \ MUST be carried in the EVPN BGP routes.\n   Furthermore, the advertising PE\
    \ advertises the MPLS Label1 in the\n   MAC/IP Advertisement route representing\
    \ both the Ethernet Tag ID and\n   the EVI, so that upon receiving an MPLS-encapsulated\
    \ packet, it can\n   identify the corresponding bridge table from the MPLS EVPN\
    \ label and\n   perform Ethernet Tag ID translation ONLY at the disposition PE\
    \ --\n   i.e., the Ethernet frames transported over the MPLS/IP network MUST\n\
    \   remain tagged with the originating VID, and VID translation is\n   performed\
    \ on the disposition PE.  The Ethernet Tag ID in all EVPN\n   routes MUST be set\
    \ to the normalized Ethernet Tag ID assigned by the\n   EVPN provider.\n"
- title: 6.3.1.  Port-Based VLAN-Aware Service Interface
  contents:
  - "6.3.1.  Port-Based VLAN-Aware Service Interface\n   This service interface is\
    \ a special case of the VLAN-aware bundle\n   service interface, where all of\
    \ the VLANs on the port are part of the\n   same service and are mapped to a single\
    \ bundle but without any VID\n   translation.  The procedures are a subset of\
    \ those described in\n   Section 6.3.\n"
- title: 7.  BGP EVPN Routes
  contents:
  - "7.  BGP EVPN Routes\n   This document defines a new BGP Network Layer Reachability\n\
    \   Information (NLRI) called the EVPN NLRI.\n   The format of the EVPN NLRI is\
    \ as follows:\n                 +-----------------------------------+\n      \
    \           |    Route Type (1 octet)           |\n                 +-----------------------------------+\n\
    \                 |     Length (1 octet)              |\n                 +-----------------------------------+\n\
    \                 | Route Type specific (variable)    |\n                 +-----------------------------------+\n\
    \   The Route Type field defines the encoding of the rest of the EVPN\n   NLRI\
    \ (Route Type specific EVPN NLRI).\n   The Length field indicates the length in\
    \ octets of the Route Type\n   specific field of the EVPN NLRI.\n   This document\
    \ defines the following Route Types:\n      + 1 - Ethernet Auto-Discovery (A-D)\
    \ route\n      + 2 - MAC/IP Advertisement route\n      + 3 - Inclusive Multicast\
    \ Ethernet Tag route\n      + 4 - Ethernet Segment route\n   The detailed encoding\
    \ and procedures for these route types are\n   described in subsequent sections.\n\
    \   The EVPN NLRI is carried in BGP [RFC4271] using BGP Multiprotocol\n   Extensions\
    \ [RFC4760] with an Address Family Identifier (AFI) of 25\n   (L2VPN) and a Subsequent\
    \ Address Family Identifier (SAFI) of 70\n   (EVPN).  The NLRI field in the MP_REACH_NLRI/MP_UNREACH_NLRI\n\
    \   attribute contains the EVPN NLRI (encoded as specified above).\n   In order\
    \ for two BGP speakers to exchange labeled EVPN NLRI, they\n   must use BGP Capabilities\
    \ Advertisements to ensure that they both are\n   capable of properly processing\
    \ such NLRI.  This is done as specified\n   in [RFC4760], by using capability\
    \ code 1 (multiprotocol BGP) with an\n   AFI of 25 (L2VPN) and a SAFI of 70 (EVPN).\n"
- title: 7.1.  Ethernet Auto-discovery Route
  contents:
  - "7.1.  Ethernet Auto-discovery Route\n   An Ethernet A-D route type specific EVPN\
    \ NLRI consists of the\n   following:\n                +---------------------------------------+\n\
    \                |  Route Distinguisher (RD) (8 octets)  |\n                +---------------------------------------+\n\
    \                |Ethernet Segment Identifier (10 octets)|\n                +---------------------------------------+\n\
    \                |  Ethernet Tag ID (4 octets)           |\n                +---------------------------------------+\n\
    \                |  MPLS Label (3 octets)                |\n                +---------------------------------------+\n\
    \   For the purpose of BGP route key processing, only the Ethernet\n   Segment\
    \ Identifier and the Ethernet Tag ID are considered to be part\n   of the prefix\
    \ in the NLRI.  The MPLS Label field is to be treated as\n   a route attribute\
    \ as opposed to being part of the route.\n   For procedures and usage of this\
    \ route, please see Sections 8.2\n   (\"Fast Convergence\") and 8.4 (\"Aliasing\
    \ and Backup Path\").\n"
- title: 7.2.  MAC/IP Advertisement Route
  contents:
  - "7.2.  MAC/IP Advertisement Route\n   A MAC/IP Advertisement route type specific\
    \ EVPN NLRI consists of the\n   following:\n                +---------------------------------------+\n\
    \                |  RD (8 octets)                        |\n                +---------------------------------------+\n\
    \                |Ethernet Segment Identifier (10 octets)|\n                +---------------------------------------+\n\
    \                |  Ethernet Tag ID (4 octets)           |\n                +---------------------------------------+\n\
    \                |  MAC Address Length (1 octet)         |\n                +---------------------------------------+\n\
    \                |  MAC Address (6 octets)               |\n                +---------------------------------------+\n\
    \                |  IP Address Length (1 octet)          |\n                +---------------------------------------+\n\
    \                |  IP Address (0, 4, or 16 octets)      |\n                +---------------------------------------+\n\
    \                |  MPLS Label1 (3 octets)               |\n                +---------------------------------------+\n\
    \                |  MPLS Label2 (0 or 3 octets)          |\n                +---------------------------------------+\n\
    \   For the purpose of BGP route key processing, only the Ethernet Tag\n   ID,\
    \ MAC Address Length, MAC Address, IP Address Length, and IP\n   Address fields\
    \ are considered to be part of the prefix in the NLRI.\n   The Ethernet Segment\
    \ Identifier, MPLS Label1, and MPLS Label2 fields\n   are to be treated as route\
    \ attributes as opposed to being part of the\n   \"route\".  Both the IP and MAC\
    \ address lengths are in bits.\n   For procedures and usage of this route, please\
    \ see Sections 9\n   (\"Determining Reachability to Unicast MAC Addresses\") and\
    \ 14 (\"Load\n   Balancing of Unicast Packets\").\n"
- title: 7.3.  Inclusive Multicast Ethernet Tag Route
  contents:
  - "7.3.  Inclusive Multicast Ethernet Tag Route\n   An Inclusive Multicast Ethernet\
    \ Tag route type specific EVPN NLRI\n   consists of the following:\n         \
    \      +---------------------------------------+\n               |  RD (8 octets)\
    \                        |\n               +---------------------------------------+\n\
    \               |  Ethernet Tag ID (4 octets)           |\n               +---------------------------------------+\n\
    \               |  IP Address Length (1 octet)          |\n               +---------------------------------------+\n\
    \               |  Originating Router's IP Address      |\n               |  \
    \        (4 or 16 octets)             |\n               +---------------------------------------+\n\
    \   For procedures and usage of this route, please see Sections 11\n   (\"Handling\
    \ of Multi-destination Traffic\"), 12 (\"Processing of Unknown\n   Unicast Packets\"\
    ), and 16 (\"Multicast and Broadcast\").  The IP\n   address length is in bits.\
    \  For the purpose of BGP route key\n   processing, only the Ethernet Tag ID,\
    \ IP Address Length, and\n   Originating Router's IP Address fields are considered\
    \ to be part of\n   the prefix in the NLRI.\n"
- title: 7.4.  Ethernet Segment Route
  contents:
  - "7.4.  Ethernet Segment Route\n   An Ethernet Segment route type specific EVPN\
    \ NLRI consists of the\n   following:\n               +---------------------------------------+\n\
    \               |  RD (8 octets)                        |\n               +---------------------------------------+\n\
    \               |Ethernet Segment Identifier (10 octets)|\n               +---------------------------------------+\n\
    \               |  IP Address Length (1 octet)          |\n               +---------------------------------------+\n\
    \               |  Originating Router's IP Address      |\n               |  \
    \        (4 or 16 octets)             |\n               +---------------------------------------+\n\
    \   For procedures and usage of this route, please see Section 8.5\n   (\"Designated\
    \ Forwarder Election\").  The IP address length is in bits.\n   For the purpose\
    \ of BGP route key processing, only the Ethernet\n   Segment ID, IP Address Length,\
    \ and Originating Router's IP Address\n   fields are considered to be part of\
    \ the prefix in the NLRI.\n"
- title: 7.5.  ESI Label Extended Community
  contents:
  - "7.5.  ESI Label Extended Community\n   This Extended Community is a new transitive\
    \ Extended Community having\n   a Type field value of 0x06 and the Sub-Type 0x01.\
    \  It may be\n   advertised along with Ethernet Auto-discovery routes, and it\
    \ enables\n   split-horizon procedures for multihomed sites as described in\n\
    \   Section 8.3 (\"Split Horizon\").  The ESI Label field represents an ES\n \
    \  by the advertising PE, and it is used in split-horizon filtering by\n   other\
    \ PEs that are connected to the same multihomed Ethernet segment.\n   Each ESI\
    \ Label extended community is encoded as an 8-octet value, as\n   follows:\n \
    \    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    | Type=0x06     | Sub-Type=0x01 | Flags(1 octet)|  Reserved=0   |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    |  Reserved=0   |          ESI Label                            |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   The low-order bit of the Flags octet is defined as the\n   \"Single-Active\"\
    \ bit.  A value of 0 means that the multihomed site\n   is operating in All-Active\
    \ redundancy mode, and a value of 1 means\n   that the multihomed site is operating\
    \ in Single-Active redundancy\n   mode.\n"
- title: 7.6.  ES-Import Route Target
  contents:
  - "7.6.  ES-Import Route Target\n   This is a new transitive Route Target extended\
    \ community carried with\n   the Ethernet Segment route.  When used, it enables\
    \ all the PEs\n   connected to the same multihomed site to import the Ethernet\
    \ Segment\n   routes.  The value is derived automatically for the ESI Types 1,\
    \ 2,\n   and 3, by encoding the high-order 6-octet portion of the 9-octet ESI\n\
    \   Value, which corresponds to a MAC address, in the ES-Import Route\n   Target.\
    \  The format of this Extended Community is as follows:\n     0 1 2 3 4 5 6 7\
    \ 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    | Type=0x06     | Sub-Type=0x02 |          ES-Import            |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    |                     ES-Import Cont'd                          |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   This document expands the definition of the Route Target extended\n   community\
    \ to allow the value of the high-order octet (Type field) to\n   be 0x06 (in addition\
    \ to the values specified in [RFC4360]).  The\n   low-order octet (Sub-Type field)\
    \ value 0x02 indicates that this\n   Extended Community is of type \"Route Target\"\
    .  The new Type field\n   value 0x06 indicates that the structure of this RT is\
    \ a 6-octet value\n   (e.g., a MAC address).  A BGP speaker that implements RT\
    \ Constraint\n   [RFC4684] MUST apply the RT Constraint procedures to the ES-Import\
    \ RT\n   as well.\n   For procedures and usage of this attribute, please see Section\
    \ 8.1\n   (\"Multihomed Ethernet Segment Auto-discovery\").\n"
- title: 7.7.  MAC Mobility Extended Community
  contents:
  - "7.7.  MAC Mobility Extended Community\n   This Extended Community is a new transitive\
    \ Extended Community having\n   a Type field value of 0x06 and the Sub-Type 0x00.\
    \  It may be\n   advertised along with MAC/IP Advertisement routes.  The procedures\n\
    \   for using this Extended Community are described in Section 15 (\"MAC\n   Mobility\"\
    ).\n   The MAC Mobility extended community is encoded as an 8-octet value,\n \
    \  as follows:\n     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8\
    \ 9 0 1\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    | Type=0x06     | Sub-Type=0x00 |Flags(1 octet)|  Reserved=0    |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \    |                       Sequence Number                         |\n    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   The low-order bit of the Flags octet is defined as the\n   \"Sticky/static\"\
    \ flag and may be set to 1.  A value of 1 means that\n   the MAC address is static\
    \ and cannot move.  The sequence number is\n   used to ensure that PEs retain\
    \ the correct MAC/IP Advertisement route\n   when multiple updates occur for the\
    \ same MAC address.\n"
- title: 7.8.  Default Gateway Extended Community
  contents:
  - "7.8.  Default Gateway Extended Community\n   The Default Gateway community is\
    \ an Extended Community of an Opaque\n   Type (see Section 3.3 of [RFC4360]).\
    \  It is a transitive community,\n   which means that the first octet is 0x03.\
    \  The value of the second\n   octet (Sub-Type) is 0x0d (Default Gateway) as assigned\
    \ by IANA.  The\n   Value field of this community is reserved (set to 0 by the\
    \ senders,\n   ignored by the receivers).  For procedures and usage of this\n\
    \   attribute, please see Section 10.1 (\"Default Gateway\").\n"
- title: 7.9.  Route Distinguisher Assignment per MAC-VRF
  contents:
  - "7.9.  Route Distinguisher Assignment per MAC-VRF\n   The Route Distinguisher\
    \ (RD) MUST be set to the RD of the MAC-VRF\n   that is advertising the NLRI.\
    \  An RD MUST be assigned for a given\n   MAC-VRF on a PE.  This RD MUST be unique\
    \ across all MAC-VRFs on a PE.\n   It is RECOMMENDED to use the Type 1 RD [RFC4364].\
    \  The value field\n   comprises an IP address of the PE (typically, the loopback\
    \ address)\n   followed by a number unique to the PE.  This number may be generated\n\
    \   by the PE.  Or, in the Unique VLAN EVPN case, the low-order 12 bits\n   may\
    \ be the 12-bit VLAN ID, with the remaining high-order 4 bits set\n   to 0.\n"
- title: 7.10.  Route Targets
  contents:
  - "7.10.  Route Targets\n   The EVPN route MAY carry one or more Route Target (RT)\
    \ attributes.\n   RTs may be configured (as in IP VPNs) or may be derived\n  \
    \ automatically.\n   If a PE uses RT Constraint, the PE advertises all such RTs\
    \ using RT\n   Constraints per [RFC4684].  The use of RT Constraints allows each\n\
    \   EVPN route to reach only those PEs that are configured to import at\n   least\
    \ one RT from the set of RTs carried in the EVPN route.\n"
- title: 7.10.1.  Auto-derivation from the Ethernet Tag ID
  contents:
  - "7.10.1.  Auto-derivation from the Ethernet Tag ID\n   For the \"Unique VLAN EVPN\"\
    \ scenario, it is highly desirable to\n   auto-derive the RT from the Ethernet\
    \ Tag ID (VLAN ID) for that EVPN\n   instance.  The procedure for performing such\
    \ auto-derivation is as\n   follows:\n   + The Global Administrator field of the\
    \ RT MUST be set to the\n     Autonomous System (AS) number with which the PE\
    \ is associated.\n   + The 12-bit VLAN ID MUST be encoded in the lowest 12 bits\
    \ of the\n     Local Administrator field, with the remaining bits set to zero.\n"
- title: 8.  Multihoming Functions
  contents:
  - "8.  Multihoming Functions\n   This section discusses the functions, procedures,\
    \ and associated BGP\n   routes used to support multihoming in EVPN.  This covers\
    \ both\n   multihomed device (MHD) and multihomed network (MHN) scenarios.\n"
- title: 8.1.  Multihomed Ethernet Segment Auto-discovery
  contents:
  - "8.1.  Multihomed Ethernet Segment Auto-discovery\n   PEs connected to the same\
    \ Ethernet segment can automatically discover\n   each other with minimal to no\
    \ configuration through the exchange of\n   the Ethernet Segment route.\n"
- title: 8.1.1.  Constructing the Ethernet Segment Route
  contents:
  - "8.1.1.  Constructing the Ethernet Segment Route\n   The Route Distinguisher (RD)\
    \ MUST be a Type 1 RD [RFC4364].  The\n   value field comprises an IP address\
    \ of the PE (typically, the\n   loopback address) followed by a number unique\
    \ to the PE.\n   The Ethernet Segment Identifier (ESI) MUST be set to the 10-octet\n\
    \   value described in Section 5.\n   The BGP advertisement that advertises the\
    \ Ethernet Segment route MUST\n   also carry an ES-Import Route Target, as defined\
    \ in Section 7.6.\n   The Ethernet Segment route filtering MUST be done such that\
    \ the\n   Ethernet Segment route is imported only by the PEs that are\n   multihomed\
    \ to the same Ethernet segment.  To that end, each PE that\n   is connected to\
    \ a particular Ethernet segment constructs an import\n   filtering rule to import\
    \ a route that carries the ES-Import Route\n   Target, constructed from the ESI.\n"
- title: 8.2.  Fast Convergence
  contents:
  - "8.2.  Fast Convergence\n   In EVPN, MAC address reachability is learned via the\
    \ BGP control\n   plane over the MPLS network.  As such, in the absence of any\
    \ fast\n   protection mechanism, the network convergence time is a function of\n\
    \   the number of MAC/IP Advertisement routes that must be withdrawn by\n   the\
    \ PE encountering a failure.  For highly scaled environments, this\n   scheme\
    \ yields slow convergence.\n   To alleviate this, EVPN defines a mechanism to\
    \ efficiently and\n   quickly signal, to remote PE nodes, the need to update their\n\
    \   forwarding tables upon the occurrence of a failure in connectivity to\n  \
    \ an Ethernet segment.  This is done by having each PE advertise a set\n   of\
    \ one or more Ethernet A-D per ES routes for each locally attached\n   Ethernet\
    \ segment (refer to Section 8.2.1 below for details on how\n   these routes are\
    \ constructed).  A PE may need to advertise more than\n   one Ethernet A-D per\
    \ ES route for a given ES because the ES may be in\n   a multiplicity of EVIs\
    \ and the RTs for all of these EVIs may not fit\n   into a single route.  Advertising\
    \ a set of Ethernet A-D per ES routes\n   for the ES allows each route to contain\
    \ a subset of the complete set\n   of RTs.  Each Ethernet A-D per ES route is\
    \ differentiated from the\n   other routes in the set by a different Route Distinguisher\
    \ (RD).\n   Upon a failure in connectivity to the attached segment, the PE\n \
    \  withdraws the corresponding set of Ethernet A-D per ES routes.  This\n   triggers\
    \ all PEs that receive the withdrawal to update their next-hop\n   adjacencies\
    \ for all MAC addresses associated with the Ethernet\n   segment in question.\
    \  If no other PE had advertised an Ethernet A-D\n   route for the same segment,\
    \ then the PE that received the withdrawal\n   simply invalidates the MAC entries\
    \ for that segment.  Otherwise, the\n   PE updates its next-hop adjacencies accordingly.\n"
- title: 8.2.1.  Constructing Ethernet A-D per Ethernet Segment Route
  contents:
  - "8.2.1.  Constructing Ethernet A-D per Ethernet Segment Route\n   This section\
    \ describes the procedures used to construct the Ethernet\n   A-D per ES route,\
    \ which is used for fast convergence (as discussed\n   above) and for advertising\
    \ the ESI label used for split-horizon\n   filtering (as discussed in Section\
    \ 8.3).  Support of this route is\n   REQUIRED.\n   The Route Distinguisher (RD)\
    \ MUST be a Type 1 RD [RFC4364].  The\n   value field comprises an IP address\
    \ of the PE (typically, the\n   loopback address) followed by a number unique\
    \ to the PE.\n   The Ethernet Segment Identifier MUST be a 10-octet entity as\n\
    \   described in Section 5 (\"Ethernet Segment\").  The Ethernet A-D route\n \
    \  is not needed when the Segment Identifier is set to 0 (e.g., single-\n   homed\
    \ scenarios).\n   The Ethernet Tag ID MUST be set to MAX-ET.\n   The MPLS label\
    \ in the NLRI MUST be set to 0.\n   The ESI Label extended community MUST be included\
    \ in the route.  If\n   All-Active redundancy mode is desired, then the \"Single-Active\"\
    \ bit\n   in the flags of the ESI Label extended community MUST be set to 0 and\n\
    \   the MPLS label in that Extended Community MUST be set to a valid MPLS\n  \
    \ label value.  The MPLS label in this Extended Community is referred\n   to as\
    \ the ESI label and MUST have the same value in each Ethernet A-D\n   per ES route\
    \ advertised for the ES.  This label MUST be a downstream\n   assigned MPLS label\
    \ if the advertising PE is using ingress\n   replication for receiving multicast,\
    \ broadcast, or unknown unicast\n   traffic from other PEs.  If the advertising\
    \ PE is using P2MP MPLS\n   LSPs for sending multicast, broadcast, or unknown\
    \ unicast traffic,\n   then this label MUST be an upstream assigned MPLS label.\
    \  The usage\n   of this label is described in Section 8.3.\n   If Single-Active\
    \ redundancy mode is desired, then the \"Single-Active\"\n   bit in the flags\
    \ of the ESI Label extended community MUST be set to 1\n   and the ESI label SHOULD\
    \ be set to a valid MPLS label value.\n"
- title: 8.2.1.1.  Ethernet A-D Route Targets
  contents:
  - "8.2.1.1.  Ethernet A-D Route Targets\n   Each Ethernet A-D per ES route MUST\
    \ carry one or more Route Target\n   (RT) attributes.  The set of Ethernet A-D\
    \ routes per ES MUST carry\n   the entire set of RTs for all the EVPN instances\
    \ to which the\n   Ethernet segment belongs.\n"
- title: 8.3.  Split Horizon
  contents:
  - "8.3.  Split Horizon\n   Consider a CE that is multihomed to two or more PEs on\
    \ an Ethernet\n   segment ES1 operating in All-Active redundancy mode.  If the\
    \ CE sends\n   a broadcast, unknown unicast, or multicast (BUM) packet to one\
    \ of the\n   non-Designated Forwarder (non-DF) PEs, say PE1, then PE1 will forward\n\
    \   that packet to all or a subset of the other PEs in that EVPN\n   instance,\
    \ including the DF PE for that Ethernet segment.  In this\n   case, the DF PE\
    \ to which the CE is multihomed MUST drop the packet\n   and not forward back\
    \ to the CE.  This filtering is referred to as\n   \"split-horizon filtering\"\
    \ in this document.\n   When a set of PEs are operating in Single-Active redundancy\
    \ mode, the\n   use of this split-horizon filtering mechanism is highly recommended\n\
    \   because it prevents transient loops at the time of failure or\n   recovery\
    \ that would impact the Ethernet segment -- e.g., when two PEs\n   think that\
    \ both are DFs for that segment before the DF election\n   procedure settles down.\n\
    \   In order to achieve this split-horizon function, every BUM packet\n   originating\
    \ from a non-DF PE is encapsulated with an MPLS label that\n   identifies the\
    \ Ethernet segment of origin (i.e., the segment from\n   which the frame entered\
    \ the EVPN network).  This label is referred to\n   as the ESI label and MUST\
    \ be distributed by all PEs when operating in\n   All-Active redundancy mode using\
    \ a set of Ethernet A-D per ES routes,\n   per Section 8.2.1 above.  The ESI label\
    \ SHOULD be distributed by all\n   PEs when operating in Single-Active redundancy\
    \ mode using a set of\n   Ethernet A-D per ES routes.  These routes are imported\
    \ by the PEs\n   connected to the Ethernet segment and also by the PEs that have\
    \ at\n   least one EVPN instance in common with the Ethernet segment in the\n\
    \   route.  As described in Section 8.1.1, the route MUST carry an ESI\n   Label\
    \ extended community with a valid ESI label.  The disposition PE\n   relies on\
    \ the value of the ESI label to determine whether or not a\n   BUM frame is allowed\
    \ to egress a specific Ethernet segment.\n"
- title: 8.3.1.  ESI Label Assignment
  contents:
  - "8.3.1.  ESI Label Assignment\n   The following subsections describe the assignment\
    \ procedures for the\n   ESI label, which differ depending on the type of tunnels\
    \ being used\n   to deliver multi-destination packets in the EVPN network.\n"
- title: 8.3.1.1.  Ingress Replication
  contents:
  - "8.3.1.1.  Ingress Replication\n   Each PE that operates in All-Active or Single-Active\
    \ redundancy mode\n   and that uses ingress replication to receive BUM traffic\
    \ advertises a\n   downstream assigned ESI label in the set of Ethernet A-D per\
    \ ES\n   routes for its attached ES.  This label MUST be programmed in the\n \
    \  platform label space by the advertising PE, and the forwarding entry\n   for\
    \ this label must result in NOT forwarding packets received with\n   this label\
    \ onto the Ethernet segment for which the label was\n   distributed.\n   The rules\
    \ for the inclusion of the ESI label in a BUM packet by the\n   ingress PE operating\
    \ in All-Active redundancy mode are as follows:\n   - A non-DF ingress PE MUST\
    \ include the ESI label distributed by the\n     DF egress PE in the copy of a\
    \ BUM packet sent to it.\n   - An ingress PE (DF or non-DF) SHOULD include the\
    \ ESI label\n     distributed by each non-DF egress PE in the copy of a BUM packet\n\
    \     sent to it.\n   The rule for the inclusion of the ESI label in a BUM packet\
    \ by the\n   ingress PE operating in Single-Active redundancy mode is as follows:\n\
    \   - An ingress DF PE SHOULD include the ESI label distributed by the\n     egress\
    \ PE in the copy of a BUM packet sent to it.\n   In both All-Active and Single-Active\
    \ redundancy mode, an ingress PE\n   MUST NOT include an ESI label in the copy\
    \ of a BUM packet sent to an\n   egress PE that is not attached to the ES through\
    \ which the BUM packet\n   entered the EVI.\n   As an example, consider PE1 and\
    \ PE2, which are multihomed to CE1 on\n   ES1 and operating in All-Active multihoming\
    \ mode.  Further, consider\n   that PE1 is using P2P or MP2P LSPs to send packets\
    \ to PE2.  Consider\n   that PE1 is the non-DF for VLAN1 and PE2 is the DF for\
    \ VLAN1, and PE1\n   receives a BUM packet from CE1 on VLAN1 on ES1.  In this\
    \ scenario,\n   PE2 distributes an Inclusive Multicast Ethernet Tag route for\
    \ VLAN1\n   corresponding to an EVPN instance.  So, when PE1 sends a BUM packet\n\
    \   that it receives from CE1, it MUST first push onto the MPLS label\n   stack\
    \ the ESI label that PE2 has distributed for ES1.  It MUST then\n   push onto\
    \ the MPLS label stack the MPLS label distributed by PE2 in\n   the Inclusive\
    \ Multicast Ethernet Tag route for VLAN1.  The resulting\n   packet is further\
    \ encapsulated in the P2P or MP2P LSP label stack\n   required to transmit the\
    \ packet to PE2.  When PE2 receives this\n   packet, it determines, from the top\
    \ MPLS label, the set of ESIs to\n   which it will replicate the packet after\
    \ any P2P or MP2P LSP labels\n   have been removed.  If the next label is the\
    \ ESI label assigned by\n   PE2 for ES1, then PE2 MUST NOT forward the packet\
    \ onto ES1.  If the\n   next label is an ESI label that has not been assigned\
    \ by PE2, then\n   PE2 MUST drop the packet.  It should be noted that in this\
    \ scenario,\n   if PE2 receives a BUM packet for VLAN1 from CE1, then it SHOULD\n\
    \   encapsulate the packet with an ESI label received from PE1 when\n   sending\
    \ it to PE1 in order to avoid any transient loops during a\n   failure scenario\
    \ that would impact ES1 (e.g., port or link failure).\n"
- title: 8.3.1.2.  P2MP MPLS LSPs
  contents:
  - "8.3.1.2.  P2MP MPLS LSPs\n   The non-DF PEs that operate in All-Active redundancy\
    \ mode and that\n   use P2MP LSPs to send BUM traffic advertise an upstream assigned\
    \ ESI\n   label in the set of Ethernet A-D per ES routes for their common\n  \
    \ attached ES.  This label is upstream assigned by the PE that\n   advertises\
    \ the route.  This label MUST be programmed by the other PEs\n   that are connected\
    \ to the ESI advertised in the route, in the context\n   label space for the advertising\
    \ PE.  Further, the forwarding entry\n   for this label must result in NOT forwarding\
    \ packets received with\n   this label onto the Ethernet segment for which the\
    \ label was\n   distributed.  This label MUST also be programmed by the other\
    \ PEs\n   that import the route but are not connected to the ESI advertised in\n\
    \   the route, in the context label space for the advertising PE.\n   Further,\
    \ the forwarding entry for this label must be a label pop with\n   no other associated\
    \ action.\n   The DF PE that operates in Single-Active redundancy mode and that\n\
    \   uses P2MP LSPs to send BUM traffic should advertise an upstream\n   assigned\
    \ ESI label in the set of Ethernet A-D per ES routes for its\n   attached ES,\
    \ just as described in the previous paragraph.\n   As an example, consider PE1\
    \ and PE2, which are multihomed to CE1 on\n   ES1 and operating in All-Active\
    \ multihoming mode.  Also, consider\n   that PE3 belongs to one of the EVPN instances\
    \ of ES1.  Further,\n   assume that PE1, which is the non-DF, is using P2MP MPLS\
    \ LSPs to send\n   BUM packets.  When PE1 sends a BUM packet that it receives\
    \ from CE1,\n   it MUST first push onto the MPLS label stack the ESI label that\
    \ it\n   has assigned for the ESI on which the packet was received.  The\n   resulting\
    \ packet is further encapsulated in the P2MP MPLS label stack\n   necessary to\
    \ transmit the packet to the other PEs.  Penultimate hop\n   popping MUST be disabled\
    \ on the P2MP LSPs used in the MPLS transport\n   infrastructure for EVPN.  When\
    \ PE2 receives this packet, it\n   decapsulates the top MPLS label and forwards\
    \ the packet using the\n   context label space determined by the top label.  If\
    \ the next label\n   is the ESI label assigned by PE1 to ES1, then PE2 MUST NOT\
    \ forward\n   the packet onto ES1.  When PE3 receives this packet, it decapsulates\n\
    \   the top MPLS label and forwards the packet using the context label\n   space\
    \ determined by the top label.  If the next label is the ESI\n   label assigned\
    \ by PE1 to ES1 and PE3 is not connected to ES1, then\n   PE3 MUST pop the label\
    \ and flood the packet over all local ESIs in\n   that EVPN instance.  It should\
    \ be noted that when PE2 sends a BUM\n   frame over a P2MP LSP, it should encapsulate\
    \ the frame with an ESI\n   label even though it is the DF for that VLAN, in order\
    \ to avoid any\n   transient loops during a failure scenario that would impact\
    \ ES1\n   (e.g., port or link failure).\n"
- title: 8.4.  Aliasing and Backup Path
  contents:
  - "8.4.  Aliasing and Backup Path\n   In the case where a CE is multihomed to multiple\
    \ PE nodes, using a\n   Link Aggregation Group (LAG) with All-Active redundancy,\
    \ it is\n   possible that only a single PE learns a set of the MAC addresses\n\
    \   associated with traffic transmitted by the CE.  This leads to a\n   situation\
    \ where remote PE nodes receive MAC/IP Advertisement routes\n   for these addresses\
    \ from a single PE, even though multiple PEs are\n   connected to the multihomed\
    \ segment.  As a result, the remote PEs are\n   not able to effectively load balance\
    \ traffic among the PE nodes\n   connected to the multihomed Ethernet segment.\
    \  This could be the\n   case, for example, when the PEs perform data-plane learning\
    \ on the\n   access, and the load-balancing function on the CE hashes traffic\
    \ from\n   a given source MAC address to a single PE.\n   Another scenario where\
    \ this occurs is when the PEs rely on control-\n   plane learning on the access\
    \ (e.g., using ARP), since ARP traffic\n   will be hashed to a single link in\
    \ the LAG.\n   To address this issue, EVPN introduces the concept of 'aliasing',\n\
    \   which is the ability of a PE to signal that it has reachability to an\n  \
    \ EVPN instance on a given ES even when it has learned no MAC addresses\n   from\
    \ that EVI/ES.  The Ethernet A-D per EVI route is used for this\n   purpose. \
    \ A remote PE that receives a MAC/IP Advertisement route with\n   a non-reserved\
    \ ESI SHOULD consider the advertised MAC address to be\n   reachable via all PEs\
    \ that have advertised reachability to that MAC\n   address's EVI/ES via the combination\
    \ of an Ethernet A-D per EVI route\n   for that EVI/ES (and Ethernet tag, if applicable)\
    \ AND Ethernet A-D\n   per ES routes for that ES with the \"Single-Active\" bit\
    \ in the flags\n   of the ESI Label extended community set to 0.\n   Note that\
    \ the Ethernet A-D per EVI route may be received by a remote\n   PE before it\
    \ receives the set of Ethernet A-D per ES routes.\n   Therefore, in order to handle\
    \ corner cases and race conditions, the\n   Ethernet A-D per EVI route MUST NOT\
    \ be used for traffic forwarding by\n   a remote PE until it also receives the\
    \ associated set of Ethernet A-D\n   per ES routes.\n   The backup path is a closely\
    \ related function, but it is used in\n   Single-Active redundancy mode.  In this\
    \ case, a PE also advertises\n   that it has reachability to a given EVI/ES using\
    \ the same combination\n   of Ethernet A-D per EVI route and Ethernet A-D per\
    \ ES route as\n   discussed above, but with the \"Single-Active\" bit in the flags\
    \ of the\n   ESI Label extended community set to 1.  A remote PE that receives\
    \ a\n   MAC/IP Advertisement route with a non-reserved ESI SHOULD consider\n \
    \  the advertised MAC address to be reachable via any PE that has\n   advertised\
    \ this combination of Ethernet A-D routes, and it SHOULD\n   install a backup\
    \ path for that MAC address.\n"
- title: 8.4.1.  Constructing Ethernet A-D per EVPN Instance Route
  contents:
  - "8.4.1.  Constructing Ethernet A-D per EVPN Instance Route\n   This section describes\
    \ the procedures used to construct the Ethernet\n   A-D per EVPN instance (EVI)\
    \ route, which is used for aliasing (as\n   discussed above).  Support of this\
    \ route is OPTIONAL.\n   The Route Distinguisher (RD) MUST be set per Section\
    \ 7.9.\n   The Ethernet Segment Identifier MUST be a 10-octet entity as\n   described\
    \ in Section 5 (\"Ethernet Segment\").  The Ethernet A-D route\n   is not needed\
    \ when the Segment Identifier is set to 0.\n   The Ethernet Tag ID is the identifier\
    \ of an Ethernet tag on the\n   Ethernet segment.  This value may be a 12-bit\
    \ VLAN ID, in which case\n   the low-order 12 bits are set to the VLAN ID and\
    \ the high-order\n   20 bits are set to 0.  Or, it may be another Ethernet tag\
    \ used by the\n   EVPN.  It MAY be set to the default Ethernet tag on the Ethernet\n\
    \   segment or to the value 0.\n   Note that the above allows the Ethernet A-D\
    \ route to be advertised\n   with one of the following granularities:\n   + One\
    \ Ethernet A-D route per <ESI, Ethernet Tag ID> tuple per\n     MAC-VRF.  This\
    \ is applicable when the PE uses MPLS-based\n     disposition with VID translation\
    \ or may be applicable when the\n     PE uses MAC-based disposition with VID translation.\n\
    \   + One Ethernet A-D route for each <ESI> per MAC-VRF (where the\n     Ethernet\
    \ Tag ID is set to 0).  This is applicable when the PE uses\n     MAC-based disposition\
    \ or MPLS-based disposition without VID\n     translation.\n   The usage of the\
    \ MPLS label is described in Section 14 (\"Load\n   Balancing of Unicast Packets\"\
    ).\n   The Next Hop field of the MP_REACH_NLRI attribute of the route MUST\n \
    \  be set to the IPv4 or IPv6 address of the advertising PE.\n   The Ethernet\
    \ A-D route MUST carry one or more Route Target (RT)\n   attributes, per Section\
    \ 7.10.\n"
- title: 8.5.  Designated Forwarder Election
  contents:
  - "8.5.  Designated Forwarder Election\n   Consider a CE that is a host or a router\
    \ that is multihomed directly\n   to more than one PE in an EVPN instance on a\
    \ given Ethernet segment.\n   One or more Ethernet tags may be configured on the\
    \ Ethernet segment.\n   In this scenario, only one of the PEs, referred to as\
    \ the Designated\n   Forwarder (DF), is responsible for certain actions:\n   -\
    \ Sending multicast and broadcast traffic, on a given Ethernet tag on\n     a\
    \ particular Ethernet segment, to the CE.\n   - Flooding unknown unicast traffic\
    \ (i.e., traffic for which a PE does\n     not know the destination MAC address),\
    \ on a given Ethernet tag on a\n     particular Ethernet segment to the CE, if\
    \ the environment requires\n     flooding of unknown unicast traffic.\n   Note\
    \ that this behavior, which allows selecting a DF at the\n   granularity of <ES,\
    \ VLAN> or <ES, VLAN bundle> for multicast,\n   broadcast, and unknown unicast\
    \ traffic, is the default behavior in\n   this specification.\n   Note that a\
    \ CE always sends packets belonging to a specific flow\n   using a single link\
    \ towards a PE.  For instance, if the CE is a host,\n   then, as mentioned earlier,\
    \ the host treats the multiple links that\n   it uses to reach the PEs as a Link\
    \ Aggregation Group (LAG).  The CE\n   employs a local hashing function to map\
    \ traffic flows onto links in\n   the LAG.\n   If a bridged network is multihomed\
    \ to more than one PE in an EVPN\n   network via switches, then the support of\
    \ All-Active redundancy mode\n   requires the bridged network to be connected\
    \ to two or more PEs using\n   a LAG.\n   If a bridged network does not connect\
    \ to the PEs using a LAG, then\n   only one of the links between the bridged network\
    \ and the PEs must be\n   the active link for a given <ES, VLAN> or <ES, VLAN\
    \ bundle>.  In this\n   case, the set of Ethernet A-D per ES routes advertised\
    \ by each PE\n   MUST have the \"Single-Active\" bit in the flags of the ESI Label\n\
    \   extended community set to 1.\n   The default procedure for DF election at\
    \ the granularity of <ES,\n   VLAN> for VLAN-based service or <ES, VLAN bundle>\
    \ for VLAN-(aware)\n   bundle service is referred to as \"service carving\". \
    \ With service\n   carving, it is possible to elect multiple DFs per Ethernet\
    \ segment\n   (one per VLAN or VLAN bundle) in order to perform load balancing\
    \ of\n   multi-destination traffic destined to a given segment.  The load-\n \
    \  balancing procedures carve up the VLAN space per ES among the PE\n   nodes\
    \ evenly, in such a way that every PE is the DF for a disjoint\n   set of VLANs\
    \ or VLAN bundles for that ES.  The procedure for service\n   carving is as follows:\n\
    \   1. When a PE discovers the ESI of the attached Ethernet segment, it\n    \
    \  advertises an Ethernet Segment route with the associated ES-Import\n      extended\
    \ community attribute.\n   2. The PE then starts a timer (default value = 3 seconds)\
    \ to allow\n      the reception of Ethernet Segment routes from other PE nodes\n\
    \      connected to the same Ethernet segment.  This timer value should\n    \
    \  be the same across all PEs connected to the same Ethernet segment.\n   3. When\
    \ the timer expires, each PE builds an ordered list of the IP\n      addresses\
    \ of all the PE nodes connected to the Ethernet segment\n      (including itself),\
    \ in increasing numeric value.  Each IP address\n      in this list is extracted\
    \ from the \"Originating Router's IP\n      address\" field of the advertised\
    \ Ethernet Segment route.  Every PE\n      is then given an ordinal indicating\
    \ its position in the ordered\n      list, starting with 0 as the ordinal for\
    \ the PE with the\n      numerically lowest IP address.  The ordinals are used\
    \ to determine\n      which PE node will be the DF for a given EVPN instance on\
    \ the\n      Ethernet segment, using the following rule:\n      Assuming a redundancy\
    \ group of N PE nodes, for VLAN-based service,\n      the PE with ordinal i is\
    \ the DF for an <ES, VLAN V> when (V mod N)\n      = i.  In the case of VLAN-(aware)\
    \ bundle service, then the\n      numerically lowest VLAN value in that bundle\
    \ on that ES MUST be\n      used in the modulo function.\n      It should be noted\
    \ that using the \"Originating Router's IP\n      address\" field in the Ethernet\
    \ Segment route to get the PE IP\n      address needed for the ordered list allows\
    \ for a CE to be\n      multihomed across different ASes if such a need ever arises.\n\
    \   4. The PE that is elected as a DF for a given <ES, VLAN> or <ES, VLAN\n  \
    \    bundle> will unblock multi-destination traffic for that VLAN or\n      VLAN\
    \ bundle on the corresponding ES.  Note that the DF PE unblocks\n      multi-destination\
    \ traffic in the egress direction towards the\n      segment.  All non-DF PEs\
    \ continue to drop multi-destination\n      traffic in the egress direction towards\
    \ that <ES, VLAN> or <ES,\n      VLAN bundle>.\n      In the case of link or port\
    \ failure, the affected PE withdraws its\n      Ethernet Segment route.  This\
    \ will re-trigger the service carving\n      procedures on all the PEs in the\
    \ redundancy group.  For PE node\n      failure, or upon PE commissioning or decommissioning,\
    \ the PEs\n      re-trigger the service carving.  In the case of Single-Active\n\
    \      multihoming, when a service moves from one PE in the redundancy\n     \
    \ group to another PE as a result of re-carving, the PE, which ends\n      up\
    \ being the elected DF for the service, SHOULD trigger a MAC\n      address flush\
    \ notification towards the associated Ethernet\n      segment.  This can be done,\
    \ for example, using the IEEE 802.1ak\n      Multiple VLAN Registration Protocol\
    \ (MVRP) 'new' declaration.\n"
- title: 8.6.  Interoperability with Single-Homing PEs
  contents:
  - "8.6.  Interoperability with Single-Homing PEs\n   Let's refer to PEs that only\
    \ support single-homed CE devices as\n   single-homing PEs.  For single-homing\
    \ PEs, all the above multihoming\n   procedures can be omitted; however, to allow\
    \ for single-homing PEs\n   to fully interoperate with multihoming PEs, some of\
    \ the multihoming\n   procedures described above SHOULD be supported even by single-\n\
    \   homing PEs:\n   - procedures related to processing Ethernet A-D routes for\
    \ the\n     purpose of fast convergence (Section 8.2 (\"Fast Convergence\")),\
    \ to\n     let single-homing PEs benefit from fast convergence\n   - procedures\
    \ related to processing Ethernet A-D routes for the\n     purpose of aliasing\
    \ (Section 8.4 (\"Aliasing and Backup Path\")), to\n     let single-homing PEs\
    \ benefit from load balancing\n   - procedures related to processing Ethernet\
    \ A-D routes for the\n     purpose of a backup path (Section 8.4 (\"Aliasing and\
    \ Backup\n     Path\")), to let single-homing PEs benefit from the corresponding\n\
    \     convergence improvement\n"
- title: 9.  Determining Reachability to Unicast MAC Addresses
  contents:
  - "9.  Determining Reachability to Unicast MAC Addresses\n   PEs forward packets\
    \ that they receive based on the destination MAC\n   address.  This implies that\
    \ PEs must be able to learn how to reach a\n   given destination unicast MAC address.\n\
    \   There are two components to MAC address learning -- \"local learning\"\n \
    \  and \"remote learning\":\n"
- title: 9.1.  Local Learning
  contents:
  - "9.1.  Local Learning\n   A particular PE must be able to learn the MAC addresses\
    \ from the CEs\n   that are connected to it.  This is referred to as local learning.\n\
    \   The PEs in a particular EVPN instance MUST support local data-plane\n   learning\
    \ using standard IEEE Ethernet learning procedures.  A PE must\n   be capable\
    \ of learning MAC addresses in the data plane when it\n   receives packets such\
    \ as the following from the CE network:\n   - DHCP requests\n   - An ARP Request\
    \ for its own MAC\n   - An ARP Request for a peer\n   Alternatively, PEs MAY learn\
    \ the MAC addresses of the CEs in the\n   control plane or via management-plane\
    \ integration between the PEs and\n   the CEs.\n   There are applications where\
    \ a MAC address that is reachable via a\n   given PE on a locally attached segment\
    \ (e.g., with ESI X) may move,\n   such that it becomes reachable via another\
    \ PE on another segment\n   (e.g., with ESI Y).  This is referred to as \"MAC\
    \ Mobility\".\n   Procedures to support this are described in Section 15 (\"MAC\n\
    \   Mobility\").\n"
- title: 9.2.  Remote Learning
  contents:
  - "9.2.  Remote Learning\n   A particular PE must be able to determine how to send\
    \ traffic to MAC\n   addresses that belong to or are behind CEs connected to other\
    \ PEs,\n   i.e., to remote CEs or hosts behind remote CEs.  We call such MAC\n\
    \   addresses \"remote\" MAC addresses.\n   This document requires a PE to learn\
    \ remote MAC addresses in the\n   control plane.  In order to achieve this, each\
    \ PE advertises the MAC\n   addresses it learns from its locally attached CEs\
    \ in the control\n   plane, to all the other PEs in that EVPN instance, using\
    \ MP-BGP and,\n   specifically, the MAC/IP Advertisement route.\n"
- title: 9.2.1.  Constructing MAC/IP Address Advertisement
  contents:
  - "9.2.1.  Constructing MAC/IP Address Advertisement\n   BGP is extended to advertise\
    \ these MAC addresses using the MAC/IP\n   Advertisement route type in the EVPN\
    \ NLRI.\n   The RD MUST be set per Section 7.9.\n   The Ethernet Segment Identifier\
    \ is set to the 10-octet ESI described\n   in Section 5 (\"Ethernet Segment\"\
    ).\n   The Ethernet Tag ID may be zero or may represent a valid Ethernet\n   Tag\
    \ ID.  This field may be non-zero when there are multiple bridge\n   tables in\
    \ the MAC-VRF (i.e., the PE needs to support VLAN-aware\n   bundle service for\
    \ that EVI).\n   When the Ethernet Tag ID in the NLRI is set to a non-zero value\
    \ for a\n   particular broadcast domain, then this Ethernet Tag ID may be either\n\
    \   the CE's Ethernet tag value (e.g., CE VLAN ID) or the EVPN provider's\n  \
    \ Ethernet tag value (e.g., provider VLAN ID).  The latter would be the\n   case\
    \ if the CE Ethernet tags (e.g., CE VLAN ID) for a particular\n   broadcast domain\
    \ are different on different CEs.\n   The MAC Address Length field is in bits,\
    \ and it is set to 48.  MAC\n   address length values other than 48 bits are outside\
    \ the scope of\n   this document.  The encoding of a MAC address MUST be the 6-octet\
    \ MAC\n   address specified by [802.1Q] and [802.1D-REV].\n   The IP Address field\
    \ is optional.  By default, the IP Address Length\n   field is set to 0, and the\
    \ IP Address field is omitted from the\n   route.  When a valid IP address needs\
    \ to be advertised, it is then\n   encoded in this route.  When an IP address\
    \ is present, the IP Address\n   Length field is in bits, and it is set to 32\
    \ or 128 bits.  Other IP\n   Address Length values are outside the scope of this\
    \ document.  The\n   encoding of an IP address MUST be either 4 octets for IPv4\
    \ or\n   16 octets for IPv6.  The Length field of the EVPN NLRI (which is in\n\
    \   octets and is described in Section 7) is sufficient to determine\n   whether\
    \ an IP address is encoded in this route and, if so, whether\n   the encoded IP\
    \ address is IPv4 or IPv6.\n   The MPLS Label1 field is encoded as 3 octets, where\
    \ the high-order\n   20 bits contain the label value.  The MPLS Label1 MUST be\
    \ downstream\n   assigned, and it is associated with the MAC address being advertised\n\
    \   by the advertising PE.  The advertising PE uses this label when it\n   receives\
    \ an MPLS-encapsulated packet to perform forwarding based on\n   the destination\
    \ MAC address toward the CE.  The forwarding procedures\n   are specified in Sections\
    \ 13 and 14.\n   A PE may advertise the same single EVPN label for all MAC addresses\n\
    \   in a given MAC-VRF.  This label assignment is referred to as a per\n   MAC-VRF\
    \ label assignment.  Alternatively, a PE may advertise a unique\n   EVPN label\
    \ per <MAC-VRF, Ethernet tag> combination.  This label\n   assignment is referred\
    \ to as a per <MAC-VRF, Ethernet tag> label\n   assignment.  As a third option,\
    \ a PE may advertise a unique EVPN\n   label per <ESI, Ethernet tag> combination.\
    \  This label assignment is\n   referred to as a per <ESI, Ethernet tag> label\
    \ assignment.  As a\n   fourth option, a PE may advertise a unique EVPN label\
    \ per MAC\n   address.  This label assignment is referred to as a per MAC label\n\
    \   assignment.  All of these label assignment methods have their\n   trade-offs.\
    \  The choice of a particular label assignment methodology\n   is purely local\
    \ to the PE that originates the route.\n   An assignment per MAC-VRF label requires\
    \ the least number of EVPN\n   labels but requires a MAC lookup in addition to\
    \ an MPLS lookup on an\n   egress PE for forwarding.  On the other hand, a unique\
    \ label per\n   <ESI, Ethernet tag> or a unique label per MAC allows an egress\
    \ PE to\n   forward a packet that it receives from another PE, to the connected\n\
    \   CE, after looking up only the MPLS labels without having to perform a\n  \
    \ MAC lookup.  This includes the capability to perform appropriate VLAN\n   ID\
    \ translation on egress to the CE.\n   The MPLS Label2 field is an optional field.\
    \  If it is present, then\n   it is encoded as 3 octets, where the high-order\
    \ 20 bits contain the\n   label value.\n   The Next Hop field of the MP_REACH_NLRI\
    \ attribute of the route MUST\n   be set to the IPv4 or IPv6 address of the advertising\
    \ PE.\n   The BGP advertisement for the MAC/IP Advertisement route MUST also\n\
    \   carry one or more Route Target (RT) attributes.  RTs may be\n   configured\
    \ (as in IP VPNs) or may be derived automatically from the\n   Ethernet Tag ID,\
    \ in the Unique VLAN case, as described in\n   Section 7.10.1.\n   It is to be\
    \ noted that this document does not require PEs to create\n   forwarding state\
    \ for remote MACs when they are learned in the control\n   plane.  When this forwarding\
    \ state is actually created is a local\n   implementation matter.\n"
- title: 9.2.2.  Route Resolution
  contents:
  - "9.2.2.  Route Resolution\n   If the Ethernet Segment Identifier field in a received\
    \ MAC/IP\n   Advertisement route is set to the reserved ESI value of 0 or MAX-ESI,\n\
    \   then if the receiving PE decides to install forwarding state for the\n   associated\
    \ MAC address, it MUST be based on the MAC/IP Advertisement\n   route alone.\n\
    \   If the Ethernet Segment Identifier field in a received MAC/IP\n   Advertisement\
    \ route is set to a non-reserved ESI, and the receiving\n   PE is locally attached\
    \ to the same ESI, then the PE does not alter\n   its forwarding state based on\
    \ the received route.  This ensures that\n   local routes are preferred to remote\
    \ routes.\n   If the Ethernet Segment Identifier field in a received MAC/IP\n\
    \   Advertisement route is set to a non-reserved ESI, then if the\n   receiving\
    \ PE decides to install forwarding state for the associated\n   MAC address, it\
    \ MUST be when both the MAC/IP Advertisement route AND\n   the associated set\
    \ of Ethernet A-D per ES routes have been received.\n   The dependency of MAC\
    \ route installation on Ethernet A-D per ES\n   routes is to ensure that MAC routes\
    \ don't get accidentally installed\n   during a mass withdraw period.\n   To illustrate\
    \ this with an example, consider two PEs (PE1 and PE2)\n   connected to a multihomed\
    \ Ethernet segment ES1.  All-Active\n   redundancy mode is assumed.  A given MAC\
    \ address M1 is learned by PE1\n   but not PE2.  On PE3, the following states\
    \ may arise:\n   T1    When the MAC/IP Advertisement route from PE1 and the set\
    \ of\n         Ethernet A-D per ES routes and Ethernet A-D per EVI routes from\n\
    \         PE1 and PE2 are received, PE3 can forward traffic destined to\n    \
    \     M1 to both PE1 and PE2.\n   T2    If after T1 PE1 withdraws its set of Ethernet\
    \ A-D per ES\n         routes, then PE3 forwards traffic destined to M1 to PE2\
    \ only.\n   T2'   If after T1 PE2 withdraws its set of Ethernet A-D per ES\n \
    \        routes, then PE3 forwards traffic destined to M1 to PE1 only.\n   T2''\
    \  If after T1 PE1 withdraws its MAC/IP Advertisement route, then\n         PE3\
    \ treats traffic to M1 as unknown unicast.\n   T3    PE2 also advertises a MAC\
    \ route for M1, and then PE1 withdraws\n         its MAC route for M1.  PE3 continues\
    \ forwarding traffic\n         destined to M1 to both PE1 and PE2.  In other words,\
    \ despite M1\n         withdrawal by PE1, PE3 forwards the traffic destined to\
    \ M1 to\n         both PE1 and PE2.  This is because a flow from the CE,\n   \
    \      resulting in M1 traffic getting hashed to PE1, can get\n         terminated,\
    \ resulting in M1 being aged out in PE1; however, M1\n         can be reachable\
    \ by both PE1 and PE2.\n"
- title: 10.  ARP and ND
  contents:
  - "10.  ARP and ND\n   The IP Address field in the MAC/IP Advertisement route may\
    \ optionally\n   carry one of the IP addresses associated with the MAC address.\
    \  This\n   provides an option that can be used to minimize the flooding of ARP\n\
    \   or Neighbor Discovery (ND) messages over the MPLS network and to\n   remote\
    \ CEs.  This option also minimizes ARP (or ND) message\n   processing on end-stations/hosts\
    \ connected to the EVPN network.  A PE\n   may learn the IP address associated\
    \ with a MAC address in the control\n   or management plane between the CE and\
    \ the PE.  Or, it may learn this\n   binding by snooping certain messages to or\
    \ from a CE.  When a PE\n   learns the IP address associated with a MAC address\
    \ of a locally\n   connected CE, it may advertise this address to other PEs by\
    \ including\n   it in the MAC/IP Advertisement route.  The IP address may be an\
    \ IPv4\n   address encoded using 4 octets or an IPv6 address encoded using\n \
    \  16 octets.  For ARP and ND purposes, the IP Address Length field MUST\n   be\
    \ set to 32 for an IPv4 address or 128 for an IPv6 address.\n   If there are multiple\
    \ IP addresses associated with a MAC address,\n   then multiple MAC/IP Advertisement\
    \ routes MUST be generated, one for\n   each IP address.  For instance, this may\
    \ be the case when there are\n   both an IPv4 and an IPv6 address associated with\
    \ the same MAC address\n   for dual-IP-stack scenarios.  When the IP address is\
    \ dissociated with\n   the MAC address, then the MAC/IP Advertisement route with\
    \ that\n   particular IP address MUST be withdrawn.\n   Note that a MAC-only route\
    \ can be advertised along with, but\n   independent from, a MAC/IP route for scenarios\
    \ where the MAC learning\n   over an access network/node is done in the data plane\
    \ and independent\n   from ARP snooping that generates a MAC/IP route.  In such\
    \ scenarios,\n   when the ARP entry times out and causes the MAC/IP to be withdrawn,\n\
    \   then the MAC information will not be lost.  In scenarios where the\n   host\
    \ MAC/IP is learned via the management or control plane, then the\n   sender PE\
    \ may only generate and advertise the MAC/IP route.  If the\n   receiving PE receives\
    \ both the MAC-only route and the MAC/IP route,\n   then when it receives a withdraw\
    \ message for the MAC/IP route, it\n   MUST delete the corresponding entry from\
    \ the ARP table but not the\n   MAC entry from the MAC-VRF table, unless it receives\
    \ a withdraw\n   message for the MAC-only route.\n   When a PE receives an ARP\
    \ Request for an IP address from a CE, and if\n   the PE has the MAC address binding\
    \ for that IP address, the PE SHOULD\n   perform ARP proxy by responding to the\
    \ ARP Request.\n"
- title: 10.1.  Default Gateway
  contents:
  - "10.1.  Default Gateway\n   When a PE needs to perform inter-subnet forwarding\
    \ where each subnet\n   is represented by a different broadcast domain (e.g.,\
    \ a different\n   VLAN), the inter-subnet forwarding is performed at Layer 3,\
    \ and the\n   PE that performs such a function is called the default gateway for\n\
    \   the EVPN instance.  In this case, when the PE receives an ARP Request\n  \
    \ for the IP address configured as the default gateway address, the PE\n   originates\
    \ an ARP Reply.\n   Each PE that acts as a default gateway for a given EVPN instance\
    \ MAY\n   advertise in the EVPN control plane its default gateway MAC address\n\
    \   using the MAC/IP Advertisement route, and each such PE indicates that\n  \
    \ such a route is associated with the default gateway.  This is\n   accomplished\
    \ by requiring the route to carry the Default Gateway\n   extended community defined\
    \ in Section 7.8 (\"Default Gateway Extended\n   Community\").  The ESI field\
    \ is set to zero when advertising the MAC\n   route with the Default Gateway extended\
    \ community.\n   The IP Address field of the MAC/IP Advertisement route is set\
    \ to the\n   default gateway IP address for that subnet (e.g., an EVPN instance).\n\
    \   For a given subnet (e.g., a VLAN or EVPN instance), the default\n   gateway\
    \ IP address is the same across all the participant PEs.  The\n   inclusion of\
    \ this IP address enables the receiving PE to check its\n   configured default\
    \ gateway IP address against the one received in the\n   MAC/IP Advertisement\
    \ route for that subnet (or EVPN instance), and if\n   there is a discrepancy,\
    \ then the PE SHOULD notify the operator and\n   log an error message.\n   Unless\
    \ it is known a priori (by means outside of this document) that\n   all PEs of\
    \ a given EVPN instance act as a default gateway for that\n   EVPN instance, the\
    \ MPLS label MUST be set to a valid downstream\n   assigned label.\n   Furthermore,\
    \ even if all PEs of a given EVPN instance do act as a\n   default gateway for\
    \ that EVPN instance, but only some, but not all,\n   of these PEs have sufficient\
    \ (routing) information to provide\n   inter-subnet routing for all the inter-subnet\
    \ traffic originated\n   within the subnet associated with the EVPN instance,\
    \ then when such a\n   PE advertises in the EVPN control plane its default gateway\
    \ MAC\n   address using the MAC/IP Advertisement route and indicates that such\n\
    \   a route is associated with the default gateway, the route MUST carry\n   a\
    \ valid downstream assigned label.\n   If all PEs of a given EVPN instance act\
    \ as a default gateway for that\n   EVPN instance, and the same default gateway\
    \ MAC address is used\n   across all gateway devices, then no such advertisement\
    \ is needed.\n   However, if each default gateway uses a different MAC address,\
    \ then\n   each default gateway needs to be aware of other gateways' MAC\n   addresses\
    \ and thus the need for such an advertisement.  This is\n   called MAC address\
    \ aliasing, since a single default gateway can be\n   represented by multiple\
    \ MAC addresses.\n   Each PE that receives this route and imports it as per procedures\n\
    \   specified in this document follows the procedures in this section\n   when\
    \ replying to ARP Requests that it receives.\n   Each PE that acts as a default\
    \ gateway for a given EVPN instance that\n   receives this route and imports it\
    \ as per procedures specified in\n   this document MUST create MAC forwarding\
    \ state that enables it to\n   apply IP forwarding to the packets destined to\
    \ the MAC address\n   carried in the route.\n"
- title: 11.  Handling of Multi-destination Traffic
  contents:
  - "11.  Handling of Multi-destination Traffic\n   Procedures are required for a\
    \ given PE to send broadcast or multicast\n   traffic received from a CE encapsulated\
    \ in a given Ethernet tag\n   (VLAN) in an EVPN instance to all the other PEs\
    \ that span that\n   Ethernet tag (VLAN) in that EVPN instance.  In certain scenarios,\
    \ as\n   described in Section 12 (\"Processing of Unknown Unicast Packets\"),\
    \ a\n   given PE may also need to flood unknown unicast traffic to other PEs.\n\
    \   The PEs in a particular EVPN instance may use ingress replication,\n   P2MP\
    \ LSPs, or MP2MP LSPs to send unknown unicast, broadcast, or\n   multicast traffic\
    \ to other PEs.\n   Each PE MUST advertise an \"Inclusive Multicast Ethernet Tag\
    \ route\" to\n   enable the above.  The following subsection provides the procedures\n\
    \   to construct the Inclusive Multicast Ethernet Tag route.  Subsequent\n   subsections\
    \ describe its usage in further detail.\n"
- title: 11.1.  Constructing Inclusive Multicast Ethernet Tag Route
  contents:
  - "11.1.  Constructing Inclusive Multicast Ethernet Tag Route\n   The RD MUST be\
    \ set per Section 7.9.\n   The Ethernet Tag ID is the identifier of the Ethernet\
    \ tag.  It may be\n   set to 0 or to a valid Ethernet tag value.\n   The Originating\
    \ Router's IP Address field value MUST be set to an IP\n   address of the PE that\
    \ should be common for all the EVIs on the PE\n   (e.g., this address may be the\
    \ PE's loopback address).  The IP\n   Address Length field is in bits.\n   The\
    \ Next Hop field of the MP_REACH_NLRI attribute of the route MUST\n   be set to\
    \ the IPv4 or IPv6 address of the advertising PE.\n   The BGP advertisement for\
    \ the Inclusive Multicast Ethernet Tag route\n   MUST also carry one or more Route\
    \ Target (RT) attributes.  The\n   assignment of RTs as described in Section 7.10\
    \ MUST be followed.\n"
- title: 11.2.  P-Tunnel Identification
  contents:
  - "11.2.  P-Tunnel Identification\n   In order to identify the P-tunnel used for\
    \ sending broadcast, unknown\n   unicast, or multicast traffic, the Inclusive\
    \ Multicast Ethernet Tag\n   route MUST carry a Provider Multicast Service Interface\
    \ (PMSI) Tunnel\n   attribute as specified in [RFC6514].\n   Depending on the\
    \ technology used for the P-tunnel for the EVPN\n   instance on the PE, the PMSI\
    \ Tunnel attribute of the Inclusive\n   Multicast Ethernet Tag route is constructed\
    \ as follows.\n   + If the PE that originates the advertisement uses a P-multicast\
    \ tree\n     for the P-tunnel for EVPN, the PMSI Tunnel attribute MUST contain\n\
    \     the identity of the tree (note that the PE could create the\n     identity\
    \ of the tree prior to the actual instantiation of the\n     tree).\n   + A PE\
    \ that uses a P-multicast tree for the P-tunnel MAY aggregate\n     two or more\
    \ EVPN instances (EVIs) present on the PE onto the same\n     tree.  In this case,\
    \ in addition to carrying the identity of the\n     tree, the PMSI Tunnel attribute\
    \ MUST carry an MPLS upstream\n     assigned label, which the PE has bound uniquely\
    \ to the EVI\n     associated with this update (as determined by its RTs).\n \
    \    If the PE has already advertised Inclusive Multicast Ethernet Tag\n     routes\
    \ for two or more EVIs that it now desires to aggregate, then\n     the PE MUST\
    \ re-advertise those routes.  The re-advertised routes\n     MUST be the same\
    \ as the original ones, except for the PMSI Tunnel\n     attribute and the label\
    \ carried in that attribute.\n   + If the PE that originates the advertisement\
    \ uses ingress\n     replication for the P-tunnel for EVPN, the route MUST include\
    \ the\n     PMSI Tunnel attribute with the Tunnel Type set to Ingress\n     Replication\
    \ and the Tunnel Identifier set to a routable address of\n     the PE.  The PMSI\
    \ Tunnel attribute MUST carry a downstream assigned\n     MPLS label.  This label\
    \ is used to demultiplex the broadcast,\n     multicast, or unknown unicast EVPN\
    \ traffic received over an MP2P\n     tunnel by the PE.\n   + The Leaf Information\
    \ Required flag of the PMSI Tunnel attribute\n     MUST be set to zero and MUST\
    \ be ignored on receipt.\n"
- title: 12.  Processing of Unknown Unicast Packets
  contents:
  - "12.  Processing of Unknown Unicast Packets\n   The procedures in this document\
    \ do not require the PEs to flood\n   unknown unicast traffic to other PEs.  If\
    \ PEs learn CE MAC addresses\n   via a control-plane protocol, the PEs can then\
    \ distribute MAC\n   addresses via BGP, and all unicast MAC addresses will be\
    \ learned\n   prior to traffic to those destinations.\n   However, if a destination\
    \ MAC address of a received packet is not\n   known by the PE, the PE may have\
    \ to flood the packet.  When flooding,\n   one must take into account \"split-horizon\
    \ forwarding\" as follows: The\n   principles behind the following procedures\
    \ are borrowed from the\n   split-horizon forwarding rules in VPLS solutions [RFC4761]\
    \ [RFC4762].\n   When a PE capable of flooding (say PEx) receives an unknown\n\
    \   destination MAC address, it floods the frame.  If the frame arrived\n   from\
    \ an attached CE, PEx must send a copy of that frame on every\n   Ethernet segment\
    \ (belonging to that EVI) for which it is the DF,\n   other than the Ethernet\
    \ segment on which it received the frame.  In\n   addition, the PE must flood\
    \ the frame to all other PEs participating\n   in that EVPN instance.  If, on\
    \ the other hand, the frame arrived from\n   another PE (say PEy), PEx must send\
    \ a copy of the packet on each\n   Ethernet segment (belonging to that EVI) for\
    \ which it is the DF.  PEx\n   MUST NOT send the frame to other PEs, since PEy\
    \ would have already\n   done so.  Split-horizon forwarding rules apply to unknown\
    \ MAC\n   addresses.\n   Whether or not to flood packets to unknown destination\
    \ MAC addresses\n   should be an administrative choice, depending on how learning\
    \ happens\n   between CEs and PEs.\n   The PEs in a particular EVPN instance may\
    \ use ingress replication\n   using RSVP-TE P2P LSPs or LDP MP2P LSPs for sending\
    \ unknown unicast\n   traffic to other PEs.  Or, they may use RSVP-TE P2MP or\
    \ LDP P2MP for\n   sending such traffic to other PEs.\n"
- title: 12.1.  Ingress Replication
  contents:
  - "12.1.  Ingress Replication\n   If ingress replication is in use, the P-tunnel\
    \ attribute, carried in\n   the Inclusive Multicast Ethernet Tag routes for the\
    \ EVPN instance,\n   specifies the downstream label that the other PEs can use\
    \ to send\n   unknown unicast, multicast, or broadcast traffic for that EVPN\n\
    \   instance to this particular PE.\n   The PE that receives a packet with this\
    \ particular MPLS label MUST\n   treat the packet as a broadcast, multicast, or\
    \ unknown unicast\n   packet.  Further, if the MAC address is a unicast MAC address,\
    \ the PE\n   MUST treat the packet as an unknown unicast packet.\n"
- title: 12.2.  P2MP MPLS LSPs
  contents:
  - "12.2.  P2MP MPLS LSPs\n   The procedures for using P2MP LSPs are very similar\
    \ to the VPLS\n   procedures described in [RFC7117].  The P-tunnel attribute used\
    \ by a\n   PE for sending unknown unicast, broadcast, or multicast traffic for\
    \ a\n   particular EVPN instance is advertised in the Inclusive Multicast\n  \
    \ Ethernet Tag route as described in Section 11 (\"Handling of\n   Multi-destination\
    \ Traffic\").\n   The P-tunnel attribute specifies the P2MP LSP identifier.  This\
    \ is\n   the equivalent of an Inclusive tree as described in [RFC7117].  Note\n\
    \   that multiple Ethernet tags, which may be in different EVPN\n   instances,\
    \ may use the same P2MP LSP, using upstream labels\n   [RFC7117].  This is the\
    \ equivalent of an Aggregate Inclusive tree\n   [RFC7117].  When P2MP LSPs are\
    \ used for flooding unknown unicast\n   traffic, packet reordering is possible.\n\
    \   The PE that receives a packet on the P2MP LSP specified in the PMSI\n   Tunnel\
    \ attribute MUST treat the packet as a broadcast, multicast, or\n   unknown unicast\
    \ packet.  Further, if the MAC address is a unicast MAC\n   address, the PE MUST\
    \ treat the packet as an unknown unicast packet.\n"
- title: 13.  Forwarding Unicast Packets
  contents:
  - "13.  Forwarding Unicast Packets\n   This section describes procedures for forwarding\
    \ unicast packets by\n   PEs, where such packets are received from either directly\
    \ connected\n   CEs or some other PEs.\n"
- title: 13.1.  Forwarding Packets Received from a CE
  contents:
  - "13.1.  Forwarding Packets Received from a CE\n   When a PE receives a packet\
    \ from a CE, on a given Ethernet Tag ID, it\n   must first look up the source\
    \ MAC address of the packet.  In certain\n   environments that enable MAC security,\
    \ the source MAC address MAY be\n   used to validate the host identity and determine\
    \ that traffic from\n   the host can be allowed into the network.  Source MAC\
    \ lookup MAY also\n   be used for local MAC address learning.\n   If the PE decides\
    \ to forward the packet, the destination MAC address\n   of the packet must be\
    \ looked up.  If the PE has received MAC address\n   advertisements for this destination\
    \ MAC address from one or more\n   other PEs or has learned it from locally connected\
    \ CEs, the MAC\n   address is considered a known MAC address.  Otherwise, it is\n\
    \   considered an unknown MAC address.\n   For known MAC addresses, the PE forwards\
    \ this packet to one of the\n   remote PEs or to a locally attached CE.  When\
    \ forwarding to a remote\n   PE, the packet is encapsulated in the EVPN MPLS label\
    \ advertised by\n   the remote PE, for that MAC address, and in the MPLS LSP label\
    \ stack\n   to reach the remote PE.\n   If the MAC address is unknown and if the\
    \ administrative policy on the\n   PE requires flooding of unknown unicast traffic,\
    \ then:\n   - The PE MUST flood the packet to other PEs.  The PE MUST first\n\
    \     encapsulate the packet in the ESI MPLS label as described in\n     Section\
    \ 8.3.  If ingress replication is used, the packet MUST be\n     replicated to\
    \ each remote PE, with the VPN label being an MPLS\n     label determined as follows:\
    \ This is the MPLS label advertised by\n     the remote PE in a PMSI Tunnel attribute\
    \ in the Inclusive Multicast\n     Ethernet Tag route for a <MAC-VRF> or <MAC-VRF,\
    \ Ethernet tag>\n     combination.\n     The Ethernet tag in the route may be\
    \ the same as the Ethernet tag\n     associated with the interface on which the\
    \ ingress PE receives the\n     packet.  If P2MP LSPs are being used, the packet\
    \ MUST be sent on\n     the P2MP LSP of which the PE is the root, for the Ethernet\
    \ tag in\n     the EVPN instance.  If the same P2MP LSP is used for all Ethernet\n\
    \     tags, then all the PEs in the EVPN instance MUST be the leaves of\n    \
    \ the P2MP LSP.  If a distinct P2MP LSP is used for a given Ethernet\n     tag\
    \ in the EVPN instance, then only the PEs in the Ethernet tag\n     MUST be the\
    \ leaves of the P2MP LSP.  The packet MUST be\n     encapsulated in the P2MP LSP\
    \ label stack.\n   If the MAC address is unknown, then, if the administrative\
    \ policy on\n   the PE does not allow flooding of unknown unicast traffic:\n \
    \  - the PE MUST drop the packet.\n"
- title: 13.2.  Forwarding Packets Received from a Remote PE
  contents:
  - "13.2.  Forwarding Packets Received from a Remote PE\n   This section describes\
    \ the procedures for forwarding known and\n   unknown unicast packets received\
    \ from a remote PE.\n"
- title: 13.2.1.  Unknown Unicast Forwarding
  contents:
  - "13.2.1.  Unknown Unicast Forwarding\n   When a PE receives an MPLS packet from\
    \ a remote PE, then, after\n   processing the MPLS label stack, if the top MPLS\
    \ label ends up being\n   a P2MP LSP label associated with an EVPN instance or\
    \ -- in the case\n   of ingress replication -- the downstream label advertised\
    \ in the\n   P-tunnel attribute, and after performing the split-horizon procedures\n\
    \   described in Section 8.3:\n   - If the PE is the designated forwarder of BUM\
    \ traffic on a\n     particular set of ESIs for the Ethernet tag, the default\
    \ behavior\n     is for the PE to flood the packet on these ESIs.  In other words,\n\
    \     the default behavior is for the PE to assume that for BUM traffic\n    \
    \ it is not required to perform a destination MAC address lookup.  As\n     an\
    \ option, the PE may perform a destination MAC lookup to flood the\n     packet\
    \ to only a subset of the CE interfaces in the Ethernet tag.\n     For instance,\
    \ the PE may decide to not flood a BUM packet on\n     certain Ethernet segments\
    \ even if it is the DF on the Ethernet\n     segment, based on administrative\
    \ policy.\n   - If the PE is not the designated forwarder on any of the ESIs for\n\
    \     the Ethernet tag, the default behavior is for it to drop the\n     packet.\n"
- title: 13.2.2.  Known Unicast Forwarding
  contents:
  - "13.2.2.  Known Unicast Forwarding\n   If the top MPLS label ends up being an\
    \ EVPN label that was advertised\n   in the unicast MAC advertisements, then the\
    \ PE either forwards the\n   packet based on CE next-hop forwarding information\
    \ associated with\n   the label or does a destination MAC address lookup to forward\
    \ the\n   packet to a CE.\n"
- title: 14.  Load Balancing of Unicast Packets
  contents:
  - "14.  Load Balancing of Unicast Packets\n   This section specifies the load-balancing\
    \ procedures for sending\n   known unicast packets to a multihomed CE.\n"
- title: 14.1.  Load Balancing of Traffic from a PE to Remote CEs
  contents:
  - "14.1.  Load Balancing of Traffic from a PE to Remote CEs\n   Whenever a remote\
    \ PE imports a MAC/IP Advertisement route for a given\n   <ESI, Ethernet tag>\
    \ in a MAC-VRF, it MUST examine all imported\n   Ethernet A-D routes for that\
    \ ESI in order to determine the load-\n   balancing characteristics of the Ethernet\
    \ segment.\n"
- title: 14.1.1.  Single-Active Redundancy Mode
  contents:
  - "14.1.1.  Single-Active Redundancy Mode\n   For a given ES, if the remote PE has\
    \ imported the set of Ethernet A-D\n   per ES routes from at least one PE, where\
    \ the \"Single-Active\" flag in\n   the ESI Label extended community is set, then\
    \ the remote PE MUST\n   deduce that the ES is operating in Single-Active redundancy\
    \ mode.  As\n   such, the MAC address will be reachable only via the PE announcing\n\
    \   the associated MAC/IP Advertisement route -- this is referred to as\n   the\
    \ primary PE.  The other PEs advertising the set of Ethernet A-D\n   per ES routes\
    \ for the same ES provide backup paths for that ES, in\n   case the primary PE\
    \ encounters a failure, and are referred to as\n   backup PEs.  It should be noted\
    \ that the primary PE for a given <ES,\n   VLAN> (or <ES, VLAN bundle>) is the\
    \ DF for that <ES, VLAN> (or <ES,\n   VLAN bundle>).\n   If the primary PE encounters\
    \ a failure, it MAY withdraw its set of\n   Ethernet A-D per ES routes for the\
    \ affected ES prior to withdrawing\n   its set of MAC/IP Advertisement routes.\n\
    \   If there is only one backup PE for a given ES, the remote PE MAY use\n   the\
    \ primary PE's withdrawal of its set of Ethernet A-D per ES routes\n   as a trigger\
    \ to update its forwarding entries, for the associated MAC\n   addresses, to point\
    \ towards the backup PE.  As the backup PE starts\n   learning the MAC addresses\
    \ over its attached ES, it will start\n   sending MAC/IP Advertisement routes\
    \ while the failed PE withdraws its\n   routes.  This mechanism minimizes the\
    \ flooding of traffic during\n   fail-over events.\n   If there is more than one\
    \ backup PE for a given ES, the remote PE\n   MUST use the primary PE's withdrawal\
    \ of its set of Ethernet A-D per\n   ES routes as a trigger to start flooding\
    \ traffic for the associated\n   MAC addresses (as long as flooding of unknown\
    \ unicast packets is\n   administratively allowed), as it is not possible to select\
    \ a single\n   backup PE.\n"
- title: 14.1.2.  All-Active Redundancy Mode
  contents:
  - "14.1.2.  All-Active Redundancy Mode\n   For a given ES, if the remote PE has\
    \ imported the set of Ethernet A-D\n   per ES routes from one or more PEs and\
    \ none of them have the\n   \"Single-Active\" flag in the ESI Label extended community\
    \ set, then\n   the remote PE MUST deduce that the ES is operating in All-Active\n\
    \   redundancy mode.  A remote PE that receives a MAC/IP Advertisement\n   route\
    \ with a non-reserved ESI SHOULD consider the advertised MAC\n   address to be\
    \ reachable via all PEs that have advertised reachability\n   to that MAC address's\
    \ EVI/ES via the combination of an Ethernet A-D\n   per EVI route for that EVI/ES\
    \ (and Ethernet tag, if applicable) AND\n   an Ethernet A-D per ES route for that\
    \ ES.  The remote PE MUST use\n   received MAC/IP Advertisement routes and Ethernet\
    \ A-D per EVI/per ES\n   routes to construct the set of next hops for the advertised\
    \ MAC\n   address.\n   Each next hop comprises an MPLS label stack that is to\
    \ be used by the\n   egress PE to forward the packet.  This label stack is determined\
    \ as\n   follows:\n   - If the next hop is constructed as a result of a MAC route,\
    \ then\n     this label stack MUST be used.  However, if the MAC route doesn't\n\
    \     exist for that PE, then the next hop and the MPLS label stack are\n    \
    \ constructed as a result of the Ethernet A-D routes.  Note that the\n     following\
    \ description applies to determining the label stack for a\n     particular next\
    \ hop to reach a given PE, from which the remote PE\n     has received and imported\
    \ Ethernet A-D routes that have the same\n     ESI and Ethernet tag as the ones\
    \ present in the MAC advertisement.\n     The Ethernet A-D routes mentioned in\
    \ the following description\n     refer to the ones imported from this given PE.\n\
    \   - If a set of Ethernet A-D per ES routes for that ES AND an Ethernet\n   \
    \  A-D route per EVI exist, only then must the label from that latter\n     route\
    \ be used.\n   The following example explains the above.\n   Consider a CE (CE1)\
    \ that is dual-homed to two PEs (PE1 and PE2) on a\n   LAG interface (ES1), and\
    \ is sending packets with source MAC address\n   MAC1 on VLAN1 (mapped to EVI1).\
    \  A remote PE, say PE3, is able to\n   learn that MAC1 is reachable via PE1 and\
    \ PE2.  Both PE1 and PE2 may\n   advertise MAC1 in BGP if they receive packets\
    \ with MAC1 from CE1.  If\n   this is not the case, and if MAC1 is advertised\
    \ only by PE1, PE3\n   still considers MAC1 as reachable via both PE1 and PE2,\
    \ as both PE1\n   and PE2 advertise a set of Ethernet A-D per ES routes for ES1\
    \ as well\n   as an Ethernet A-D per EVI route for <EVI1, ES1>.\n   The MPLS label\
    \ stack to send the packets to PE1 is the MPLS LSP stack\n   to get to PE1 (at\
    \ the top of the stack) followed by the EVPN label\n   advertised by PE1 for CE1's\
    \ MAC.\n   The MPLS label stack to send packets to PE2 is the MPLS LSP stack to\n\
    \   get to PE2 (at the top of the stack) followed by the MPLS label in\n   the\
    \ Ethernet A-D route advertised by PE2 for <ES1, VLAN1>, if PE2 has\n   not advertised\
    \ MAC1 in BGP.\n   We will refer to these label stacks as MPLS next hops.\n  \
    \ The remote PE (PE3) can now load balance the traffic it receives from\n   its\
    \ CEs, destined for CE1, between PE1 and PE2.  PE3 may use N-tuple\n   flow information\
    \ to hash traffic into one of the MPLS next hops for\n   load balancing of IP\
    \ traffic.  Alternatively, PE3 may rely on the\n   source MAC addresses for load\
    \ balancing.\n   Note that once PE3 decides to send a particular packet to PE1\
    \ or PE2,\n   it can pick one out of multiple possible paths to reach the\n  \
    \ particular remote PE using regular MPLS procedures.  For instance, if\n   the\
    \ tunneling technology is based on RSVP-TE LSPs and PE3 decides to\n   send a\
    \ particular packet to PE1, then PE3 can choose from multiple\n   RSVP-TE LSPs\
    \ that have PE1 as their destination.\n   When PE1 or PE2 receives the packet\
    \ destined for CE1 from PE3, if the\n   packet is a known unicast, it is forwarded\
    \ to CE1.  If it is a BUM\n   packet, then only one of PE1 or PE2 must forward\
    \ the packet to the\n   CE.  Whether PE1 or PE2 forwards this packet to the CE\
    \ is determined\n   based on which of the two is the DF.\n"
- title: 14.2.  Load Balancing of Traffic between a PE and a Local CE
  contents:
  - "14.2.  Load Balancing of Traffic between a PE and a Local CE\n   A CE may be\
    \ configured with more than one interface connected to\n   different PEs or the\
    \ same PE for load balancing, using a technology\n   such as a LAG.  The PE(s)\
    \ and the CE can load balance traffic onto\n   these interfaces using one of the\
    \ following mechanisms.\n"
- title: 14.2.1.  Data-Plane Learning
  contents:
  - "14.2.1.  Data-Plane Learning\n   Consider that the PEs perform data-plane learning\
    \ for local MAC\n   addresses learned from local CEs.  This enables the PE(s)\
    \ to learn a\n   particular MAC address and associate it with one or more interfaces,\n\
    \   if the technology between the PE and the CE supports multipathing.\n   The\
    \ PEs can now load balance traffic destined to that MAC address on\n   the multiple\
    \ interfaces.\n   Whether the CE can load balance traffic that it generates on\
    \ the\n   multiple interfaces is dependent on the CE implementation.\n"
- title: 14.2.2.  Control-Plane Learning
  contents:
  - "14.2.2.  Control-Plane Learning\n   The CE can be a host that advertises the\
    \ same MAC address using a\n   control protocol on all interfaces.  This enables\
    \ the PE(s) to learn\n   the host's MAC address and associate it with all interfaces.\
    \  The PEs\n   can now load balance traffic destined to the host on all these\n\
    \   interfaces.  The host can also load balance the traffic it generates\n   onto\
    \ these interfaces, and the PE that receives the traffic employs\n   EVPN forwarding\
    \ procedures to forward the traffic.\n"
- title: 15.  MAC Mobility
  contents:
  - "15.  MAC Mobility\n   It is possible for a given host or end-station (as defined\
    \ by its MAC\n   address) to move from one Ethernet segment to another; this is\n\
    \   referred to as 'MAC Mobility' or 'MAC move', and it is different from\n  \
    \ the multihoming situation in which a given MAC address is reachable\n   via\
    \ multiple PEs for the same Ethernet segment.  In a MAC move, there\n   would\
    \ be two sets of MAC/IP Advertisement routes -- one set with the\n   new Ethernet\
    \ segment and one set with the previous Ethernet segment\n   -- and the MAC address\
    \ would appear to be reachable via each of these\n   segments.\n   In order to\
    \ allow all of the PEs in the EVPN instance to correctly\n   determine the current\
    \ location of the MAC address, all advertisements\n   of it being reachable via\
    \ the previous Ethernet segment MUST be\n   withdrawn by the PEs, for the previous\
    \ Ethernet segment, that had\n   advertised it.\n   If local learning is performed\
    \ using the data plane, these PEs will\n   not be able to detect that the MAC\
    \ address has moved to another\n   Ethernet segment, and the receipt of MAC/IP\
    \ Advertisement routes,\n   with the MAC Mobility extended community attribute,\
    \ from other PEs\n   serves as the trigger for these PEs to withdraw their advertisements.\n\
    \   If local learning is performed using the control or management\n   planes,\
    \ these interactions serve as the trigger for these PEs to\n   withdraw their\
    \ advertisements.\n   In a situation where there are multiple moves of a given\
    \ MAC,\n   possibly between the same two Ethernet segments, there may be\n   multiple\
    \ withdrawals and re-advertisements.  In order to ensure that\n   all PEs in the\
    \ EVPN instance receive all of these correctly through\n   the intervening BGP\
    \ infrastructure, introducing a sequence number\n   into the MAC Mobility extended\
    \ community attribute is necessary.\n   In order to process mobility events correctly,\
    \ an implementation MUST\n   handle scenarios in which sequence number wraparound\
    \ occurs.\n   Every MAC mobility event for a given MAC address will contain a\n\
    \   sequence number that is set using the following rules:\n   - A PE advertising\
    \ a MAC address for the first time advertises it\n     with no MAC Mobility extended\
    \ community attribute.\n   - A PE detecting a locally attached MAC address for\
    \ which it had\n     previously received a MAC/IP Advertisement route with a different\n\
    \     Ethernet segment identifier advertises the MAC address in a MAC/IP\n   \
    \  Advertisement route tagged with a MAC Mobility extended community\n     attribute\
    \ with a sequence number one greater than the sequence\n     number in the MAC\
    \ Mobility extended community attribute of the\n     received MAC/IP Advertisement\
    \ route.  In the case of the first\n     mobility event for a given MAC address,\
    \ where the received MAC/IP\n     Advertisement route does not carry a MAC Mobility\
    \ extended\n     community attribute, the value of the sequence number in the\n\
    \     received route is assumed to be 0 for the purpose of this\n     processing.\n\
    \   - A PE detecting a locally attached MAC address for which it had\n     previously\
    \ received a MAC/IP Advertisement route with the same\n     non-zero Ethernet\
    \ segment identifier advertises it with:\n     1. no MAC Mobility extended community\
    \ attribute, if the received\n        route did not carry said attribute.\n  \
    \   2. a MAC Mobility extended community attribute with the sequence\n       \
    \ number equal to the highest of the sequence number(s) in the\n        received\
    \ MAC/IP Advertisement route(s), if the received route(s)\n        is (are) tagged\
    \ with a MAC Mobility extended community\n        attribute.\n   - A PE detecting\
    \ a locally attached MAC address for which it had\n     previously received a\
    \ MAC/IP Advertisement route with the same zero\n     Ethernet segment identifier\
    \ (single-homed scenarios) advertises it\n     with a MAC Mobility extended community\
    \ attribute with the sequence\n     number set properly.  In the case of single-homed\
    \ scenarios, there\n     is no need for ESI comparison.  ESI comparison is done\
    \ for\n     multihoming in order to prevent false detection of MAC moves among\n\
    \     the PEs attached to the same multihomed site.\n   A PE receiving a MAC/IP\
    \ Advertisement route for a MAC address with a\n   different Ethernet segment\
    \ identifier and a higher sequence number\n   than that which it had previously\
    \ advertised withdraws its MAC/IP\n   Advertisement route.  If two (or more) PEs\
    \ advertise the same MAC\n   address with the same sequence number but different\
    \ Ethernet segment\n   identifiers, a PE that receives these routes selects the\
    \ route\n   advertised by the PE with the lowest IP address as the best route.\n\
    \   If the PE is the originator of the MAC route and it receives the same\n  \
    \ MAC address with the same sequence number that it generated, it will\n   compare\
    \ its own IP address with the IP address of the remote PE and\n   will select\
    \ the lowest IP.  If its own route is not the best one, it\n   will withdraw the\
    \ route.\n"
- title: 15.1.  MAC Duplication Issue
  contents:
  - "15.1.  MAC Duplication Issue\n   A situation may arise where the same MAC address\
    \ is learned by\n   different PEs in the same VLAN because of two (or more) hosts\
    \ being\n   misconfigured with the same (duplicate) MAC address.  In such a\n\
    \   situation, the traffic originating from these hosts would trigger\n   continuous\
    \ MAC moves among the PEs attached to these hosts.  It is\n   important to recognize\
    \ such a situation and avoid incrementing the\n   sequence number (in the MAC\
    \ Mobility extended community attribute) to\n   infinity.  In order to remedy\
    \ such a situation, a PE that detects a\n   MAC mobility event via local learning\
    \ starts an M-second timer (with\n   a default value of M = 180), and if it detects\
    \ N MAC moves before the\n   timer expires (with a default value of N = 5), it\
    \ concludes that a\n   duplicate-MAC situation has occurred.  The PE MUST alert\
    \ the operator\n   and stop sending and processing any BGP MAC/IP Advertisement\
    \ routes\n   for that MAC address until a corrective action is taken by the\n\
    \   operator.  The values of M and N MUST be configurable to allow for\n   flexibility\
    \ in operator control.  Note that the other PEs in the EVPN\n   instance will\
    \ forward the traffic for the duplicate MAC address to\n   one of the PEs advertising\
    \ the duplicate MAC address.\n"
- title: 15.2.  Sticky MAC Addresses
  contents:
  - "15.2.  Sticky MAC Addresses\n   There are scenarios in which it is desired to\
    \ configure some MAC\n   addresses as static so that they are not subjected to\
    \ MAC moves.  In\n   such scenarios, these MAC addresses are advertised with a\
    \ MAC\n   Mobility extended community where the static flag is set to 1 and the\n\
    \   sequence number is set to zero.  If a PE receives such advertisements\n  \
    \ and later learns the same MAC address(es) via local learning, then\n   the PE\
    \ MUST alert the operator.\n"
- title: 16.  Multicast and Broadcast
  contents:
  - "16.  Multicast and Broadcast\n   The PEs in a particular EVPN instance may use\
    \ ingress replication or\n   P2MP LSPs to send multicast traffic to other PEs.\n"
- title: 16.1.  Ingress Replication
  contents:
  - "16.1.  Ingress Replication\n   The PEs may use ingress replication for flooding\
    \ BUM traffic as\n   described in Section 11 (\"Handling of Multi-destination\
    \ Traffic\").  A\n   given broadcast packet must be sent to all the remote PEs.\
    \  However,\n   a given multicast packet for a multicast flow may be sent to only\
    \ a\n   subset of the PEs.  Specifically, a given multicast flow may be sent\n\
    \   to only those PEs that have receivers that are interested in the\n   multicast\
    \ flow.  Determining which of the PEs have receivers for a\n   given multicast\
    \ flow is done using explicit tracking per [RFC7117].\n"
- title: 16.2.  P2MP LSPs
  contents:
  - "16.2.  P2MP LSPs\n   A PE may use an \"Inclusive\" tree for sending a BUM packet.\
    \  This\n   terminology is borrowed from [RFC7117].\n   A variety of transport\
    \ technologies may be used in the service\n   provider (SP) network.  For Inclusive\
    \ P-multicast trees, these\n   transport technologies include point-to-multipoint\
    \ LSPs created by\n   RSVP-TE or Multipoint LDP (mLDP).\n"
- title: 16.2.1.  Inclusive Trees
  contents:
  - "16.2.1.  Inclusive Trees\n   An Inclusive tree allows the use of a single multicast\
    \ distribution\n   tree, referred to as an Inclusive P-multicast tree, in the\
    \ SP network\n   to carry all the multicast traffic from a specified set of EVPN\n\
    \   instances on a given PE.  A particular P-multicast tree can be set up\n  \
    \ to carry the traffic originated by sites belonging to a single EVPN\n   instance,\
    \ or to carry the traffic originated by sites belonging to\n   several EVPN instances.\
    \  The ability to carry the traffic of more\n   than one EVPN instance on the\
    \ same tree is termed 'Aggregation', and\n   the tree is called an Aggregate Inclusive\
    \ P-multicast tree or\n   Aggregate Inclusive tree for short.  The Aggregate Inclusive\
    \ tree\n   needs to include every PE that is a member of any of the EVPN\n   instances\
    \ that are using the tree.  This implies that a PE may\n   receive BUM traffic\
    \ even if it doesn't have any receivers that are\n   interested in receiving that\
    \ traffic.\n   An Inclusive or Aggregate Inclusive tree as defined in this document\n\
    \   is a P2MP tree.  A P2MP tree is used to carry traffic only for EVPN\n   CEs\
    \ that are connected to the PE that is the root of the tree.\n   The procedures\
    \ for signaling an Inclusive tree are the same as those\n   in [RFC7117], with\
    \ the VPLS A-D route replaced with the Inclusive\n   Multicast Ethernet Tag route.\
    \  The P-tunnel attribute [RFC7117] for\n   an Inclusive tree is advertised with\
    \ the Inclusive Multicast Ethernet\n   Tag route as described in Section 11 (\"\
    Handling of Multi-destination\n   Traffic\").  Note that for an Aggregate Inclusive\
    \ tree, a PE can\n   \"aggregate\" multiple EVPN instances on the same P2MP LSP\
    \ using\n   upstream labels.  The procedures for aggregation are the same as\n\
    \   those described in [RFC7117], with VPLS A-D routes replaced by EVPN\n   Inclusive\
    \ Multicast Ethernet Tag routes.\n"
- title: 17.  Convergence
  contents:
  - "17.  Convergence\n   This section describes failure recovery from different types\
    \ of\n   network failures.\n"
- title: 17.1.  Transit Link and Node Failures between PEs
  contents:
  - "17.1.  Transit Link and Node Failures between PEs\n   The use of existing MPLS\
    \ fast-reroute mechanisms can provide failure\n   recovery on the order of 50\
    \ ms, in the event of transit link and node\n   failures in the infrastructure\
    \ that connects the PEs.\n"
- title: 17.2.  PE Failures
  contents:
  - "17.2.  PE Failures\n   Consider a host CE1 that is dual-homed to PE1 and PE2.\
    \  If PE1 fails,\n   a remote PE, PE3, can discover this based on the failure\
    \ of the BGP\n   session.  This failure detection can be in the sub-second range\
    \ if\n   Bidirectional Forwarding Detection (BFD) is used to detect BGP\n   session\
    \ failures.  PE3 can update its forwarding state to start\n   sending all traffic\
    \ for CE1 to only PE2.\n"
- title: 17.3.  PE-to-CE Network Failures
  contents:
  - "17.3.  PE-to-CE Network Failures\n   If the connectivity between the multihomed\
    \ CE and one of the PEs to\n   which it is attached fails, the PE MUST withdraw\
    \ the set of Ethernet\n   A-D per ES routes that had been previously advertised\
    \ for that ES.\n   This enables the remote PEs to remove the MPLS next hop to\
    \ this\n   particular PE from the set of MPLS next hops that can be used to\n\
    \   forward traffic to the CE.  When the MAC entry on the PE ages out,\n   the\
    \ PE MUST withdraw the MAC address from BGP.\n   When an Ethernet tag is decommissioned\
    \ on an Ethernet segment, then\n   the PE MUST withdraw the Ethernet A-D per EVI\
    \ route(s) announced for\n   the <ESI, Ethernet tags> that are impacted by the\
    \ decommissioning.\n   In addition, the PE MUST also withdraw the MAC/IP Advertisement\n\
    \   routes that are impacted by the decommissioning.\n   The Ethernet A-D per\
    \ ES routes should be used by an implementation to\n   optimize the withdrawal\
    \ of MAC/IP Advertisement routes.  When a PE\n   receives a withdrawal of a particular\
    \ Ethernet A-D route from an\n   advertising PE, it SHOULD consider all the MAC/IP\
    \ Advertisement\n   routes that are learned from the same ESI as in the Ethernet\
    \ A-D\n   route from the advertising PE as having been withdrawn.  This\n   optimizes\
    \ the network convergence times in the event of PE-to-CE\n   failures.\n"
- title: 18.  Frame Ordering
  contents:
  - "18.  Frame Ordering\n   In a MAC address, if the value of the first nibble (bits\
    \ 8 through 5)\n   of the most significant octet of the destination MAC address\
    \ (which\n   follows the last MPLS label) happens to be 0x4 or 0x6, then the\n\
    \   Ethernet frame can be misinterpreted as an IPv4 or IPv6 packet by\n   intermediate\
    \ P nodes performing ECMP based on deep packet inspection,\n   thus resulting\
    \ in load balancing packets belonging to the same flow\n   on different ECMP paths\
    \ and subjecting those packets to different\n   delays.  Therefore, packets belonging\
    \ to the same flow can arrive at\n   the destination out of order.  This out-of-order\
    \ delivery can happen\n   during steady state in the absence of any failures,\
    \ resulting in\n   significant impact on network operations.\n   In order to avoid\
    \ any such misordering, the following rules are\n   applied:\n   - If a network\
    \ uses deep packet inspection for its ECMP, then the\n     \"Preferred PW MPLS\
    \ Control Word\" [RFC4385] SHOULD be used with the\n     value 0 (e.g., a 4-octet\
    \ field with a value of zero) when sending\n     EVPN-encapsulated packets over\
    \ an MP2P LSP.\n   - If a network uses entropy labels [RFC6790], then the control\
    \ word\n     SHOULD NOT be used when sending EVPN-encapsulated packets over an\n\
    \     MP2P LSP.\n   - When sending EVPN-encapsulated packets over a P2MP LSP or\
    \ P2P LSP,\n     then the control word SHOULD NOT be used.\n"
- title: 19.  Security Considerations
  contents:
  - "19.  Security Considerations\n   Security considerations discussed in [RFC4761]\
    \ and [RFC4762] apply to\n   this document for MAC learning in the data plane\
    \ over an Attachment\n   Circuit (AC) and for flooding of unknown unicast and\
    \ ARP messages\n   over the MPLS/IP core.  Security considerations discussed in\n\
    \   [RFC4364] apply to this document for MAC learning in the control\n   plane\
    \ over the MPLS/IP core.  This section describes additional\n   considerations.\n\
    \   As mentioned in [RFC4761], there are two aspects to achieving data\n   privacy\
    \ and protecting against denial-of-service attacks in a VPN:\n   securing the\
    \ control plane and protecting the forwarding path.\n   Compromise of the control\
    \ plane could result in a PE sending customer\n   data belonging to some EVPN\
    \ to another EVPN, or black-holing EVPN\n   customer data, or even sending it\
    \ to an eavesdropper, none of which\n   are acceptable from a data privacy point\
    \ of view.  In addition,\n   compromise of the control plane could provide opportunities\
    \ for\n   unauthorized EVPN data usage (e.g., exploiting traffic replication\n\
    \   within a multicast tree to amplify a denial-of-service attack based\n   on\
    \ sending large amounts of traffic).\n   The mechanisms in this document use BGP\
    \ for the control plane.\n   Hence, techniques such as those discussed in [RFC5925]\
    \ help\n   authenticate BGP messages, making it harder to spoof updates (which\n\
    \   can be used to divert EVPN traffic to the wrong EVPN instance) or\n   withdrawals\
    \ (denial-of-service attacks).  In the multi-AS backbone\n   options (b) and (c)\
    \ [RFC4364], this also means protecting the\n   inter-AS BGP sessions between\
    \ the Autonomous System Border Routers\n   (ASBRs), the PEs, or the Route Reflectors.\n\
    \   Further discussion of security considerations for BGP may be found in\n  \
    \ the BGP specification itself [RFC4271] and in the security analysis\n   for\
    \ BGP [RFC4272].  The original discussion of the use of the TCP MD5\n   signature\
    \ option to protect BGP sessions is found in [RFC5925], while\n   [RFC6952] includes\
    \ an analysis of BGP keying and authentication\n   issues.\n   Note that [RFC5925]\
    \ will not help in keeping MPLS labels private --\n   knowing the labels, one\
    \ can eavesdrop on EVPN traffic.  Such\n   eavesdropping additionally requires\
    \ access to the data path within an\n   SP network.  Users of VPN services are\
    \ expected to take appropriate\n   precautions (such as encryption) to protect\
    \ the data exchanged over\n   a VPN.\n   One of the requirements for protecting\
    \ the data plane is that the\n   MPLS labels be accepted only from valid interfaces.\
    \  For a PE, valid\n   interfaces comprise links from other routers in the PE's\
    \ own AS.  For\n   an ASBR, valid interfaces comprise links from other routers\
    \ in the\n   ASBR's own AS, and links from other ASBRs in ASes that have instances\n\
    \   of a given EVPN.  It is especially important in the case of multi-AS\n   EVPN\
    \ instances that one accept EVPN packets only from valid\n   interfaces.\n   It\
    \ is also important to help limit malicious traffic into a network\n   for an\
    \ impostor MAC address.  The mechanism described in Section 15.1\n   shows how\
    \ duplicate MAC addresses can be detected and continuous\n   false MAC mobility\
    \ can be prevented.  The mechanism described in\n   Section 15.2 shows how MAC\
    \ addresses can be pinned to a given\n   Ethernet segment, such that if they appear\
    \ behind any other Ethernet\n   segments, the traffic for those MAC addresses\
    \ can be prevented from\n   entering the EVPN network from the other Ethernet\
    \ segments.\n"
- title: 20.  IANA Considerations
  contents:
  - "20.  IANA Considerations\n   This document defines a new NLRI, called \"EVPN\"\
    , to be carried in BGP\n   using multiprotocol extensions.  This NLRI uses the\
    \ existing AFI of\n   25 (L2VPN).  IANA has assigned BGP EVPNs a SAFI value of\
    \ 70.\n   IANA has allocated the following EVPN Extended Community sub-types in\n\
    \   [RFC7153], and this document is the only reference for them.\n      0x00 \
    \    MAC Mobility                 [RFC7432]\n      0x01     ESI Label        \
    \            [RFC7432]\n      0x02     ES-Import Route Target       [RFC7432]\n\
    \   This document creates a registry called \"EVPN Route Types\".  New\n   registrations\
    \ will be made through the \"RFC Required\" procedure\n   defined in [RFC5226].\
    \  The registry has a maximum value of 255.\n   Initial registrations are as follows:\n\
    \      0     Reserved                           [RFC7432]\n      1     Ethernet\
    \ Auto-discovery            [RFC7432]\n      2     MAC/IP Advertisement      \
    \         [RFC7432]\n      3     Inclusive Multicast Ethernet Tag   [RFC7432]\n\
    \      4     Ethernet Segment                   [RFC7432]\n"
- title: 21.  References
  contents:
  - '21.  References

    '
- title: 21.1.  Normative References
  contents:
  - "21.1.  Normative References\n   [RFC2119]  Bradner, S., \"Key words for use in\
    \ RFCs to Indicate\n              Requirement Levels\", BCP 14, RFC 2119, March\
    \ 1997,\n              <http://www.rfc-editor.org/info/rfc2119>.\n   [RFC4271]\
    \  Rekhter, Y., Ed., Li, T., Ed., and S. Hares, Ed., \"A\n              Border\
    \ Gateway Protocol 4 (BGP-4)\", RFC 4271,\n              January 2006, <http://www.rfc-editor.org/info/rfc4271>.\n\
    \   [RFC4360]  Sangli, S., Tappan, D., and Y. Rekhter, \"BGP Extended\n      \
    \        Communities Attribute\", RFC 4360, February 2006,\n              <http://www.rfc-editor.org/info/rfc4360>.\n\
    \   [RFC4364]  Rosen, E. and Y. Rekhter, \"BGP/MPLS IP Virtual Private\n     \
    \         Networks (VPNs)\", RFC 4364, February 2006,\n              <http://www.rfc-editor.org/info/rfc4364>.\n\
    \   [RFC4760]  Bates, T., Chandra, R., Katz, D., and Y. Rekhter,\n           \
    \   \"Multiprotocol Extensions for BGP-4\", RFC 4760,\n              January 2007,\
    \ <http://www.rfc-editor.org/info/rfc4760>.\n   [RFC4761]  Kompella, K., Ed.,\
    \ and Y. Rekhter, Ed., \"Virtual Private\n              LAN Service (VPLS) Using\
    \ BGP for Auto-Discovery and\n              Signaling\", RFC 4761, January 2007,\n\
    \              <http://www.rfc-editor.org/info/rfc4761>.\n   [RFC4762]  Lasserre,\
    \ M., Ed., and V. Kompella, Ed., \"Virtual Private\n              LAN Service\
    \ (VPLS) Using Label Distribution Protocol (LDP)\n              Signaling\", RFC\
    \ 4762, January 2007,\n              <http://www.rfc-editor.org/info/rfc4762>.\n\
    \   [RFC7153]  Rosen, E. and Y. Rekhter, \"IANA Registries for BGP\n         \
    \     Extended Communities\", RFC 7153, March 2014,\n              <http://www.rfc-editor.org/info/rfc7153>.\n"
- title: 21.2.  Informative References
  contents:
  - "21.2.  Informative References\n   [802.1D-REV]\n              \"IEEE Standard\
    \ for Local and metropolitan area networks -\n              Media Access Control\
    \ (MAC) Bridges\", IEEE Std. 802.1D,\n              June 2004.\n   [802.1Q]  \
    \ \"IEEE Standard for Local and metropolitan area networks -\n              Media\
    \ Access Control (MAC) Bridges and Virtual Bridged\n              Local Area Networks\"\
    , IEEE Std 802.1Q(tm), 2014 Edition,\n              November 2014.\n   [RFC4272]\
    \  Murphy, S., \"BGP Security Vulnerabilities Analysis\",\n              RFC 4272,\
    \ January 2006,\n              <http://www.rfc-editor.org/info/rfc4272>.\n   [RFC4385]\
    \  Bryant, S., Swallow, G., Martini, L., and D. McPherson,\n              \"Pseudowire\
    \ Emulation Edge-to-Edge (PWE3) Control Word for\n              Use over an MPLS\
    \ PSN\", RFC 4385, February 2006,\n              <http://www.rfc-editor.org/info/rfc4385>.\n\
    \   [RFC4664]  Andersson, L., Ed., and E. Rosen, Ed., \"Framework for\n      \
    \        Layer 2 Virtual Private Networks (L2VPNs)\", RFC 4664,\n            \
    \  September 2006, <http://www.rfc-editor.org/info/rfc4664>.\n   [RFC4684]  Marques,\
    \ P., Bonica, R., Fang, L., Martini, L., Raszuk,\n              R., Patel, K.,\
    \ and J. Guichard, \"Constrained Route\n              Distribution for Border\
    \ Gateway Protocol/MultiProtocol\n              Label Switching (BGP/MPLS) Internet\
    \ Protocol (IP) Virtual\n              Private Networks (VPNs)\", RFC 4684, November\
    \ 2006,\n              <http://www.rfc-editor.org/info/rfc4684>.\n   [RFC5226]\
    \  Narten, T. and H. Alvestrand, \"Guidelines for Writing an\n              IANA\
    \ Considerations Section in RFCs\", BCP 26, RFC 5226,\n              May 2008,\
    \ <http://www.rfc-editor.org/info/rfc5226>.\n   [RFC5925]  Touch, J., Mankin,\
    \ A., and R. Bonica, \"The TCP\n              Authentication Option\", RFC 5925,\
    \ June 2010,\n              <http://www.rfc-editor.org/info/rfc5925>.\n   [RFC6514]\
    \  Aggarwal, R., Rosen, E., Morin, T., and Y. Rekhter, \"BGP\n              Encodings\
    \ and Procedures for Multicast in MPLS/BGP IP\n              VPNs\", RFC 6514,\
    \ February 2012,\n              <http://www.rfc-editor.org/info/rfc6514>.\n  \
    \ [RFC6790]  Kompella, K., Drake, J., Amante, S., Henderickx, W., and\n      \
    \        L.  Yong, \"The Use of Entropy Labels in MPLS Forwarding\",\n       \
    \       RFC 6790, November 2012,\n              <http://www.rfc-editor.org/info/rfc6790>.\n\
    \   [RFC6952]  Jethanandani, M., Patel, K., and L. Zheng, \"Analysis of\n    \
    \          BGP, LDP, PCEP, and MSDP Issues According to the Keying\n         \
    \     and Authentication for Routing Protocols (KARP) Design\n              Guide\"\
    , RFC 6952, May 2013,\n              <http://www.rfc-editor.org/info/rfc6952>.\n\
    \   [RFC7117]  Aggarwal, R., Ed., Kamite, Y., Fang, L., Rekhter, Y., and\n   \
    \           C.  Kodeboniya, \"Multicast in Virtual Private LAN Service\n     \
    \         (VPLS)\", RFC 7117, February 2014,\n              <http://www.rfc-editor.org/info/rfc7117>.\n\
    \   [RFC7209]  Sajassi, A., Aggarwal, R., Uttaro, J., Bitar, N.,\n           \
    \   Henderickx, W., and A. Isaac, \"Requirements for Ethernet\n              VPN\
    \ (EVPN)\", RFC 7209, May 2014,\n              <http://www.rfc-editor.org/info/rfc7209>.\n"
- title: Acknowledgements
  contents:
  - "Acknowledgements\n   Special thanks to Yakov Rekhter for reviewing this document\
    \ several\n   times and providing valuable comments, and for his very engaging\n\
    \   discussions on several topics of this document that helped shape this\n  \
    \ document.  We would also like to thank Pedro Marques, Kaushik Ghosh,\n   Nischal\
    \ Sheth, Robert Raszuk, Amit Shukla, and Nadeem Mohammed for\n   discussions that\
    \ helped shape this document.  We would also like to\n   thank Han Nguyen for\
    \ his comments and support of this work.  We would\n   also like to thank Steve\
    \ Kensil and Reshad Rahman for their reviews.\n   We would like to thank Jorge\
    \ Rabadan for his contribution to\n   Section 5 of this document.  We would like\
    \ to thank Thomas Morin for\n   his review of this document and his contribution\
    \ of Section 8.6.\n   Many thanks to Jakob Heitz for his help to improve several\
    \ sections\n   of this document.\n   We would also like to thank Clarence Filsfils,\
    \ Dennis Cai, Quaizar\n   Vohra, Kireeti Kompella, and Apurva Mehta for their\
    \ contributions to\n   this document.\n   Last but not least, special thanks to\
    \ Giles Heron (our WG chair) for\n   his detailed review of this document in preparation\
    \ for WG Last Call\n   and for making many valuable suggestions.\n"
- title: Contributors
  contents:
  - "Contributors\n   In addition to the authors listed on the front page, the following\n\
    \   co-authors have also contributed to this document:\n   Keyur Patel\n   Samer\
    \ Salam\n   Sami Boutros\n   Cisco\n   Yakov Rekhter\n   Ravi Shekhar\n   Juniper\
    \ Networks\n   Florin Balus\n   Nuage Networks\n"
- title: Authors' Addresses
  contents:
  - "Authors' Addresses\n   Ali Sajassi (editor)\n   Cisco\n   EMail: sajassi@cisco.com\n\
    \   Rahul Aggarwal\n   Arktan\n   EMail: raggarwa_1@yahoo.com\n   Nabil Bitar\n\
    \   Verizon Communications\n   EMail : nabil.n.bitar@verizon.com\n   Aldrin Isaac\n\
    \   Bloomberg\n   EMail: aisaac71@bloomberg.net\n   James Uttaro\n   AT&T\n  \
    \ EMail: uttaro@att.com\n   John Drake\n   Juniper Networks\n   EMail: jdrake@juniper.net\n\
    \   Wim Henderickx\n   Alcatel-Lucent\n   EMail: wim.henderickx@alcatel-lucent.com\n"
