- contents:
  - "        Label Switched Path (LSP) and Pseudowire (PW) Ping/Trace\n             over
    MPLS Networks Using Entropy Labels (ELs)\n"
  title: __initial_text__
- contents:
  - "Abstract\n   Multiprotocol Label Switching (MPLS) Label Switched Path (LSP) ping\n
    \  and traceroute are methods used to test Equal-Cost Multipath (ECMP)\n   paths.
    \ Ping is known as a connectivity-verification method and\n   traceroute is known
    as a fault-isolation method, as described in RFC\n   4379.  When an LSP is signaled
    using the Entropy Label (EL) described\n   in RFC 6790, the ability for LSP ping
    and traceroute operations to\n   discover and exercise ECMP paths is lost for
    scenarios where Label\n   Switching Routers (LSRs) apply different load-balancing
    techniques.\n   One such scenario is when some LSRs apply EL-based load balancing\n
    \  while other LSRs apply load balancing that is not EL based (e.g.,\n   IP).
    \ Another scenario is when an EL-based LSP is stitched with\n   another LSP that
    can be EL based or not EL based.\n   This document extends the MPLS LSP ping and
    traceroute multipath\n   mechanisms in RFC 6424 to allow the ability of exercising
    LSPs that\n   make use of the EL.  This document updates RFC 6790.\n"
  title: Abstract
- contents:
  - "Status of This Memo\n   This is an Internet Standards Track document.\n   This
    document is a product of the Internet Engineering Task Force\n   (IETF).  It represents
    the consensus of the IETF community.  It has\n   received public review and has
    been approved for publication by the\n   Internet Engineering Steering Group (IESG).
    \ Further information on\n   Internet Standards is available in Section 2 of RFC
    7841.\n   Information about the current status of this document, any errata,\n
    \  and how to provide feedback on it may be obtained at\n   http://www.rfc-editor.org/info/rfc8012.\n"
  title: Status of This Memo
- contents:
  - "Copyright Notice\n   Copyright (c) 2016 IETF Trust and the persons identified
    as the\n   document authors.  All rights reserved.\n   This document is subject
    to BCP 78 and the IETF Trust's Legal\n   Provisions Relating to IETF Documents\n
    \  (http://trustee.ietf.org/license-info) in effect on the date of\n   publication
    of this document.  Please review these documents\n   carefully, as they describe
    your rights and restrictions with respect\n   to this document.  Code Components
    extracted from this document must\n   include Simplified BSD License text as described
    in Section 4.e of\n   the Trust Legal Provisions and are provided without warranty
    as\n   described in the Simplified BSD License.\n"
  title: Copyright Notice
- contents:
  - "Table of Contents\n   1. Introduction ....................................................3\n
    \     1.1. Terminology ................................................5\n           1.1.1.
    Requirements Language ...............................6\n      1.2. Background
    .................................................6\n   2. Multipath Type {9} ..............................................7\n
    \  3. Pseudowire Tracing ..............................................7\n   4.
    Entropy Label FEC ...............................................8\n   5. DS Flags:
    L and E ...............................................9\n   6. New Multipath
    Information Type {10} ............................10\n   7. Initiating LSR Procedures
    ......................................12\n   8. Responder LSR Procedures .......................................14\n
    \     8.1. IP-Based Load Balancer That Does Not Push ELI/EL ..........15\n      8.2.
    IP-Based Load Balancer That Pushes ELI/EL .................15\n      8.3. Label-Based
    Load Balancer That Does Not Push ELI/EL .......16\n      8.4. Label-Based Load
    Balancer That Pushes ELI/EL ..............17\n      8.5. Flow-Aware MS-PW Stitching
    LSR ............................18\n   9. Supported and Unsupported Cases ................................18\n
    \  10. Security Considerations .......................................20\n   11.
    IANA Considerations ...........................................21\n      11.1.
    Entropy Label FEC ........................................21\n      11.2. DS Flags
    .................................................21\n      11.3. Multipath Type
    ...........................................21\n   12. References ....................................................22\n
    \     12.1. Normative References .....................................22\n      12.2.
    Informative References ...................................22\n   Acknowledgements
    ..................................................23\n   Contributors ......................................................23\n
    \  Authors' Addresses ................................................23\n"
  title: Table of Contents
- contents:
  - "1.  Introduction\n   [RFC4379] describes LSP traceroute as an operation where
    the\n   initiating LSR sends a series of MPLS echo requests towards the same\n
    \  destination.  The first packet in the series has the TTL set to 1.\n   When
    the echo reply is received from the LSR one hop away, the second\n   echo request
    in the series is sent with the TTL set to 2.  For each\n   additional echo request,
    the TTL is incremented by one until a\n   response is received from the intended
    destination.  The initiating\n   LSR discovers and exercises ECMP by obtaining
    Multipath Information\n   from each transit LSR and using a specific destination
    IP address or\n   specific entropy label.\n   From here on, the notation {x, y,
    z} refers to Multipath Information\n   Types x, y, or z.  Multipath Information
    Types are defined in\n   Section 3.3 of [RFC4379] .\n   The LSR initiating LSP
    ping sends an MPLS echo request with the\n   Multipath Information.  This Multipath
    Information is described in\n   the echo request's DDMAP TLV and may contain a
    set of IP addresses or\n   a set of labels.  Multipath Information Types {2, 4,
    8} carry a set\n   of IP addresses, and the Multipath Information Type {9} carries
    a set\n   of labels.  The responder LSR (the receiver of the MPLS echo request)\n
    \  will determine the subset of initiator-specified Multipath\n   Information,
    which load balances to each downstream (outgoing)\n   interface.  The responder
    LSR sends an MPLS echo reply with the\n   resulting Multipath Information per
    downstream (outgoing interface)\n   back to the initiating LSR.  The initiating
    LSR is then able to use a\n   specific IP destination address or a specific label
    to exercise a\n   specific ECMP path on the responder LSR.\n   The current behavior
    is problematic in the following scenarios:\n   o  The initiating LSR sends the
    IP Multipath Information, but the\n      responder LSR load balances on labels.\n
    \  o  The initiating LSR sends the Label Multipath Information, but the\n      responder
    LSR load balances on IP addresses.\n   o  The initiating LSR sends the existing
    Multipath Information to an\n      LSR that pushes ELI/EL in the label stack,
    but the initiating LSR\n      can only continue to discover and exercise specific
    paths of the\n      ECMP if the LSR that pushes ELI/EL responds with both IP addresses\n
    \     and the associated EL corresponding to each IP address.  This is\n      because:\n
    \     *  An ELI/EL-pushing LSR that is a stitching point will load\n         balance
    based on the IP address.\n      *  Downstream LSR(s) of an ELI/EL-pushing LSR
    may load balance\n         based on ELs.\n   o  The initiating LSR sends existing
    Multipath Information to an ELI/\n      EL-pushing LSR, but the initiating LSR
    can only continue to\n      discover and exercise specific paths of ECMP if the
    ELI/EL-pushing\n      LSR responds with both labels and the associated EL corresponding\n
    \     to the label.  This is because:\n      *  An ELI/EL-pushing LSR that is
    a stitching point will load\n         balance based on the EL from the previous
    LSP and push a new\n         EL.\n      *  Downstream LSR(s) of ELI/EL-pushing
    LSR may load balance based\n         on new ELs.\n   The above scenarios demonstrate
    that the existing Multipath\n   Information is insufficient when LSP traceroute
    is used on an LSP\n   with entropy labels [RFC6790].  This document defines a
    new Multipath\n   Information Type to be used in the DDMAP of MPLS echo request/reply\n
    \  packets for [RFC6790] LSPs.\n   The responder LSR can reply with empty Multipath
    Information if no IP\n   address set or if no label set is received with the Multipath\n
    \  Information.  An empty return is also possible if an initiating LSR\n   sends
    Multipath Information of one type, IP Address or Label, but the\n   responder
    LSR load balances on the other type.  To disambiguate\n   between the two results,
    this document introduces new flags in the\n   DDMAP TLV to allow the responder
    LSR to describe the load-balancing\n   technique being used.\n   To use this enhanced
    method end-to-end, all LSRs along the LSP need\n   to be able to understand the
    new flags and the new Multipath\n   Information Type.  Mechanisms to verify this
    condition are outside of\n   the scope of this document.  The rest of the requirements
    are\n   detailed in the initiating LSR and responder LSR procedures.  Two\n   additional
    DS Flags are defined for the DDMAP TLV in Section 6.\n   These two flags are used
    by the responder LSR to describe its load-\n   balancing behavior on a received
    MPLS echo request.\n   Note that the terms \"IP-Based Load Balancer\" and \"Label-Based
    Load\n   Balancer\" are in context of how a received MPLS echo request is\n   handled
    by the responder LSR.\n"
  - contents:
    - "1.1.  Terminology\n   The following abbreviations and terms are used in this
      document:\n   o  MPLS: Multiprotocol Label Switching.\n   o  LSP: Label Switched
      Path.\n   o  Stitched LSP: Stitched Label Switched Paths combine several LSPs\n
      \     such that a single end-to-end LSP is realized.  [RFC6424]\n      describes
      LSP ping for Stitched LSPs.\n   o  LSR: Label Switching Router.\n   o  FEC:
      Forwarding Equivalence Class.\n   o  ECMP: Equal-Cost Multipath.\n   o  EL:
      Entropy Label.\n   o  ELI: Entropy Label Indicator.\n   o  GAL: Generic Associated
      Channel Label.\n   o  MS-PW: Multi-Segment Pseudowire.\n   o  Initiating LSR:
      An LSR that sends an MPLS echo request.\n   o  Responder LSR: An LSR that receives
      an MPLS echo request and sends\n      an MPLS echo reply.\n   o  IP-Based Load
      Balancer: An LSR that load balances on fields from\n      an IP header (and
      possibly fields from upper layers) and does not\n      consider an entropy label
      from an MPLS label stack (i.e., flow\n      label [RFC6391] or entropy label
      [RFC6790]) for load-balancing\n      purposes.\n   o  Label-Based Load Balancer:
      An LSR that load balances on an entropy\n      label from an MPLS label stack
      (i.e., flow label or entropy label)\n      and does not consider fields from
      an IP header (and possibly\n      fields from upper layers) for load-balancing
      purposes.\n   o  Label and IP-Based Load Balancer: An LSR that load balances
      on\n      both entropy labels from an MPLS label stack and fields from an IP\n
      \     header (and possibly fields from upper layers).\n"
    - contents:
      - "1.1.1.  Requirements Language\n   The key words \"MUST\", \"MUST NOT\", \"REQUIRED\",
        \"SHALL\", \"SHALL NOT\",\n   \"SHOULD\", \"SHOULD NOT\", \"RECOMMENDED\",
        \"MAY\", and \"OPTIONAL\" in this\n   document are to be interpreted as described
        in RFC 2119 [RFC2119].\n"
      title: 1.1.1.  Requirements Language
    title: 1.1.  Terminology
  - contents:
    - "1.2.  Background\n   MPLS implementations employ a wide variety of load-balancing\n
      \  techniques in terms of fields used for hash \"keys\".  The mechanisms\n   in
      [RFC4379] and updated by [RFC6424] are designed to provide\n   multipath support
      for a subset of techniques.  The intent of this\n   document is to provide multipath
      support for the supported techniques\n   that are compromised by the use of
      ELs [RFC6790].  Section 9\n   describes supported and unsupported cases, and
      it may be useful for\n   the reader to first review this section.\n   The Downstream
      Detailed Mapping (DDMAP) TLV [RFC6424] provides\n   Multipath Information, which
      can be used by an LSP ping initiator to\n   trace and validate ECMP paths between
      an ingress and egress.  The\n   Multipath Information encodings defined by [RFC6424]
      are sufficient\n   when all the LSRs along the path(s), between ingress and
      egress,\n   consider the same set of \"keys\" as input for load-balancing\n
      \  algorithms, e.g., either all IP based or all label based.\n   With the introduction
      of [RFC6790], some LSRs may perform load\n   balancing based on labels while
      others may be IP based.  This results\n   in an LSP ping initiator that is unable
      to trace and validate all the\n   ECMP paths in the following scenarios:\n   o
      \ One or more transit LSRs along an LSP with ELI/EL in the label\n      stack
      do not perform ECMP load balancing based on EL (hashes based\n      on \"keys\"
      including the IP destination address).  This scenario is\n      not only possible
      but quite common due to transit LSRs not\n      implementing [RFC6790] or transit
      LSRs implementing [RFC6790] but\n      not implementing the suggested transit
      LSR behavior in Section 4.3\n      of [RFC6790].\n   o  Two or more LSPs stitched
      together with at least one of these LSPs\n      pushing ELI/EL into the label
      stack.\n   These scenarios can be quite common because deployments of [RFC6790]\n
      \  typically have a mixture of nodes that support ELI/EL and nodes that\n   do
      not.  There will also typically be a mixture of areas that support\n   ELI/EL
      and areas that do not.\n   As pointed out in [RFC6790], the procedures of [RFC4379]
      (and\n   consequently of [RFC6424]) with respect to Multipath Information Type\n
      \  {9} are incomplete.  However, [RFC6790] does not actually update\n   [RFC4379].
      \ Further, the specific EL location is not clearly defined,\n   particularly
      in the case of Flow-Aware Pseudowires [RFC6391].  This\n   document defines
      a new FEC Stack sub-TLV for the entropy label.\n   Section 2 of this document
      updates the procedures for the Multipath\n   Information Type {9} that are described
      in [RFC4379] and that are\n   applicable to [RFC6424].  The rest of this document
      describes\n   extensions required to restore ECMP discovery and tracing\n   capabilities
      for the scenarios described.\n   [RFC4379], [RFC6424], and this document will
      support IP-based load\n   balancers and label-based load balancers that limit
      their hash to the\n   first (top-most) or only entropy label in the label stack.
      \ Other use\n   cases (refer to Section 9) are out of scope.\n"
    title: 1.2.  Background
  title: 1.  Introduction
- contents:
  - "2.  Multipath Type {9}\n   [RFC4379] defined Multipath Type {9} for the tracing
    of LSPs where\n   label-based load balancing is used.  However, as pointed out
    in\n   [RFC6790], the procedures for using this type are incomplete as the\n   specific
    location of the label was not defined.  It was assumed that\n   the presence of
    Multipath Type {9} implied that the value of the\n   bottom-of-stack label should
    be varied by the values indicated by the\n   multipath to determine the respective
    outgoing interfaces.\n   Section 4 defines a new FEC-Stack sub-TLV to indicate
    an entropy\n   label.  These labels MAY appear anywhere in a label stack.\n   Multipath
    Type {9} applies to the first label in the label stack that\n   corresponds to
    an EL-FEC.  If no such label is found, it applies to\n   the label at the bottom
    of the label stack.\n"
  title: 2.  Multipath Type {9}
- contents:
  - "3.  Pseudowire Tracing\n   This section defines procedures for tracing Pseudowires.
    \ These\n   procedures pertain to the use of Multipath Information Type {9} as\n
    \  well as Type {10}.  In all cases below, when a control word is in\n   use,
    the N flag in the DDMAP MUST be set.  Note that when a control\n   word is not
    in use, the returned DDMAPs may not be accurate.\n   In order to trace a Pseudowire
    that is not flow aware, the initiator\n   includes an EL-FEC instead of the appropriate
    PW FEC at the bottom of\n   the FEC Stack.  Tracing in this way will cause compliant
    routers to\n   return the proper outgoing interface.  Note that this procedure
    only\n   traces to the end of the MPLS LSP that is under test and will not\n   verify
    the PW FEC.  To actually verify the PW FEC or in the case of a\n   MS-PW, to determine
    the next Pseudowire label value, the initiator\n   MUST repeat that step of the
    trace (i.e., repeating the TTL value\n   used) but with the FEC Stack modified
    to contain the appropriate PW\n   FEC.  Note that these procedures are applicable
    to scenarios where an\n   initiator is able to vary the bottom label (i.e., Pseudowire
    label).\n   Possible scenarios are tracing multiple Pseudowires that are not flow\n
    \  aware on the same endpoints or tracing a Pseudowire that is not flow-\n   aware
    provisioned with multiple Pseudowire labels.\n   In order to trace a flow-aware
    Pseudowire [RFC6391], the initiator\n   includes an EL FEC at the bottom of the
    FEC Stack and pushes the\n   appropriate PW FEC onto the FEC Stack.\n   In order
    to trace through routers that are not compliant, the\n   initiator forms an MPLS
    echo request message and includes a DDMAP\n   with the Multipath Type {9}.  For
    a Pseudowire that is not flow\n   aware, it includes the appropriate PW FEC in
    the FEC Stack.  For a\n   flow- aware Pseudowire, the initiator includes a Nil
    FEC at the\n   bottom of the FEC Stack and pushes the appropriate PW FEC onto
    the\n   FEC Stack.\n"
  title: 3.  Pseudowire Tracing
- contents:
  - "4.  Entropy Label FEC\n   The ELI is a reserved label that has no associated
    explicit FEC, and\n   has the label value 7 assigned from the reserved range.
    \ Use the Nil\n   FEC as the Target FEC Stack sub-TLV to account for ELI in a
    Target\n   FEC Stack TLV.\n   The EL is a special-purpose label with the label
    value being\n   discretionary (i.e., the label value is not from the reserved
    range).\n   For LSP verification mechanics to perform its purpose, it is\n   necessary
    for a Target FEC Stack sub-TLV to clearly describe the EL,\n   particularly in
    the scenario where the label stack does not carry ELI\n   (e.g., flow-aware Pseudowire
    [RFC6391]).  Therefore, this document\n   defines an EL FEC sub-TLV (33, see Section
    11.1) that allows a Target\n   FEC Stack sub-TLV to be added to the Target FEC
    Stack to account for\n   EL.\n   The Length is 4.  Labels are 20-bit values treated
    as numbers.\n    0                   1                   2                   3\n
    \   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \  |                 Label                 |          MBZ          |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \                       Figure 1: Entropy Label FEC\n   \"Label\" is the actual
    label value inserted in the label stack; the\n   \"MBZ\" field MUST be zero when
    sent and ignored on receipt.\n"
  title: 4.  Entropy Label FEC
- contents:
  - "5.  DS Flags: L and E\n   Two flags, L and E, are added to the DS Flags field
    of the DDMAP TLV.\n   Both flags MUST NOT be set in the echo request packets when
    sending\n   and SHOULD be ignored when received.  Zero, one, or both new flags\n
    \  MUST be set in the echo reply packets.\n    DS Flags\n    --------\n        0
    1 2 3 4 5 6 7\n       +-+-+-+-+-+-+-+-+\n       |  MBZ  |L|E|I|N|\n       +-+-+-+-+-+-+-+-+\n
    \   Flag  Name and Meaning\n    ----  ----------------\n       L  Label-based
    load balance indicator\n          This flag MUST be cleared in the echo request.
    \ An LSR\n          that performs load balancing on a label MUST set this\n          flag
    in the echo reply.  An LSR that performs load\n          balancing on IP MUST
    NOT set this flag in the echo\n          reply.\n       E  ELI/EL push indicator\n
    \         This flag MUST be cleared in the echo request.  An LSR\n          that
    pushes ELI/EL MUST set this flag in the echo\n          reply.  An LSR that does
    not push ELI/EL MUST NOT set\n          this flag in the echo reply.\n   The two
    flags result in four load-balancing techniques, which the\n   echo reply generating
    LSR can indicate:\n   o  {L=0, E=0} LSR load balances based on IP and does not
    push ELI/EL.\n   o  {L=0, E=1} LSR load balances based on IP and pushes ELI/EL.\n
    \  o  {L=1, E=0} LSR load balances based on labels and does not push\n      ELI/EL.\n
    \  o  {L=1, E=1} LSR load balances based on labels and pushes ELI/EL.\n"
  title: '5.  DS Flags: L and E'
- contents:
  - "6.  New Multipath Information Type {10}\n   One new Multipath Information Type
    is added to be used in DDMAP TLV.\n   This new Multipath Type has the value of
    10.\n     Key   Type                  Multipath Information\n     ---   ----------------
    \     ---------------------\n     10    IP and Label set      IP addresses and
    label prefixes\n   Multipath Information Type {10} is comprised of three sections.
    \ The\n   first section describes the IP address set.  The second section\n   describes
    the label set.  The third section describes another label\n   set, which associates
    to either the IP address set or the label set\n   specified in the other sections.\n
    \  Multipath Information Type {10} has the following format:\n    0                   1
    \                  2                   3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
    6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \  |IPMultipathType|     IP Multipath Length       | Reserved(MBZ) |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \  ~                                                               ~\n   |                  (IP
    Multipath Information)                   |\n   ~                                                               ~\n
    \  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |LbMultipathType|
    \   Label Multipath Length     | Reserved(MBZ) |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \  ~                                                               ~\n   |                 (Label
    Multipath Information)                 |\n   ~                                                               ~\n
    \  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   | Assoc.
    Label Multipath Length |         Reserved(MBZ)         |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n
    \  ~                                                               ~\n   |            (Associated
    Label Multipath Information)           |\n   ~                                                               ~\n
    \  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n                 Figure
    2: Multipath Information Type {10}\n   o  IPMultipathType\n      *  0 when \"IP
    Multipath Information\" is omitted.  Otherwise, one\n         of the IP Multipath
    Information values: {2, 4, 8}.\n   o  IP Multipath Information\n      *  This
    section is omitted when \"IPMultipathType\" is 0.\n         Otherwise, this section
    reuses the IP Multipath Information\n         from [RFC4379].  Specifically, Multipath
    Information for values\n         {2, 4, 8} can be used.\n   o  LbMultipathType\n
    \     *  0 when the \"Label Multipath Information\" is omitted.\n         Otherwise,
    the Label Multipath Information value {9}.\n   o  Label Multipath Information\n
    \     *  This section is omitted when the \"LbMultipathType\" is 0.\n         Otherwise,
    this section reuses the Label Multipath Information\n         from [RFC4379].
    \ Specifically, the Multipath Information for\n         value {9} can be used.\n
    \  o  Associated Label Multipath Information\n      *  \"Associated Label Multipath
    Length\" is a 16-bit field of\n         Multipath Information that indicates the
    length in octets of\n         the Associated Label Multipath Information.\n      *
    \ \"Associated Label Multipath Information\" is a list of labels\n         with
    each label described in 24 bits.  This section MUST be\n         omitted in an
    MPLS echo request message.  A midpoint that\n         pushes ELI/EL labels SHOULD
    include \"Associated Label Multipath\n         Information\" in its MPLS echo
    reply message, along with either\n         \"IP Multipath Information\" or \"Label
    Multipath Information\".\n         Each specified associated label described in
    this section maps\n         to a specific IP address OR label described in the
    \"IP\n         Multipath Information\" section or the \"Label Multipath\n         Information\"
    section.  For example, if three IP addresses are\n         specified in the \"IP
    Multipath Information\" section, then there\n         MUST be three labels described
    in this section.  The first\n         label maps to the first IP address specified,
    the second label\n         maps to the second IP address specified, and the third
    label\n         maps to the third IP address specified.\n   When a section is
    omitted, the length for that section MUST be set to\n   zero.\n"
  title: 6.  New Multipath Information Type {10}
- contents:
  - "7.  Initiating LSR Procedures\n   The following procedure is described in terms
    of an EL_LSP boolean\n   maintained by the initiating LSR.  This value controls
    the Multipath\n   Information Type to be used in the transmitted echo request
    packets.\n   When the initiating LSR is transmitting an echo request packet with\n
    \  DDMAP with a non-zero Multipath Information Type, then the EL_LSP\n   boolean
    MUST be consulted to determine the Multipath Information Type\n   to use.\n   In
    addition to the procedures described in [RFC4379], as updated by\n   Section 2
    and [RFC6424], the initiating LSR MUST operate with the\n   following procedures:\n
    \  o  When the initiating LSR pushes ELI/EL, initialize EL_LSP=True.\n      Else,
    set EL_LSP=False.\n   o  When the initiating LSR is transmitting a non-zero Multipath\n
    \     Information Type:\n      *  If (EL_LSP), the initiating LSR MUST use the
    Multipath\n         Information Type {10} unless the responder LSR cannot handle\n
    \        Type {10}.  When the initiating LSR is transmitting the\n         Multipath
    Information Type {10}, both \"IP Multipath\n         Information\" and \"Label
    Multipath Information\" MUST be\n         included, and \"Associated Label Multipath
    Information\" MUST be\n         omitted (NULL).\n      *  Else, the initiating
    LSR MAY use the Multipath Information Type\n         {2, 4, 8, 9, 10}.  When the
    initiating LSR is transmitting the\n         Multipath Information Type {10} in
    this case, \"IP Multipath\n         Information\" MUST be included, and \"Label
    Multipath\n         Information\" and \"Associated Label Multipath Information\"
    MUST\n         be omitted (NULL).\n   o  When the initiating LSR receives an echo
    reply with {L=0, E=1} in\n      the DS Flags with valid contents, set EL_LSP=True.\n
    \  In the following conditions, the initiating LSR may have lost the\n   ability
    to exercise specific ECMP paths.  The initiating LSR MAY\n   continue with \"best
    effort\" in the following cases:\n   o  Received echo reply contains empty Multipath
    Information.\n   o  Received echo reply contains {L=0, E=<any>} DS Flags, but
    does not\n      contain IP Multipath Information.\n   o  Received echo reply contains
    {L=1, E=<any>} DS Flags, but does not\n      contain Label Multipath Information.\n
    \  o  Received echo reply contains {L=<any>, E=1} DS Flags, but does not\n      contain
    Associated Label Multipath Information.\n   o  IP Multipath Information Types
    {2, 4, 8} sent, and received echo\n      reply with {L=1, E=0} in DS Flags.\n
    \  o  Multipath Information Type {10} sent, and received echo reply with\n      Multipath
    Information Type other than {10}.\n"
  title: 7.  Initiating LSR Procedures
- contents:
  - "8.  Responder LSR Procedures\n   Common Procedures:\n   o  The responder LSR
    receiving an MPLS echo request packet MUST first\n      determine whether or not
    the initiating LSR supports this LSP ping\n      and traceroute extension for
    entropy labels.  If either of the\n      following conditions are met, the responder
    LSR SHOULD determine\n      that the initiating LSR supports this LSP ping and
    traceroute\n      extension for entropy labels.\n      1.  Received MPLS echo
    request contains the Multipath Information\n          Type {10}.\n      2.  Received
    MPLS echo request contains a Target FEC Stack TLV\n          that includes the
    entropy label FEC.\n      If the initiating LSR is determined not to support this
    LSP ping\n      and traceroute extension for entropy labels, then the responder\n
    \     LSR MUST NOT follow further procedures described in this section.\n      Specifically,
    MPLS echo reply packets:\n      *  MUST have the following DS Flags cleared (i.e.,
    not set): \"ELI/\n         EL push indicator\" and \"Label-based load balance
    indicator\".\n      *  MUST NOT use the Multipath Information Type {10}.\n   o
    \ The responder LSR receiving an MPLS echo request packet with the\n      Multipath
    Information Type {10} MUST validate the following\n      contents.  Any deviation
    MUST result in the responder LSR\n      considering the packet to be malformed
    and returning code 1\n      (\"Malformed echo request received\") in the MPLS
    echo reply packet.\n      *  IP Multipath Information MUST be included.\n      *
    \ Label Multipath Information MAY be included.\n      *  Associated Label Multipath
    Information MUST be omitted (NULL).\n   The following subsections describe expected
    responder LSR procedures\n   when the echo reply is to include DDMAP TLVs, based
    on the local load\n   balance technique being employed.  In case the responder
    LSR performs\n   deviating load balance techniques on a per-downstream basis,\n
    \  appropriate procedures matched to each downstream load balance\n   technique
    MUST be followed.\n"
  - contents:
    - "8.1.  IP-Based Load Balancer That Does Not Push ELI/EL\n   o  The responder
      MUST set {L=0, E=0} in DS Flags.\n   o  If the Multipath Information Type {2,
      4, 8} is received, the\n      responder MUST comply with [RFC4379] and [RFC6424].\n
      \  o  If the Multipath Information Type {9} is received, the responder\n      MUST
      reply with Multipath Type {0}.\n   o  If the Multipath Information Type {10}
      is received, the following\n      procedures are to be used:\n      *  The responder
      MUST reply with the Multipath Information Type\n         {10}.\n      *  The
      \"Label Multipath Information\" and \"Associated Label\n         Multipath Information\"
      sections MUST be omitted (NULL).\n      *  If no matching IP address is found,
      then the \"IPMultipathType\"\n         field MUST be set to the Multipath Information
      Type {0} and the\n         \"IP Multipath Information\" section MUST also be
      omitted (NULL).\n      *  If at least one matching IP address is found, then
      the\n         \"IPMultipathType\" field MUST be set to the appropriate\n         Multipath
      Information Type {2, 4, 8} and the \"IP Multipath\n         Information\" section
      MUST be included.\n"
    title: 8.1.  IP-Based Load Balancer That Does Not Push ELI/EL
  - contents:
    - "8.2.  IP-Based Load Balancer That Pushes ELI/EL\n   o  The responder MUST set
      {L=0, E=1} in DS Flags.\n   o  If the Multipath Information Type {9} is received,
      the responder\n      MUST reply with Multipath Type {0}.\n   o  If the Multipath
      Type {2, 4, 8, 10} is received, the following\n      procedures are to be used:\n
      \     *  The responder MUST respond with Multipath Type {10}.  See\n         Section
      6 for details of Multipath Type {10}.\n      *  The \"Label Multipath Information\"
      section MUST be omitted\n         (i.e., it is not there).\n      *  The IP
      address set specified in the received IP Multipath\n         Information MUST
      be used to determine the returned IP/Label\n         pairs.\n      *  If the
      received Multipath Information Type was {10}, the\n         received \"Label
      Multipath Information\" sections MUST NOT be\n         used to determine the
      associated label portion of the returned\n         IP/Label pairs.\n      *
      \ If no matching IP address is found, then the \"IPMultipathType\"\n         field
      MUST be set to the Multipath Information Type {0} and the\n         \"IP Multipath
      Information\" section MUST be omitted.  In\n         addition, the \"Associated
      Label Multipath Length\" MUST be set\n         to 0, and the \"Associated Label
      Multipath Information\" section\n         MUST also be omitted.\n      *  If
      at least one matching IP address is found, then the\n         \"IPMultipathType\"
      field MUST be set to the appropriate\n         Multipath Information Type {2,
      4, 8} and the \"IP Multipath\n         Information\" section MUST be included.
      \ In addition, the\n         \"Associated Label Multipath Information\" section
      MUST be\n         populated with a list of labels corresponding to each IP\n
      \        address specified in the \"IP Multipath Information\" section.\n         \"Associated
      Label Multipath Length\" MUST be set to a value\n         representing the length
      in octets of the \"Associated Label\n         Multipath Information\" field.\n"
    title: 8.2.  IP-Based Load Balancer That Pushes ELI/EL
  - contents:
    - "8.3.  Label-Based Load Balancer That Does Not Push ELI/EL\n   o  The responder
      MUST set {L=1, E=0} in DS Flags.\n   o  If the Multipath Information Type {2,
      4, 8} is received, the\n      responder MUST reply with Multipath Type {0}.\n
      \  o  If the Multipath Information Type {9} is received, the responder\n      MUST
      comply with [RFC4379] and [RFC6424] as updated by Section 2.\n   o  If the Multipath
      Information Type {10} is received, the following\n      procedures are to be
      used:\n      *  The responder MUST reply with the Multipath Information Type\n
      \        {10}.\n      *  The \"IP Multipath Information\" and \"Associated Label
      Multipath\n         Information\" sections MUST be omitted (NULL).\n      *
      \ If no matching label is found, then the \"LbMultipathType\" field\n         MUST
      be set to the Multipath Information Type {0} and the\n         \"Label Multipath
      Information\" section MUST also be omitted\n         (NULL).\n      *  If at
      least one matching label is found, then the\n         \"LbMultipathType\" field
      MUST be set to the appropriate\n         Multipath Information Type {9} and
      the \"Label Multipath\n         Information\" section MUST be included.\n"
    title: 8.3.  Label-Based Load Balancer That Does Not Push ELI/EL
  - contents:
    - "8.4.  Label-Based Load Balancer That Pushes ELI/EL\n   o  The responder MUST
      set {L=1, E=1} in DS Flags.\n   o  If the Multipath Information Type {2, 4,
      8} is received, the\n      responder MUST reply with Multipath Type {0}.\n   o
      \ If the Multipath Type {9, 10} is received, the following\n      procedures
      are to be used:\n      *  The responder MUST respond with the Multipath Type
      {10}.\n      *  The \"IP Multipath Information\" section MUST be omitted.\n
      \     *  The label set specified in the received Label Multipath\n         Information
      MUST be used to determine the returned Label/Label\n         pairs.\n      *
      \ If the received Multipath Information Type was {10} received,\n         the
      \"Label Multipath Information\" sections MUST NOT be used to\n         determine
      the associated label portion of the returned Label/\n         Label pairs.\n
      \     *  If no matching label is found, then the \"LbMultipathType\" field\n
      \        MUST be set to the Multipath Information Type {0} and the\n         \"Label
      Multipath Information\" section MUST be omitted.  In\n         addition, the
      \"Associated Label Multipath Length\" MUST be set\n         to 0, and the \"Associated
      Label Multipath Information\" section\n         MUST also be omitted.\n      *
      \ If at least one matching label is found, then the\n         \"LbMultipathType\"
      field MUST be set to the appropriate\n         Multipath Information Type {9}
      and the \"Label Multipath\n         Information\" section MUST be included.
      \ In addition, the\n         \"Associated Label Multipath Information\" section
      MUST be\n         populated with a list of labels corresponding to each label\n
      \        specified in the \"Label Multipath Information\" section.  The\n         \"Associated
      Label Multipath Length\" MUST be set to a value\n         representing the length
      in octets of the \"Associated Label\n         Multipath Information\" field.\n"
    title: 8.4.  Label-Based Load Balancer That Pushes ELI/EL
  - contents:
    - "8.5.  Flow-Aware MS-PW Stitching LSR\n   A stitching LSR that cross-connects
      flow-aware Pseudowires behaves in\n   one of two ways:\n   o  Load balances
      on the previous flow label and carries over the same\n      flow label.  For
      this case, the stitching LSR is to behave as\n      described in Section 8.3.\n
      \  o  Load balances on the previous flow label and replaces the flow\n      label
      with a newly computed label.  For this case, the stitching\n      LSR is to
      behave as described in Section 8.4.\n"
    title: 8.5.  Flow-Aware MS-PW Stitching LSR
  title: 8.  Responder LSR Procedures
- contents:
  - "9.  Supported and Unsupported Cases\n   The MPLS architecture does not define
    strict rules on how\n   implementations are to identify hash \"keys\" for load-balancing\n
    \  purposes.  As a result, implementations may be of the following load\n   balancer
    types:\n   1.  IP-based load balancer.\n   2.  Label-based load balancer.\n   3.
    \ Label- and IP-based load balancer.\n   For cases (2) and (3), an implementation
    can include different sets\n   of labels from the label stack for load-balancing
    purpose.  Thus, the\n   following sub-cases are possible:\n   a.  Entire label
    stack.\n   b.  Top N labels from label stack where the number of labels in label\n
    \      stack is > N.\n   c.  Bottom N labels from label stack where the number
    of labels in\n       label stack is > N.\n   In a scenario where there is one
    flow label or entropy label present\n   in the label stack, the following further
    cases are possible for\n   (2b), (2c), (3b), and (3c):\n   1.  N labels from label
    stack include flow label or entropy label.\n   2.  N labels from label stack do
    not include flow label or entropy\n       label.\n   Also, in a scenario where
    there are multiple entropy labels present\n   in the label stack, it is possible
    for implementations to employ\n   deviating techniques:\n   o  Search for entropy
    stops at the first entropy label.\n   o  Search for entropy includes any entropy
    label found plus continues\n      to search for entropy in the label stack.\n
    \  Furthermore, handling of reserved (i.e., special) labels varies among\n   implementations:\n
    \  o  Reserved labels are used in the hash as any other label would be\n      (not
    a recommended practice).\n   o  Reserved labels are skipped over and, for implementations
    limited\n      to N labels, the reserved labels do not count towards the limit
    of\n      N.\n   o  Reserved labels are skipped over and, for implementations
    limited\n      to N labels, the reserved labels count towards the limit of N.\n
    \  It is important to point this out since the presence of GAL will\n   affect
    those implementations that include reserved labels for load-\n   balancing purposes.\n
    \  As can be seen from the above, there are many types of potential\n   load-balancing
    implementations.  Attempting to get any Operations,\n   Administration, and Maintenance
    (OAM) tools to support ECMP discovery\n   and traversal over all types would require
    fairly complex procedures.\n   Complexities in OAM tools have minimal benefit
    if the majority of\n   implementations are expected to employ only a small subset
    of the\n   cases described above.\n   o  Section 4.3 of [RFC6790] states that
    in implementations, for load-\n      balancing purposes, parsing beyond the label
    stack after finding\n      an entropy label has \"limited incremental value\".
    \ Therefore, it\n      is expected that most implementations will be of types
    \"IP-based\n      load balancer\" or \"Label-based load balancer\".\n   o  Section
    2.4.5.1 of [RFC7325] recommends that searching for entropy\n      labels in the
    label stack should terminate upon finding the first\n      entropy label.  Therefore,
    it is expected that implementations\n      will only include the first (top-most)
    entropy label when there\n      are multiple entropy labels in the label stack.\n
    \  o  It is expected that, in most cases, the number of labels in the\n      label
    stack will not exceed the number of labels (N) that\n      implementations can
    include for load-balancing purposes.\n   o  It is expected that labels in the
    label stack, besides the flow\n      label and entropy label, are constant for
    the lifetime of a single\n      LSP multipath traceroute operation.  Therefore,
    deviating load-\n      balancing implementations with respect to reserved labels
    should\n      not affect this tool.\n   Thus, [RFC4379], [RFC6424], and this document
    support cases (1) and\n   (2a1), where only the first (top-most) entropy label
    is included when\n   there are multiple entropy labels in the label stack.\n"
  title: 9.  Supported and Unsupported Cases
- contents:
  - "10.  Security Considerations\n   While [RFC4379] and [RFC6424] already allow
    for the discovery and\n   exercise of ECMP paths, this document extends the LSP
    ping and\n   traceroute mechanisms to more precisely discover and exercise ECMP\n
    \  paths when an LSP uses ELI/EL in the label stack.  Sourcing or\n   inspecting
    LSP ping packets can be used for network reconnaissance.\n   The extended capability
    defined in this document requires minor\n   additional processing for the responder
    and initiator nodes.  The\n   responder node that pushes ELI/EL will need to compute
    and return\n   multipath data including associated EL.  The initiator node will
    need\n   to store and handle both IP Multipath and Label Multipath\n   Information,
    and include destination IP addresses and/or ELs in MPLS\n   echo request packets
    as well as in the Multipath Information sent to\n   downstream nodes.  The security
    considerations of [RFC4379] already\n   cover Denial-of-Service attacks by regulating
    LSP ping traffic going\n   to the control plane.\n   Finally, the security measures
    described in [RFC4379], [RFC6424], and\n   [RFC6790] are applicable.  [RFC6424]
    provides guidelines if a network\n   operator wants to prevent tracing or does
    not want to expose details\n   of the tunnel and [RFC6790] provides guidance on
    the use of the EL.\n"
  title: 10.  Security Considerations
- contents:
  - '11.  IANA Considerations

    '
  - contents:
    - "11.1.  Entropy Label FEC\n   IANA has assigned a new sub-TLV from the \"Sub-TLVs
      for TLV Types 1,\n   16, and 21\" section from the \"Multi-Protocol Label Switching
      (MPLS)\n   Label Switched Paths (LSPs) Ping Parameters\" registry under \"TLVs\"\n
      \  ([IANA-MPLS-LSP-PING]).\n    Sub-Type Sub-TLV Name          Reference\n    --------
      ------------          ---------\n       33     Entropy label FEC     this document\n"
    title: 11.1.  Entropy Label FEC
  - contents:
    - "11.2.  DS Flags\n   IANA has assigned new bit numbers from the \"DS Flags\"
      subregistry\n   from the \"TLVs\" section of the \"Multi-Protocol Label Switching
      (MPLS)\n   Label Switched Paths (LSPs) Ping Parameters\" registry\n   ([IANA-MPLS-LSP-PING]).\n
      \  Note: The \"DS Flags\" subregistry was created by [RFC7537].\n   Bit number
      Name                                        Reference\n   ---------- ----------------------------------------
      \   ---------\n       5       E: ELI/EL push indicator                    this
      document\n       4       L: Label-based load balance indicator       this document\n"
    title: 11.2.  DS Flags
  - contents:
    - "11.3.  Multipath Type\n   IANA has assigned a new value from the \"Multipath
      Type\" subregistry\n   from the \"TLVs\" section of the \"Multi-Protocol Label
      Switching (MPLS)\n   Label Switched Paths (LSPs) Ping Parameters\" registry\n
      \  ([IANA-MPLS-LSP-PING]).\n   Note: The \"Multipath Type\" subregistry was
      created by [RFC7537].\n    Value      Meaning                                  Reference\n
      \   ---------- ---------------------------------------- ---------\n      10
      \      IP and label set                         this document\n"
    title: 11.3.  Multipath Type
  title: 11.  IANA Considerations
- contents:
  - '12.  References

    '
  - contents:
    - "12.1.  Normative References\n   [RFC2119]  Bradner, S., \"Key words for use
      in RFCs to Indicate\n              Requirement Levels\", BCP 14, RFC 2119,\n
      \             DOI 10.17487/RFC2119, March 1997,\n              <http://www.rfc-editor.org/info/rfc2119>.\n
      \  [RFC4379]  Kompella, K. and G. Swallow, \"Detecting Multi-Protocol\n              Label
      Switched (MPLS) Data Plane Failures\", RFC 4379,\n              DOI 10.17487/RFC4379,
      February 2006,\n              <http://www.rfc-editor.org/info/rfc4379>.\n   [RFC6424]
      \ Bahadur, N., Kompella, K., and G. Swallow, \"Mechanism for\n              Performing
      Label Switched Path Ping (LSP Ping) over MPLS\n              Tunnels\", RFC
      6424, DOI 10.17487/RFC6424, November 2011,\n              <http://www.rfc-editor.org/info/rfc6424>.\n
      \  [RFC6790]  Kompella, K., Drake, J., Amante, S., Henderickx, W., and\n              L.
      Yong, \"The Use of Entropy Labels in MPLS Forwarding\",\n              RFC 6790,
      DOI 10.17487/RFC6790, November 2012,\n              <http://www.rfc-editor.org/info/rfc6790>.\n
      \  [RFC7537]  Decraene, B., Akiya, N., Pignataro, C., Andersson, L., and\n              S.
      Aldrin, \"IANA Registries for LSP Ping Code Points\",\n              RFC 7537,
      DOI 10.17487/RFC7537, May 2015,\n              <http://www.rfc-editor.org/info/rfc7537>.\n"
    title: 12.1.  Normative References
  - contents:
    - "12.2.  Informative References\n   [IANA-MPLS-LSP-PING]\n              IANA,
      \"Multi-Protocol Label Switching (MPLS) Label\n              Switched Paths
      (LSPs) Ping Parameters\",\n              <http://www.iana.org/assignments/mpls-lsp-ping-parameters>.\n
      \  [RFC6391]  Bryant, S., Ed., Filsfils, C., Drafz, U., Kompella, V.,\n              Regan,
      J., and S. Amante, \"Flow-Aware Transport of\n              Pseudowires over
      an MPLS Packet Switched Network\",\n              RFC 6391, DOI 10.17487/RFC6391,
      November 2011,\n              <http://www.rfc-editor.org/info/rfc6391>.\n   [RFC7325]
      \ Villamizar, C., Ed., Kompella, K., Amante, S., Malis, A.,\n              and
      C. Pignataro, \"MPLS Forwarding Compliance and\n              Performance Requirements\",
      RFC 7325, DOI 10.17487/RFC7325,\n              August 2014, <http://www.rfc-editor.org/info/rfc7325>.\n"
    title: 12.2.  Informative References
  title: 12.  References
- contents:
  - "Acknowledgements\n   The authors would like to thank Loa Andersson, Curtis Villamizar,\n
    \  Daniel King, Sriganesh Kini, Victor Ji, Acee Lindem, Deborah\n   Brungard,
    Shawn M Emery, Scott O. Bradner, and Peter Yee for\n   performing thorough reviews
    and providing very valuable comments.\n   Carlos Pignataro would like to acknowledge
    his lifetime friend Martin\n   Rigueiro, with deep gratitude and esteem, for sharing
    his contagious\n   passion for engineering and sciences, and for selflessly teaching
    so\n   many lessons.\n"
  title: Acknowledgements
- contents:
  - "Contributors\n   Nagendra Kumar\n   Cisco Systems, Inc.\n   Email: naikumar@cisco.com\n"
  title: Contributors
- contents:
  - "Authors' Addresses\n   Nobo Akiya\n   Big Switch Networks\n   Email: nobo.akiya.dev@gmail.com\n
    \  George Swallow\n   Cisco Systems, Inc.\n   Email: swallow@cisco.com\n   Carlos
    Pignataro\n   Cisco Systems, Inc.\n   Email: cpignata@cisco.com\n   Andrew G.
    Malis\n   Huawei Technologies\n   Email: agmalis@gmail.com\n   Sam Aldrin\n   Google\n
    \  Email: aldrin.ietf@gmail.com\n"
  title: Authors' Addresses
