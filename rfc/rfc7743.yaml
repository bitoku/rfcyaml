- title: __initial_text__
  contents:
  - '    Relayed Echo Reply Mechanism for Label Switched Path (LSP) Ping

    '
- title: Abstract
  contents:
  - "Abstract\n   In some inter-AS (Autonomous System) and inter-area deployment\n\
    \   scenarios for RFC 4379 (\"Label Switched Path (LSP) Ping and\n   Traceroute\"\
    ), a replying Label Switching Router (LSR) may not have\n   the available route\
    \ to an initiator, and the Echo Reply message sent\n   to the initiator would\
    \ be discarded, resulting in false negatives or\n   a complete failure of operation\
    \ of the LSP Ping and Traceroute.  This\n   document describes extensions to the\
    \ LSP Ping mechanism to enable the\n   replying LSR to have the capability to\
    \ relay the Echo Response by a\n   set of routable intermediate nodes to the initiator.\
    \  This document\n   updates RFC 4379.\n"
- title: Status of This Memo
  contents:
  - "Status of This Memo\n   This is an Internet Standards Track document.\n   This\
    \ document is a product of the Internet Engineering Task Force\n   (IETF).  It\
    \ represents the consensus of the IETF community.  It has\n   received public\
    \ review and has been approved for publication by the\n   Internet Engineering\
    \ Steering Group (IESG).  Further information on\n   Internet Standards is available\
    \ in Section 2 of RFC 5741.\n   Information about the current status of this document,\
    \ any errata,\n   and how to provide feedback on it may be obtained at\n   http://www.rfc-editor.org/info/rfc7743.\n"
- title: Copyright Notice
  contents:
  - "Copyright Notice\n   Copyright (c) 2016 IETF Trust and the persons identified\
    \ as the\n   document authors.  All rights reserved.\n   This document is subject\
    \ to BCP 78 and the IETF Trust's Legal\n   Provisions Relating to IETF Documents\n\
    \   (http://trustee.ietf.org/license-info) in effect on the date of\n   publication\
    \ of this document.  Please review these documents\n   carefully, as they describe\
    \ your rights and restrictions with respect\n   to this document.  Code Components\
    \ extracted from this document must\n   include Simplified BSD License text as\
    \ described in Section 4.e of\n   the Trust Legal Provisions and are provided\
    \ without warranty as\n   described in the Simplified BSD License.\n"
- title: Table of Contents
  contents:
  - "Table of Contents\n   1. Introduction ....................................................3\n\
    \      1.1. Conventions Used in This Document ..........................3\n  \
    \ 2. Motivation ......................................................3\n   3.\
    \ Extensions ......................................................5\n      3.1.\
    \ Relayed Echo Reply Message .................................5\n      3.2. Relay\
    \ Node Address Stack ...................................6\n      3.3. MTU Exceeded\
    \ Return Code ...................................8\n   4. Procedures ......................................................8\n\
    \      4.1. Sending an Echo Request ....................................9\n  \
    \    4.2. Receiving an Echo Request ..................................9\n    \
    \  4.3. Originating a Relayed Echo Reply ..........................10\n      4.4.\
    \ Relaying a Relayed Echo Reply .............................11\n      4.5. Sending\
    \ an Echo Reply .....................................11\n      4.6. Sending Subsequent\
    \ Echo Requests ..........................12\n      4.7. Impact on Traceroute\
    \ ......................................12\n   5. LSP Ping Relayed Echo Reply\
    \ Example ............................13\n   6. Security Considerations ........................................14\n\
    \   7. Backward Compatibility .........................................15\n  \
    \ 8. IANA Considerations ............................................15\n    \
    \  8.1. MPLS Relayed Echo Reply ...................................15\n      8.2.\
    \ Relay Node Address Stack TLV ..............................16\n      8.3. MTU\
    \ Exceeded Return Code ..................................16\n   9. References\
    \ .....................................................16\n      9.1. Normative\
    \ References ......................................16\n      9.2. Informative\
    \ References ....................................17\n   Acknowledgements ..................................................17\n\
    \   Contributors ......................................................17\n  \
    \ Authors' Addresses ................................................18\n"
- title: 1.  Introduction
  contents:
  - "1.  Introduction\n   This document describes extensions to the Label Switched\
    \ Path (LSP)\n   Ping specified in [RFC4379] by adding a Relayed Echo Reply mechanism\n\
    \   that could be used to report data-plane failures for inter-AS\n   (Autonomous\
    \ System) and inter-area LSPs.  Without these extensions,\n   the ping functionality\
    \ provided by [RFC4379] would fail in many\n   deployed inter-AS scenarios, since\
    \ the replying Label Switching\n   Router (LSR) in one AS may not have an available\
    \ route to the\n   initiator in the other AS.  The mechanism in this document\
    \ defines a\n   new Message Type referred to as the \"Relayed Echo Reply message\"\
    \ and\n   a new TLV referred to as the \"Relay Node Address Stack TLV\".\n   This\
    \ document updates [RFC4379]; it includes updates to the Echo\n   Request sending\
    \ procedure in Section 4.3 of [RFC4379], the Echo\n   Request receiving procedure\
    \ in Section 4.4 of [RFC4379], the Echo\n   Reply sending procedure in Section\
    \ 4.5 of [RFC4379], and the Echo\n   Reply receiving procedure in Section 4.6\
    \ of [RFC4379].\n"
- title: 1.1.  Conventions Used in This Document
  contents:
  - "1.1.  Conventions Used in This Document\n   The key words \"MUST\", \"MUST NOT\"\
    , \"REQUIRED\", \"SHALL\", \"SHALL NOT\",\n   \"SHOULD\", \"SHOULD NOT\", \"RECOMMENDED\"\
    , \"MAY\", and \"OPTIONAL\" in this\n   document are to be interpreted as described\
    \ in [RFC2119].\n"
- title: 2.  Motivation
  contents:
  - "2.  Motivation\n   LSP Ping [RFC4379] defines a mechanism to detect data-plane\
    \ failures\n   and localize faults.  The mechanism specifies that the Echo Reply\n\
    \   should be sent back to the initiator using a UDP packet with the\n   IPv4/IPv6\
    \ destination address set to an address of the LSR that\n   originated the Echo\
    \ Request.  This works in administrative domains\n   where IP-address reachability\
    \ is allowed among LSRs and every LSR is\n   able to route back to the originating\
    \ LSR.  However, in practice,\n   this is often not the case due to intra-provider\
    \ routing policy,\n   route hiding, and network address translation at Autonomous\
    \ System\n   Border Routers (ASBRs).  In fact, it is almost always the case that\n\
    \   in inter-AS scenarios, the only node in one AS to which direct\n   routing\
    \ is allowed from the other AS is the ASBR, and routing\n   information from within\
    \ one AS is not distributed into another AS.\n   Figure 1 demonstrates a case\
    \ where an LSP is set up between PE1 and\n   PE2.  If PE1's IP address is not\
    \ distributed to AS2, a traceroute\n   from PE1 directed towards PE2 can result\
    \ in a failure because an LSR\n   in AS2 may not be able to send the Echo Reply\
    \ message.  For example,\n   P2 cannot forward packets back to PE1 given that\
    \ it is a routable IP\n   address in AS1 but not routable in AS2.  In this case,\
    \ PE1 would\n   detect a path break, as the Echo Reply messages would not be\n\
    \   received.  Then, localization of the actual fault would not be\n   possible.\n\
    \   Note that throughout the document, \"routable address\" means that it\n  \
    \ is possible to route an IP packet to this address using the normal\n   information\
    \ exchanged by the IGP and BGP (or EGP) operating in the\n   AS.\n   +-------+\
    \   +-------+   +------+   +------+   +------+   +------+\n   |       |   |  \
    \     |   |      |   |      |   |      |   |      |\n   |  PE1  +---+   P1  +---+\
    \ ASBR1+---+ ASBR2+---+  P2  +---+  PE2 |\n   |       |   |       |   |      |\
    \   |      |   |      |   |      |\n   +-------+   +-------+   +------+   +------+\
    \   +------+   +------+\n   <---------------AS1-------------><---------------AS2------------>\n\
    \   <---------------------------- LSP ------------------------------>\n      \
    \          Figure 1: Simple Inter-AS LSP Configuration\n   A second example that\
    \ illustrates how [RFC4379] would be insufficient\n   would be the inter-area\
    \ situation in a seamless MPLS architecture\n   [MPLSARCH] as shown below in Figure\
    \ 2.  In this example, LSRs in the\n   core network would not have an IP-reachable\
    \ route to any of the\n   access nodes (ANs).  When tracing an LSP from one AN\
    \ to the remote\n   AN, the LSR1/LSR2 node cannot send the Echo Reply either,\
    \ like the P2\n   node in the inter-AS scenario in Figure 1.\n              +-------+\
    \   +-------+   +------+   +------+\n              |       |   |       |   | \
    \     |   |      |\n           +--+ AGN11 +---+ AGN21 +---+ ABR1 +---+ LSR1 +-->\
    \ to AGN\n          /   |       |  /|       |   |      |   |      |\n   +----+/\
    \    +-------+\\/ +-------+   +------+  /+------+\n   | AN |              /\\\
    \                     \\/\n   +----+\\    +-------+  \\+-------+   +------+/\\\
    \ +------+\n          \\   |       |   |       |   |      |  \\|      |\n    \
    \       +--+ AGN12 +---+ AGN22 +---+ ABR2 +---+ LSR2 +--> to AGN\n           \
    \   |       |   |       |   |      |   |      |\n              +-------+   +-------+\
    \   +------+   +------+\n   static route    IS-IS L1 LDP            IS-IS L2 LDP\n\
    \   <-Access-><--Aggregation Domain--><---------Core--------->\n   AGN: aggregation\
    \ node\n                   Figure 2: Seamless MPLS Architecture\n   This document\
    \ describes extensions to the LSP Ping mechanism to\n   facilitate a response\
    \ from the replying LSR by defining a mechanism\n   that uses a relay node (e.g.,\
    \ ASBR) to relay the message back to the\n   initiator.  Every designated or learned\
    \ relay node must be reachable\n   to the next relay node or to the initiator.\
    \  Using a recursive\n   approach, a relay node could relay the message to the\
    \ next relay node\n   until the initiator is reached.\n   The LSP Ping relay mechanism\
    \ in this document is defined for unicast.\n   How to apply the LSP Ping relay\
    \ mechanism in multicast is out of\n   scope.\n"
- title: 3.  Extensions
  contents:
  - "3.  Extensions\n   [RFC4379] defines two Message Types: Echo Request and Echo\
    \ Reply.\n   This document defines a new Message Type: Relayed Echo Reply.  The\n\
    \   Relayed Echo Reply message is used in place of the Echo Reply message\n  \
    \ when an LSR is replying LSR to a relay node.\n   A new TLV named the \"Relay\
    \ Node Address Stack TLV\" is defined in this\n   document to carry the IP addresses\
    \ of the relay nodes for the\n   replying LSR.\n   In addition, the Maximum Transmission\
    \ Unit (MTU) Exceeded Return Code\n   is defined to indicate to the initiator\
    \ that one or more TLVs will\n   not be returned due to the MTU size.\n   It should\
    \ be noted that this document focuses only on detecting the\n   LSP that is set\
    \ up using a uniform IP address family type.  That is,\n   all hops between the\
    \ source and destination node use the same address\n   family type for their LSP\
    \ Ping control planes.  This does not\n   preclude nodes that support both IPv6\
    \ and IPv4 addresses\n   simultaneously, but the entire path must be addressable\
    \ using only\n   one address family type.  Support for mixed IPv4-only and IPv6-only\n\
    \   is beyond the scope of this document.\n"
- title: 3.1.  Relayed Echo Reply Message
  contents:
  - "3.1.  Relayed Echo Reply Message\n   The Relayed Echo Reply message is a UDP\
    \ packet, and the UDP payload\n   has the same format with Echo Request/Reply\
    \ message.  A new Message\n   Type is requested from IANA.\n   New Message Type:\n\
    \       Value    Meaning\n       -----    -------\n       5        MPLS Relayed\
    \ Echo Reply\n   The use of TCP and UDP port number 3503 is described in [RFC4379]\
    \ and\n   has been allocated by IANA for LSP Ping messages.  The Relayed Echo\n\
    \   Reply message will use the same port number.\n"
- title: 3.2.  Relay Node Address Stack
  contents:
  - "3.2.  Relay Node Address Stack\n   The Relay Node Address Stack TLV is an optional\
    \ TLV.  It MUST be\n   carried in the Echo Request, Echo Reply, and Relayed Echo\
    \ Reply\n   messages if the Echo Reply relayed mechanism described in this\n \
    \  document is required.  Figure 3 illustrates the TLV format.\n      0      \
    \             1                   2                   3\n      0 1 2 3 4 5 6 7\
    \ 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \     |                Type           |               Length          |\n    \
    \ +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     |  \
    \ Initiator Source Port       | Reply Add Type|   Reserved    |\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \     |    Source Address of Replying Router (0, 4, or 16 octets)     |\n    \
    \ +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     |  Destination\
    \ Address Offset   |   Number of Relayed Addresses |\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \     |                                                               |\n    \
    \ ~                Stack of Relayed Addresses                     ~\n     |  \
    \                                                             |\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                  Figure 3: Relay Node Address Stack TLV\n   -  Type: Value is\
    \ 32768.  The value has been assigned by IANA from\n      the 32768-49161 range\
    \ as suggested by [RFC4379], Section 3.\n   -  Length: The length of the value\
    \ field in octets.\n   -  Initiator Source Port: The source UDP port that the\
    \ initiator uses\n      in the Echo Request message, and the port that is expected\
    \ to\n      receive the Echo Reply message.\n   -  Reply Address Type: Address\
    \ type of replying router.  This value\n      also implies the length of the address\
    \ field as shown below.\n   Type#   Address Type   Address Length\n   ----   \
    \ ------------   ------------\n   0       Null           0\n   1       IPv4  \
    \         4\n   2       IPv6           16\n   -  Reserved: This field is reserved\
    \ and MUST be set to zero.\n   -  Source Address of Replying Router: Source IP\
    \ address of the\n      originator of Echo Reply or Relay Echo Reply message.\n\
    \   -  Destination Address Offset: The offset in octets from the top-of-\n   \
    \   stack to the destination address entry.  Each entry size has been\n      listed\
    \ in this section.  Please also refer to Section 4.2 for more\n      detail of\
    \ the operation.\n   -  Number of Relayed Addresses: An integer indicating the\
    \ number of\n      relayed addresses in the stack.\n   -  Stack of Relayed Addresses:\
    \ A list of relay node address entries.\n      This stack grows downward, with\
    \ relay node addresses that are\n      further along the LSP appearing lower down\
    \ in the stack.  Please\n      refer to Section 4.2 for the relay node discovery\
    \ mechanism.\n   The format of each relay node address entry is as below:\n  \
    \    0                   1                   2                   3\n      0 1\
    \ 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \     | Address  Type |K|  Reserved   |          Reserved             |\n    \
    \ +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     ~  \
    \         Relayed Address (0, 4, or 16 octets)                ~\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                    Figure 4: Relay Node Address Entry\n   Type#   Address Type\
    \   Address Length   Size of the Entry\n   ----    ------------   ------------\
    \     -----------------\n   0       Null           0                4\n   1  \
    \     IPv4           4                8\n   2       IPv6           16        \
    \       20\n   Reserved: The two fields are reserved and MUST be set to zero.\n\
    \   K bit: If the K bit is set to 1, then this address stack entry MUST\n   NOT\
    \ be stripped from the Relay Node Address Stack during the\n   processing described\
    \ in Section 4.2.  If the K bit is clear, the\n   entry might be stripped according\
    \ to the processing described in\n   Section 4.2.\n   Having the K bit set in\
    \ the relay node address entry causes that\n   entry to be preserved in the Relay\
    \ Node Address Stack TLV for the\n   entire traceroute operation.  A responder\
    \ node MAY set the K bit to\n   ensure its relay node address entry remains as\
    \ one of the relay nodes\n   in the Relay Node Address Stack TLV.  The address\
    \ with the K bit set\n   will always be a relay node address for the Relayed Echo\
    \ Reply, see\n   Section 4.3.\n   Relayed Address: This field specifies the node\
    \ address: either IPv4\n   or IPv6.\n"
- title: 3.3.  MTU Exceeded Return Code
  contents:
  - "3.3.  MTU Exceeded Return Code\n   This Return Code is defined to indicate that\
    \ one or more TLVs were\n   omitted from the Echo Reply or Relayed Echo Reply\
    \ message to avoid\n   exceeding the message's effective MTU size.  These TLVs\
    \ MAY be\n   included in an Errored TLV's Object with their lengths set to 0 and\n\
    \   no value.  The return sub-code MUST be set to the value that\n   otherwise\
    \ would have been sent.  For more detail, please refer to\n   Section 4.2.\n \
    \  MTU Exceeded Return Code:\n       Value    Meaning\n       -----    -------\n\
    \       20       One or more TLVs not returned due to MTU size\n   This document\
    \ updates step 7 in Section 4.4 of [RFC4379] to integrate\n   the processing of\
    \ the MTU Exceeded Return Code by adding the\n   following text:\n      Before\
    \ sending Echo Reply, the new packet size should be checked.\n      If Best-return-code\
    \ is 3 (\"Replying router is an egress for the\n      FEC at stack depth\"), or\
    \ 8 (\"Label switched at stack-depth\"), and\n      if the packet size exceeds\
    \ MTU size, then Best-return-code is 20\n      (\"One or more TLVs not returned\
    \ due to MTU size\").\n"
- title: 4.  Procedures
  contents:
  - "4.  Procedures\n   To perform a ping operation, the initiator first discovers\
    \ the relay\n   nodes.  Once those nodes have been discovered, the initiator includes\n\
    \   the Relay Node Address Stack TLV into any Echo Request message.  The\n   node\
    \ can then ping as normal.  Note that, in some cases, the repeated\n   lack of\
    \ replies to Echo Request messages may be due to a route change\n   that has impacted\
    \ the necessary stack of relay nodes.  In this case,\n   the initiator may need\
    \ to rediscover the relay nodes.  The following\n   sections describe the procedures\
    \ for sending and receiving Echo\n   Request messages with the Relay Node Address\
    \ Stack TLV.  These\n   procedures can be used in traceroute mode to discover\
    \ the relay\n   nodes.\n"
- title: 4.1.  Sending an Echo Request
  contents:
  - "4.1.  Sending an Echo Request\n   In addition to the procedures described in\
    \ Section 4.3 of [RFC4379],\n   a Relay Node Address Stack TLV MUST be carried\
    \ in the Echo Request\n   message if the relay functionality is required.  The\
    \ relay function\n   initiation is out of the scope of this document.  One possible\
    \ way to\n   do this is that the operator can explicitly add an option to the\
    \ ping\n   command.\n   When the initiator sends the first Echo Request with a\
    \ Relay Node\n   Address Stack TLV, the TLV MUST contain the initiator address\
    \ as the\n   first entry of the stack of relayed addresses, the Destination\n\
    \   Address Offset set to this entry, and the source address of the\n   replying\
    \ router set to null.  The Initiator Source Port field MUST be\n   set to the\
    \ source UDP port.  Note that the first relay node address\n   in the stack will\
    \ always be the initiator's address.\n   When sending a subsequent Echo Request\
    \ message, refer to Section 4.6.\n"
- title: 4.2.  Receiving an Echo Request
  contents:
  - "4.2.  Receiving an Echo Request\n   The Type of the Relay Node Address Stack\
    \ TLV (32768) falls within the\n   range defined in [RFC4379] as \"optional TLVs\"\
    \ that can be silently\n   dropped if not recognized.  An LSR that does not recognize\
    \ the TLV\n   SHOULD ignore it.\n   In addition to the processes in Section 4.4\
    \ of [RFC4379], the\n   procedures of the Relay Node Address Stack TLV are defined\
    \ here.\n   Upon receiving a Relay Node Address Stack TLV in an Echo Request\n\
    \   message, the receiver updates the \"Source Address of Replying\n   Router\"\
    .  The address MUST be the same as the source IP address of\n   Relay Echo Reply\
    \ (Section 4.3) or Echo Reply message (Section 4.5)\n   being sent.\n   Those\
    \ address entries with the K bit set to 1 MUST be kept in the\n   stack.  The\
    \ receiver MUST check the addresses of the stack in\n   sequence from bottom to\
    \ top to find the last address in the stack\n   with the K bit set (or the top\
    \ of the stack if no K bit was found).\n   The receiver then checks the stack\
    \ beginning with this entry,\n   proceeding towards the bottom to find the first\
    \ routable address IP\n   address.  The Destination Address Offset MUST be set\
    \ to this entry,\n   which is also the resolved destination address.  Address\
    \ entries\n   below the first routable IP address MUST be deleted.  At least one\n\
    \   address entry of the replying LSR MUST be added at the bottom of the\n   stack.\
    \  A second address entry (or more) MAY also be added if\n   necessary, depending\
    \ on implementation.  The final address added MUST\n   be an address that is reachable\
    \ through the interface that the Echo\n   Request message would have been forwarded\
    \ to if its TTL had not\n   expired at this node.  The updated Relay Node Address\
    \ Stack TLV MUST\n   be carried in the response message.\n   If the replying LSR\
    \ is configured to hide its routable address\n   information, the address entry\
    \ added in the stack MUST be a NIL entry\n   with Address Type set to NULL.\n\
    \   If a node spans two addressing domains (with respect to this message)\n  \
    \ where nodes on either side may not be able to reach nodes in the\n   other domain,\
    \ then the final address added SHOULD set the K bit.  One\n   example of spanning\
    \ two address domains is the ASBR node.\n   K bit applies in the case of a NULL\
    \ address, to serve as a warning to\n   the initiator that further Echo Request\
    \ messages may not result in\n   receiving Echo Reply messages.\n   If the full\
    \ reply message would exceed the MTU size, the Relay Node\n   Address Stack TLV\
    \ SHOULD be included in the Echo Reply message (i.e.,\n   other optional TLVs\
    \ are excluded).\n"
- title: 4.3.  Originating a Relayed Echo Reply
  contents:
  - "4.3.  Originating a Relayed Echo Reply\n   The destination address determined\
    \ as described in Section 4.2 is\n   used as the next relay node address.  If\
    \ the resolved next relay node\n   address is not routable, then the sending of\
    \ the Relayed Echo Reply\n   or Echo Reply will fail.\n   If the first IP address\
    \ in the Relay Node Address Stack TLV is not\n   the next relay node address,\
    \ the replying LSR SHOULD send a Relayed\n   Echo Reply message to the next relay\
    \ node.  The processing of Relayed\n   Echo Reply is the same with the procedure\
    \ of the Echo Reply described\n   in Section 4.5 of [RFC4379], except the destination\
    \ IP address and\n   the destination UDP port.  The destination IP address of\
    \ the Relayed\n   Echo Reply is set to the next relay node address from the Relay\
    \ Node\n   Address Stack TLV, and both the source and destination UDP port are\n\
    \   set to 3503.  The updated Relay Node Address Stack TLV described in\n   Section\
    \ 4.2 MUST be carried in the Relayed Echo Reply message.  The\n   Source Address\
    \ of the Replying Router field is kept unmodified, and\n   the Source IP address\
    \ field of the IP header is set to an address of\n   the sending node.\n   When\
    \ the next relay node address is the first one in the address\n   list, please\
    \ refer to Section 4.5.\n"
- title: 4.4.  Relaying a Relayed Echo Reply
  contents:
  - "4.4.  Relaying a Relayed Echo Reply\n   Upon receiving a Relayed Echo Reply message\
    \ with its own address as\n   the destination address in the IP header, the relay\
    \ node MUST\n   determine the next relay node address as described in Section\
    \ 4.2,\n   with the modification that the location of the received destination\n\
    \   address is used instead of the bottom of stack in the algorithm.  The\n  \
    \ Destination Address Offset in Relay Node Address Stack TLV will be\n   set to\
    \ the next relay node address.  Note that unlike in Section 4.2,\n   no changes\
    \ are made to the Stack of Relayed Addresses.\n   If the next relay node address\
    \ is not the first one in the address\n   list, i.e., another intermediate relay\
    \ node, the relay node MUST send\n   a Relayed Echo Reply message to the determined\
    \ upstream node with the\n   payload unchanged other than the Relay Node Address\
    \ Stack TLV.  The\n   TTL SHOULD be copied from the received Relay Echo Reply\
    \ and\n   decremented by 1.  The Source Address of the Replying Router field is\n\
    \   kept unmodified and the Source IP address field of the IP header is\n   set\
    \ to an address of the sending node.\n   When the next relay node address is the\
    \ first one in the address\n   list, please refer to Section 4.5.\n"
- title: 4.5.  Sending an Echo Reply
  contents:
  - "4.5.  Sending an Echo Reply\n   The Echo Reply is sent in two cases:\n   1. \
    \ When the replying LSR receives an Echo Request, and the first IP\n       address\
    \ in the Relay Node Address Stack TLV is the next relay\n       node address (Section\
    \ 4.3), the replying LSR would send an Echo\n       Reply to the initiator.  In\
    \ addition to the procedure of the Echo\n       Reply described in Section 4.5\
    \ of [RFC4379], the updated Relay\n       Node Address Stack TLV described in\
    \ Section 4.2 MUST be carried\n       in the Echo Reply.\n       If the receiver\
    \ does not recognize the Relay Node Address Stack\n       TLV, as per Sections\
    \ 3 and 4.5 of [RFC4379], it will send an Echo\n       Reply without including\
    \ the TLV.\n   2.  When the intermediate relay node receives a Relayed Echo Reply,\n\
    \       and the first IP address in the Relay Node Address Stack TLV is\n    \
    \   the next relay node address (Section 4.4), the intermediate relay\n      \
    \ node will send the Echo Reply to the initiator, and update the\n       Message\
    \ Type field from type of \"Relayed Echo Reply\" to \"Echo\n       Reply\".  The\
    \ updated Relay Node Address Stack TLV described in\n       Section 4.4 MUST be\
    \ carried in the Echo Reply.  The destination\n       IP address of the Echo Reply\
    \ is set to the first IP address in\n       the stack, and the destination UDP\
    \ port will be copied from the\n       Initiator Source Port field of the Relay\
    \ Node Address Stack TLV.\n       The source UDP port should be 3503.  The TTL\
    \ of the Echo Reply\n       SHOULD be copied from the received Relay Echo Reply\
    \ and\n       decremented by 1.  The Source Address of the Replying Router\n \
    \      field is kept unmodified, and the Source IP address field of the\n    \
    \   IP header is set to an address of the sending node.\n"
- title: 4.6.  Sending Subsequent Echo Requests
  contents:
  - "4.6.  Sending Subsequent Echo Requests\n   During a traceroute operation, multiple\
    \ Echo Request messages are\n   sent.  Each time the TTL is increased, the initiator\
    \ SHOULD copy the\n   Relay Node Address Stack TLV received in the previous Echo\
    \ Reply to\n   the next Echo Request.  The Relay Node Address Stack TLV MUST NOT\
    \ be\n   modified except as follows.  A NIL entry that does not have the K bit\n\
    \   set MAY be removed.  A NIL entry with the K bit serves as a warning\n   that\
    \ further Echo Request messages are likely not to result in a\n   reply.  If,\
    \ however, the initiator decides to continue a traceroute\n   operation, the NIL\
    \ entry with the K bit set MUST be removed.  The\n   Source Address of the Replying\
    \ Router and Destination Address Offset\n   fields may be preserved or reset since\
    \ these fields are ignored in\n   the received MPLS Echo Request.\n"
- title: 4.7.  Impact on Traceroute
  contents:
  - "4.7.  Impact on Traceroute\n   The Source IP address in Echo Reply and Relay\
    \ Echo Reply should be\n   the address of the node sending those packets, not\
    \ the original\n   responding node.  Then the traceroute address output module\
    \ will\n   print the source IP address as below:\n     if (Relay Node Address\
    \ Stack TLV exists) {\n   Print the Source Address of Replying Router in\n   Relay\
    \ Node Address Stack TLV;\n     } else {\n   Print the source IP address of Echo\
    \ Reply message;\n     }\n"
- title: 5.  LSP Ping Relayed Echo Reply Example
  contents:
  - "5.  LSP Ping Relayed Echo Reply Example\n   Considering the inter-AS scenario\
    \ in Figure 5 below, AS1 and AS2 are\n   two independent address domains.  In\
    \ the example, an LSP has been\n   created between PE1 to PE2, but PE1 in AS1\
    \ is not reachable by P2 in\n   AS2.\n   +-------+   +-------+   +------+   +------+\
    \   +------+   +------+\n   |       |   |       |   |      |   |      |   |  \
    \    |   |      |\n   |  PE1  +---+   P1  +---+ ASBR1+---+ ASBR2+---+  P2  +---+\
    \  PE2 |\n   |       |   |       |   |      |   |      |   |      |   |      |\n\
    \   +-------+   +-------+   +------+   +------+   +------+   +------+\n   <---------------AS1-------------><---------------AS2------------>\n\
    \   <--------------------------- LSP ------------------------------->\n      \
    \                Figure 5: Example Inter-AS LSP\n   When performing LSP traceroute\
    \ on the LSP, the first Echo Request\n   sent by PE1 with outermost label TTL=1\
    \ contains the Relay Node\n   Address Stack TLV with PE1's address as the first\
    \ relayed address.\n   After being processed by P1, P1's interface address facing\
    \ ASBR1\n   without the K bit set will be added in the Relay Node Address Stack\n\
    \   TLV address list following PE1's address in the Echo Reply.\n   PE1 copies\
    \ the Relay Node Address Stack TLV into the next Echo\n   Request when receiving\
    \ the Echo Reply.\n   Upon receiving the Echo Request, ASBR1 checks the address\
    \ list in the\n   Relay Node Address Stack TLV and determines that PE1's address\
    \ is the\n   next relay address.  Then it deletes P1's address, and adds its\n\
    \   interface address facing ASBR2 with the K bit set.  As a result,\n   there\
    \ will be PE1's address followed by ASBR1's interface address\n   facing ASBR2\
    \ in the Relay Node Address Stack TLV of the Echo Reply\n   sent by ASBR1.\n \
    \  PE1 then sends an Echo Request with outermost label TTL=3, containing\n   the\
    \ Relay Node Address Stack TLV copied from the received Echo Reply\n   message.\
    \  Upon receiving the Echo Request message, ASBR2 checks the\n   address list\
    \ in the Relay Node Address Stack TLV and determines that\n   ASBR1's interface\
    \ address is the next relay address in the stack TLV.\n   ASBR2 adds its interface\
    \ address facing P2 with the K bit set.  Then\n   ASBR2 sets the next relay address\
    \ as the destination address of the\n   Relayed Echo Reply and sends the Relayed\
    \ Echo Reply to ASBR1.\n   Upon receiving the Relayed Echo Reply from ASBR2, ASBR1\
    \ checks the\n   address list in the Relay Node Address Stack TLV and determines\
    \ that\n   PE1's address is the next relay node.  Then ASBR1 sends an Echo Reply\n\
    \   to PE1.\n   For the Echo Request with outermost label TTL=4, P2 checks the\n\
    \   address list in the Relay Node Address Stack TLV and determines that\n   ASBR2's\
    \ interface address is the next relay address.  Then P2 sends a\n   Relayed Echo\
    \ Reply to ASBR2 with the Relay Node Address Stack TLV\n   containing four addresses:\
    \ PE1's, ASBR1's interface address, ASBR2's\n   interface address, and P2's interface\
    \ address facing PE2 in sequence.\n   Then, according to the process described\
    \ in Section 4.4, ASBR2 sends\n   the Relayed Echo Reply to ASBR1.  Upon receiving\
    \ the Relayed Echo\n   Reply, ASBR1 sends an Echo Reply to PE1.  And, as relayed\
    \ by ASBR2\n   and ASBR1, the Echo Reply would finally be sent to the initiator\
    \ PE1.\n   For the Echo Request with outermost label TTL=5, the Echo Reply would\n\
    \   relayed to PE1 by ASBR2 and ASBR1, similar to the case of TTL=4.\n   The Echo\
    \ Reply from the replying node that has no IP reachable route\n   to the initiator\
    \ is thus transmitted to the initiator by multiple\n   relay nodes.\n"
- title: 6.  Security Considerations
  contents:
  - "6.  Security Considerations\n   The Relayed Echo Reply mechanism for LSP Ping\
    \ creates an increased\n   risk of DoS by putting the IP address of a target router\
    \ in the Relay\n   Node Address Stack.  These messages could then be used to attack\
    \ the\n   control plane of an LSR by overwhelming it with these packets.  A\n\
    \   rate limiter SHOULD be applied to the well-known UDP port on the\n   relay\
    \ node as suggested in [RFC4379].  The node that acts as a relay\n   node SHOULD\
    \ validate the relay reply against a set of valid source\n   addresses and discard\
    \ packets from untrusted border router addresses.\n   An implementation SHOULD\
    \ provide such filtering capabilities.\n   If an operator wants to obscure their\
    \ nodes, it is RECOMMENDED that\n   they replace the replying node address that\
    \ originated the Echo Reply\n   with the NIL address entry in the Relay Node Address\
    \ Stack TLV.\n   A receiver of an MPLS Echo Request could verify that the first\n\
    \   address in the Relay Node Address Stack TLV is the same address as\n   the\
    \ source IP address field of the received IP header.\n   The Relay Node Address\
    \ Stack TLV has the path information of the LSP,\n   and such information may\
    \ be maliciously used by any uncontrolled LSR/\n   LER.  We have two ways to reduce\
    \ the path information in the TLV:\n   o  It is recommended to clear the K bit\
    \ in the relay address entry\n      unless it must be set (e.g., as listed in\
    \ Section 4.2).\n   o  It is recommended to use the NIL address entry to hide\
    \ node\n      information, if possible.\n   Other security considerations discussed\
    \ in [RFC4379] are also\n   applicable to this document.\n"
- title: 7.  Backward Compatibility
  contents:
  - "7.  Backward Compatibility\n   When one of the nodes along the LSP does not support\
    \ the mechanism\n   specified in this document, the node will ignore the Relay\
    \ Node\n   Address Stack TLV as described in Section 4.2.  Then the initiator\n\
    \   may not receive the Relay Node Address Stack TLV in Echo Reply\n   message\
    \ from that node.  In this case, an indication should be\n   reported to the operator,\
    \ and the Relay Node Address Stack TLV in the\n   next Echo Request message should\
    \ be copied from the previous Echo\n   Request, and continue the ping process.\
    \  If the node described above\n   is located between the initiator and the first\
    \ relay node, the ping\n   process could continue without interruption.\n"
- title: 8.  IANA Considerations
  contents:
  - "8.  IANA Considerations\n   IANA has assigned one new Message Type, one new TLV,\
    \ and one Return\n   Code.\n"
- title: 8.1.  MPLS Relayed Echo Reply
  contents:
  - "8.1.  MPLS Relayed Echo Reply\n   One new Message Type from the \"Multi-Protocol\
    \ Label Switching (MPLS)\n   Label Switched Paths (LSPs) Ping Parameters\" registry\
    \ in the \"Message\n   Type\" subregistry has been allocated:\n        Value \
    \   Meaning\n        -----    -------\n        5        MPLS Relayed Echo Reply\n\
    \   The value has been assigned from the \"Standards Action\" [RFC5226]\n   range\
    \ (0-191) using the lowest free value within this range.\n"
- title: 8.2.  Relay Node Address Stack TLV
  contents:
  - "8.2.  Relay Node Address Stack TLV\n   One new TLV from the \"Multi-Protocol\
    \ Label Switching (MPLS) Label\n   Switched Paths (LSPs) Ping Parameters\" registry\
    \ in the \"TLVs\"\n   subregistry has been allocated:\n        Type    TLV Name\n\
    \        ----    --------\n        32768   Relay Node Address Stack TLV\n   The\
    \ value has been assigned from the \"Standards Action\" range\n   (32768-49161)\
    \ as suggested by [RFC4379] Sections 3 and 7.2 using the\n   first free value\
    \ within this range.\n"
- title: 8.3.  MTU Exceeded Return Code
  contents:
  - "8.3.  MTU Exceeded Return Code\n   The MTU Exceeded return code from the \"Multi-Protocol\
    \ Label Switching\n   (MPLS) Label Switched Paths (LSPs) Ping Parameters\" registry\
    \ in the\n   \"Return Codes\"subregistry has been allocated:\n       Value   \
    \ Meaning\n       -----    -------\n       20       One or more TLVs not returned\
    \ due to MTU size\n   The value has been assigned from the \"Standards Action\"\
    \ range (0-191)\n   using the lowest free value within this range.\n"
- title: 9.  References
  contents:
  - '9.  References

    '
- title: 9.1.  Normative References
  contents:
  - "9.1.  Normative References\n   [RFC2119]  Bradner, S., \"Key words for use in\
    \ RFCs to Indicate\n              Requirement Levels\", BCP 14, RFC 2119,\n  \
    \            DOI 10.17487/RFC2119, March 1997,\n              <http://www.rfc-editor.org/info/rfc2119>.\n\
    \   [RFC4379]  Kompella, K. and G. Swallow, \"Detecting Multi-Protocol\n     \
    \         Label Switched (MPLS) Data Plane Failures\", RFC 4379,\n           \
    \   DOI 10.17487/RFC4379, February 2006,\n              <http://www.rfc-editor.org/info/rfc4379>.\n"
- title: 9.2.  Informative References
  contents:
  - "9.2.  Informative References\n   [MPLSARCH] Leymann, N., Decraene, B., Filsfils,\
    \ C., Konstantynowicz,\n              M., and D. Steinberg, \"Seamless MPLS Architecture\"\
    , Work\n              in Progress, draft-ietf-mpls-seamless-mpls-07, June 2014.\n\
    \   [RFC5226]  Narten, T. and H. Alvestrand, \"Guidelines for Writing an\n   \
    \           IANA Considerations Section in RFCs\", BCP 26, RFC 5226,\n       \
    \       DOI 10.17487/RFC5226, May 2008,\n              <http://www.rfc-editor.org/info/rfc5226>.\n"
- title: Acknowledgements
  contents:
  - "Acknowledgements\n   The authors would like to thank Carlos Pignataro, Xinwen\
    \ Jiao, Manuel\n   Paul, Loa Andersson, Wim Henderickx, Mach Chen, Thomas Morin,\
    \ Gregory\n   Mirsky, Nobo Akiya, and Joel M. Halpern for their valuable comments\n\
    \   and suggestions.\n"
- title: Contributors
  contents:
  - "Contributors\n   Ryan Zheng\n   JSPTPD\n   371, Zhongshan South Road\n   Nanjing\
    \ 210006\n   China\n   Email: ryan.zhi.zheng@gmail.com\n"
- title: Authors' Addresses
  contents:
  - "Authors' Addresses\n   Jian Luo (editor)\n   ZTE\n   50, Ruanjian Avenue\n  \
    \ Nanjing  210012\n   China\n   Email: luo.jian@zte.com.cn\n   Lizhong Jin (editor)\n\
    \   Shanghai\n   China\n   Email: lizho.jin@gmail.com\n   Thomas Nadeau (editor)\n\
    \   Brocade\n   Email: tnadeau@lucidvision.com\n   George Swallow (editor)\n \
    \  Cisco Systems\n   Email: swallow@cisco.com\n"
