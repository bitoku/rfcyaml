- title: __initial_text__
  contents:
  - '          Mobile IPv6 Support for Dual Stack Hosts and Routers

    '
- title: Status of This Memo
  contents:
  - "Status of This Memo\n   This document specifies an Internet standards track protocol\
    \ for the\n   Internet community, and requests discussion and suggestions for\n\
    \   improvements.  Please refer to the current edition of the \"Internet\n   Official\
    \ Protocol Standards\" (STD 1) for the standardization state\n   and status of\
    \ this protocol.  Distribution of this memo is unlimited.\n"
- title: Copyright Notice
  contents:
  - "Copyright Notice\n   Copyright (c) 2009 IETF Trust and the persons identified\
    \ as the\n   document authors.  All rights reserved.\n   This document is subject\
    \ to BCP 78 and the IETF Trust's Legal\n   Provisions Relating to IETF Documents\
    \ in effect on the date of\n   publication of this document (http://trustee.ietf.org/license-info).\n\
    \   Please review these documents carefully, as they describe your rights\n  \
    \ and restrictions with respect to this document.\n"
- title: Abstract
  contents:
  - "Abstract\n   The current Mobile IPv6 and Network Mobility (NEMO) specifications\n\
    \   support IPv6 only.  This specification extends those standards to\n   allow\
    \ the registration of IPv4 addresses and prefixes, respectively,\n   and the transport\
    \ of both IPv4 and IPv6 packets over the tunnel to\n   the home agent.  This specification\
    \ also allows the mobile node to\n   roam over both IPv6 and IPv4, including the\
    \ case where Network\n   Address Translation is present on the path between the\
    \ mobile node\n   and its home agent.\n"
- title: Table of Contents
  contents:
  - "Table of Contents\n   1. Introduction ....................................................3\n\
    \      1.1. Requirements Notation ......................................4\n  \
    \    1.2. Motivation for Using Mobile IPv6 Only ......................4\n    \
    \  1.3. Scenarios Considered by This Specification .................4\n   2. Solution\
    \ Overview ...............................................6\n      2.1. Home Agent\
    \ Address Discovery ...............................6\n      2.2. Mobile Prefix\
    \ Solicitation and Advertisement ...............7\n      2.3. Binding Management\
    \ .........................................8\n           2.3.1. Foreign Network\
    \ Supports IPv6 .......................8\n           2.3.2. Foreign Network Supports\
    \ IPv4 Only ..................9\n      2.4. Route Optimization ........................................11\n\
    \      2.5. Dynamic IPv4 Home Address Allocation ......................11\n  \
    \ 3. Extensions and Modifications to Mobile IPv6 ....................11\n    \
    \  3.1. Binding Update Extensions .................................11\n      \
    \     3.1.1. IPv4 Home Address Option ...........................11\n        \
    \   3.1.2. The IPv4 Care-of Address Option ....................13\n          \
    \ 3.1.3. The Binding Update Message Extensions ..............13\n      3.2. Binding\
    \ Acknowledgement Extensions ........................14\n           3.2.1. IPv4\
    \ Address Acknowledgement Option ................14\n           3.2.2. The NAT\
    \ Detection Option ...........................16\n   4. Protocol Operation .............................................17\n\
    \      4.1. Tunnelling Formats ........................................17\n  \
    \         4.1.1. Tunnelling Impacts on Transport and MTU ............18\n    \
    \  4.2. NAT Detection .............................................19\n      4.3.\
    \ NAT Keepalives ............................................21\n      4.4. Mobile\
    \ Node Operation .....................................22\n           4.4.1. Selecting\
    \ a Care-of Address ........................22\n           4.4.2. Sending Binding\
    \ Updates ............................23\n           4.4.3. Sending Packets from\
    \ a Visited Network .............25\n           4.4.4. Movement Detection in IPv4-Only\
    \ Networks ...........26\n      4.5. Home Agent Operation ......................................26\n\
    \           4.5.1. Sending Packets to the Mobile Node .................28\n  \
    \    4.6. Correspondent Node Operation ..............................29\n   5.\
    \ Security Considerations ........................................29\n      5.1.\
    \ Handover Interactions for IPsec and IKE ...................30\n      5.2. IKE\
    \ Negotiation Messages between the Mobile Node\n           and Home Agent ............................................33\n\
    \           5.2.1. IKEv2 Operation for Securing DSMIPv6 Signaling .....33\n  \
    \         5.2.2. IKEv2 Operation for Securing Data over IPv4 ........36\n   6.\
    \ Protocol Constants .............................................38\n   7. Acknowledgements\
    \ ...............................................38\n   8. IANA Considerations\
    \ ............................................38\n   9. References .....................................................39\n\
    \      9.1. Normative References ......................................39\n  \
    \    9.2. Informative References ....................................40\n   10.\
    \ Contributors ..................................................41\n"
- title: 1.  Introduction
  contents:
  - "1.  Introduction\n   Mobile IPv6 [RFC3775] and NEMO [RFC3963] allow mobile nodes\
    \ to move\n   within the Internet while maintaining reachability and ongoing\n\
    \   sessions, using an IPv6 home address or prefix.  However, since IPv6\n   is\
    \ not widely deployed, it is unlikely that mobile nodes will\n   initially use\
    \ only IPv6 addresses for their connections.  It is\n   reasonable to assume that\
    \ mobile nodes will, for a long time, need an\n   IPv4 home address that can be\
    \ used by upper layers.  It is also\n   reasonable to assume that mobile nodes\
    \ will move to networks that\n   might not support IPv6 and would therefore need\
    \ the capability to\n   support an IPv4 care-of address.  Hence, this specification\
    \ extends\n   Mobile IPv6 capabilities to allow dual stack mobile nodes to request\n\
    \   that their home agent (also dual stacked) tunnel IPv4/IPv6 packets\n   addressed\
    \ to their home addresses, as well as IPv4/IPv6 care-of\n   address(es).\n   Using\
    \ this specification, mobile nodes would only need Mobile IPv6\n   and [RFC3963]\
    \ to manage mobility while moving within the Internet,\n   hence eliminating the\
    \ need to run two mobility management protocols\n   simultaneously.  This specification\
    \ provides the extensions needed in\n   order to allow dual stack mobile nodes\
    \ to use IPv6 mobility only.\n   This specification will also consider cases where\
    \ a mobile node moves\n   into a private IPv4 network and gets configured with\
    \ a private IPv4\n   care-of address.  In these scenarios, the mobile node needs\
    \ to be\n   able to traverse the IPv4 NAT in order to communicate with the home\n\
    \   agent.  IPv4 NAT traversal for Mobile IPv6 is presented in this\n   specification.\n\
    \   In this specification, the term \"mobile node\" refers to both a mobile\n\
    \   host and a mobile router unless the discussion is specific to either\n   hosts\
    \ or routers.  Similarly, we use the term \"home address\" to\n   reflect an address/prefix\
    \ format.  Note that both mobile host and\n   router functionality have already\
    \ been defined in [RFC3775] and\n   [RFC3963], respectively.  This specification\
    \ does not change those\n   already defined behaviors, nor does it extend the\
    \ specific types of\n   hosts and router support already defined, with the following\
    \ two\n   exceptions: (i) allowing the mobile node to communicate with its home\n\
    \   agent even over IPv4 networks, and (ii) allowing the use of IPv4 home\n  \
    \ addresses and prefixes.\n   In this specification, extensions are defined for\
    \ the binding update\n   and binding acknowledgement.  It should be noted that\
    \ all these\n   extensions apply to cases where the mobile node communicates with\
    \ a\n   Mobility Anchor Point (MAP) as defined in [RFC5380].  The\n   requirements\
    \ on the MAP are identical to those stated for the home\n   agent; however, it\
    \ is unlikely that NAT traversal would be needed\n   with a MAP, as it is expected\
    \ to be in the same address domain.\n"
- title: 1.1.  Requirements Notation
  contents:
  - "1.1.  Requirements Notation\n   The key words \"MUST\", \"MUST NOT\", \"REQUIRED\"\
    , \"SHALL\", \"SHALL NOT\",\n   \"SHOULD\", \"SHOULD NOT\", \"RECOMMENDED\", \"\
    MAY\", and \"OPTIONAL\" in this\n   document are to be interpreted as described\
    \ in [RFC2119].\n"
- title: 1.2.  Motivation for Using Mobile IPv6 Only
  contents:
  - "1.2.  Motivation for Using Mobile IPv6 Only\n   IPv6 offers a number of improvements\
    \ over today's IPv4, primarily due\n   to its large address space.  Mobile IPv6\
    \ offers a number of\n   improvements over Mobile IPv4 [RFC3344], mainly due to\
    \ capabilities\n   inherited from IPv6.  For instance, route optimization and\
    \ dynamic\n   home agent discovery can only be achieved with Mobile IPv6.\n  \
    \ One of the advantages of the large address space provided by IPv6 is\n   that\
    \ it allows mobile nodes to obtain a globally unique care-of\n   address wherever\
    \ they are.  Hence, there is no need for Network\n   Address Translator (NAT)\
    \ traversal techniques designed for Mobile\n   IPv4.  This allows Mobile IPv6\
    \ to be a significantly simpler and more\n   bandwidth-efficient mobility management\
    \ protocol.  At the same time,\n   during the transition towards IPv6, NAT traversal\
    \ for existing\n   private IPv4 networks needs to be considered.  This specification\n\
    \   introduces NAT traversal for this purpose.\n   The above benefits make the\
    \ case for using only Mobile IPv6 for dual\n   stack mobile nodes, as it allows\
    \ for a long-lasting mobility\n   solution.  The use of Mobile IPv6 for dual stack\
    \ mobility eliminates\n   the need for changing the mobility solution due to the\
    \ introduction\n   of IPv6 within a deployed network.\n"
- title: 1.3.  Scenarios Considered by This Specification
  contents:
  - "1.3.  Scenarios Considered by This Specification\n   There are several scenarios\
    \ that illustrate potential\n   incompatibilities for mobile nodes using Mobile\
    \ IPv6.  Some of the\n   problems associated with mobility and transition issues\
    \ were\n   presented in [RFC4977].  This specification considers the scenarios\n\
    \   that address all the problems discussed in [RFC4977].  The scenarios\n   considered\
    \ in this specification are listed below.\n   All of the following scenarios assume\
    \ that both the mobile node and\n   the home agent are IPv4- and IPv6-enabled\
    \ and that only Mobile IPv6\n   is used between the mobile node and the home agent.\
    \  We also assume\n   that the home agent is always reachable through a globally\
    \ unique\n   IPv4 address.  Finally, it's important to note that the following\n\
    \   scenarios are not mutually exclusive.\n   Scenario 1: IPv4-only foreign network\n\
    \   In this scenario, a mobile node is connected to an IPv4-only foreign\n   network.\
    \  The mobile node can only configure an IPv4 care-of address.\n   Scenario 2:\
    \ Mobile node behind a NAT\n   In this scenario, the mobile node is in a private\
    \ IPv4 foreign\n   network that has a NAT device connecting it to the Internet.\
    \  If the\n   home agent is located outside the NAT device, the mobile node will\n\
    \   need a NAT traversal mechanism to communicate with the home agent.\n   It\
    \ should be noted that [RFC5389] highlights issues with some types\n   of NATs\
    \ that act as generic Application Level Gateways (ALGs) and\n   rewrite any 32-bit\
    \ field containing the NAT's public IP addresses.\n   This specification will\
    \ not support such NATs.\n   Scenario 3: Home agent behind a NAT\n   In this scenario,\
    \ the communication between the mobile node and the\n   home agent is further\
    \ complicated by the fact that the home agent is\n   located within a private\
    \ IPv4 network.  However, in this scenario, we\n   assume that the home agent\
    \ is allocated a globally unique IPv4\n   address.  The address might not be physically\
    \ configured on the home\n   agent interface.  Instead, it is associated with\
    \ the home agent on\n   the Network Address Port Translation (NAPT) device, which\
    \ allows the\n   home agent to be reachable through address or port mapping.\n\
    \   Scenario 4: Use of IPv4-only applications\n   In this scenario, the mobile\
    \ node may be located in an IPv4, IPv6, or\n   dual network.  However, the mobile\
    \ node might be communicating with\n   an IPv4-only node.  In this case, the mobile\
    \ node would need a stable\n   IPv4 address for its application.  The alternative\
    \ to using an IPv4\n   address is to use protocol translators; however, end-to-end\n\
    \   communication with IPv4 is preferred to the use of protocol\n   translators.\n\
    \   The mobile node may also be communicating with an IPv4-only\n   application\
    \ that requires an IPv4 address.\n   The cases above illustrate the need for the\
    \ allocation of a stable\n   IPv4 home address to the mobile node.  This is done\
    \ using an IPv4\n   home address.  Since running Mobile IPv4 and Mobile IPv6\n\
    \   simultaneously is problematic (as illustrated in [RFC4977]), this\n   scenario\
    \ adds a requirement on Mobile IPv6 to support IPv4 home\n   addresses.\n   Scenario\
    \ 5: IPv6 and IPv4-enabled networks\n   In this scenario, the mobile node should\
    \ prefer the use of an IPv6\n   care-of address for either its IPv6 or IPv4 home\
    \ address.  Normal\n   IP-in-IP tunnelling should be used in this scenario as\
    \ described in\n   [RFC3775].  Under rare exceptions, where IP-in-IP tunnelling\
    \ for IPv6\n   does not allow the mobile node to reach the home agent, the mobile\n\
    \   node follows the sending algorithm described in Section 4.4.1.  UDP\n   tunnelling\
    \ in IPv6 networks is proposed in this document as a last-\n   resort mechanism\
    \ when reachability cannot be achieved through normal\n   IP-in-IP tunnelling.\
    \  It should not be viewed as a normal mode of\n   operation and should not be\
    \ used as a first resort.\n"
- title: 2.  Solution Overview
  contents:
  - "2.  Solution Overview\n   In order to allow Mobile IPv6 to be used by dual stack\
    \ mobile nodes,\n   the following needs to be done:\n   o  Mobile nodes should\
    \ be able to use IPv4 and IPv6 home or care-of\n      addresses simultaneously\
    \ and to update their home agents\n      accordingly.\n   o  Mobile nodes need\
    \ to be able to know the IPv4 address of the home\n      agent as well as its\
    \ IPv6 address.  There is no need for IPv4\n      prefix discovery, however.\n\
    \   o  Mobile nodes need to be able to detect the presence of a NAT\n      device\
    \ and traverse it in order to communicate with the home\n      agent.\n   This\
    \ section presents an overview of the extensions required in order\n   to allow\
    \ mobile nodes to use only Mobile IPv6 for IP mobility\n   management.\n"
- title: 2.1.  Home Agent Address Discovery
  contents:
  - "2.1.  Home Agent Address Discovery\n   Dynamic Home Agent Address Discovery (DHAAD)\
    \ is defined in [RFC3775]\n   to allow mobile nodes to discover their home agents\
    \ by appending a\n   well-known anycast interface identifier to their home link's\
    \ prefix.\n   However, this mechanism is based on IPv6-anycast routing.  If a\n\
    \   mobile node (MN) is located in an IPv4-only foreign network, it\n   cannot\
    \ rely on native IPv6 routing.  In this scenario, the solution\n   for discovering\
    \ the home agent's IPv4 address is through the Domain\n   Name System (DNS). \
    \ If the MN is attached to an IPv6-only or dual\n   stack network, it may also\
    \ use procedures defined in [CHOWDHURY] to\n   discover home agent information.\
    \  Note that the use of [CHOWDHURY]\n   cannot give the mobile node information\
    \ that allows it to communicate\n   with the home agent if the mobile node is\
    \ located in an IPv4-only\n   network.  In this scenario, the mobile node needs\
    \ to discover the\n   IPv4 address of its home agent through the DNS.\n   For\
    \ DNS lookup by name, the mobile node should be configured with the\n   name of\
    \ the home agent.  When the mobile node needs to discover a\n   home agent, it\
    \ sends a DNS request with QNAME set to the configured\n   name.  An example is\
    \ \"ha1.example.com\".  If a home agent has an IPv4\n   and IPv6 address, the\
    \ corresponding DNS record should be configured\n   with both 'AAAA' and 'A' records.\
    \  Accordingly, the DNS reply will\n   contain 'AAAA' and 'A' records.\n   For\
    \ DNS lookup by service, the SRV record defined in [RFC5026] is\n   reused.  For\
    \ instance, if the service name is \"mip6\" and the protocol\n   name is \"ipv6\"\
    \ in the SRV record, the mobile node SHOULD send a DNS\n   request with the QNAME\
    \ set to \"_mip6._ipv6.example.com\".  The\n   response should contain the home\
    \ agent's FQDN(s) and may include the\n   corresponding 'AAAA' and 'A' records\
    \ as well.\n   If multiple home agents reside on the home link, each configured\
    \ with\n   a public IPv4 address, then the operation above applies.  The correct\n\
    \   DNS entries can be configured accordingly.\n"
- title: 2.2.  Mobile Prefix Solicitation and Advertisement
  contents:
  - "2.2.  Mobile Prefix Solicitation and Advertisement\n   According to [RFC3775],\
    \ the mobile node can send a Mobile Prefix\n   Solicitation and receive a Mobile\
    \ Prefix Advertisement containing all\n   prefixes advertised on the home link.\n\
    \   A dual stack mobile node MAY send a Mobile Prefix Solicitation\n   message\
    \ encapsulated in IPv4 (i.e., IPv6 in IPv4) in the case where\n   the mobile node\
    \ has no access to IPv6 within the local network.\n   Securing these messages\
    \ requires the mobile node to have a security\n   association with the home agent,\
    \ using IPsec and based on the mobile\n   node's IPv4 care-of address as described\
    \ in [RFC3775] and [RFC4877].\n   [RFC3775] requires the mobile node to include\
    \ the home address option\n   in the solicitation message sent to the home agent.\
    \  If the mobile\n   node is located in an IPv4 network, it will not be assigned\
    \ an IPv6\n   address to include in the source address.  In this case, the mobile\n\
    \   node MUST use its home address in the source address field of the\n   IPv6\
    \ packet, in addition to using the home address option as expected\n   by [RFC3775].\n"
- title: 2.3.  Binding Management
  contents:
  - "2.3.  Binding Management\n   A dual stack mobile node will need to update its\
    \ home agent with its\n   care-of address.  If a mobile node has an IPv4 and an\
    \ IPv6 home\n   address, it will need to create a binding cache entry for each\n\
    \   address.  The format of the IP packet carrying the binding update and\n  \
    \ acknowledgement messages will vary depending on whether the mobile\n   node\
    \ has access to IPv6 in the visited network.  There are three\n   different scenarios\
    \ to consider with respect to the visited network:\n   o  The visited network\
    \ has IPv6 connectivity and provides the mobile\n      node with a care-of address\
    \ (in a stateful or stateless manner).\n   o  The mobile node can only configure\
    \ a globally unique IPv4 address\n      in the visited network.\n   o  The mobile\
    \ node can only configure a private IPv4 address in the\n      visited network.\n"
- title: 2.3.1.  Foreign Network Supports IPv6
  contents:
  - "2.3.1.  Foreign Network Supports IPv6\n   In this case, the mobile node is able\
    \ to configure a globally unique\n   IPv6 address.  The mobile node will send\
    \ a binding update to the IPv6\n   address of its home agent, as defined in [RFC3775].\
    \  The binding\n   update MAY include the IPv4 home address option introduced\
    \ in this\n   document.  After receiving the binding update, the home agent creates\n\
    \   two binding cache entries: one for the mobile node's IPv4 home\n   address\
    \ and another for the mobile node's IPv6 home address.  Both\n   entries will\
    \ point to the mobile node's IPv6 care-of address.  Hence,\n   whenever a packet\
    \ is addressed to the mobile node's IPv4 or IPv6 home\n   address, the home agent\
    \ will tunnel it in IPv6 to the mobile node's\n   IPv6 care-of address that is\
    \ included in the binding update.\n   Effectively, the mobile node establishes\
    \ two different tunnels, one\n   for its IPv4 traffic (IPv4 in IPv6) and one for\
    \ its IPv6 traffic\n   (IPv6 in IPv6), with a single binding update.\n   In this\
    \ scenario, this document extends [RFC3775] by including the\n   IPv4 home address\
    \ option in the binding update message.  Furthermore,\n   if the network supports\
    \ both IPv4 and IPv6, or if the mobile node is\n   experiencing problems with\
    \ IP-in-IP tunnelling, this document\n   proposes some mitigating actions as described\
    \ in Section 4.4.1.\n   After accepting the binding update and creating the corresponding\n\
    \   binding cache entries, the home agent MUST send a binding\n   acknowledgement\
    \ to the mobile node as defined in [RFC3775].  In\n   addition, if the binding\
    \ update included an IPv4 home address option,\n   the binding acknowledgement\
    \ MUST include the IPv4 address\n   acknowledgment option as described in Section\
    \ 3.2.1.  This option\n   informs the mobile node whether the binding was accepted\
    \ for the IPv4\n   home address.  If this option is not included in the binding\n\
    \   acknowledgement and the IPv4 home address option was included in the\n   binding\
    \ update, the mobile node MUST assume that the home agent does\n   not support\
    \ the IPv4 home address option and therefore SHOULD NOT\n   include the option\
    \ in future binding updates to that home agent\n   address.\n   When a mobile\
    \ node acquires both IPv4 and IPv6 care-of addresses at\n   the foreign network,\
    \ it SHOULD prioritize the IPv6 care-of address\n   for its MIPv6 binding as described\
    \ in Section 4.4.1.\n"
- title: 2.3.2.  Foreign Network Supports IPv4 Only
  contents:
  - "2.3.2.  Foreign Network Supports IPv4 Only\n   If the mobile node is in a foreign\
    \ network that only supports IPv4,\n   it needs to detect whether a NAT is in\
    \ its communication path to the\n   home agent.  This is done while exchanging\
    \ the binding update and\n   acknowledgement messages as shown later in this document.\
    \  NAT\n   detection is needed for the purposes of the signaling presented in\n\
    \   this specification.\n"
- title: 2.3.2.1.  Foreign Network Supports IPv4 Only (Public Addresses)
  contents:
  - "2.3.2.1.  Foreign Network Supports IPv4 Only (Public Addresses)\n   In this scenario,\
    \ the mobile node will need to tunnel IPv6 packets\n   containing the binding\
    \ update to the home agent's IPv4 address.  The\n   mobile node uses the IPv4\
    \ address it gets from the foreign network as\n   a source address in the outer\
    \ header.  The binding update will\n   contain the mobile node's IPv6 home address.\
    \  However, since the\n   care-of address in this scenario is the mobile node's\
    \ IPv4 address,\n   the mobile node MUST include its IPv4 care-of address in the\
    \ IPv6\n   packet.  The IPv4 address is represented in the IPv4 care-of address\n\
    \   option defined in this specification.  If the mobile node had an IPv4\n  \
    \ home address, it MUST also include the IPv4 home address option\n   described\
    \ in this specification.\n   After accepting the binding update, the home agent\
    \ MUST create a new\n   binding cache entry for the mobile node's IPv6 home address.\
    \  If an\n   IPv4 home address option is included, the home agent MUST create\n\
    \   another entry for that address.  All entries MUST point to the mobile\n  \
    \ node's IPv4 care-of address.  Hence, all packets addressed to the\n   mobile\
    \ node's home address(es) (IPv4 or IPv6) will be encapsulated in\n   an IPv4 header\
    \ that includes the home agent's IPv4 address in the\n   source address field\
    \ and the mobile node's IPv4 care-of address in\n   the destination address field.\n\
    \   After accepting the binding updates and creating the corresponding\n   entries,\
    \ the home agent MUST send a binding acknowledgement as\n   specified in [RFC3775].\
    \  In addition, if the binding update included\n   an IPv4 home address option,\
    \ the binding acknowledgement MUST include\n   the IPv4 address acknowledgment\
    \ option as described in Section 3.2.1.\n   The binding acknowledgement is encapsulated\
    \ to the IPv4 care-of\n   address, which was included in the source address field\
    \ of the IPv4\n   header encapsulating the binding update.\n"
- title: 2.3.2.2.  Foreign Network Supports IPv4 Only (Private Addresses)
  contents:
  - "2.3.2.2.  Foreign Network Supports IPv4 Only (Private Addresses)\n   In this\
    \ scenario the mobile node will need to tunnel IPv6 packets\n   containing the\
    \ binding update to the home agent's IPv4 address.  In\n   order to traverse the\
    \ NAT device, IPv6 packets are tunneled using UDP\n   and IPv4.  The UDP port\
    \ allocated for the home agent is 4191\n   (dsmipv6).\n   The mobile node uses\
    \ the IPv4 address it gets from the visited\n   network as a source address in\
    \ the IPv4 header.  The binding update\n   will contain the mobile node's IPv6\
    \ home address.\n   After accepting the binding update, the home agent MUST create\
    \ a new\n   binding cache entry for the mobile node's IPv6 home address.  If an\n\
    \   IPv4 home address option is included, the home agent MUST create\n   another\
    \ entry for that address.  All entries MUST point to the mobile\n   node's IPv4\
    \ care-of address included in the source address of the\n   IPv4 header that encapsulated\
    \ the binding update message.  In\n   addition, the tunnel used MUST indicate\
    \ UDP encapsulation for NAT\n   traversal.  Hence, all packets addressed to the\
    \ mobile node's home\n   address(es) (IPv4 or IPv6) will be encapsulated in UDP\
    \ and then\n   encapsulated in an IPv4 header that includes the home agent's IPv4\n\
    \   address in the source address field and the mobile node's IPv4 care-\n   of\
    \ address in the destination address field.  Note that the home\n   agent MUST\
    \ store the source UDP port numbers contained in the packet\n   carrying the binding\
    \ update in order to be able to forward packets to\n   the mobile node.\n   After\
    \ accepting the binding updates and creating the corresponding\n   entries, the\
    \ home agent MUST send a binding acknowledgement as\n   specified in [RFC3775].\
    \  In addition, if the binding update included\n   an IPv4 home address option,\
    \ the binding acknowledgement MUST include\n   the IPv4 address acknowledgment\
    \ option as described later in this\n   specification.  The binding acknowledgement\
    \ is encapsulated in UDP\n   and then in IPv4 with the home agent's IPv4 address\
    \ in the source\n   address field and the mobile node's IPv4 care-of address in\
    \ the\n   destination field.  The IPv4 address in the destination field of the\n\
    \   IPv4 packet is the source address that was received in the IPv4\n   header\
    \ containing the binding update message.  The inner IPv6 packet\n   will contain\
    \ the home agent's IPv6 address as a source address and\n   the mobile node's\
    \ IPv6 home address in the destination address field.\n   The mobile node needs\
    \ to maintain the NAT bindings for its current\n   IPv4 care-of address.  This\
    \ is done through sending the binding\n   update regularly to the home agent.\n"
- title: 2.4.  Route Optimization
  contents:
  - "2.4.  Route Optimization\n   Route optimization, as specified in [RFC3775], will\
    \ operate in an\n   identical manner for dual stack mobile nodes when they are\
    \ located in\n   a visited network that provides IPv6 addresses to the mobile\
    \ node and\n   while communicating with an IPv6-enabled correspondent node.\n\
    \   However, when located in an IPv4-only network, or when using the IPv4\n  \
    \ home address to communicate with an IPv4 correspondent node, route\n   optimization\
    \ will not be possible due to the difficulty of performing\n   the return-routability\
    \ test.  In this specification, UDP\n   encapsulation is only used between the\
    \ mobile node and its home\n   agent.  Therefore, mobile nodes will need to communicate\
    \ through the\n   home agent.\n   Route optimization will not be possible for\
    \ IPv4 traffic -- that is,\n   traffic addressed to the mobile node's IPv4 home\
    \ address.  This is\n   similar to using Mobile IPv4; therefore, there is no reduction\
    \ of\n   features resulting from using this specification.\n"
- title: 2.5.  Dynamic IPv4 Home Address Allocation
  contents:
  - "2.5.  Dynamic IPv4 Home Address Allocation\n   It is possible to allow for the\
    \ mobile node's IPv4 home address to be\n   allocated dynamically.  This is done\
    \ by including 0.0.0.0 in the IPv4\n   home address option that is included in\
    \ the binding update.  The home\n   agent SHOULD allocate an IPv4 address to the\
    \ mobile node and include\n   it in the IPv4 address acknowledgement option sent\
    \ to the mobile\n   node.  In this case, the lifetime of the binding is bound\
    \ to the\n   minimum of the lifetimes of the IPv6 binding and the lease time of\n\
    \   the IPv4 home address.\n"
- title: 3.  Extensions and Modifications to Mobile IPv6
  contents:
  - "3.  Extensions and Modifications to Mobile IPv6\n   This section highlights the\
    \ protocol and implementation additions\n   required to support this specification.\n"
- title: 3.1.  Binding Update Extensions
  contents:
  - '3.1.  Binding Update Extensions

    '
- title: 3.1.1.  IPv4 Home Address Option
  contents:
  - "3.1.1.  IPv4 Home Address Option\n   This option is included in the mobility\
    \ header, including the binding\n   update message sent from the mobile node to\
    \ a home agent or Mobility\n   Anchor Point.  The alignment requirement for this\
    \ option is 4n.\n    0                   1                   2               \
    \    3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n\
    \   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |  \
    \ Type        |   Length      |Prefix-len |P|    Reserved     |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |                     IPv4 home address                         |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                    Figure 1: IPv4 Home Address Option\n   Type\n      29\n \
    \  Length\n      6\n   Prefix-len\n      The length of the prefix allocated to\
    \ the mobile node.  If only a\n      single address is allocated, this field MUST\
    \ be set to 32.  In the\n      first binding update requesting a prefix, the field\
    \ contains the\n      prefix length requested.  However, in the following binding\n\
    \      updates, this field must contain the length of the prefix\n      allocated.\
    \  A value of zero is invalid and MUST be considered an\n      error.\n   P\n\
    \      A flag indicating, when set, that the mobile node requests a\n      mobile\
    \ network prefix.  This flag is only relevant for new\n      requests, and must\
    \ be ignored for binding refreshes.\n   Reserved\n      This field is reserved\
    \ for future use.  It MUST be set to zero by\n      the sender and ignored by\
    \ the receiver.\n   IPv4 Home Address\n      The mobile node's IPv4 home address\
    \ that should be defended by the\n      home agent.  This field could contain\
    \ any unicast IPv4 address\n      (public or private) that was assigned to the\
    \ mobile node.  The\n      value 0.0.0.0 is used to request an IPv4 home address\
    \ from the\n      home agent.  A mobile node may choose to use this option to\n\
    \      request a prefix by setting the address to All Zeroes and setting\n   \
    \   the P flag.  The mobile node could then form an IPv4 home address\n      based\
    \ on the allocated prefix.  Alternatively, the mobile node may\n      use two\
    \ different options, one for requesting an address (static\n      or dynamic)\
    \ and another for requesting a prefix.\n"
- title: 3.1.2.  The IPv4 Care-of Address Option
  contents:
  - "3.1.2.  The IPv4 Care-of Address Option\n   This option is included in the mobility\
    \ header, including the binding\n   update message sent from the mobile node to\
    \ a home agent or Mobility\n   Anchor Point.  The alignment requirement for this\
    \ option is 4n.\n    0                   1                   2               \
    \    3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n\
    \   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |  \
    \ Type        |   Length      |         Reserved              |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |                     IPv4 Care-of address                      |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                       Figure 2: The IPv4 CoA Option\n   Type\n      32\n   Length\n\
    \      6\n   Reserved\n      This field is set to zero by the sender and ignored\
    \ by the\n      receiver.\n   IPv4 Care-of Address\n      This field contains\
    \ the mobile node's IPv4 care-of address.  The\n      IPv4 care-of address is\
    \ used when the mobile node is located in an\n      IPv4-only network.\n"
- title: 3.1.3.  The Binding Update Message Extensions
  contents:
  - "3.1.3.  The Binding Update Message Extensions\n   This specification extends\
    \ the binding update message with one new\n   flag.  The flag is shown and described\
    \ below.\n    0                   1                   2                   3\n\
    \    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n       \
    \                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n             \
    \                      |          Sequence #           |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |A|H|L|K|M|R|P|F|  Reserved     |           Lifetime            |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                     Figure 3: Binding Update Message\n   F\n      When set,\
    \ this flag indicates a request for forcing UDP\n      encapsulation regardless\
    \ of whether a NAT is present on the path\n      between the mobile node and the\
    \ home agent.  This flag may be set\n      by the mobile node if it is required\
    \ to use UDP encapsulation\n      regardless of the presence of a NAT.  This flag\
    \ SHOULD NOT be set\n      when the mobile node is configured with an IPv6 care-of\
    \ address --\n      with the exception of the scenario mentioned in Section 4.4.1.\n"
- title: 3.2.  Binding Acknowledgement Extensions
  contents:
  - '3.2.  Binding Acknowledgement Extensions

    '
- title: 3.2.1.  IPv4 Address Acknowledgement Option
  contents:
  - "3.2.1.  IPv4 Address Acknowledgement Option\n   This option is included in the\
    \ mobility header, including the binding\n   acknowledgement message sent from\
    \ the home agent or Mobility Anchor\n   Point to the mobile node.  This option\
    \ indicates whether a binding\n   cache entry was created for the mobile node's\
    \ IPv4 address.\n   Additionally, this option includes an IPv4 home address in\
    \ the case\n   of dynamic IPv4 home address configuration (i.e., if the unspecified\n\
    \   IPv4 address was included in the binding update).  The alignment\n   requirement\
    \ for this option is 4n.\n    0                   1                   2      \
    \             3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8\
    \ 9 0 1\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |     Type      |    Length     |   Status      |Pref-len   |Res|\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |                      IPv4 home address                        |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \               Figure 4: IPv4 Address Acknowledgement Option\n   Type\n     \
    \ 30\n   Length\n      6\n   Status\n      Indicates success or failure for the\
    \ IPv4 home address binding.\n      Values from 0 to 127 indicate success.  Higher\
    \ values indicate\n      failure.\n   Pref-len\n      The prefix length of the\
    \ address allocated.  This field is only\n      valid in case of success and MUST\
    \ be set to zero and ignored in\n      case of failure.  This field overrides\
    \ what the mobile node\n      requested (if not equal to the requested length).\n\
    \   Res\n      This field is reserved for future use.  It MUST be set to zero\
    \ by\n      the sender and ignored by the receiver\n   IPv4 Home Address\n   \
    \   The IPv4 home address that the home agent will use in the binding\n      cache\
    \ entry.  This could be a public or private address.  This\n      field MUST contain\
    \ the mobile node's IPv4 home address.  If the\n      address were dynamically\
    \ allocated, the home agent will add the\n      address to inform the mobile node.\
    \  Otherwise, if the address is\n      statically allocated to the mobile node,\
    \ the home agent will copy\n      it from the binding update message.\n   The\
    \ following values are allocated for the status field:\n   o  0 Success\n   o\
    \  128 Failure, reason unspecified\n   o  129 Administratively prohibited\n  \
    \ o  130 Incorrect IPv4 home address\n   o  131 Invalid IPv4 address\n   o  132\
    \ Dynamic IPv4 home address assignment not available\n   o  133 Prefix allocation\
    \ unauthorized\n"
- title: 3.2.2.  The NAT Detection Option
  contents:
  - "3.2.2.  The NAT Detection Option\n   This option is sent from the home agent\
    \ to the mobile node to\n   indicate whether a NAT was in the path.  This option\
    \ MAY also include\n   a suggested NAT binding refresh time for the mobile node.\
    \  This might\n   be useful for scenarios where the mobile node is known to be\
    \ moving\n   within the home agent's administrative domain and, therefore, the\
    \ NAT\n   timeout is known (through configuration) to the home agent.  Section\n\
    \   3.5 of [RFC5405] discusses issues with NAT timeout in some detail.\n   The\
    \ alignment requirement for this option is 4n.  If a NAT is\n   detected, this\
    \ option MUST be sent by the home agent.\n    0                   1          \
    \         2                   3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0\
    \ 1 2 3 4 5 6 7 8 9 0 1\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |     Type      |    Length     |F|          Reserved           |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \   |                      Refresh time                             |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\
    \                    Figure 5: The NAT Detection Option\n   Type\n      31\n \
    \  Length\n      6\n   F\n      This flag indicates to the mobile node that UDP\
    \ encapsulation is\n      required.  When set, this flag indicates that the mobile\
    \ node MUST\n      use UDP encapsulation even if a NAT is not located between\
    \ the\n      mobile node and home agent.  This flag SHOULD NOT be set when the\n\
    \      mobile node is assigned an IPv6 care-of address -- with the\n      exception\
    \ of accommodating the scenarios discussed in\n      Section 4.4.1.\n   Reserved\n\
    \      This field is reserved for future use.  It MUST be set to zero by\n   \
    \   the sender and ignored by the receiver.\n   Refresh Time\n      A suggested\
    \ time (in seconds) for the mobile node to refresh the\n      NAT binding.  If\
    \ set to zero, it is ignored.  If this field is set\n      to all 1s, it means\
    \ that keepalives are not needed, i.e., no NAT\n      was detected.  The home\
    \ agent MUST be configured with a default\n      value for the refresh time. \
    \ The recommended value is outlined in\n      Section 6.\n"
- title: 4.  Protocol Operation
  contents:
  - "4.  Protocol Operation\n   This section presents the protocol operation and processing\
    \ for the\n   messages presented above.  In addition, this section introduces\
    \ the\n   NAT detection and traversal mechanism used by this specification.\n"
- title: 4.1.  Tunnelling Formats
  contents:
  - "4.1.  Tunnelling Formats\n   This specification allows the mobile node to use\
    \ various tunnelling\n   formats depending on its location and the visited network's\n\
    \   capabilities.  The mobile node can tunnel IPv6 in IPv4, IPv4 in IPv6,\n  \
    \ or use UDP encapsulation to tunnel IPv6 in IPv4.  Naturally, this\n   specification\
    \ also supports tunnelling IPv6 in IPv6 [RFC2473].\n   This specification allows\
    \ UDP-based tunnelling to be used between the\n   mobile node and its home agent\
    \ or MAP.  A UDP encapsulation format\n   means the following order of headers:\n\
    \      IPv4/v6\n      UDP\n      IP (v4 or v6)\n      Other headers\n   Note that\
    \ the use of UDP encapsulation for IPv6 care-of addresses\n   SHOULD NOT be done\
    \ except in the circumstances highlighted in Section\n   4.4.1.\n   When using\
    \ this format, the receiver parses the version field\n   following the UDP header\
    \ in order to determine whether the following\n   header is IPv4 or IPv6.  The\
    \ rest of the headers are processed\n   normally.  The above order of headers\
    \ does not take IPsec headers\n   into account as they may be placed in different\
    \ parts of the packet.\n   The above format MUST be supported by all implementations\
    \ of this\n   specification and MUST always be used to send the binding update\n\
    \   message.\n   UDP tunnelling can also encapsulate an Encapsulating Security\
    \ Payload\n   (ESP) header as shown below:\n      IPv4/v6\n      UDP\n      ESP\n\
    \      IP (v4 or v6)\n      Other headers\n   The negotiation of the secure tunnel\
    \ format described above is\n   discussed in Section 5.2.  The receiver of a UDP\
    \ tunnel detects\n   whether or not an ESP header is present based on the UDP\
    \ port used.\n"
- title: 4.1.1.  Tunnelling Impacts on Transport and MTU
  contents:
  - "4.1.1.  Tunnelling Impacts on Transport and MTU\n   Changing the tunnel format\
    \ may occur due to movement of the mobile\n   node from one network to another.\
    \  This can impact the link and path\n   MTU, which may affect the amount of bandwidth\
    \ available to the\n   applications.  The mobile node may use Path MTU Discovery\
    \ (PMTUD) as\n   specified in [RFC4459].\n   To accommodate traffic that uses\
    \ Explicit Congestion Notification\n   (ECN), it is RECOMMENDED that the ECN and\
    \ Differentiated Services\n   Code Point (DSCP) information be copied between\
    \ the inner and outer\n   header as defined in [RFC3168] and [RFC2983].  It is\
    \ RECOMMENDED that\n   the full-functionality option defined in Section 9.1.1\
    \ of [RFC3168]\n   be used to deal with ECN.\n   Note that some implementations\
    \ may not be able to use ECN over the\n   UDP tunnel.  This is due to the lack\
    \ of access to ECN bits in the UDP\n   API on most platforms.  However, this issue\
    \ can be avoided if UDP\n   encapsulation is done in the kernel.\n   Note that,\
    \ when using UDP encapsulation, the Time to Live (TTL) field\n   must be decremented\
    \ in the same manner as when IP-in-IP encapsulation\n   is used.\n"
- title: 4.2.  NAT Detection
  contents:
  - "4.2.  NAT Detection\n   This section deals with NAT detection for the purpose\
    \ of\n   encapsulating packets between the mobile node and the home agent when\n\
    \   the mobile node is present in a private IPv4 network.  Mobile IPv6\n   uses\
    \ IKEv2 to establish the IPsec security association (SA) between\n   the mobile\
    \ node and the home agent.  IKEv2 has its own NAT detection\n   mechanism.  However,\
    \ IKEv2's NAT detection is only used for the\n   purpose of setting up the IPsec\
    \ SA for secure traffic.  The\n   interactions between the two NAT traversal mechanisms\
    \ are described\n   in Section 5.\n   NAT detection is done when the initial binding\
    \ update message is sent\n   from the mobile node to the home agent.  When located\
    \ in an IPv4-only\n   foreign link, the mobile node sends the binding update message\n\
    \   encapsulated in UDP and IPv4.  The source address of the IPv6 packet\n   is\
    \ the mobile node's IPv6 home address.  The destination address is\n   the IPv6\
    \ address of the home agent.  The IPv4 header contains the\n   IPv4 care-of address\
    \ in the source address field and the IPv4 address\n   of the home agent in the\
    \ destination address field.\n   When the home agent receives the encapsulated\
    \ binding update, it\n   compares the IPv4 address of the source address field\
    \ in the IPv4\n   header with the IPv4 address included in the IPv4 care-of address\n\
    \   option.  If the two addresses match, no NAT device was in the path.\n   Otherwise,\
    \ a NAT was in the path and the NAT detection option is\n   included in the binding\
    \ acknowledgement.  The binding acknowledgement\n   and all future packets are\
    \ then encapsulated in UDP and IPv4.  The\n   source address in the IPv4 header\
    \ is the IPv4 address of the home\n   agent.  The destination address is the IPv4\
    \ address received in the\n   IPv4 header encapsulating the binding update (this\
    \ address will be\n   different from the IPv4 care-of address when a NAT is in\
    \ the path).\n   The source port in the packet is the home agent's source port.\
    \  The\n   destination port is the source port received in the binding update\n\
    \   message.  Note that the home agent stores the port numbers and\n   associates\
    \ them with the mobile node's tunnel in order to forward\n   future packets.\n\
    \   Upon receiving the binding acknowledgement with the NAT detection\n   option,\
    \ the mobile node sets the tunnel to the home agent to UDP\n   encapsulation.\
    \  Hence, all future packets to the home agent are\n   tunneled in UDP and IPv4.\
    \  For all tunneled IPv6 packets, the source\n   address in the IPv6 header is\
    \ the mobile node's IPv6 home address and\n   the destination address is the correspondent\
    \ node's IPv6 address.\n   All tunneled IPv4 packets will contain the mobile node's\
    \ IPv4 home\n   address in the source address field of the inner IPv4 packet and\
    \ the\n   correspondent node's IPv4 address in the destination address field.\n\
    \   The outer IPv4 header is the same whether the inner packet is IPv4 or\n  \
    \ IPv6.\n   If no NAT device was detected in the path between the mobile node\
    \ and\n   the home agent, then IPv6 packets are tunneled in an IPv4 header\n \
    \  unless the home agent forces UDP encapsulation using the F flag.  The\n   content\
    \ of the inner and outer headers are identical to the UDP\n   encapsulation case.\n\
    \   A mobile node MUST always tunnel binding updates in UDP when located\n   in\
    \ an IPv4-only network.  Essentially, this process allows for\n   perpetual NAT\
    \ detection.  Similarly, the home agent MUST encapsulate\n   binding acknowledgements\
    \ in a UDP header whenever the binding update\n   is encapsulated in UDP.\n  \
    \ In conclusion, the packet formats for the binding update and\n   acknowledgement\
    \ messages are shown below:\n   Binding update received by the home agent:\n \
    \     IPv4 header (src=V4ADDR, dst=HA_V4ADDR)\n      UDP header\n      IPv6 header\
    \ (src=V6HOA, dst=HAADDR)\n      ESP header\n      Mobility header\n      BU [IPv4\
    \ HAO]\n      IPv4 CoA option\n   Where V4ADDR is either the IPv4 care-of address\
    \ or the address\n   provided by the NAT device.  V6HOA is the IPv6 home address\
    \ of the\n   mobile node.  The binding update MAY also contain the IPv4 home\n\
    \   address option, IPv4 HAO.\n   Binding acknowledgement sent by the home agent:\n\
    \      IPv4 header (src= HA_V4ADDR, dst=V4ADDR)\n      UDP header\n      IPv6\
    \ header (src=HAADDR, dst=V6HOA)\n      ESP header\n      Mobility header\n  \
    \    BA ([IPv4 ACK], NAT DET)\n   Where V6HOA is the IPv6 home address of the\
    \ mobile node.  The IPv4\n   ACK is the IPv4 address acknowledgement option, which\
    \ is only\n   included if the IPv4 home address option is present in the BU. \
    \ The\n   NAT DET is the NAT detection option, which MUST be present in the\n\
    \   binding acknowledgement message if the binding update was\n   encapsulated\
    \ in UDP.\n"
- title: 4.3.  NAT Keepalives
  contents:
  - "4.3.  NAT Keepalives\n   If a NAT is detected, the mobile node will need to refresh\
    \ the NAT\n   bindings in order to be reachable from the home agent.  NAT bindings\n\
    \   can be refreshed through sending and receiving traffic encapsulated\n   in\
    \ UDP.  However, if the mobile node is not active, it will need to\n   periodically\
    \ send a message to the home agent in order to refresh the\n   NAT binding.  This\
    \ can be done using the binding update message.  The\n   binding update/acknowledgement\
    \ pair will ensure that the NAT bindings\n   are refreshed in a reliable manner.\
    \  There is no way for the mobile\n   node to know the exact time of the NAT binding.\
    \  The default time\n   suggested in this specification is NATKATIMEOUT (see Section\
    \ 6).  If\n   the home agent suggests a different refresh period in the binding\n\
    \   acknowledgement, the mobile node SHOULD use the value suggested by\n   the\
    \ home agent.\n   If the refresh time in the NAT detection option in the binding\n\
    \   acknowledgement is set to all 1s, the mobile node need not send\n   messages\
    \ to refresh the NAT binding.  However, the mobile node may\n   still be required\
    \ to encapsulate traffic in UDP.  This scenario may\n   take place when a NAT\
    \ is not detected but the home agent still\n   requires the mobile node to use\
    \ UDP encapsulation.\n   It should be noted that a mobile node that does not need\
    \ to be\n   reachable (i.e., one that only cares about the session continuity\n\
    \   aspect of Mobile IP) does not need to refresh the NAT binding.  In\n   this\
    \ case, the mobile node would only be able to initiate\n   communication with\
    \ other nodes.  However, this is likely to imply\n   that the mobile node will\
    \ need to send a binding update before\n   initiating communication after a long\
    \ idle period as it is likely to\n   be assigned a different port and IPv4 address\
    \ by the NAT when it\n   initiates communication.  Hence, an implementation may\
    \ choose, for\n   the sake of simplicity, to always maintain the NAT bindings\
    \ even when\n   it does not need reachability.\n   Note that keepalives are also\
    \ needed by IKEv2 over UDP port 4500.\n   This is needed for IKE (Internet Key\
    \ Exchange Protocol) dead-peer\n   detection, which is not handled by DSMIPv6\
    \ keepalives.\n"
- title: 4.4.  Mobile Node Operation
  contents:
  - "4.4.  Mobile Node Operation\n   In addition to the operations specified in [RFC3775]\
    \ and [RFC3963],\n   this specification requires mobile nodes to be able to support\
    \ an\n   IPv4 home address.  This specification also requires the mobile node\n\
    \   to choose an IPv4 or an IPv6 care-of address.  We first discuss\n   care-of\
    \ address selection, then continue with binding management and\n   transmission\
    \ of normal traffic.\n"
- title: 4.4.1.  Selecting a Care-of Address
  contents:
  - "4.4.1.  Selecting a Care-of Address\n   When a mobile node is in a dual stacked,\
    \ visited network, it will\n   have a choice between an IPv4 and an IPv6 care-of\
    \ address.  The\n   mobile node SHOULD prefer the IPv6 care-of address and bind\
    \ it to its\n   home address(es).  If a mobile node attempted to bind the IPv6\
    \ care-\n   of address to its home address(es) and the binding update timed out,\n\
    \   the mobile node SHOULD:\n   o  Resend the binding update using the exponential\
    \ back-off algorithm\n      described in [RFC3775].\n   o  If after three attempts,\
    \ in total, a binding acknowledgement was\n      not received, the mobile node\
    \ SHOULD send a new binding update\n      using the IPv4 care-of address.  The\
    \ exponential backoff algorithm\n      described in [RFC3775] should be used for\
    \ re-transmission of the\n      binding update if needed.\n   This procedure should\
    \ be used to avoid scenarios where IPv6\n   connectivity may not be as reliable\
    \ as IPv4.  This unreliability may\n   take place during early deployments of\
    \ IPv6 or may simply be due to\n   temporary outages affecting IPv6 routing.\n\
    \   It is RECOMMENDED that upon movement, the mobile node not change the\n   IP\
    \ address family chosen for the previous binding update unless the\n   mobile\
    \ node is aware that it has moved to a different administrative\n   domain where\
    \ previous problems with IPv6 routing may not be present.\n   Repeating the above\
    \ procedure upon every movement can cause\n   significant degradation of the mobile\
    \ node's applications'\n   performance due to extended periods of packet losses\
    \ after handover,\n   if the routing outage is still in effect.\n   When using\
    \ an IPv4 care-of address and IP-in-IP encapsulation, if the\n   mobile node implementation\
    \ is made aware by upper layers of\n   persistent packet losses, it may attempt\
    \ to resend the binding update\n   with the F flag set, requesting UDP encapsulation\
    \ for all packets.\n   This may avoid packet losses due to situations where local\n\
    \   firewalling policies prevent the use of IP-in-IP encapsulation.\n   The effect\
    \ of this address selection mechanism is to allow the\n   following preferences\
    \ in the absence of NAT:\n   1. IPv6\n   2. IPv4 (using IP-in-IP or UDP encapsulation\
    \ if a NAT is detected)\n   3. UDP encapsulation when IP-in-IP is not allowed\
    \ by the local\n      domain.\n"
- title: 4.4.2.  Sending Binding Updates
  contents:
  - "4.4.2.  Sending Binding Updates\n   When sending an IPv6 packet containing a\
    \ binding update while\n   connected to an IPv4-only access network, mobile nodes\
    \ MUST ensure\n   the following:\n   o  The IPv6 packet is encapsulated in UDP.\n\
    \   o  The source address in the IPv4 header is the mobile node's IPv4\n     \
    \ care-of address.\n   o  The destination address in the IPv4 header is the home\
    \ agent's\n      IPv4 address.\n   o  The source address in the IPv6 header is\
    \ the mobile node's IPv6\n      home address.\n   o  The IPv4 home address option\
    \ MAY be included in the mobility\n      header.  This option contains the IPv4\
    \ home address.  If the\n      mobile node did not have a static home address,\
    \ it MAY include the\n      unspecified IPv4 address, which acts as a request\
    \ for a dynamic\n      IPv4 home address.  Alternatively, one or more IPv4 home\
    \ address\n      options may be included with requests for IPv4 prefixes (i.e.,\n\
    \      with the P flag set).\n   o  If the mobile node wishes to use UDP encapsulation\
    \ only, it must\n      set the F flag in the binding update message.\n   o  The\
    \ IPv6 packet MUST be authenticated as per [RFC3775], based on\n      the mobile\
    \ node's IPv6 home address.\n   When sending a binding update from a visited network\
    \ that supports\n   IPv6, the mobile node MUST follow the rules specified in [RFC3775].\n\
    \   In addition, if the mobile node has an IPv4 home address or needs\n   one,\
    \ it MUST include the IPv4 home address option in the mobility\n   header.  If\
    \ the mobile node already has a static IPv4 home address,\n   this address MUST\
    \ be included in the IPv4 home address option.\n   Otherwise, if the mobile node\
    \ needs a dynamic IPv4 address, it MUST\n   include the IPv4 0.0.0.0 address in\
    \ the IPv4 home address option.\n   In addition to the rules in [RFC3775], the\
    \ mobile node should follow\n   the care-of address selection guidelines in Section\
    \ 4.4.1.\n   When the mobile node receives a binding acknowledgement from the\
    \ home\n   agent, it follows the rules in [RFC3775] and [RFC3963].  In addition,\n\
    \   the following actions MUST be made:\n   o  If the status field indicated failure\
    \ with error code 144, the\n      mobile node MAY resend the binding update without\
    \ setting the F\n      flag.\n   o  If the mobility header includes an IPv4 address\
    \ acknowledgement\n      option indicating success, the mobile node should create\
    \ two\n      entries in its binding update list: one for the IPv6 home address\n\
    \      and another for the IPv4 home address.\n   o  If the NAT detection option\
    \ is present, the mobile node MUST\n      tunnel future packets in UDP and IPv4.\
    \  This MUST be indicated in\n      the binding update list.\n   o  If no IPv4\
    \ address acknowledgement option is present, and an IPv4\n      home address option\
    \ was present in the binding update, the mobile\n      node MUST only create one\
    \ binding update list entry for its IPv6\n      home address.  The mobile node\
    \ MAY include the IPv4 home address\n      option in future binding updates.\n\
    \   o  If an IPv4 address acknowledgement option is present and it\n      indicates\
    \ failure for the IPv4 home address binding, the mobile\n      node MUST NOT create\
    \ an entry for that address in its binding\n      update list.  The mobile node\
    \ MAY include the IPv4 home address\n      option in future binding updates.\n"
- title: 4.4.2.1.  Removing Bindings
  contents:
  - "4.4.2.1.  Removing Bindings\n   Mobile nodes will remove bindings from the home\
    \ agent's binding cache\n   whenever they move to the home link, or simply when\
    \ mobility support\n   is not needed.\n   Deregistering the IPv6 home address\
    \ is described in [RFC3775].  The\n   same mechanism applies in this specification.\
    \  Mobile nodes may\n   remove the binding for only the IPv4 home address by sending\
    \ a\n   binding update that does not include the IPv4 home address option.\n \
    \  Upon receiving this binding update, the home agent will replace the\n   existing\
    \ cache entries with the content of the new message.  This\n   ensures that the\
    \ IPv4 home address binding is removed while\n   maintaining an IPv6 binding.\n\
    \   Note that the mobile node cannot remove the IPv6 home address binding\n  \
    \ while maintaining an IPv4 home address binding.\n   A binding update message\
    \ with a lifetime of zero will remove all\n   bindings for the mobile node.\n"
- title: 4.4.3.  Sending Packets from a Visited Network
  contents:
  - "4.4.3.  Sending Packets from a Visited Network\n   When the mobile node is located\
    \ in an IPv6-enabled network, it sends\n   and receives IPv6 packets as described\
    \ in [RFC3775].  In cases where\n   IP-in-IP encapsulation is not providing connectivity\
    \ to the home\n   agent, the mobile node may choose to encapsulate in UDP as suggested\n\
    \   in Section 4.4.1.  However, this encapsulation of IPv6 traffic should\n  \
    \ be used as a last resort, as described.  IPv4 traffic is encapsulated\n   in\
    \ IPv6 packets to the home agent.\n   When the mobile node is located in an IPv4-only\
    \ network, it will send\n   IPv6 packets to its home agent according to the following\
    \ format:\n      IPv4 header (src=V4CoA, dst=HA_V4ADDR)\n      [UDP header]\n\
    \      IPv6 header (src=V6HoA, dst=CN)\n      Upper layer protocols\n   Here,\
    \ the UDP header is only used if a NAT has been detected between\n   the mobile\
    \ node and the home agent, or if the home agent forced UDP\n   encapsulation.\
    \  V4CoA is the IPv4 care-of address configured by the\n   mobile node in the\
    \ visited network.\n   Similarly, IPv4 packets are sent according to the following\
    \ format:\n      IPv4 header (src=V4CoA, dst=HA_V4ADDR)\n      [UDP header]\n\
    \      IPv4 header (src=V4HoA, dst=V4CN)\n      Upper Layer protocols\n   Here,\
    \ the UDP header is only used if a NAT has been detected between\n   the mobile\
    \ node and the home agent, or if the home agent forced UDP\n   encapsulation.\n"
- title: 4.4.4.  Movement Detection in IPv4-Only Networks
  contents:
  - "4.4.4.  Movement Detection in IPv4-Only Networks\n   [RFC3775] describes movement\
    \ detection mostly based on IPv6-specific\n   triggers and Neighbor Discovery\
    \ [RFC4861] information.  These\n   triggers are not available in an IPv4-only\
    \ network.  Hence, a mobile\n   node located in an IPv4-only network SHOULD use\
    \ [RFC4436] for\n   guidance on movement-detection mechanisms in IPv4-only networks.\n\
    \   The mobile node detects that it's in an IPv4-only network when the\n   IPv6\
    \ movement-detection algorithm fails to configure an IPv6 address.\n   This specification\
    \ does not support mobile nodes returning home while\n   using IPv4.  That is,\
    \ the IPv4 support is only defined for mobile\n   nodes that are in a visited\
    \ network.\n"
- title: 4.5.  Home Agent Operation
  contents:
  - "4.5.  Home Agent Operation\n   In addition to the home agent specification in\
    \ [RFC3775] and\n   [RFC3963], the home agent needs to be able to process the\
    \ IPv4 home\n   address option and generate the IPv4 address acknowledgement option.\n\
    \   Both options are included in the mobility header.  Furthermore, the\n   home\
    \ agent MUST be able to detect the presence of a NAT device and\n   indicate that\
    \ presence in the NAT detection option included in the\n   binding acknowledgement.\n\
    \   A home agent must also act as a proxy for address resolution in IPv4\n   for\
    \ the registered IPv4 home addresses of mobile nodes it is serving.\n   Moreover,\
    \ the administrative domain of the home agent is responsible\n   for advertising\
    \ the routing information of registered IPv4 mobile-\n   network prefixes of the\
    \ mobile nodes.\n   In order to comply with this specification, the home agent\
    \ MUST be\n   able to find the IPv4 home address of a mobile node when given the\n\
    \   IPv6 home address.  That is, given an IPv6 home address, the home\n   agent\
    \ MUST store the corresponding IPv4 home address if a static one\n   is present.\
    \  If a dynamic address is requested by the mobile node,\n   the home agent MUST\
    \ store that address (associated with the IPv6 home\n   address) after it's allocated\
    \ to the mobile node.\n   When the home agent receives a binding update encapsulated\
    \ in UDP and\n   containing the IPv4 home address option, it needs to follow all\
    \ the\n   steps in [RFC3775] and [RFC3963].  In addition, the following checks\n\
    \   MUST be done:\n   o  If the IPv4 care-of address in the IPv4 CoA option is\
    \ not the same\n      as the IPv4 address in the source address in the IPv4 header,\
    \ then\n      a NAT was in the path.  This information should be flagged for the\n\
    \      binding acknowledgement.\n   o  If the F flag in the binding update is\
    \ set, the home agent needs\n      to determine whether it accepts forcing UDP\
    \ encapsulation.  If it\n      does not, the binding acknowledgement is sent with\
    \ error code 144.\n      UDP encapsulation SHOULD NOT be used when the mobile\
    \ node is\n      located in an IPv6-enabled link, with the exception of the\n\
    \      scenarios outlined in Section 4.4.1.\n   o  If the IPv4 home address option\
    \ contains a valid unicast IPv4\n      address, the home agent MUST check that\
    \ this address is allocated\n      to the mobile node that has the IPv6 home address\
    \ included in the\n      home address option.  The same MUST be done for an IPv4\
    \ prefix.\n   o  If the IPv4 home address option contained the unspecified IPv4\n\
    \      address, the home agent SHOULD dynamically allocate an IPv4 home\n    \
    \  address to the mobile node.  If none is available, the home agent\n      MUST\
    \ return error code 132 in the status field of the IPv4 address\n      acknowledgement\
    \ option.  If a prefix is requested, the home agent\n      SHOULD allocate a prefix\
    \ with the requested length; if prefix\n      allocation (of any length) is not\
    \ possible, the home agent MUST\n      indicate failure of the operation with\
    \ the appropriate error code.\n   o  If the binding update is accepted for the\
    \ IPv4 home address, the\n      home agent creates a binding cache entry for the\
    \ IPv4 home\n      address/prefix.  The home agent MUST include an IPv4\n    \
    \  acknowledgement option in the mobility header containing the\n      binding\
    \ acknowledgement.\n   o  If the binding update is accepted for both IPv4 and\
    \ IPv6 home\n      addresses, the home agent creates separate binding cache entries,\n\
    \      one for each home address.  The care-of address is the one\n      included\
    \ in the binding update.  If the care-of address is an IPv4\n      address, the\
    \ home agent MUST set up a tunnel to the IPv4 care-of\n      address of the mobile\
    \ node.\n   When sending a binding acknowledgement to the mobile node, the home\n\
    \   agent constructs the message according to [RFC3775] and [RFC3963].\n   Note\
    \ that the routing header MUST always contain the IPv6 home\n   address as specified\
    \ in [RFC3775].\n   If the care-of address of the mobile node is an IPv4 address,\
    \ the\n   home agent includes the mobile node's IPv6 home address in the\n   destination\
    \ address field in the IPv6 header.  If a NAT is detected,\n   the home agent\
    \ MUST then encapsulate the packet in UDP and in an IPv4\n   header.  The source\
    \ address is set to the home agent's IPv4 address\n   and the destination address\
    \ is set to the address received in the\n   source address of the IPv4 header\
    \ encapsulating the binding update.\n   After creating a binding cache entry for\
    \ the mobile node's home\n   addresses, all packets sent to the mobile node's\
    \ home addresses are\n   tunneled by the home agent to the mobile node's care-of\
    \ address.  If\n   a NAT is detected, packets are encapsulated in UDP and IPv4.\n\
    \   Otherwise, if the care-of address is an IPv4 address and no NAT is\n   detected,\
    \ packets are encapsulated in an IPv4 header unless UDP\n   encapsulation is forced\
    \ by the home agent.\n"
- title: 4.5.1.  Sending Packets to the Mobile Node
  contents:
  - "4.5.1.  Sending Packets to the Mobile Node\n   The home agent follows the rules\
    \ specified in [RFC3775] for sending\n   IPv6 packets to mobile nodes located\
    \ in IPv6 networks.  When sending\n   IPv4 packets to mobile nodes in an IPv6\
    \ network, the home agent must\n   encapsulate the IPv4 packets in IPv6.\n   When\
    \ sending IPv6 packets to a mobile node located in an IPv4\n   network, the home\
    \ agent uses the following format:\n      IPv4 header (src= HA_V4ADDR, dst= V4ADDR)\n\
    \      [UDP header]\n      IPv6 header (src=CN, dst= V6HoA)\n      Upper layer\
    \ protocols\n   Where the UDP header is only included if a NAT is detected between\n\
    \   the mobile node and the home agent or if the home agent forced UDP\n   encapsulation.\
    \  V4ADDR is the IPv4 address received in the source\n   address field of the\
    \ IPv4 packet containing the binding update.\n   When sending IPv4 packets to\
    \ a mobile node located in an IPv4\n   network, the home agent must follow the\
    \ format negotiated in the\n   binding update/acknowledgement exchange.  In the\
    \ absence of a\n   negotiated format, the default format that MUST be supported\
    \ by all\n   implementations is:\n      IPv4 header (src= HA_V4ADDR, dst= V4ADDR)\n\
    \      [UDP header]\n      IPv4 header (src=V4CN, dst= V4HoA)\n      Upper layer\
    \ protocols\n   Where the UDP header is only included if a NAT is detected between\n\
    \   the mobile node and home agent or if the home agent forced UDP\n   encapsulation.\n"
- title: 4.6.  Correspondent Node Operation
  contents:
  - "4.6.  Correspondent Node Operation\n   This specification has no impact on IPv4\
    \ or IPv6 correspondent nodes.\n"
- title: 5.  Security Considerations
  contents:
  - "5.  Security Considerations\n   This specification allows a mobile node to send\
    \ one binding update\n   for its IPv6 and IPv4 home addresses.  This is a slight\
    \ deviation\n   from [RFC3775], which requires one binding update per home address.\n\
    \   However, like [RFC3775], the IPsec security association needed to\n   authenticate\
    \ the binding update is still based on the mobile node's\n   IPv6 home address.\
    \  Therefore, in order to authorize the mobile\n   node's IPv4 home address binding,\
    \ the home agent MUST store the IPv4\n   address corresponding to the IPv6 address\
    \ that is allocated to a\n   mobile node.  Therefore, it is sufficient for the\
    \ home agent to know\n   that the IPsec verification for the packet containing\
    \ the binding\n   update was valid, provided that it knows which IPv4 home address\
    \ is\n   associated with which IPv6 home address.  Hence, the security of the\n\
    \   IPv4 home address binding is the same as the IPv6 binding.\n   In effect,\
    \ associating the mobile node's IPv4 home address with its\n   IPv6 home address\
    \ moves the authorization of the binding update for\n   the IPv4 address to the\
    \ Mobile IPv6 implementation, which infers it\n   from the fact that the mobile\
    \ node has an IPv6 home address and the\n   right credentials for sending an authentic\
    \ binding update for the\n   IPv6 address.\n   This specification requires the\
    \ use of IKEv2 as the default mechanism\n   for dynamic keying.\n   In cases where\
    \ this specification is used for NAT traversal, it is\n   important to note that\
    \ it has the same vulnerabilities associated\n   with [RFC3519].  An attacker\
    \ is able to hijack the mobile node's\n   session with the home agent if it can\
    \ modify the contents of the\n   outer IPv4 header.  The contents of the header\
    \ are not authenticated\n   and there is no way for the home agent to verify their\
    \ validity.\n   Hence, a man in the middle attack, where a change in the contents\
    \ of\n   the IPv4 header can cause a legitimate mobile node's traffic to be\n\
    \   diverted to an illegitimate receiver independently of the\n   authenticity\
    \ of the binding update message, is possible.\n   In this specification, the binding\
    \ update message MUST be protected\n   using ESP transport mode.  When the mobile\
    \ node is located in an\n   IPv4-only network, the binding update message is encapsulated\
    \ in UDP\n   as described earlier in Section 4.2.  However, UDP SHOULD NOT be\
    \ used\n   to encapsulate the binding update message when the mobile node is\n\
    \   located in an IPv6-enabled network.  If protection of payload traffic\n  \
    \ is needed when the mobile node is located in an IPv4-only network,\n   encapsulation\
    \ is done using tunnel mode ESP over port 4500 as\n   described in [RFC3948].\
    \  During the IKE negotiation with the home\n   agent, if the mobile node and\
    \ home agent support the use of port\n   4500, the mobile node MUST establish\
    \ the security association over\n   port 4500, regardless of the presence of a\
    \ NAT.  This is done to\n   avoid switching between ports 500 and 4500 and the\
    \ potential traffic\n   disruption resulting from this switch.\n   Handovers within\
    \ private IPv4 networks or from IPv6 to IPv4 networks\n   will impact the security\
    \ association between the mobile node and the\n   home agent.  The following section\
    \ presents the expected behaviour of\n   the mobile node and home agent in those\
    \ situations.  The details of\n   the IKE negotiations and messages are illustrated\
    \ in Section 5.2.\n"
- title: 5.1.  Handover Interactions for IPsec and IKE
  contents:
  - "5.1.  Handover Interactions for IPsec and IKE\n   After the mobile node detects\
    \ movement, it configures a new care-of\n   address.  If the mobile node is in\
    \ an IPv4-only network, it removes\n   binding update list entries for correspondent\
    \ nodes, since route\n   optimisation cannot be supported.  This may cause inbound\
    \ packet\n   losses, as remote correspondent nodes are unaware of such movement.\n\
    \   To avoid confusion in the correspondent node, the mobile node SHOULD\n   deregister\
    \ its binding with each correspondent node by sending a\n   deregistration binding\
    \ update.  The deregistration binding update\n   message is tunnelled to the home\
    \ agent and onto the correspondent\n   node.  This is done after the mobile node\
    \ updates the home agent with\n   its new location as discussed below.\n   The\
    \ mobile node sends the binding update message to the home agent.\n   If the mobile\
    \ node is in an IPv6-enabled network, the binding update\n   SHOULD be sent without\
    \ IPv4/UDP encapsulation, unless UDP\n   encapsulation is needed as described\
    \ in Section 4.4.1.  If the mobile\n   node is in an IPv4-only network, then --\
    \ after IPsec processing of\n   the binding update (BU) message -- it encapsulates\
    \ the BU in UDP/IPv4\n   as discussed in Sections 4.2 and 4.4.  In order to be\
    \ able to send\n   the binding update while in an IPv4-only network, the mobile\
    \ node\n   needs to use the new IPv4 care-of address in the outer header, which\n\
    \   is different from the care-of address used in the existing tunnel.\n   This\
    \ should be done without permanently updating the tunnel within\n   the mobile\
    \ node's implementation in order to allow the mobile node to\n   receive packets\
    \ on the old care-of address until the binding\n   acknowledgement is received.\
    \  The method used to achieve this effect\n   is implementation dependent and\
    \ is outside the scope of this\n   specification.  This implies that the IP forwarding\
    \ function (which\n   selects the interface or tunnel through which a packet is\
    \ sent) is\n   not based solely on the destination address: some IPv6 packets\n\
    \   destined to the home agent are sent via the existing tunnel, while\n   BUs\
    \ are sent using the new care-of address.  Since BUs are protected\n   by IPsec,\
    \ the forwarding function cannot necessarily determine the\n   correct treatment\
    \ from the packet headers.  Thus, the DSMIPv6\n   implementation has to attach\
    \ additional information to BUs, and this\n   information has to be preserved\
    \ after IPsec processing and made\n   available to the forwarding function or\
    \ to DSMIP extensions included\n   in the forwarding function.  Depending on the\
    \ mobile node's\n   implementation, meeting this requirement may require changes\
    \ to the\n   IPsec implementation.\n   Upon receiving the binding update message\
    \ encapsulated in UDP/IPv4,\n   the home agent processes it as follows.  In order\
    \ to allow the\n   DSMIPv6 implementation in the home agent to detect the presence\
    \ of a\n   NAT on the path to the mobile node, it needs to compare the outer\n\
    \   IPv4 source address with the IPv4 address in the IPv4 care-of address\n  \
    \ option.  This implies that the information in the outer header will\n   be preserved\
    \ after IPsec processing and made available to the DSMIPv6\n   implementation\
    \ in the home agent.  Depending on the home agent's\n   implementation, meeting\
    \ this requirement may require changes to the\n   IPsec implementation.\n   The\
    \ home agent updates its tunnel mode security association to\n   include the mobile\
    \ node's care-of address as the remote-tunnel header\n   address and 4500 as the\
    \ port number.  The IPv4 address and port\n   number are likely to be wrong; the\
    \ mobile node provides the correct\n   information in a separate exchange as described\
    \ below.  When the\n   mobile node is located in a private IPv4 network (which\
    \ is detected\n   as described above), the new address and port number are allocated\
    \ by\n   the NAT.  The home agent will also enable or disable UDP\n   encapsulation\
    \ for outgoing ESP packets for the purpose of NAT\n   traversal.\n   If the Key\
    \ Management Mobility Capability (K) bit was set in the\n   binding update, and\
    \ the home agent supports this feature, the home\n   agent updates its IKE security\
    \ associations to include the mobile\n   node's care-of address as the peer address\
    \ and 4500 as the port\n   number.  The home agent may also need to change NAT\
    \ traversal fields\n   in the IKE_SA to enable the dynamic update of the IP address\
    \ and port\n   number, based on the reception of authenticated IKE messages or\n\
    \   authenticated packets using tunnel mode ESP.  The dynamic updates are\n  \
    \ described in Section 2.23 of [RFC4306].  As described above, when the\n   mobile\
    \ node is located in a private IPv4 network, the address and\n   port number used\
    \ for IPsec and IKE traffic is not yet known by the\n   home agent at this point.\n\
    \   The mobile node updates the IKE SA in one of two ways.  If the K flag\n  \
    \ was set in the binding acknowledgement message, the mobile node\n   SHOULD send\
    \ an empty informational message, which results in the IKE\n   module in the home\
    \ agent dynamically updating the SA information.\n   The IKE implementation in\
    \ the home agent is REQUIRED to support this\n   feature.  Alternatively, the\
    \ IKE SA should be re-negotiated.  Note\n   that updating the IKE SA MUST take\
    \ place after the mobile node has\n   sent the binding update and received the\
    \ acknowledgement from the\n   home agent.\n   It is important to note that the\
    \ mobile node's IPv4 care-of address\n   seen by the DSMIPv6 module in the home\
    \ agent upon receiving the\n   binding update may differ from the IPv4 care-of\
    \ address seen by the\n   IKE module and the care-of address used for forwarding\
    \ IPsec tunnel\n   mode traffic.  Hence, it is probable that different modules\
    \ in the\n   home agent will have a different care-of address that should be used\n\
    \   for encapsulating traffic to the mobile node.\n   After successfully processing\
    \ the binding update, the home agent\n   sends the binding acknowledgement to\
    \ the mobile node's care-of\n   address as received in the outer header of the\
    \ packet containing the\n   binding update.  Note that if the BU was rejected,\
    \ the binding\n   acknowledgement (BAck) is sent to the same address from which\
    \ the BU\n   was received.  This may require special treatment in IP forwarding\n\
    \   and/or IPsec processing that resembles the sending of BUs in the\n   mobile\
    \ node (described above).\n   Upon receiving the binding acknowledgement, the\
    \ mobile node updates\n   its local tunnel mode security association information\
    \ to include the\n   tunnel header IP source address, which is the mobile node's\
    \ address,\n   and the tunnel header IP destination, which is the home agent's\n\
    \   address.  The mobile node may also need to enable or disable UDP\n   encapsulation\
    \ for outgoing ESP packets for the purpose of NAT\n   traversal and the sending\
    \ of keepalives.\n   The mobile node MAY use MOBIKE [RFC4555] to update its IKE\
    \ SA with\n   the home agent.  Using MOBIKE requires negotiating this capability\n\
    \   with the home agent when establishing the SA.  In this case, the\n   mobile\
    \ node and the home agent MUST NOT update their IPsec SAs\n   locally, as this\
    \ step is performed by MOBIKE.  Furthermore, the use\n   of MOBIKE allows the\
    \ mobile node to update the SA independently of\n   the binding update exchange.\
    \  Hence, there is no need for the mobile\n   node to wait for a binding acknowledgement\
    \ before performing MOBIKE.\n   The use of MOBIKE is OPTIONAL in this specification.\n"
- title: 5.2.  IKE Negotiation Messages between the Mobile Node and Home Agent
  contents:
  - "5.2.  IKE Negotiation Messages between the Mobile Node and Home Agent\n   This\
    \ specification defines a number of possible data encapsulation\n   formats, depending\
    \ on the mobile node's connectivity to the visited\n   network.  When connected\
    \ to an IPv6-enabled network, the tunnelling\n   formats are clear.  However,\
    \ when connected to an IPv4-only network,\n   care should be taken when negotiating\
    \ the IKE association and the\n   consequential tunnelling formats used for secure\
    \ and insecure\n   traffic.  This section illustrates the IKE message exchange\
    \ between\n   the mobile node and home agent when the mobile node is located in\
    \ an\n   IPv4-only network.  Two different IKE negotiations are considered:\n\
    \   o  IKEv2 operation for securing DSMIPv6 signaling.\n   o  IKEv2 operation\
    \ for securing data over IPv4\n"
- title: 5.2.1.  IKEv2 Operation for Securing DSMIPv6 Signaling
  contents:
  - "5.2.1.  IKEv2 Operation for Securing DSMIPv6 Signaling\n   A mobile node connected\
    \ to an IPv4-only network SHOULD follow the\n   procedures described below in\
    \ order to establish an SA for the\n   protection of binding update and binding\
    \ acknowledgement messages.\n   Note that V4ADDR refers to either the mobile node's\
    \ care-of address\n   in the visited link or the public address allocated to the\
    \ mobile\n   node by the NAT.\n   Mobile Node                                \
    \      Home Agent\n   -----------                                      ----------\n\
    \   IPv4(source_addr=V4ADDR, dest_addr=HAADDR)\n    UDP (500, 500) HDR, SAi1,\
    \ KEi, Ni\n     NAT-D, NAT-D -->\n                      <- IPv4(source_addr=HAADDR,\
    \ dest_addr=V4ADDR)\n                               UDP(500,X) HDR, SAr1, KEr,\
    \ Nr, [CERTREQ]\n                                NAT-D, NAT-D\n   IPv4(source_addr=V4ADDR,\
    \ dest_addr=HAADDR)\n     UDP (4500,4500) <non-ESP Marker > HDR, SK\n     {IDi,\
    \ [CERT,] [CERTREQ,] [IDr,] AUTH, N(USE_TRANSPORT_MODE),\n     SAi2, TSi, TSr}\n\
    \    -->\n                      <-- IPv4(source_addr=HAADDR, dest_addr=V4ADDR)\n\
    \                              UDP (4500,Y) <non-ESP Marker > HDR, SK\n      \
    \                        {IDr, [CERT,] AUTH, N(USE_TRANSPORT_MODE),\n        \
    \                      SAr2, TSi, TSr}\n   The corresponding Security Policy Database\
    \ (SPD) entries are shown\n   below.\n   Mobile node SPD-S:\n      IF local_address\
    \ = home_address_1 &\n         remote_address = home_agent_1 &\n         proto\
    \ = MH & local_mh_type = BU &\n         remote_mh_type = BAck\n     Then use SA\
    \ ESP transport mode\n     Initiate using IDi = user_1 to address home_agent_1\n\
    \   Home Agent SPD-S:\n      IF local_address = home_agent_1 &\n         remote_address\
    \ = home_address_1 &\n         proto = MH &\n         local_mh_type = BAck &\n\
    \         remote_mh_type = BU\n      Then use SA ESP transport mode\n   Where\
    \ home_address_1 is the mobile node's registered IPv6 home\n   address and home_agent_1\
    \ is the IP address of the home agent.\n   The above should result in BU/BA messages\
    \ with the following BU\n   received by the home agent:\n      IPv4 header (src=V4ADDR,\
    \ dst=HA_V4ADDR)\n      UDP header (sport=Z, dport=DSMIPv6)\n      IPv6 header\
    \ (src=V6HOA, dst=HAADDR)\n      ESP header in transport mode\n      Mobility\
    \ header\n      BU [IPv4 HAO]\n      IPv4 CoA option\n      (and others as needed)\n\
    \   At the home agent, following UDP de-capsulation, the binding update\n   is\
    \ delivered to the IPsec module as shown below:\n      IPv6 header (src=V6HOA,\
    \ dst=HAADDR)\n      ESP header in transport mode\n      Mobility header\n   \
    \   BU [IPv4 HAO]\n      IPv4 CoA option\n      (and others as needed)\n   In\
    \ addition, V4ADDR and the sport (Z) need to be passed with the\n   packet to\
    \ ensure correct processing.\n   Following IPsec processing, the binding update\
    \ is delivered to the\n   DSMIPv6 home agent module as follows:\n      IPv6 header\
    \ (src=V6HOA, dst=HAADDR)\n      Mobility header\n      BU [IPv4 HAO]\n      IPv4\
    \ CoA option\n      (and others as needed)\n   In addition, V4ADDR and the sport\
    \ (Z) need to be passed with the\n   packet to ensure correct processing.\n  \
    \ The binding acknowledgement sent by the home agent module to the\n   IPsec module\
    \ is as follows:\n      IPv6 header (src=HAADDR, dst=V6HOA)\n      Mobility header\n\
    \      BA ([IPv4 ACK], NAT DET)\n      (and others as needed)\n   In addition,\
    \ V4ADDR, the sport from the BU (Z), and an indication\n   that UDP encapsulation\
    \ must be used need to be passed with the packet\n   to ensure correct processing.\n\
    \   The binding acknowledgement sent by the home agent to the mobile node\n  \
    \ is as follows:\n      IPv4 header (src= HA_V4ADDR, dst=V4ADDR)\n      UDP header\
    \ (sport=DSMIPv6, dport=Z)\n      IPv6 header (src=HAADDR, dst=V6HOA)\n      ESP\
    \ header in transport mode\n      Mobility header\n      BA ([IPv4 ACK], NAT DET)\n"
- title: 5.2.2.  IKEv2 Operation for Securing Data over IPv4
  contents:
  - "5.2.2.  IKEv2 Operation for Securing Data over IPv4\n   To secure data traffic\
    \ when the mobile node is located in an IPv4-\n   only network, the mobile node\
    \ MUST establish a child_SA for that\n   purpose.  Note that V4ADDR refers to\
    \ either the mobile node's care-of\n   address in the visited link or the public\
    \ address allocated to the\n   mobile node by the NAT.  The procedure is as follows:\n\
    \   Mobile Node                                     Home Agent\n   -----------\
    \                                     ----------\n   IPv4(source_addr=V4ADDR,\
    \ dest_addr=HAADDR)\n    UDP (4500,4500) < non-ESP Marker > HDR, SK\n     {[N],\
    \ SA, Ni, [KEi], TSi, TSr}    -->\n                        <--IPv4(source_addr=HAADDR,\
    \ dest_addr=V4ADDR)\n                               UDP (4500,Y) < non-ESP Marker\
    \ > HDR, SK\n                                SA, Nr, [KEr], TSi, TSr}\n   If no\
    \ NAT is detected, the encapsulation used will be:\n      IPv4 (source_addr=v4CoA,\
    \ dest_addr=HAAddr)\n      ESP\n      IP (source_addr=HoA, set_addr=CNAddr)\n\
    \      Upper_layer_HDR\n   Where IP is either IPv4 or IPv6 and HoA is either the\
    \ IPv4 HoA or the\n   IPv6 HoA.\n   If a NAT is detected, the encapsulation used\
    \ will be:\n      IPv4 (source_addr=v4Addr, dest_addr=HAAddr)\n      UDP (sport=Y,\
    \ dport=4500)\n      ESP\n      IP (source_addr=HoA, set_addr=CNAddr)\n      Upper_layer_HDR\n\
    \   Where v4CoA may be the external IPv4 address of the NAT, IP is either\n  \
    \ an IPv4 or IPv6 header, and HoA is either the IPv4 or the IPv6 HoA.\n   The\
    \ above format shows the packet as seen by the home agent.\n   The SPD, whether\
    \ a NAT is detected or not, is set as follows.  Note\n   that this rule is designed\
    \ to match all data from the MN to nodes\n   other than the home agent.  This\
    \ is done so that this rule does not\n   overlap with the earlier rule securing\
    \ BU/BA signaling between the MN\n   and the HA.\n   Mobile Node SPD-S:\n    \
    \  IF local_address = home_address &\n         remote_address != home_agent &\n\
    \         proto=any\n      Then use SA ESP tunnel mode\n      Initiate using IDi\
    \ = user_1 to address home_agent_1\n   home agent SPD-S:\n      IF local_address\
    \ != home_agent &\n         remote_address = home_address &\n         proto=any\n\
    \      Then use SA ESP tunnel mode\n   Where home_address is the MN's registered\
    \ IPv6 or IPv4 home address\n   and home_agent is the IPv6 or the IPv4 address\
    \ of the home agent.\n"
- title: 6.  Protocol Constants
  contents:
  - "6.  Protocol Constants\n      NATKATIMEOUT = 110 seconds.\n"
- title: 7.  Acknowledgements
  contents:
  - "7.  Acknowledgements\n   Thanks to the following members (in alphabetical order)\
    \ of the MIP6\n   and NEMO Working Groups for their contributions, discussions,\
    \ and\n   reviews: Jari Arkko, Sri Gundavelli, Wassim Haddad, Alfred Hoenes,\n\
    \   Conny Larsson, Acee Lindem, Ahmad Muhanna, Vidya Narayanan, Karen\n   Nielsen,\
    \ and Keiichi Shima.  Thanks to Karen Nielsen, Pasi Eronen,\n   and Christian\
    \ Kaas-Petersen for raising the issue of IKEv2\n   interactions and proposing\
    \ the solution included in this document.\n   Thanks to Pasi Eronen for many thorough\
    \ reviews of this document.\n"
- title: 8.  IANA Considerations
  contents:
  - "8.  IANA Considerations\n   IANA has made the following allocations according\
    \ to this\n   specification:\n      A UDP port (4191) has been assigned for the\
    \ NAT traversal\n      mechanism described in Section 4.2.\n      The IPv4 home\
    \ address option described in Section 3.1.1 has been\n      assigned value 29.\
    \  This option is included in the mobility header\n      described in [RFC3775].\n\
    \      The IPv4 address acknowledgement option described in Section 3.2.1\n  \
    \    has been assigned value 29.  This option is included in the\n      mobility\
    \ header described in [RFC3775].\n      The NAT detection option described in\
    \ Section 3.2.2 has been\n      assigned a value 31.  This option is included\
    \ in the mobility\n      header described in [RFC3775].\n      The IPv4 care-of\
    \ address option described in Section 3.1.2 has\n      been assigned value 32.\
    \  This option is included in the mobility\n      header described in [RFC3775].\n\
    \   The status field in the IPv4 home address option has been allocated\n   by\
    \ IANA under the new registry: \"DSMIPv6 IPv4 Home Address Option\n   Status Codes\"\
    .\n   The status field values are allocated using the following procedure:\n \
    \  1. New status field values are allocated through IETF review.  This\n     \
    \ is for all RFC types including standards track, informational, and\n      experimental\
    \ status that originate from the IETF and have been\n      approved by the IESG\
    \ for publication.\n   2. Requests for new option type value assignments from\
    \ outside the\n      IETF are only made through the publication of an IETF document,\n\
    \      per 1 above.  Note also that documents published as Independent\n     \
    \ \"RFC Editor contributions\" [RFC4844] are not considered to be IETF\n     \
    \ documents.\n"
- title: 9.  References
  contents:
  - '9.  References

    '
- title: 9.1.  Normative References
  contents:
  - "9.1.  Normative References\n   [RFC2119]   Bradner, S., \"Key words for use in\
    \ RFCs to Indicate\n               Requirement Levels\", BCP 14, RFC 2119, March\
    \ 1997.\n   [RFC2473]   Conta, A. and S. Deering, \"Generic Packet Tunneling in\n\
    \               IPv6 Specification\", RFC 2473, December 1998.\n   [RFC3168] \
    \  Ramakrishnan, K., Floyd, S., and D. Black, \"The Addition\n               of\
    \ Explicit Congestion Notification (ECN) to IP\", RFC\n               3168, September\
    \ 2001.\n   [RFC3775]   Johnson, D., Perkins, C., and J. Arkko, \"Mobility Support\n\
    \               in IPv6\", RFC 3775, June 2004.\n   [RFC3948]   Huttunen, A.,\
    \ Swander, B., Volpe, V., DiBurro, L., and M.\n               Stenberg, \"UDP\
    \ Encapsulation of IPsec ESP Packets\", RFC\n               3948, January 2005.\n\
    \   [RFC3963]   Devarapalli, V., Wakikawa, R., Petrescu, A., and P.\n        \
    \       Thubert, \"Network Mobility (NEMO) Basic Support\n               Protocol\"\
    , RFC 3963, January 2005.\n   [RFC4306]   Kaufman, C., Ed., \"Internet Key Exchange\
    \ (IKEv2)\n               Protocol\", RFC 4306, December 2005.\n   [RFC4436] \
    \  Aboba, B., Carlson, J., and S. Cheshire, \"Detecting\n               Network\
    \ Attachment in IPv4 (DNAv4)\", RFC 4436, March\n               2006.\n   [RFC4555]\
    \   Eronen, P., \"IKEv2 Mobility and Multihoming Protocol\n               (MOBIKE)\"\
    , RFC 4555, June 2006.\n   [RFC4861]   Narten, T., Nordmark, E., Simpson, W.,\
    \ and H. Soliman,\n               \"Neighbor Discovery for IP version 6 (IPv6)\"\
    , RFC 4861,\n               September 2007.\n   [RFC4877]   Devarapalli, V. and\
    \ F. Dupont, \"Mobile IPv6 Operation\n               with IKEv2 and the Revised\
    \ IPsec Architecture\", RFC 4877,\n               April 2007.\n   [RFC5026]  \
    \ Giaretta, G., Ed., Kempf, J., and V. Devarapalli, Ed.,\n               \"Mobile\
    \ IPv6 Bootstrapping in Split Scenario\", RFC 5026,\n               October 2007.\n"
- title: 9.2.  Informative References
  contents:
  - "9.2.  Informative References\n   [CHOWDHURY] Chowdhury, K. and A. Yegin, \"MIP6-bootstrapping\
    \ for the\n               Integrated Scenario\", Work in Progress, April 2008.\n\
    \   [RFC2983]   Black, D., \"Differentiated Services and Tunnels\", RFC\n    \
    \           2983, October 2000.\n   [RFC3344]   Perkins, C., Ed., \"IP Mobility\
    \ Support for IPv4\", RFC\n               3344, August 2002.\n   [RFC3519]   Levkowetz,\
    \ H. and S. Vaarala, \"Mobile IP Traversal of\n               Network Address\
    \ Translation (NAT) Devices\", RFC 3519,\n               April 2003.\n   [RFC4459]\
    \   Savola, P., \"MTU and Fragmentation Issues with In-the-\n               Network\
    \ Tunneling\", RFC 4459, April 2006.\n   [RFC4844]   Daigle, L., Ed., and Internet\
    \ Architecture Board, \"The\n               RFC Series and RFC Editor\", RFC 4844,\
    \ July 2007.\n   [RFC4977]   Tsirtsis, G. and H. Soliman, \"Problem Statement:\
    \ Dual\n               Stack Mobility\", RFC 4977, August 2007.\n   [RFC5380]\
    \   Soliman, H., Castelluccia, C., ElMalki, K., and L.\n               Bellier,\
    \ \"Hierarchical Mobile IPv6 (HMIPv6) Mobility\n               Management\", RFC\
    \ 5380, October 2008.\n   [RFC5389]   Rosenberg, J., Mahy, R., Matthews, P., and\
    \ D. Wing,\n               \"Session Traversal Utilities for NAT (STUN)\", RFC\
    \ 5389,\n               October 2008.\n   [RFC5405]   Eggert, L. and G. Fairhurst,\
    \ \"Unicast UDP Usage\n               Guidelines for Application Designers\",\
    \ BCP 145, RFC 5405,\n               November 2008.\n"
- title: 10. Contributors
  contents:
  - "10. Contributors\n   This document reflects discussions and contributions from\
    \ several\n   people including (in alphabetical order):\n      Vijay Devarapalli:\
    \ vijay.devarapalli@azairenet.com\n      James Kempf: kempf@docomolabs-usa.com\n\
    \      Henrik Levkowetz: henrik@levkowetz.com\n      Pascal Thubert: pthubert@cisco.com\n\
    \      George Tsirtsis: G.Tsirtsis@Qualcomm.com\n      Ryuji Wakikawa: ryuji@sfc.wide.ad.jp\n"
- title: Author's Address
  contents:
  - "Author's Address\n   Hesham Soliman (editor)\n   Elevate Technologies\n   EMail:\
    \ hesham@elevatemobile.com\n"
