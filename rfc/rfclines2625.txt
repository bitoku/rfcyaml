Abstract Fibre Channel (FC) is a high speed serial interface technology that supports several higher layer protocols including Small Computer System Interface (SCSI) and Internet Protocol(IP).
Until now, SCSI has been the only widely used protocol over FC.
Existing FC standards [3] do not adequately specify how IP packets may be transported over FC and how IP addresses are resolved to FC addresses.
The purpose of this document is to specify a way of encapsulating IP and Address Resolution Protocol(ARP) over Fibre Channel and also to describe a mechanism(s) for IP address resolution.
Introduction Fibre Channel (FC) is a gigabit speed networking technology primarily used for Storage Area Networking (SAN).
FC is standardized under American National Standard for Information Systems of the National Committee for Information Technology Standards (NCITS) and has specified a number of documents describing its protocols, operations, and services.
Currently, Fibre Channel is predominantly used for communication between storage devices and servers using the SCSI protocol, with most  of the servers still communicating with each other over LANs.
Although, there exists a Fibre Channel Standard [3] that has architecturally defined support for IP encapsulation and address resolution, it is inadequately specified.
([3] prohibits broadcasts, thus loops are not covered; [10] has no support for Class 3).
This has lead to a nonstandard way of using IP over FC in the past.
Once such a standard method is completely specified, servers can directly communicate with each other using IP over FC, possibly boosting performance in Server host to host communications.
This technique will be especially useful in a Clustering Application.
The major objective of this specification is to promote interoperable implementations of IPv4 over FC.
This specification describes a method for encapsulating IPv4 and Address Resolution Protocol (ARP) packets over FC.
This specification accommodates any FC topology (loop, fabric, or point to point) and any FC class of service (1, 2 or 3).
This specification also describes a FC Address Resolution Protocol(FARP) for associating World Wide Port Names (MAC addresses) and FC Port identifiers.
A secondary objective of this specification is to describe other optional address resolution mechanisms: Other FARP mechanisms that directly build IPv4 address and FC Port Identifier (Port ID) associations.
that allows learning the IP address of a remote node given its World Wide Port Name (WW PN) and Port ID.
"Multicasting" in Fibre Channel is defined as an optional service [11] for FC Classes 3 and 6 only, with no definition for Classes 1 and 2.
Currently, there are no vendor implementations of this service for either Class of service.
Broadcast service available within Fibre Channel can be used to do multicasting, although less efficiently.
Presently, there appears to be no IP applications over Fibre Channel that require support for IP multicasting.
This specification therefore does not support IP Multicasting.
Section 2 states the problem that is solved in this  specification.
Section 3 describes the techniques used for encapsulating  IP and ARP packets in a FC sequence.
Section 4 discusses the ARP protocol(IP address to WW PN).
Section 5 discusses the FARP protocol used in FC Layer mappings (WW PN to Port ID).
Section 6 describes the "Exchange" Management in FC.
Section 7 is a summary section and provides a quick reference to FC header settings, FC Link Service Commands,
supported features in ARP, FARP, InARP, FC Sequences, FC Exchanges, and FC Login Parameters.
Section 9 acknowledges the technical contributors of this document.
Section 10 provides a list of references, and Section 11 provides the authors' addresses.
Appendix A discusses other optional FARP mechanisms.
Appendix B discusses the Inverse ARP protocol(WW PN to IP address) as an alternate and optional way of building MAC and IP address associations.
Appendix C lists some informal mechanisms for FC Layer Mappings.
Appendix D provides a discussion on validation of the FC  layer mappings for the different FC topologies.
Appendix E provides a brief overview of the FC Protocols and Networks.
Appendix F addresses reliability in Class 3 and Sequence Count FC Protocol issues.
Appendix G provides a list of acronyms and a glossary of FC Terms used in this specification.
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 [19].
This specification addresses two problems: A format definition and encapsulation mechanism for IPv4 and ARP packets over FC Mechanisms for Address Resolution
As noted earlier, the existing FC Standard [3] ([10]) is inadequate to solve the above problems.
A solution to both problems was first proposed by the Fibre Channel Association (FCA)[1].
FCA is an industry consortium of FC vendor companies and not a Standards Body.
This specification is based on the proposed solution in [1] and builds on it.
Address Resolution is concerned with resolving IP addresses to WW PN (MAC address) and WW PN to FC Port Identifiers (Port ID).
ARP provides a solution to the first resolution problem and FARP the second.
An optional FARP mechanism resolves IP address directly to FC Port IDs.
This is useful in some upper layer applications.
InARP is another optional mechanism that resolves WW PN and Port ID to an IP address.
InARP is useful when a node after performing a PLOGI with another node, knows its WW PN and Port ID, but not its IP address.
IP and ARP Encapsulation 3.1 FC Frame Format
All FC frames have a standard format much like LAN 802.x protocols.
(See Appendix E and F).
However, the exact size of each frame varies depending on the size of the variable fields.
The size of the variable field ranges from 0 to 2112 bytes as shown in the FC Frame Format in Fig.
The Start of Frame (SOF) and End of Frame (EOF) are both 4 bytes long and act as frame delimiters.
The CRC is 4 bytes long and uses the same 32 bit polynomial used in FDDI and is specified in ANSI X3.139 Fiber Distributed Data Interface.
The Frame Header is 24 bytes long and has several fields that are associated with the identification and control of the payload.
Some of the values and options for this field that are relevant to the IP and ARP payloads are discussed in Section 7.
Current FC Standards allow up to 3 Optional Header fields [11]: Network Header (16 bytes)
Device Header (up to 64 bytes).
The IP and ARP FC Sequences SHALL carry only the Network Header field which is 16 bytes long.
Other types of optional headers SHALL NOT be used.
The Network Header is REQUIRED in all ARP packets and in the first frame of a logical sequence carrying an IP payload as described below.
An application level payload such as IP is called an Information Unit at the FC 4 Level.
Lower FC levels map this to a FC Sequence.
(See Appendix E.2 for a description of Sequences and Information Units.)
Typically, a Sequence consists of more than one frame.
Larger user data is segmented and reassembled using two methods: Sequence Count and Relative Offset [18].
With the use of Sequence Count, data blocks are sent using frames with increasing sequence counts (modulo 65536) and it is quite straightforward to detect the first frame that contains the Network Header.
When Relative Offset is used, as frames arrive, some computation is required to detect the first frame that contains the Network Header.
Sequence Count and Relative Offset field control information, is carried in the FC Header.
In FC, the physical temporal ordering of the frames as it arrives at a destination can be different from that of the order sent because of traversing through a FC Network.
When IP forms the FC Payload then only the first frame of the logical Sequence SHALL include the FC Network Header.
2 shows the logical First Frame and logical subsequent frames.
Since frames may arrive out of order, detection of the first frame of the logical FC Sequence is necessary.
ARP packets map to a single frame FC Sequence and SHALL always carry the FC Network Header.
Note the definition of FC Data Field and FC Frame Payload in Fig.
FC Data Field includes the FC Frame Payload and the FC Optional Header, that is, Frame Payload definition does not include the FC Optional Header.
One or more Frame Payloads together make the FC Sequence Payload as shown in Fig 2 and discussed further in Sections 3.2 and 3.4.
FC Sequence Payload includes the mapped IP or ARP packet along with the LLC/SNAP headers.
2 FC Network Header in a Frame Sequence
The SOF, CRC, EOF control fields of the FC frame and other optional headers have been omitted in the figure for clarity.
3.2 MTU 3.2.1 IP MTU An FC Information Unit specific to each protocol such as IP is defined in FC 4.
This defines the upper bound on the size of the information that can be transported.
Each IP or ARP Packet is mapped to a single FC Information Unit, which in turn is mapped to a single FC Sequence.
There is a one to  one mapping between an IP or ARP packet and a FC Sequence.
Fibre Channel limits the size of a single Information Unit to 2^32 1, which is very large [2].
However, since the Maximum Transmission Unit (MTU) size of an IPv4 packet does not exceed 65,536 bytes, the mapped IPv4 size is far below the 2^32 1 limit.
IPv4 Packet definition includes the IP Payload and IP Headers both fixed and optional.
The corresponding FC Sequence Payload includes the LLC/SNAP Header and the IPv4 packet.
As noted above, the greatest length allowed for an IPv4 Packet including any optional headers and independent of this standard is 65,536 bytes.
However, limiting the IP MTU size to 65,280 bytes helps in buffer resource allocation at N Ports and also allows for up to 256 bytes of overhead.
Since the FC Network Header requires 16 bytes and the IEEE 802.2 LLC/SNAP header requires 8 bytes, it leaves 232 bytes for future use.
All implementations SHALL restrict the IP MTU size to 65,280 bytes and the corresponding FC Sequence Payload size to 65536 bytes.
In order for IP fragmentation and reassembly to work properly it is necessary that every implementation of IP be capable of transporting a maximally minimum size IP packet without fragmentation.
A maximally minimum size IP Packet is defined as an IP Packet with an 8 byte payload (the smallest possible non zero payload size for a fragment) and a 60 byte header (the largest possible header consisting of a 20 byte fixed part and a maximum size option field of 40 bytes) [17].
All implementations SHALL support a FC Data Field of 92 bytes, which is required to support 68 bytes of the maximally minimum sized IP Packet, 16 bytes of the FC Network Header, and 8 bytes of the LLC/SNAP Header.
The ARP packet has a fixed size of 28 bytes.
All implementations SHALL support a FC Data Field size of 52 bytes, which is required to support 28 bytes of an ARP Packet, 16 bytes of the FC Network Header, and 8 bytes of the LLC/SNAP Header.
Note that the minimum MTU requirement for ARP is already covered by the minimum MTU requirement for IP
but it is mentioned here for completeness.
The InARP packet is identical in size to the ARP and the same MTU requirements apply.
3.2.4 FC Data Field containing FARP Packet
The FARP Command is a FC Extended Link Service (ELS) command and maps directly to the FC Data Field without the LLC/SNAP or the FC Network Header.
The FARP Command has a fixed size of 76 bytes.
Because FARP operates purely in the FC space, it places no special MTU requirements in this specification.
3.3 FC Port and Node Network Addresses FC devices are identified by Nodes and their Ports.
A Node is a collection of one or more Ports identified by a unique nonvolatile 64 bit World Wide Node name (WW NN).
Each Port in a node, is identified with a unique nonvolatile 64 bit World Wide Port name (WW PN), and a volatile Port Identifier (Port ID).
Port IDs are 24 bits long.
A FC frame header carries a Source Port ID (S ID) and a Destination Port ID (D ID).
The Port ID of a given port is volatile.
(The mechanism(s) by which a Port ID may change in a FC topology is outside the scope of this document.
The FC Network Header is normally optional in FC Standards, but REQUIRED in this specification.
A FC Network Header carries source and destination WW PNs.
A WW PN consists of a 60 bit Network Address and a upper 4 bit Network Address Authority (NAA) field as shown in Fig.
The 4 bit NAA field is used to distinguish between the various name registration authorities used to define the Network Address [2].
In this specification, both the Source and Destination 4 bit NAA identifiers SHALL be set to binary '0001' indicating that an IEEE 48 bit MAC address is contained in the lower 48 bits of the network address fields.
The high order 12 bits in the network address fields SHALL be set to 0x0000.
The NAA field value equal to binary '0001' allows FC networks to be bridged with other FC networks or traditional LANs.
3 Format of the Network Header Field 3.4
FC Sequence Payload Format FC Payload with IP
: An FC Sequence Payload carrying an IP and ARP packet SHALL use the formats shown in Figs.
Both formats use the 8 byte LLC/SNAP header.
4 Format of FC Sequence Payload carrying IP FC Sequence Payload with ARP: As noted earlier, FC frames belonging to the same Sequence may be delivered out of order over a Fabric.
If the Relative Offset method is used to identify FC Sequence Payload fragments, then the IP Header MUST appear in the frame that has a relative offset of 0.
5 Format of FC Sequence Payload carrying ARP FC Sequence Payload with FARP:
FARP Protocol commands are directly mapped to the Frame Sequence Payload and are 76 bytes long.
No LLC/SNAP Header or FC Network Header is used and therefore the FC Data Field size simply consists of the FC Sequence Payload.
A Logical Link Control (LLC) field along with a Sub Network Access Protocol (SNAP) field is a method used to identify routed and bridged non OSI protocol PDUs and is defined by IEEE 802.2 and applied to IP in [8].
In LLC Type 1 operation (i.e., unacknowledged connectionless mode), the LLC header is 3 bytes long and consists of a 1 byte Destination Service Access Point (DSAP)field, a 1 byte Source Service Access Point (SSAP)field, and a 1 byte Control field as shown in Fig.
The LLC's DSAP and SSAP values of 0xAA indicate that an IEEE 802.2 SNAP header follows.
The LLC's CTRL value equal to 0x03 specifies an Unnumbered Information Command PDU.
In this specification the LLC Header value SHALL be set to 0xAA AA 03.
Other values of DSAP/SSAP indicate support for other protocols and SHALL NOT be used in this specification.
The SNAP Header is 5 bytes long and consists of a 3 byte Organizationally Unique Identifier (OUI) field and a 2 byte Protocol Identifier (PID) as shown in Fig.
7 SNAP Format SNAP was invented to "encapsulate" LAN frames within the payload.
The SNAP OUI value equal to 0x00 00 00 specifies that the PID is an EtherType (i.e., routed non OSI protocol).
The SNAP OUI value equal to 0x00 80 C2 indicates Bridged Protocols.
With the OUI value set to 0x00 00 00, the SNAP PID value equal to 0x08 00 indicates IP and a PID value equal to 0x08 06 indicates ARP (or InARP).
The complete LLC/SNAP Header is shown in Fig.
3.5 Bit and Byte Ordering IP or ARP
Packets are mapped to FC 4 Level using the big endian byte ordering, which corresponds to the standard network byte order or canonical form [20].
FC 4 Payload maps with no change in order to the FC 2 Level.
FC 1 Level defines the method used to encode data prior to transmission and subsequently decode the data upon reception.
The method encodes 8 bit bytes into 10 bit transmission characters to improve the transmission characteristics of the serial data stream.
In Fibre Channel, data fields are aligned on word boundaries.
A word in FC is defined as 4 bytes or 32 bits.
The resulting transmission word after the 8 bit to 10 bit encoding consists of 40 bits.
Data words or Ordered Sets (special FC 2 Level control words) from the FC 2 Level map to the FC 1 Level with no change in order and the bytes in the word are transmitted in the Most Significant Byte first to Least Significant Byte order.
The transmission order of bits within each byte is the Least Significant Bit to the Most Significant Bit.
ARP 4.1 Address Resolution Address Resolution in this specification is primarily concerned with associating IP addresses with FC Port addresses.
As described earlier, FC device ports have two types of addresses: a non volatile unique 64 bit address called World Wide Port Name (WW PN)
a volatile 24 bit address called a Port ID The Address Resolution mechanism therefore will need two levels of mapping: 1.
A mapping from the IP address to the WW PN (i.e., IEEE 48 bit MAC address) 2.
A mapping from the WW PN to the Port ID (see Appendix G for a definition of Port ID)
The address resolution problem is compounded by the fact that the Port ID is volatile and the second mapping MUST be valid before use.
Moreover, this validation process can be different depending on the network topology used.
Appendix D provides a discussion on validation for the different FC topologies.
Architecturally, the first level of mapping and control operation is handled by the Address Resolution Protocol (ARP), and the second level by the FC Address Resolution Protocol (FARP).
FARP is described in Section 5.
Other optional mechanisms in FARP that directly map an IP address to a Port ID, or WW NN to a Port ID are described in Appendix A.
The Inverse Address Resolution Protocol (InARP) is yet another optional mechanism that resolves WW PN and Port IDs to IP addresses.
InARP is described in Appendix B. 4.2 ARP Packet Format
The Address Resolution Protocol (ARP) given in [9] was designed to be a general purpose protocol, and to work with many network technologies, and with many upper layer protocols.
Fig 9 shows the ARP packet format based on [9], where the upper layer protocol uses a 4 octet protocol (IP) address and
the network technology uses six  octet hardware (MAC) address.
The ARP uses two packet types Request and Reply and each type of packet is 28  bytes long in this specification.
The ARP Packet fields are common to both ARP Requests and ARP Replys.
ARP Request Packet is mapped to a FC Broadcast Sequence and the exact mechanism used to broadcast a FC Sequence depends on the FC topology.
This is discussed later in this section.
Compliant ARP Request Broadcasts SHALL include Network Headers.
ARP Reply Packet is mapped to a FC Sequence.
Compliant ARP Replys SHALL include Network Headers.
Note that in all discussions to follow, the WW PN and the 48 bit MAC address conceptually mean the same thing.
The 'HW Type' field SHALL be set to 0x00 01.
Technically, the correct HW Type value should be set to 0x00 06
according to RFC 1700 indicating IEEE 802 networks.
However, as a practical matter a HW Type value of 0x00 06 is known to cause rejections from some Ethernet end stations when FC is bridged to Ethernet.
Translational bridges are normally expected to change this field from Type 6 to 1 and vice versa under these configurations, but many do not.
It is because of this reason that the Type Code is set to 1 rather than 6.
However, both HW Type values of 0x00 01 and 0x00 06 SHALL be accepted.
The 'Protocol' field SHALL be set to 0x08 00
The 'HW Addr Length' field SHALL be set to 0x06 indicating 6 bytes of HW address.
The 'Protocol Addr Length' field SHALL be set to 0x04 indicating 4  bytes of IPv4 address.
The 'Operation' Code field SHALL be set as follows: 0x00 01 for ARP Request 0x00 02 for ARP Reply
The 'HW Addr of Sender' field SHALL be the 6 byte IEEE MAC address of the sender.
It is either the Requester (ARP Request) or the Responder (ARP Reply) address.
The 'Protocol Addr of Sender' field SHALL be the 4 byte IP address of the Requester (ARP Request) or that of the Responder (ARP Reply).
The 'HW Addr of Target' field SHALL be set to zero during an ARP Request and to the 6 byte MAC address of the Requester (ARP Request) in an ARP Reply.
The 'Protocol Addr of Target' field SHALL be set to the 4 byte IP address of the Responder (ARP Reply) in a ARP Request, and to the 4 byte IP address of the Requester (ARP Request) in an ARP Reply.
ARP Packet Format 4.3 ARP Layer Mapping and Operation
Whenever a FC port wishes to send IP data to another FC port, then the following steps are taken: 1.
The source port should first consult its local mapping tables to determine the <destination IP address, destination WW PN>.
If such a mapping is found, then the source sends the IP data to the port whose WW PN address was found in the table.
If such a mapping is not found, then the source sends an ARP Request broadcast to its connected FC network in anticipation of getting a reply from the correct destination along with its WW PN.
When an ARP Request Broadcast frame is received by a node with the matching IP address, it generates an ARP Reply.
Since the ARP Reply must be addressed to a specific destination Port ID, the FC layer mapping between the WW PN and Port ID (of the ARP Request orginator) MUST be valid before the reply is sent.
If no node has the matching IP address, the result is a silent behavior.
4.4 ARP Broadcast in a Point to Point Topology
The ARP Request (Broadcast) and Reply mechanism described above still apply, although there is only one node that receives the ARP Request.
4.5 ARP Broadcast in a Private Loop Topology
In a private loop, the ARP Request Broadcast frame is sent using the broadcast method specified in the FC AL [7]standard. 1.
The source port first sends an Open Broadcast Replicate primitive (OPN(fr))Signal forcing all the ports in the loop (except itself), to replicate the frames that they receive while examining the frame header's Destination ID field.
The source port then removes this OPN(fr) signal when it returns to it.
The loop is now ready to receive the ARP broadcast.
The source now sends the ARP Request as a single frame Broadcast Sequence in a Class 3 frame with the following FC Header D ID field and F CTL bits setting:
Destination ID <Word 0, bit 0:23
D ID   0xFF FF FF Sequence Initiative <Word 2, bit23>: SI 0
Last Sequence <Word 2, bit 20>:
End Sequence <Word 2, bit 19>: ES 1. 4.
A compliant ARP Broadcast Sequence frame SHALL include the Network Header with destination MAC address set to 0xFF FF FF  FF FF FF and with NAA   b'0001' 5.
The destination port recognizing its IP address in the ARP Request packet SHALL respond with an ARP Reply.
4.6 ARP Broadcast in a Public Loop Topology
The following steps will be followed when a port is configured in a public loop: 1.
A public loop device attached to a fabric through a FL Port MUST NOT use the OPN(fr) signal primitive.
Rather, it sends the broadcast sequence to the FL Port at AL PA   0x00.
A FC Fabric propagates the broadcast to all other ports including the FL Port which the broadcast arrived on.
This includes all F Ports, and other FL Ports.
On each FL Port, the fabric propagates the broadcast by first using the primitive signal OPNfr, in order to prepare the loop to receive the broadcast sequence.
A Broadcast Sequence is now sent on all ports (all FL ports, F Ports) in Class 3 frame with:
Destination ID <Word 0, bit 23:0
D ID   0xFF FF FF Sequence Initiative <Word 2, bit23>: SI 0
Last Sequence <Word 2, bit 20>:
End Sequence <Word 2, bit 19>: ES 1. 5.
A compliant ARP Broadcast Sequence frame SHALL include the Network Header with destination MAC address set to 0xFF FF FF  FF FF FF and with NAA   b'0001' 6.
The destination port recognizing its IP address in the ARP Request packet SHALL respond with an ARP Reply.
4.7 ARP Operation in a Fabric Topology 1.
Nodes directly attached to fabric do not require the OPN(fr) primitive signal.
A Broadcast Sequence is now sent on all ports (all FL ports, F Ports) in Class 3 frame with:
Destination ID <Word 0, bit 23:0
D ID   0xFF FF FF Sequence Initiative <Word 2, bit23>: SI 0
Last Sequence <Word 2, bit 20>:
End Sequence <Word 2, bit 19>: ES 1. 3.
A compliant ARP Broadcast Sequence frame SHALL include the Network Header with destination MAC address set to 0xFF FF FF FF FF FF and with NAA   b'0001' 4.
The destination port recognizing its IP address in the ARP packet SHALL respond with an ARP Reply.
FARP 5.1 Scope FC Layer Mapping between the WW PN and the Port ID is independent of the ARP mechanism and is more closely associated with the details of the FC protocols.
Name Server and FC Address Resolution Protocol (FARP) are two formal mechanisms that can be used to create and maintain WW PN to Port ID tables.
FARP is a method using Extended Link Service (ELS) commands that resolves <
WW PN, Port ID> mappings.
The WW PN to Port ID address resolution using FARP is especially useful in instances where the Login table entries at a node expire and a Name Server is not available.
It is outside the scope of this document to describe Name Server.
Additional address matching mechanisms that resolve <WW NN, Port ID> and <IP addr.
, Port ID> mapping have been added to FARP.
These additional mechanisms are optional and described in Appendix A. Direct IP address to Port ID mapping is useful in applications where there is no visibility of the MAC address.
Other less formal FC Layer Mapping mechanisms are described in Appendix C.
Since Port IDs are volatile, all mapped Port IDs  at all times MUST be valid before use.
There are many events that can invalidate this mapping.
Appendix D discusses conditions when such a validation is required.
The FARP protocol uses two ELS commands FARP REQ and FARP REPLY.
Note: In the following discussion 'Requester' means the node issuing the FARP REQ ELS message; 'Responder' means the node replying to the request by sending the FARP REPLY command.
The FARP REQ ELS Broadcast Request command is used to retrieve a specific node's current Port ID given its unique WW PN.
This Port ID is sent in a FARP REPLY unicast command.
The FARP REQ may indicate that the Responder: Perform only a Login with it (Requester) or, Send only a FARP REPLY or, Perform a Login and send a FARP REPLY.
No sequence initiative is transferred with the FARP REQ and therefore no Reply (ACCEPT or REJECT) follows this command.
Since a Sequence Initiative is transferred with the FARP REPLY, either a ACCEPT or REJECT follows this command as a response.
Reception of a FARP REQ requires a higher level entity at the responding node to send a FARP REPLY or perform a Port Login.
You do not have to be logged in to issue a FARP Request.
Also, you do not have to be logged in to the FARP Requester to issue a FARP REPLY.
Request Sequence (No Reply Sequence)
FARP REPLY (ELS command) Sequence Accept/Reject Reply Sequence
The FARP Protocol Format [2] and Size:
FT 1, 76 bytes fixed size
In a FARP REQ, the S ID in the FC Header designates the Requester's Port ID.
The D ID in the FC Header is the broadcast identifier 0xFF FF FF.
In a FARP REPLY, the S ID in the FC Header designates the Responder's Port ID.
The D ID in the FC Header is the Requester's Port ID.
5.3 FARP Command Format FARP REQ and FARP REPLY commands have identical formats (76 bytes fixed size) and fields but use different command codes.
Port ID of Requester: It is the 24 bit Port ID used in the S ID field of the FC Header of a FARP REQ.
It is supplied by the Requester in a FARP REQ and retained in a FARP REPLY.
Port ID of Responder: It is the 24 bit Port ID used in the S ID field of the FC Header of a FARP REPLY.
It SHALL be set to 0x00 00 00 in a FARP REQ.
It is supplied by the Responder in a FARP REPLY.
This address field is used with the b'001', b'011', b'101, b'111', Match Address Code Points.
See Match Address Code Point Table below.
The Requester supplies the unique 8 byte WW PN of the Requester and the Responder.
It is retained in a FARP REPLY.
The WW NN address field is used with Match Address Code Points b'010', b'011', b'110', and b'111', which are all optional.
Its usage is fully described in Appendix A.
When the WW NN field is not used it SHALL be either set to '0' or a valid non zero address.
The IPv4 address field is used with the Match Address Code Points b'100', b'101', b'110', and b'111', which are all optional.
Its usage is fully described in Appendix A.
When the IP Address field is not used it SHALL be either set to '0' or a valid IP address.
A valid IP address consists of the 32 bit IPv4 Address with the upper 96 bits set to '0'.
5.4 Match Address Code Points For each receipt of the FARP REQ Broadcast ELS
, the recipients match one or more addresses based on the encoded bits of the "FARP Match Address Code Points" field shown in the table below.
FARP operation with the Match Address Code Point equal to b'001' is described in this section.
Other code points are OPTIONAL and are discussed in Appendix A.
The upper 5 bits of the Match Address Code Point byte are unused and their use is not currently defined.
If there is a match, then the node issues a response according to the action indicated by the FARP Responder Flag.
WW NN and IPv4 address fields are not used with the b'001' Code Point operation.
They SHALL be set to '0' or a valid address either by the Requester or the Requester and the Responder.
Note that there can be utmost one FARP REPLY per FARP REQ.
The Responder Flags define what Responder action to take if the result of the Match Address Code Points is successful. '
Responder Flags' is an 8 bit field (bits 0 7) and is defined in the table below.
This field is used only in a FARP REQ.
This field is retained unchanged in a FARP REPLY.
If no bits are set, the Responder will take no action.
If INIT P LOGI bit is set then, a Login is performed with the port identified by "Port ID of Requester" field.
If INIT REPLY is set then, a FARP REPLY is sent to the Port Identified by "Port ID of Requester" field.
If both bits are set at the same time, then both Actions are performed.
All other bit patterns are undefined at this time and are reserved for possible future use.
5.6 FARP Support Requirements Responder action FARP REPLY and/or Port Login for a successful MATCH
WW PN is always REQUIRED.
If there is no address match then a silent behavior is specified.
Support for all other Match Address Code Points is OPTIONAL and a silent behavior from the Responder is valid when it is not supported.
Recipients of the FARP REQ ELS SHALL NOT issue a Service Reject (LS RJT) if FARP OPTIONAL mechanisms are not supported.
In all cases, if there are no matches, then a silent behavior is specified.
If an implementation issues a FARP REQ with a Match Address Code Point that is OPTIONAL, and fails to receive a response, and the implementation has not obtained the Port ID of the Responder's port by other means (e.g., prior FARP REQ with other Code Points), then the implementation SHALL reattempt the FARP REQ with the MATCH WW PN Code Point.
Getting multiple FARP Replies corresponding to a single FARP REQ should normally never occur.
It is beyond the scope of this document to specify conditions under which this error may occur or what the corrective action ought to be.
Exchange Management 6.1 Exchange Origination FC Exchanges shall be established to transfer data between ports.
Frames on IP exchanges shall not transfer Sequence Initiative.
See Appendix E for a discussion on FC Exchanges.
6.2 Exchange Termination With the exception of the recommendations in Appendix F, Section F.1, "Reliability in Class 3", the mechanism for aging or expiring exchanges based on activity, timeout, or other method is outside the scope of this document.
Exchanges may be terminated by either port.
The Exchange Originator may terminate Exchanges by setting the LS bit, following normal FC standard FC PH [2] rules.
This specification prohibits the use of the NOP ELS with LS set for Exchange termination.
Exchanges may be torn down by the Exchange Originator or Exchange Responder by using the ABTS LS protocol.
The use of ABTS LS for terminating aged Exchanges or error recovery is outside the scope of this document.
The termination of IP Exchanges by Logout is discouraged, since this may terminate active Exchanges on other FC 4s.
Summary of Supported Features Note: 'Settable' means support is as specified in the relevant standard; all other key words are as defined earlier in this document.
This table applies only to FC 4 related data, such as IP and ARP packets.
This table does not apply to link services and other non FC 4 sequences (PLOGI, for example) that must occur for normal operation.
The TYPE field in the FC Header (Word 2 bits 31 24) MUST indicate ISO 8802 2 LLC/SNAP Encapsulation (Type 5).
This revision of the document focuses solely on the issues related to running IP and ARP over FC.
All other issues are outside the scope of this document, including full support for IEEE 802.2 LLC.
DF CTL field (Word 3, bits 23 16 of FC Header) MUST indicate the presence of a Network Header (0010 0000) on the First logical Frame of FC 4 Sequences.
It should not indicate the presence of a Network Header on any subsequent frames of the Sequence.
7.2 R CTL R CTL in FC Header:
This is REQUIRED for FC 4 (IP and ARP) packets Routing bits of R CTL field
MUST indicate Device Data frames (0000)
Information Category of R CTL field MUST indicate Unsolicited Data (0100)
7.3 F CTL F CTL in FC Header: Word 2, bits 23 0
First / Last / End Sequence (FS/LS/ES)
Condition  continue and single Seq.
For FC 4 frames, each N Port shall have a dedicated OX ID for sending data to each N Port in the network and a dedicated RX ID for receiving data from each N Port as well.
Exchanges are used in a unidirectional mode, thus setting Sequence Initiative is not valid for FC 4 frames.
Sequence Initiative is valid when using Extended Link Services.
This field is required to be 00, no information.
Sequence error policy is requested by an exchange originator in the F CTL Abort Sequence Condition bits in the first data frame of the exchange.
For Classes 1 and 2, ACK frame is required to be "continuous sequence".
Relative offset prohibited on all other types (Information Category) of frames.
not limited by end to end credit
Only one active sequence per exchange is optional.
A Sequence Initiator shall be capable of transmitting Sequences containing more frames than the available credit indicated by a Sequence recipient at Login.
FC PH [2] end to end flow control rules will be followed when transmitting such Sequences.
a) IP MTU size is 65280 bytes and resulting FC Sequence Payload size is 65536 bytes.
Maximally Minimum IP Packet size is 68 bytes and resulting FC Data Field size is 92 bytes.
Packet size is 28 bytes and resulting FC Data Field size is 52 bytes.
Some OS environments may not handle the max Sequence Payload size of 65536.
It is up to the administrator to configure the Max size for all systems.
All class 3 sequences are assumed to be non streamed.
Only applies for Class 1 and 2.
Use of ACK 1 is default, ACK 0 used if indicated by Sequence recipient at Login.
The administrator configured class of service is used, except where otherwise specified (e.g. Broadcasts are always sent in Class 3).
Review Appendix F, "Reliability in Class 3".
The first frame of the first sequence of a new Exchange must have SEQ CNT   0 [2].
Only applies to Classes 1 and 2, supported by the Exchange Originator.
A Port SHALL be capable of interoperating with another Port that requires X ID interlock.
The Exchange Originator facility within the Port shall use the X ID Interlock protocol in such cases.
An Exchange Responder is not required to assign RX IDs.
If a RX ID of FFFF is assigned, it is identifying Exchanges based on S ID / D ID / OX ID only.
In Classes 1 and 2, a Port shall reject a frame that would create a new Exchange with a P RJT containing reason code "Unable to establish Exchange".
In Class 3, the frame would be dropped.
When an Exchange is created between 2 Ports for IP/ARP data, it remains active while the ports are logged in with each other.
An Exchange SHALL NOT transfer Sequence Initiative (SI).
Broadcasts and ELS commands may use short lived Exchanges.
Well known Address FFFFFC is not used for ARP requests.
Frames from Well known address FFFFFC are not considered to be ARP frames.
Broadcast support is REQUIRED for ARP. 2.
The IP Address is mapped to a specific MAC address with ARP.
An ARP request is a Broadcast Sequence, therefore Class 3 is always used.
An ARP reply is a normal Sequence, thus the administrator configured class of service is used.
Request or Reply is a normal Sequence, thus an administrator configured class of service is used.
FARP REQ/FARP REPLY ELS commands
The administrator configured class of service is used.
PDISC shall not be used as a Requester; ADISC shall be used instead.
As a Responder, an implementation may need to respond to both ADISC and PDISC for compatibility with other specifications.
Responder Action FARP REPLY and/or Port Login for a successful MATCH
WW PN is always REQUIRED.
Support for all other match
Address Codes Points is a silent behavior from the Responder is valid when it is not supported.
Recipients of the FARP REQ ELS shall not issue a Service Reject (LS RJT) if FARP is not supported.
If other ELS commands are received an LS RJT may be sent.
NOP is not required by this specification, and shall not be used as a mechanism to terminate exchanges.
Required for FL Ports 7.8 Login Parameters
Unless explicitly noted here, a compliant implementation shall use the login parameters as described in [4].
7.8.1 Common Service Parameters FLOGI FC PH Version, lowest version may be 0x09 to indicate 'minimum 4.3'.
Can't use BB Credit 0 for N Port on a switched Fabric (F Port).
7.8.2 Common Service Parameters PLOGI FC PH Version, lowest version may be 0x09 to indicate 'minimum 4.3'.
Can't use BB Credit 0 for N Port in a Point to Point configuration Random Relative Offset is optional.
Note that the 'Receive Data Field Size' fields specified in the PLOGI represent both optional headers and payload.
The MAC Address can therefore be extracted from the 6 lower bytes of the WW PN field (when the IEEE 48 bit Identifier format is chosen as the NAA) during PLOGI or ACC payload exchanged during Fibre Channel Login [2].
The MAC Address can also be extracted from the WW PN field in the Network Header during ADISC (and ADISC ACC), or PDISC (and PDISC ACC).
7.8.3 Class Service Parameters PLOGI Discard error policy only.
Security Considerations 8.1 IP and ARP Related IP and ARP do not introduce any new security concerns beyond what already exists within the Fibre Channel Protocols and Technology.
Therefore IP and ARP related Security does not require special consideration in this document.
8.2 FC Related FC Standards [11] specify a Security Key Server (independent of IP and ARP) as an optional service.
However, there are no known implementations of this server yet.
Also, the previously defined [2] use of a Security Header has been discontinued [11].
Additional Matching Mechanisms in FARP Section 5 described the FC Layer mapping between the WW PN and the Port ID using the FARP Protocol.
This appendix describes other optional criteria for address matching and includes: WW NN WW PN & WW NN at the same time IPv4 IPv4 & WW PN at the same time IPv4 & WW NN at the same time IPv4 & WW PN & WW NN at the same time Depending on the Match Address Code Points, the FARP protocol fundamentally resolves three main types of addresses to Port IDs and is described in table below.
For Match Address Code Point b'001':  WW PN Names fields are used to resolve the WW PN names to Port IDs.
WW NN and IP address fields are not used with these Code Points and SHALL be set to either '0' or valid addresses by Requester or Requester and Responder.
For Match Address Code Point b'010':
WW NN Names fields are used to resolve the WW NN names to Port IDs.
WW PN and IP address fields are not used with these Code Points and SHALL be set to either '0' or valid addresses by Requester or Requester and Responder.
For Match Address Code Point b'100':  IPv4 fields are used to resolve the IPv4 addresses to Port IDs.
WW PN and WW NN fields are not used with these Code Points and SHALL be set to either ' 0' or valid addresses by Requester or Requester and Responder.
For all other Match Address Code Points b'011', b'101',b'110', b'111', depending on set bits one or more addresses are jointly resolved to a Port ID.
If fields are not used, then they are set either to '0' or valid addresses.
The Responder Flags remain the same as before.
Note that there can be utmost one FARP REPLY per FARP REQ.
Tables showing FARP REQ and FARP REPLY and address
If 'WW PN of Responder'
If 'WW NN of Responder'
If 'IPv4 Address of Responder'
If 'WW PN & IPv4 of Responder'
Set to 0x00 00 00
B.1 General Discussion Inverse ARP (InARP) is a mechanism described in RFC 1293/2390 [15, 16], which is useful when a node desires to know the protocol address of a target node whose hardware address is known.
Situations where this could occur are described in [15, 16].
The motivation for using InARP in FC is to allow a node to learn the IP address of another node with which it has performed a Port Login (PLOGI).
PLOGI is a normal FC process that happens between nodes, independent of this standard.
PLOGI makes it possible for a node to discover the WW PN and the Port ID of the other node but not its IP address.
A node in this way may potentially obtain the IP address of all nodes with which it can PLOGI.
Note that the use of the InARP mechanism can result in resolving all WW PN to IP addresses and ARP may no longer be required.
This can be beneficially applied in cases where a particular FC topology makes it inefficient to send out an ARP broadcast.
InARP uses the same ARP Packet format but
with different 'Op Codes', one for InARP Request and another for InARP Reply.
The InARP protocol operation is very simple.
The requesting node fills the hardware address (WW PN) of the target device and sets the protocol address to 0x00 00 00 00.
Because, the request is sent to a node whose WW PN and Port ID are known, there is no need for a broadcast.
The target node fills in its Protocol address (IP address in this case) and sends an InARP Reply back to the sender.
A node may collect, all such WW PN and IP addresses pairs in a similar way.
Since the InARP protocol uses the same packet format as the ARP protocol, much of the discussion on ARP formats given in Section 4 applies here.
The InARP is 28 bytes long in this application and uses two packet types:  Request and Reply.
Like ARP, the InARP Packet fields are common to both InARP
Request and Reply Packets are encapsulated in a single frame FC Sequence much like ARP.
Request and Reply FC Sequences SHALL include Network Headers.
The 'HW Type' field SHALL be set to 0x00 01.
The 'Protocol' field SHALL be set to 0x08 00
The 'HW Addr Length' field SHALL be set to 0x06 indicating 6 bytes of HW address.
The 'Protocol Addr Length' field SHALL be set to 0x04 indicating 4 bytes of IP address.
The 'Operation' Code field SHALL be set as follows: 0x00 08 for InARP
Request 0x00 09 for InARP Reply
The 'HW Addr of Sender' field SHALL be the 6 byte IEEE MAC address of the Requester (InARP Request) or Responder (InARP Reply).
The 'Protocol Addr of Sender' field SHALL be the 4 byte IP address of the Requester (InARP Request) or Responder (InARP Reply).
The 'HW Addr of Target' field SHALL be set to the 6 byte MAC address of the Responder in an InARP Request and to the 6 byte MAC address of the Requester in an InARP Reply.
The 'Protocol Addr of Target' field SHALL be set to 0x00 00 00 00 in an InARP Request and to the 4 byte IP address of the Requester in an InARP Reply.
Support Requirements Support for InARP is OPTIONAL.
If a node does not support InARP and it receives an InARP Request message then a silent behavior is specified.
APPENDIX C: Some Informal Mechanisms for FC Layer Mappings
Each method SHALL have some check to ensure PLOGI has completed successfully before data is sent.
A related concern in large networks is limiting concurrent logins to only those ports with active IP traffic.
C.1 Login on Cached Mapping Information
This method insulates the level performing Login from the level interpreting ARP.
It is more accommodating of non ARP mechanisms for building the FC layer mapping table.
Broadcast messages that carry a Network Header contain the S ID on the FC header and WW PN in the Network Header.
Caching this information provides a correlation of Port ID to WW PN.
If the received Broadcast message is compliant with this specification, the WW PN will contain the MAC Address.
The WW PN is "available" if Login has been performed to the Port ID and flagged.
If Login has not been performed, the WW PN is "unavailable".
If an outbound packet is destined for a port that is "unavailable", the cached information (from broadcast) is used to look up the Port ID.
After sending an ELS PLOGI command (Port Login) to the Port (from a higher level entity at the host), waiting for an outbound packet before sending this Port Login conserves resources for only those ports which wish to establish communication.
After Port Login completes (ACC received), the outbound packet can be forwarded.
At this point in time, both ends have the necessary information to complete their <IP address, MAC Address, Port ID> association.
C.2 Login on ARP Parsing
This method performs Login sooner by parsing ARP before passing it up to higher levels for IP/MAC Address correlation.
It requires a low  level awareness of the IP address, and is therefore protocol  specific. 1.
When an ARP Broadcast Message is received, the S ID is extracted from the FC header and the corresponding Network Source Address from the Network Header.
The ARP payload is parsed to determine if (a)
this host is the target of the ARP request (Target IP Address match), and (b) if this host is currently logged in with the port (Port ID   S ID) originating the ARP broadcast.
The ARP is passed to a higher level for ARP Response generation.
If a Port Login is required, an ELS PLOGI command (Port Login) is sent immediately to the Port originating the ARP Broadcast.
After Port Login completes, an ARP response can be forwarded.
Note that there are two possible scenarios: The ACC to PLOGI returns before the ARP reply is processed and the ARP Reply is immediately forwarded.
The ARP reply is delayed, waiting for ACC (successful Login).
At this point in time, both ends have the necessary information to complete their <IP address, MAC Address, Port ID> association.
C.3 Login to Everyone In Fibre Channel topologies with a limited number of ports, it may be efficient to unconditionally Login to each port.
This method is discouraged in fabric and public loop environments.
After Port Login completes, the MAC Address to Port ID Address tables can be constructed.
In some loop environments with a limited number of ports, a static mapping from a MAC Address to Port ID (D ID or AL PA) may be maintained.
The FC layer will always know the destination Port ID based on the table.
The table is typically downloaded into the driver at configuration time.
This method scales poorly, and is therefore not recommended.
Appendix D:  FC Layer Address Validation D.1 General Discussion
At all times, the <WW PN, Port ID> mapping MUST be valid before use.
There are many events that can invalidate this mapping.
The following discussion addresses conditions when such a validation is required.
After a FC link interruption occurs, the Port ID of a port may change.
After the interruption, the Port IDs of all other ports that have previously performed PLOGI (N Port Login) with this port may have changed, and its own Port ID may have changed.
Because of this, address validation is required after a LIP in a loop topology [7] or after NOS/OLS in a point to point topology [6].
Port IDs will not change as a result of Link Reset (LR),thus address validation is not required.
In addition to actively validating devices after a link interruption, if a port receives any FC 4 data frames (other than broadcast frames), from a port that is not currently logged in, then it shall send an explicit Extended Link Service (ELS) Request logout (LOGO) command to that port.
ELS commands (Requests and Replies) are used by an N Port to solicit a destination port (F Port or N Port) to perform some link level function or service.)
The LOGO Request is used to request invalidation of the service parameters and Port ID of the recipient N Port.
The level of initialization and subsequent validation and recovery reported to the upper (FC 4) layers is implementation specific.
In general, an explicit Logout (LOGO) SHALL be sent whenever the FC  Layer mapping between the Port ID and WW PN of a remote port is removed.
The effect of power up or re boot on the mapping tables is outside the scope of this specification.
D.2 FC Layer Address Validation in a Point to Point Topology
No validation is required after LR.
In a point to point topology, NOS/OLS causes implicit Logout of each port and after a NOS/OLS, each port must perform a PLOGI [2].
D.3 FC Layer Address Validation in a Private Loop Topology
After a LIP, a port SHALL not transmit any link data to another port until the address of the other port has been validated.
The validation consists of completing either ADISC or PDISC.
ADISC (Address Discovery) is an ELS command for discovering the hard addresses the 24 bit identifier  of NL Ports [5], [6].
PDISC (Discover Port) is an ELS command for exchanging service parameters without affecting Login state [5], [6].
As a requester, this specification prohibits PDISC and requires ADISC.
As a responder, an implementation may need to respond to both ADISC and PDISC for compatibility with other FC specifications.
If the three addresses, Port ID, WW PN, WW NN, exactly match the values prior to the LIP, then any active exchanges may continue.
If any of the three addresses have changed, then the node must be explicitly Logged out [4], [5].
If a port's N Port ID changes after a LIP, then all active Port ID to WW PN mappings at this port must be explicitly Logged out.
D.4 FC Layer Address Validation in a Public Loop Topology A FAN
ELS command is sent by the fabric to all known previously logged in  ports following an initialization event.
Therefore, after a LIP, hosts may wait for this notification to arrive or they may perform a FLOGI.
If the WW PN and WW NN of the fabric FL Port contained in the FAN ELS or FLOGI response exactly match the values before the LIP, and if the AL PA obtained by the port is the same as the one before the LIP, then the port may resume all exchanges.
If not, then FLOGI (Fabric Login) must be performed with the fabric and all nodes must be explicitly Logged out.
A public loop device will have to perform the private loop authentication to any nodes on the local loop which have an Area
XX D.5 FC Layer Address Validation in a Fabric Topology
No validation is required after LR (link reset).
After NOS/OLS, a port must perform FLOGI.
If, after FLOGI, the S ID of the port, the WW PN of the fabric, and the WW NN of the fabric are the same as before the NOS/OLS, then the port may resume all exchanges.
If not, all nodes must be explicitly, Logged out [2].
Fibre Channel Overview E.1 Brief Tutorial
The FC Standard [2] defines 5 "levels" (not layers) for its protocol description: FC 0, FC 1, FC 2, FC 3, and FC 4.
The first three levels (FC 0, FC 1, FC 2) are largely concerned with the physical formatting and control aspects of the protocol.
FC 3 has been architected to provide a place holder for functions that might need to be performed after the upper layer protocol has requested the transmission of an information unit, but before FC 2 is asked to deliver that piece of information by using a sequence of frames [18].
At this time, no FC 3 functions have been defined.
FC 4 is meant for supporting profiles of Upper Layer Protocols (ULP) such as IP and Small Computer System Interface (SCSI), and supports a relatively small set compared to LAN protocols such as IEEE 802.3.
FC devices are called "Nodes", each of which has at least one "Port" to connect to other ports.
A Node may be a workstation, a disk drive or disk array, a camera, a display unit, etc.
A "Link" is two unidirectional paths flowing in opposite directions and connecting two Ports within adjacent Nodes.
FC Nodes communicate using higher layer protocols such as SCSI and IP and are configured to operate using Point to Point, Private Loop, Public Loop (attachment to a Fabric), or Fabric network topologies.
The point to point is the simplest of the four topologies, where only two nodes communicate with each other.
The private loop may connect a number of devices (max 126) in a logical ring much like Token Ring, and is distinguished from a public loop by the absence of a Fabric Node participating in the loop.
The Fabric topology is a switched network where any attached node can communicate with any other.
For a detail description of FC topologies refer to [18].
Table below summarizes the usage of port types depending on its location [12].
Note that E Port is not relevant to any discussion in this specification but is included below for completeness.
In N Port mode  Point to Point or Fabric
An Exchange is opened whenever an operation is started between two ports.
The Exchange is closed when this operation ends.
The FC 4 Level specifies data units for each type of application level payload called 'Information Unit' (IU).
Each protocol carried by FC has a defined size for the IU.
Every operation must have at least one IU.
Lower FC levels map this to a FC Sequence.
Typically, a Sequence consists of more than one frame.
Larger user data is segmented and reassembled using two methods: Sequence Count and Relative Offset [18].
With the use of Sequence Count, data blocks are sent using frames with increasing sequence counts (modulo 65536) and it is quite straightforward to detect the first frame that contains the Network Header.
When Relative Offset is used, as frames arrive, some computation is required to detect the first frame that contains the Network Header.
Sequence Count and Relative Offset field control information, is carried in the FC Header.
The FC 4 Level makes a request to FC 3 Level when it wishes it to be delivered.
Currently, there are no FC 3 level defined functions, and this level simply converts the Information Unit delivery request into a 'Sequence' delivery request and passes it on to the FC 2 Level.
Therefore, each FC 4 Information Unit corresponds to a FC 2 Level Sequence.
The maximum data carried by a FC frame cannot exceed 2112 bytes [2].
Whenever, the Information Unit exceeds this value, the FC 2 breaks it into multiple frames and sends it in a sequence.
There can be multiple Sequences within an Exchange.
Sequences within an Exchange are processed sequentially.
Only one Sequence is active at a time.
Within an Exchange information may flow in one direction only or both.
If bi directional then one of the ports has the initiative to send the next Sequence for that Exchange.
Sequence Initiative can be passed between the ports on the last frame of Sequence when control is transferred.
This amounts to half duplex behavior.
Ports may have more than one Exchange open at a time.
Ports can multiplex between Exchanges.
Exchanges are uniquely identified by Exchange IDs (X ID).
An Originator OX ID and a Responder RX ID uniquely identify an Exchange.
E.3 Fibre Channel Header Fields
The FC header as shown in the diagrams below contains routing and other control information to manage Frames, Sequences, and Exchanges.
The Frame header is sent as 6 transmission words immediately following an SOF delimiter and before the Data Field.
D ID and S ID: FC uses destination address routing [12], [13].
Frame routing in a point to point topology is trivial.
For the Arbitrated Loop topology, with the destination NL Port on the same AL, the source port must pick the destination port, determine its AL Physical Address, and "Open" the destination port.
The frames must pass through other NL Ports or the FL Port on the loop between the source and destination, but these ports do not capture the frames.
They simply repeat and transmit the frame.
Either communicating port may "Close" the circuit.
When the destination port is not on the same AL, the source NL Port must open the FL Port attached to a Fabric.
Once in the Fabric, the Fabric routes the frames again to the destination.
In a Fabric topology, the Fabric looks into the Frame header, extracts the destination address (D ID), searches its own routing tables, and sends the frame to the destination port along the path chosen.
The process of choosing a path may be performed at each fabric element or switch until the F Port attached to the destination N Port is reached.
R CTL (Routing Control) and TYPE(data structure):
Frames for each FC 4 can be easily distinguished from the others at the receiving port using the R CTL (Routing Control) and TYPE (data structure) fields in the Frame header.
The R CTL has two sub fields: Routing bits and Information category.
The Routing bits sub field has specific values that mean FC 4 data follows and the Information Category tells the receiver the "Type" of data contained in the frame.
The R CTL and TYPE code points are shown in the diagrams.
F CTL (Frame Control) and SEQ ID (Sequence Identification), SEQ CNT (Sequence Count), OX ID (Originator exchange Identifier), RX ID (Responder exchange Identifier), and Parameter fields are used to manage the contents of a frame, and mark information exchange boundaries for the destination port.
The FC CTL field is a 3 byte field that contains information relating to the frame content.
Most of the other Frame header fields are used for frame identification.
Among other things, bits in this field indicate the First Sequence, Last Sequence, or End Sequence.
Sequence Initiative bit is used to pass control of the next Sequence in the Exchange to the recipient.
SEQ ID (Sequence Identifier) and SEQ CNT (Sequence Count): This is used to uniquely identify sequences within an Exchange.
The <S ID, D ID, SEQ ID> uniquely identifies any active Sequence.
SEQ CNT is used to uniquely identify frames within a Sequence to assure sequentiality of frame reception, and to allow unique correlation of link control frames with their related data frames.
Originator Exchange Identifier (OX ID) and Responder Exchange Identifier (RX ID):
The OX ID value provides association of frames with specific Exchanges originating at a particular N Port.
The RX ID field provides the same function that the OX ID provides for the Exchange Originator.
The OX ID is meaningful on the Exchange Originator, and the RX ID is meaningful on the Responder.
DF CTL (Data Field Control)
: The DF CTL field specifies the presence or absence of optional headers between the Frame header and Frame Payload PARAMETER:
The Parameter field has two meanings, depending on Frame type.
For Link Control Frames, the Parameter field indicates the specific type of Link Control frame.
For Data frames, this field contains the Relative Offset value.
This specifies an offset from an Upper Layer Protocol buffer from a base address.
E.4 Code Points for FC Frame E.4.1 Code Points with IP and ARP Packets
The Code Points for FC Frames with IP and ARP Packets are very similar with the exception of PID value in Word 11 which is set to 0x08 00 for IP and 0x08 06 for ARP.
Also, the Network Header appears only in the first logical frame of a FC Sequence carrying IP.
In the case, where FC frames carry ARP packets it is always present because these are single frame Sequences.
The Code Points for a FARP REQ for a specific Match Address Code Point MATCH WW PN NN ( b'011') is shown below.
In particular, note the IP addresses field of the Requester set to a valid address and that of the responder set to '0'.
Note also the setting of the D ID address and the Port ID of the Responder.
The corresponding code point for a FARP REPLY is also shown below.
In particular, note the setting of the Port ID of Responder and the IP address setting of the Responder.
Code Points with FARP Command Code Points for FC Frame with FARP REQ Command for MATCH WW PN NN
set to a valid IPv4 Address of Responder
Port ID  of Responder   S
Fibre Channel Protocol Considerations F.1 Reliability
In Class 3 Problem: Sequence ID reuse in Class 3 can conceivably result in missing frame aliasing, which could result in delivery of corrupted (incorrectly assembled) data, with no corresponding detection at the FC level.
This specification requires one of the following methods if Class 3 is used.
Continuously increasing Sequence Count (new Login Bit) both sides must set When an N Port sets the PLOGI login bit for continuously increasing SEQ CNT, it is guaranteeing that it will transmit all frames within an Exchange using a continuously increasing SEQ CNT (see description in Section B.1 below).
After using all SEQ IDs (0 255) once, must start a new Exchange.
It is recommended that a minimum of 4 Exchanges be used before an OX ID can be reused.
Note: If an implementation is not checking the OX ID when reassembling Sequences, the problem can still occur.
Cycling through some number of SEQ IDs, then jumping to a new Exchange does not solve the problem.
SEQ IDs must still be unique between two N Ports, even across Exchanges.
Use only single frame Sequences.
F.2 Continuously Increasing SEQ CNT
This method allows the recipient to check incoming frames, knowing exactly what SEQ CNT value to expect next.
Since the SEQ CNT will not repeat for 65,536 frames, the aliasing problem is significantly reduced.
A Login bit (PLOGI) is used to indicate that a device always uses a continuously increasing SEQ CNT, even across transfers of Sequence Initiative.
This bit is necessary for interoperability with some devices, and it provides other benefits as well.
In the FC PH 3 [11], the following is supported: Word 1, bit 17
Normal FC PH rules apply 1
Any N Port that sets Word 1, Bit 17   1, is guaranteeing that it will transmit all frames within an Exchange using a continuously increasing SEQ CNT.
Each Exchange SHALL start with SEQ CNT   0 in the first frame, and every frame transmitted after that SHALL increment the previous SEQ CNT by one, even across transfers of Sequence Initiative.
Any frames received from the other N Port in the Exchange shall have no effect on the transmitted SEQ CNT.
Acronyms and Glossary of FC Terms
It is assumed that the reader is familiar with the terms and acronyms used in the FC protocol specification [2].
The following is provided for easy reference.
The frame that contains the SOFi field.
This means a logical first and may not necessarily be the first frame temporally received in a sequence.
The coded bit pattern associated with control fields in frames or packets.
Protocol Data Unit ABTS LS: Abort Sequence Protocol Last Sequence.
A protocol for aborting an exchange based on the ABTS recipient setting the Last Sequence bit in the BA ACC ELS to the ABTS ADISC: Discover Address.
An ELS for discovering the Hard Addresses (the 24 bit NL Port Identifier) of N Ports D ID: Destination ID ES:
This FCTL bit in the FC header indicates this frame is the last frame of the sequence.
An ELS sent by the fabric to all known previously Logged in ports following an initialization event.
A primitive Sequence used by a port to detect if it is part of a loop or to recover from certain loop errors.
Two unidirectional paths flowing in opposite directions and connecting two Ports within adjacent Nodes.
A primitive sequence transmitted by a port to initiate the link reset protocol or to recover from a link timeout.
This FCTL bit in the FC header indicates the Sequence is the Last Sequence of the Exchange.
A 4 bit field specified in Network Headers that distinguishes between various name registration authorities that may be used to identify the WW PN and the WW NN.
NAA b'0001' indicates IEEE 48 bit
A collection of one or more Ports identified by a unique World Wide Node Name (WW NN).
A primitive Sequence transmitted to indicate that the port transmitting this Sequence has detected a link failure or is offline, waiting for OLS to be received.
A primitive Sequence transmitted to indicate that the port transmitting this Sequence is either initiating the link initialization protocol, receiving and recognizing NOS, or entering the offline state.
An ELS for exchanging Service Parameters without affecting Login state.
A primitive Sequence is an Ordered Set that is transmitted repeatedly and continuously.
A device that does not attempt Fabric Login (FLOGI) and usually adheres to PLDA.
The Area and Domain components of the NL Port ID must be 0x0000.
These devices cannot communicate with any port not in the local loop.
A device whose Area and Domain components of the NL Port ID cannot be 0x0000.
Additionally, to be FLA compliant, the device must attempt to open AL PA 0x00 and attempt FLOGI.
These devices communicate with devices on the local loop as well as devices on the other side of a Fabric.
The transmitter, receiver and associated logic at either end of a link within a Node.
There may be multiple Ports per Node.
Each Port is identified by a unique Port ID, which is volatile, and a unique World Wide Port Name (WW PN), which is unchangeable.
In this document, the term "port" may be used interchangeably with NL Port or N Port.
Fibre Channel ports are addressed by unique 24 bit Port IDs.
In a Fibre Channel frame header, the Port ID is referred to as S ID (Source ID) to identify the port originating a frame, and D ID to identify the destination port.
The Port ID of a given port is volatile (changeable).
Sequence Initiative World Wide Port Name (WW PN): Fibre Channel requires each Port to have an unchangeable WW PN.
Fibre Channel specifies a Network Address Authority (NAA) to distinguish between the various name registration authorities that may be used to identify the WW PN.
A 4 bit NAA identifier, 12 bit field set to 0x0 and an IEEE 48 bit MAC address together make this a 64 bit field.
World Wide Node Name (WW NN):
Fibre Channel identifies each Node with a unchangeable WW NN.
In a single port Node, the WW NN and the WW PN may be identical.
