Abstract This document specifies the export of packet information from a Packet SAMPling (PSAMP) Exporting Process to a PSAMP Collecting Process.
For export of packet information, the IP Flow Information eXport (IPFIX) protocol is used, as both the IPFIX and PSAMP architecture match very well, and the means provided by the IPFIX protocol are sufficient.
The document specifies in detail how the IPFIX protocol is used for PSAMP export of packet information.
The name PSAMP is a contraction of the phrase "Packet Sampling".
The word "Sampling" captures the idea that only a subset of all packets passing a network element will be selected for reporting.
PSAMP selection operations include random selection, deterministic selection, and deterministic approximations to random selection (Hash based Selection).
The IP Flow Information eXport (IPFIX) protocol specified in [RFC5101] exports IP traffic information [RFC5102] observed at network devices.
This matches the general protocol requirements outlined in the PSAMP framework [RFC5474].
However, there are some architectural differences between IPFIX and PSAMP in the requirements for an export protocol.
While the IPFIX architecture [RFC5470] is focused on gathering and exporting IP traffic flow information, the focus of the PSAMP framework [RFC5474] is on exporting information on individual packets.
This basic difference and a set of derived differences in protocol requirements are outlined in Section 4.
Despite these differences, the IPFIX protocol is well suited for the PSAMP protocol.
Section 5 specifies how the IPFIX protocol is used for the export of packet samples.
Required extensions of the IPFIX information model are specified in the PSAMP information model [RFC5477].
Conventions Used in This Document
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "
SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119
This document is one out of a series of documents from the PSAMP group.
A Framework for Packet Selection and Reporting" describes the PSAMP framework for network elements to select subsets of packets by statistical and other methods, and to export a stream of reports on the selected packets to a Collector.
"Sampling and Filtering Techniques for IP Packet Selection" describes the set of packet selection techniques supported by PSAMP.
RFC 5476 (this document): "Packet Sampling (PSAMP) Protocol Specifications" specifies the export of packet information from a PSAMP Exporting Process to a PSAMP Collecting Process.
"Information Model for Packet Sampling Exports" defines an information and data model for PSAMP.
As the IPFIX export protocol is used to export the PSAMP information, the relevant IPFIX terminology from [RFC5101] is copied over in this document.
All terms defined in this section have their first letter capitalized when used in this document.
The terminology summary table in Section 3.1 gives a quick overview of the relationships between the different IPFIX terms.
The PSAMP terminology defined here is fully consistent with all terms listed in [RFC5475] and [RFC5474], but only definitions that are relevant to the PSAMP protocol appear here.
Section 3.3 applies the PSAMP terminology to the IPFIX protocol terminology.
IPFIX specific terminology used in this document is defined in Section 2 of [RFC5101].
The only exceptions are the Metering Process, Exporting Process, and the Collector terms, which are defined more precisely in the PSAMP terminology section.
In this document, as in [RFC5101], the first letter of each IPFIX specific term is capitalized.
The PSAMP terminology section has been copied from [RFC5475].
Packet Streams and Packet Content   Observed Packet Stream
The Observed Packet Stream is the set of all packets observed at the Observation Point.
Packet Stream A Packet Stream denotes a set of packets from the Observed Packet Stream that flows past some specified point within the Metering Process.
An example of a Packet Stream is the output of the Selection Process.
Note that packets selected from a stream, e.g., by Sampling, do not necessarily possess a property by which they can be distinguished from packets that have not been selected.
For this reason, the term "stream" is favored over "flow", which is defined as a set of packets with common properties [RFC3917].
The Packet Content denotes the union of the packet header (which includes link layer, network layer, and other encapsulation headers) and the packet payload.
Note that, depending on the Observation Point, the link layer information might not be available.
Selection Process   Selection Process A Selection Process takes the Observed Packet Stream as its input and selects a subset of that stream as its output.
Selection State A Selection Process may maintain state information for use by the Selection Process.
At a given time, the Selection State may depend on packets observed at and before that time, and other variables.
Examples include: (i) sequence numbers of packets at the input of Selectors; (ii)
a timestamp of observation of the packet at the Observation Point; (iii) iterators for pseudorandom number generators; (iv)
hash values calculated during selection; (v) indicators of whether the packet was selected by a given Selector.
Selection Processes may change portions of the Selection State as a result of processing a packet.
Selection state for a packet is to reflect the state after processing the packet.
Selector A Selector defines the action of a Selection Process on a single packet of its input.
If selected, the packet becomes an element of the output Packet Stream.
The Selector can make use of the following information in determining whether a packet is selected: (i)
the Packet Content; (ii) information derived from the packet's treatment at the Observation Point; (iii)
any selection state that may be maintained by the Selection Process.
Composite Selector A Composite Selector is an ordered composition of Selectors, in which the output Packet Stream issuing from one Selector forms the input Packet Stream to the succeeding Selector.
Selector A Selector is primitive if it is not a Composite Selector.
The Selector ID is the unique ID identifying a Primitive Selector.
The ID is unique within the Observation Domain.
Selection Sequence From all the packets observed at an Observation Point
, only a few packets are selected by one or more Selectors.
The Selection Sequence is a unique value per Observation Domain describing the Observation Point and the Selector IDs through which the packets are selected.
Packet Reports Packet Reports comprise a configurable subset of a packet's input to the Selection Process, including the Packet Content, information relating to its treatment (for example, the output interface), and its associated selection state (for example, a hash of the Packet Content).
Report Interpretation Report Interpretation comprises subsidiary information, relating to one or more packets, that is used for interpretation of their Packet Reports.
Examples include configuration parameters of the Selection Process.
The Report Stream is the output of a Metering Process, comprising two distinguished types of information: Packet Reports and Report Interpretation.
Metering Process A Metering Process selects packets from the Observed Packet Stream using a Selection Process, and produces as output a Report Stream concerning the selected packets.
The PSAMP Metering Process can be viewed as analogous to the IPFIX Metering Process [RFC5101], which produces Flow Records as its output, with the difference that the PSAMP Metering Process always contains a Selection Process.
The relationship between PSAMP and IPFIX is further described in [RFC5477] and [RFC5474].
An Exporting Process sends, in the form of Export Packets, the output of one or more Metering Processes to one or more Collectors.
Packet An Export Packet is a combination of Report Interpretation(s)
and/or one or more Packet Reports that are bundled by the Exporting Process into an Export Packet for exporting to a Collector.
Device A PSAMP Device is a device hosting at least an Observation Point, a Selection Process, and an Exporting Process.
Typically, corresponding Observation Point(s), Selection Process(es), and Exporting Process(es) are co located at this device, for example, at a router.
Collector   Collector A Collector receives a Report Stream exported by one or more Exporting Processes.
In some cases, the host of the Metering and/or Exporting Processes may also serve as the Collector.
A filter is a Selector that selects a packet deterministically based on the Packet Content, or its treatment, or functions of these occurring in the Selection State.
Property Match Filtering: A packet is selected if a specific field in the packet equals a predefined value.
A Hash Function is applied to the Packet Content, and the packet is selected if the result falls in a specified range.
Sampling A Selector that is not a filter is called a Sampling operation.
This reflects the intuitive notion that if the selection of a packet cannot be determined from its content alone, there must be some type of Sampling taking place.
Content Independent Sampling A Sampling operation that does not use Packet Content (or quantities derived from it) as the basis for selection is called a Content independent Sampling operation.
Examples include systematic Sampling, and uniform pseudorandom Sampling driven by a pseudorandom number whose generation is independent of Packet Content.
Note that in Content  independent Sampling, it is not necessary to access the Packet Content in order to make the selection decision.
Content Dependent Sampling A Sampling operation where selection is dependent on Packet Content is called a Content dependent Sampling operation.
An example is pseudorandom selection according to a probability that depends on the contents of a packet field.
Note that this is not a filter, because the selection is not deterministic.
A Hash Domain is a subset of the Packet Content and the packet treatment, viewed as an N bit string for some positive integer N.
A Hash Range is a set of M bit strings for some positive integer M that define the range of values the result of the hash operation can take.
Hash Function A Hash Function defines a deterministic map from the Hash Domain into the Hash Range.
Hash Selection Range A Hash Selection Range is a subset of the Hash Range.
The packet is selected if the action of the Hash Function on the Hash Domain for the packet yields a result in the Hash Selection Range.
Hash based Selection A Hash based Selection
is Filtering specified by a Hash Domain, a Hash Function, a Hash Range, and a Hash Selection Range.
Approximative Selection Selectors in any of the above categories may be approximated by operations in the same or another category for the purposes of implementation.
Sampling may be approximated by Hash based Selection, using a suitable Hash Function and Hash Domain.
In this case, the closeness of the approximation depends on the choice of Hash Function and Hash Domain.
Population A Population is a Packet Stream, or a subset of a Packet Stream.
A Population can be considered as a base set from which packets are selected.
An example is all packets in the Observed Packet Stream that are observed within some specified time interval.
The Population Size is the number of all packets in the Population.
The Sample Size is the number of packets selected from the Population by a Selector.
The Configured Selection Fraction is the expected ratio of the Sample Size to the Population Size, as based on the configured selection parameters.
The Attained Selection Fraction is the ratio of the actual Sample Size to the Population Size.
For some Sampling methods, the Attained Selection Fraction can differ from the Configured Selection Fraction due to, for example, the inherent statistical variability in Sampling decisions of probabilistic Sampling and Hash based Selection.
Nevertheless, for large Population Sizes and properly configured Selectors, the Attained Selection Fraction usually approaches the Configured Selection Fraction.
3.3.  IPFIX and PSAMP Terminology Comparison
The PSAMP terminology has been specified with an IPFIX background, as PSAMP and IPFIX have similar terms.
However, this section clarifies the terms between the IPFIX and PSAMP terminology.
IPFIX and PSAMP Processes Figure B indicates the sequence of the IPFIX processes (Metering and Exporting) within the PSAMP Device.
PSAMP Processes The Selection Process, which takes an Observed Packet Stream as its input, is an integral part of the Metering Process.
The Selection Process chooses which packets from its input Packet Stream will be reported on by the rest of the Metering Process.
Note that a "Process" is not necessarily implemented as a separate CPU thread.
Packet Report, Packet Interpretation, and Data Record
The PSAMP terminology speaks of Packet Report and Packet Interpretation, while the IPFIX terminology speaks of Data Record and (Options) Template Record.
The PSAMP Packet Report, which comprises information about the observed packet, can be viewed as analogous to the IPFIX Data Record defined by a Template Record.
The PSAMP Report Interpretation, which comprises subsidiary information used for the interpretation of the Packet Reports, can be viewed as analogous to the IPFIX Data Record defined by an Options Template Record.
This Options Template Record contains subsidiary information, applicable to the observed packet sent into the PSAMP Packet Report.
Differences between PSAMP and IPFIX
The output of the IPFIX working group relevant for this document is structured into three documents:
IP Flow information architecture [RFC5470]
IPFIX protocol specifications [RFC5101] IP Flow information export information model [RFC5102]
In the following sections, we investigate the differences between IPFIX and PSAMP for each of those aspects.
Architecture Point of View Traffic Flow measurement as described in the IPFIX requirements [RFC3917] and the IPFIX architecture [RFC5470] can be separated into two stages: packet processing and Flow processing.
Figure C illustrates these stages.
In stage 1, all processing steps act on packets.
Packets are captured, timestamped, selected by one or more selection steps, and finally forwarded to packet classification that maps packets to Flows.
The packets' selection steps may include Filtering and Sampling functions.
In stage 2, all processing steps act on Flows.
After packets are classified (mapped to Flows), Flows are generated (or updated if they exist already).
Flow generation and update steps may be performed repeatedly for aggregating Flows.
Packet Sampling as described in the PSAMP framework [RFC5474] covers only stage 1 of the IPFIX architecture with the packet classification replaced by Packet Report export, while IPFIX covers stage 2 also, as it generates Flow Records out of the selected packets.
Protocol Point of View Concerning the protocol, the major difference between IPFIX and PSAMP is that the IPFIX protocol exports Flow Records while the PSAMP protocol exports Packet Reports.
From a pure export point of view, IPFIX will not distinguish a Flow Record composed of several packets aggregated together from a Flow Record composed of a single packet.
So the PSAMP export can be seen as a special IPFIX Flow Record containing information about a single packet.
All extensions of the IPFIX protocol that are required to satisfy the PSAMP requirements have already been incorporated in the IPFIX protocol [RFC5101], which was developed in parallel with the PSAMP protocol.
An example is the need for a data type for protocol fields that have flexible length, such as an octet array.
This was added to the IPFIX protocol specification in order to meet the requirement of the PSAMP protocol to report content of captured packets, for example, the first octets of a packet.
Information Model Point of View From the information model point of view, the overlap between both the IPFIX and PSAMP protocols is quite large.
Most of the Information Elements in the IPFIX protocol are also relevant for exporting packet information, for example, all fields reporting packet header properties.
Only a few Information Elements, such as observedFlowTotalCount (whose value will always be 1 for PSAMP), etc., cannot be used in a meaningful way by the PSAMP protocol.
Also, IPFIX protocol requirements concerning stage 2 of Figure C do not apply to the PSAMP Metering Process.
Further required extensions apply to the information model.
Even if the IPFIX charter speaks of Sampling,
no Sampling related Information Elements are specified in [RFC5102].
The task of specifying them was intentionally left for the PSAMP information model [RFC5477].
A set of several additional fields is required for satisfying the requirements for the PSAMP information model [RFC5475].
Exploiting the extensibility of the IPFIX information model, the required extension is covered by the PSAMP information model specified in [RFC5477].
PSAMP Requirements versus the IPFIX Solution
The [RFC5474] contains PSAMP protocol requirements throughout the document, with a special focus in Section 4, "Generic Requirements for PSAMP", and its subsections.
Section 4 of [RFC5474] describes one requirement that, if not directly related to the export protocol, will put some constraints on it.
Parallel Measurements: multiple independent Selection Processes at the same entity.
[RFC5474] also describes a series of requirements specifying the different Information Elements that MUST and SHOULD be reported to the Collector.
Nevertheless, IPFIX, being a generic export protocol, can export any Information Elements as long as they are described in the information model.
So these requirements are mainly targeted for [RFC5477].
Encrypted packets   Indication of information loss
Secure export   Export rate limit
The only requirement that is not met is Export Packet compression.
With the choice of IPFIX as the PSAMP export protocol, the Export Packet compression option mentioned in the Section 8.5 of the framework document [RFC5474] is not addressed.
High Level View of the Integration
The Template Record in the Template Set is used to describe the different PSAMP Information Elements that will be exported to the Collector.
The Collector decodes the Template Record in the Template Set and knows which Information Elements to expect when it receives the Data Records in the PSAMP Packet Report Data Set.
Typically, in the base level of the PSAMP functionality, the Template Set will contain the input sequence number, the packet fragment (some number of contiguous bytes from the start of the packet or from the start of the payload), and the Selection Sequence.
The Options Template Record in the Options Template Set is used to describe the different PSAMP Information Elements that concern the Metering Process itself:
Sampling and/or Filtering functions, and the associated parameters.
The Collector decodes the Options Template Records in the Options Template Set and knows which Information Elements to expect when it receives the Data Records in the PSAMP Report Interpretation Data Set.
Typically, the Options Template would contain the Selection Sequence, the Sampling or Filtering functions, and the Sampling or Filtering associated parameters.
PSAMP requires all the different possibilities of the IPFIX protocol specifications [RFC5101], that is, the three types of Sets (Data Set, Template Set, and Options Templates Set) with the two types of Template Records (Template Record and Options Template Record), as described in Figure A.
As a consequence, PSAMP can't rely on a subset of the IPFIX protocol specifications described in [RFC5101].
The entire IPFIX protocol specifications [RFC5101] MUST be implemented for the PSAMP protocol.
Using the IPFIX Protocol for PSAMP
In this section, we describe the usage of the IPFIX protocol for PSAMP.
We describe the record formats and the additional requirements that must be met.
PSAMP uses two different types of messages: Packet Reports Report Interpretation
The format of Packet Reports is defined in IPFIX Template Records.
The PSAMP data is transferred as Information Elements in IPFIX Data Records as described by the Template Record.
There are two different types of Packet Reports.
Basic Packet Reports contain only the basic Information Elements required for PSAMP reporting.
Extended Packet Reports MAY contain other Information Elements, and do not necessarily include Packet Content (See section 6.4.2).
The format of Report Interpretations is defined in the IPFIX Options Template Record.
The Information Elements are transferred in IPFIX Data Records as described by the Options Template Record.
There are four different types of Report Interpretation messages: Selection Sequence Report Interpretation Selector Report Interpretation Selection Sequence Statistics Report Interpretation Accuracy Report Interpretation A description and examples about the usage of those reports are given below.
The Selector ID is the unique ID identifying a Primitive Selector.
Each Primitive Selector MUST have a unique ID within the Observation Domain.
The Selector ID is represented by the selectorId Information Element [RFC5477].
The Selection Sequence ID From all the packets observed at an Observation Point, a subset of packets is selected by one or more Selectors.
The Selection Sequence is the combination of an Observation Point and one or more Selector(s) through which the packets are selected.
The Selection Sequence ID is a unique value representing that combination.
The Selection Sequence ID is represented by the selectionSequenceId Information Element [RFC5477].
An Exporting Process MUST be able to limit the export rate according to a configurable value.
MAY limit the export rate on a per Collecting Process basis.
Packet Report For each Selection Sequence, for each selected packet, a Packet Report MUST be created.
The format of the Packet Report is specified in a Template Record contained in a Template Set.
There are two types of Packet Report, as described in [RFC5474]: the basic Packet Report and the extended Packet Report.
Basic Packet Report For each selected packet, the Packet Report MUST contain the following information: The selectionSequenceId Information Element
If there is a digest function in the Selection Sequence, the Packet Report MUST contain the hash value (digestHashValue Information Element) generated by the digest Hash Function for each selected packet.
If there is more than one digest function, then each hash value MUST be included in the same order as they appear in the Selection Sequence.
If there are no digest functions in the Selection Sequence, no element for the digest needs to be sent.
Some number of contiguous bytes from the start of the packet, including the packet header (which includes link layer, network layer, and other encapsulation headers) and some subsequent bytes of the packet payload.
Alternatively, the number of contiguous bytes may start at the beginning of the payload.
The dataLinkFrameSection, mplsLabelStackSection, mplsPayloadPacketSection, ipPacketSection, and ipPayloadPacketSection PSAMP Information Elements are available for this use.
For each selected packet, the Packet Report SHOULD contain a time  related Information Element that matches the Metering Process time accuracy.
Typically, the observationTimeMicroseconds Information Element.
Other possible Information Elements are the observationTimeSeconds, the observationTimeMilliseconds, or the observationTimeNanoseconds.
In the Packet Report, the PSAMP Device MUST be capable of exporting the number of observed packets and the number of packets selected by each instance of its Primitive Selectors (as described by the non scope Information Elements of the Selection Sequence Statistics Report Interpretation), although it MAY be a configurable option not to include them.
If exported, the Attained Selection Fraction may be calculated precisely for the Observed Packet Stream.
The Packet Report MAY include only the final selector packetSelected, to act as an index for that Selection Sequence in the Selection Sequence Statistics Report Interpretation, which also allows the calculation of the Attained Selection Fraction.
The contiguous Information Elements (dataLinkFrameSection, mplsLabelStackSection, mplsPayloadPacketSection, ipPacketSection, and ipPayloadPacketSection)
MAY be encoded with a fixed length field or with a variable sized field.
If one of these Information Elements is encoded with a fixed length field whose length is too long for the number of contiguous bytes in the selected packet, padding MUST NOT be used.
In this case, the Exporting Process MUST export the information either in a new Template Record with the correct fixed  length field or in a new Template Record with a variable length field.
Here is an example of a basic Packet Report, with a SelectionSequenceId value of 9 and dataLinkFrameSection Information Element of 12 bytes, 0x4500 005B
FF11 832E, encoded with a fixed length field.
FF11 832E, encoded with a variable sized field.
Figure E: Example of a Basic Packet Report with a Variable Sized Field 6.4.2.
Alternatively to the basic Packet Report, the extended Packet Report MAY contain other Information Elements related to the protocols used in the packet (such as source and destination IP addresses), related to the packet treatment (such as output interface, destination BGP autonomous system [RFC4271]), or related to the Selection State associated with the packet (such as timestamp, hash value).
It is envisaged that selection of fields for extended Packet Reports may be used to reduce reporting bandwidth, in which case the option to report some number of contiguous bytes from the start of the packet, mandatory in the basic Packet Report, may not be exercised.
In this case, the Packet Content MAY be omitted.
Note this configuration is quite similar to an IPFIX Device for which a Template Record containing information about a single packet is reported.
Example of an Extended Packet Report 6.5.
To make full sense of the Packet Reports, there are a number of additional pieces of information that must be communicated to the Collector:
The details about which Selectors and Observation Points are being used within a Selection Sequence MUST be provided using the Selection Sequence Report Interpretation.
The configuration details of each Selector MUST be provided using the Selector Report Interpretation.
The Selector ID statistics MUST be provided using the Selection Sequence Statistics Report Interpretation.
The accuracies of the reported fields MUST be provided using the Accuracy Report Interpretation.
Each Packet Report contains a selectionSequenceId Information Element that identifies the particular combination of Observation Point and Selector(s) used for its selection.
For every selectionSequenceId Information Element in use, the PSAMP Device MUST export a Selection Sequence Report Interpretation using an Options Template with the following Information Elements:
one Information Element mapping the Observation Point selectorId (one or more)
An Information Element representing the Observation Point would typically be taken from the ingressInterface, egressInterface, lineCardId, exporterIPv4Address, or exporterIPv6Address Information Elements (specified in [RFC5102]), but is not limited to those: any Information Element specified in [RFC5102] or [RFC5477] can potentially be used.
In case of more complex Observation Points (such as a list of interfaces, a bus, etc.), a new Information Element describing the new type of Observation Point must be specified, along with an Options Template Record describing it in more detail (if necessary).
If the packets are selected by a Composite Selector, the Selection Sequence is composed of several Primitive Selectors.
In such a case, the Selection Sequence Report Interpretation MUST contain the list of all the Primitive Selector IDs in the Selection Sequence.
If multiple Selectors are contained in the Selection Sequence Report Interpretation, the selectorId's MUST be identified in the order they are used.
Example of two Selection Sequences: Selection Sequence 7 (Filter Sampling):
(Filter, match IPV4SourceAddress 192.0.2.1) selectorId
(Sampler, Random 1 out of ten)
Selection Sequence 9 (Sampling Filtering):
Example of a Selection Sequence Report Interpretation Notes:
There are two Records here in the same Data Set.
Each record defines a different Selection Sequence.
If, for example, a different Selection Sequence is composed of three Selectors, then a different Options Template with three selectorId Information Elements (instead of two) must be used.
Interpretation An IPFIX Data Record, defined by an Options Template Record, MUST be used to send the configuration details of every Selector in use.
The Options Template Record MUST contain the selectorId Information Element as the Scope field and the SelectorAlgorithm Information Element followed by some specific configuration parameters:
selectorAlgorithm algorithm specific Information Elements
The algorithm specific Information Elements are specified in the following subsections, depending on the selection method represented by the value of the selectorAlgorithm [RFC5477].
In systematic count based Sampling, the start and stop triggers for the Sampling interval are defined in accordance with the spatial packet position (packet count) [RFC5475].
The REQUIRED algorithm specific Information Elements in the case of systematic count based Sampling are: samplingPacketInterval: number of packets selected in a row
a simple 1 out of 10 systematic count based Selector definition, where the samplingPacketInterval is 1 and the samplingPacketSpace is 9.
Example of the Selector Report Interpretation for Systematic Count Based Sampling Notes:
A selectorAlgorithm value of 1 represents systematic count based Sampling.
and samplingPacketSpace are of type unsigned32 but are compressed down to one octet here, as allowed by the IPFIX protocol specifications [RFC5101].
In systematic time based Sampling, the start and stop triggers are used to define the Sampling intervals [RFC5475].
The REQUIRED algorithm specific Information Elements in the case of systematic time based Sampling are: samplingTimeInterval: time (in microseconds) when packets are selected
Example of the Selector Report Interpretation for Systematic Time Based Sampling Notes:
A selectorAlgorithm value of 2 represents systematic time based Sampling.
samplingTimeInterval and samplingTimeSpace are of type unsigned32 but are compressed down here.
Random n out of N Sampling
In random n out of N Sampling
, n elements are selected out of the parent Population that consists of N elements [RFC5475].
samplingSize and samplingPopulation are of type unsigned32 but are compressed down to one octet here.
In uniform probabilistic Sampling, each element has the same probability p of being selected from the parent Population [RFC5475].
The algorithm specific Information Element in case of uniform probabilistic
Sampling is: samplingProbability: a floating point number for the Sampling probability.
Example of a 15% uniform probability Sampling Selector:
Example of the Selector Report Interpretation for Uniform Probabilistic Sampling Notes:
A selectorAlgorithm value of 4 represents Uniform Probabilistic Sampling.
samplingProbability is of type float64 but is compressed down to a float32 here.
This classification includes match(es) on field(s) within a packet and/or on properties of the router state.
With this method, a packet is selected if a specific field in the packet equals a predefined value.
The algorithm specific Information Elements defining configuration parameters for Property Match Filtering are taken from the full range of available Information Elements.
When multiple different Information Elements are defined, the filter acts as a logical AND.
Note that the logical OR is not covered by these PSAMP specifications.
The Property Match Filtering Options Template Record MUST NOT have multiple identical Information Elements.
The result of the filter is independent from the order of the Information Elements in the Options Template Record, but the order may be important for implementation purposes, as the first filter will have to work at a higher rate.
In any case, an implementation is not constrained to respect the filter ordering as long as the result is the same, and it may even implement the composite Filtering in one single step.
Since encryption alters the meaning of encrypted fields, when the Property Match Filtering classification is based on the encrypted field(s) in the packet, it MUST be able to recognize that the field(s) are not available and MUST NOT select those packets unless specifically directed by the Information Element description.
Even if they are ignored, the encrypted packets MUST be accounted for in the Selector packetsObserved Information Element [RFC5477], part of the Selection Sequence Statistics Report Interpretation.
192.0.2.129 IPFIX Options Template Record:
Example of the Selector Report Interpretation for Match Based and Router State
A selectorAlgorithm value of 5 represents Property Match Filtering.
In this filter, there is a mix of information from the packet and information from the router.
In Hash based Selection, a Hash Function is run on IPv4 traffic.
The following fields MUST be used as input to that Hash Function: IP identification field Flags field Fragment offset Source IP address Destination IP address
A number of bytes from the IP payload.
The number of bytes and starting offset MUST be configurable if the Hash Function supports it.
For the bytes taken from the IP payload, IPSX has a fixed offset of 0 bytes and a fixed size of 8 bytes.
The number and offset of payload bytes in the BOB function MUST be configurable.
The minimum configuration ranges MUST be as follows:
If the selected payload bytes are not available and the Hash Function can take a variable sized input, then the Hash Function MUST be run with the information that is available and a shorter size.
Passing 0 as a substitute for missing payload bytes is only acceptable if the Hash Function takes a fixed size as is the case with IPSX.
If the Hash Function can take an initialization value, then this value MUST be configurable.
A Hash based Selection function MAY be configurable as a digest function.
Any Selection Process that is configured as a digest function MUST have the output value included in the basic Packet Report for any selected packet.
Each Hash Function used as a Hash based Selection Selector requires its own value for the selectorAlgorithm.
Currently, we have BOB (6), IPSX (7), and CRC (8) defined and any MAY be used for either Filtering or creating a Packet Digest.
Only BOB is recommended though and SHOULD be used.
The REQUIRED algorithm specific Information Elements in case of Hash based Selection are: hashIPPayloadOffset
The payload offset used by a Hash based Selection Selector hashIPPayloadSize
The payload size used by a Hash based Selection Selector hashOutputRangeMin    One or more values for the beginning of each potential output range.
hashOutputRangeMax    One or more values for the end of each potential output range.
hashSelectedRangeMin  One or more values for the beginning of each selected range.
One or more values for the end of each selected range.
Note: If more than one selection or output range needs to be sent, then the minimum and maximum elements may be repeated as needed.
These MUST make one or more non overlapping ranges.
The elements SHOULD be sent as pairs of minimum and maximum in ascending order; however, if they are sent out of order, then there will only be one way to interpret the ranges to produce a non overlapping range and the Collecting Process MUST be prepared to accept and decode this.
The following algorithm specific Information Element MAY be sent, but is optional for security considerations:
The initialiser value to the Hash Function.
Since encryption alters the meaning of encrypted fields, when the Hash based Filtering classification is based on the encrypted field(s) in the packet, it MUST be able to recognize that the field(s) are not available and MUST NOT select those packets.
Even if they are ignored, the encrypted packets MUST be accounted for in the Selector packetsObserved Information Element [RFC5477], which is part of the Selection Sequence Statistics Report Interpretation.
16 Hash Initialiser Value    0x9A3F9A3F
Example of the Selector Report Interpretation for Hash based Filtering Notes:
A selectorAlgorithm value of 6 represents Hash based Filtering using the BOB algorithm.
Some potential new selection methods MAY be added.
Some of the new selection methods, such as non uniform probabilistic Sampling and flow state dependent Sampling, are described in [RFC5475], with further references.
Each new selection method MUST be assigned a unique value for the selectorAlgorithm Information Element.
Its configuration parameter(s), along with the way to report it
/them with an Options Template, MUST be clearly specified.
Selection Sequence Statistics Report Interpretation A Selector MAY be used in multiple Selection Sequences.
However, each use of a Selector must be independent, so each separate logical instance of a Selector MUST maintain its own individual Selection State and statistics.
The Selection Sequence Statistics Report Interpretation MUST include the number of observed packets (Population Size) and the number of packets selected (Sample Size) by each instance of its Primitive Selectors.
Within a Selection Sequence composed of several Primitive Selectors, the number of packets selected for one Selector is equal to the number of packets seen by the next Selector.
The order of the Selectors in the Selection Sequence Statistics Report Interpretation MUST match the order of the Selectors in the Selection Sequence.
If the full set of statistics is not sent as part of the Basic Packet Reports, the PSAMP Device MUST export a Selection Sequence Statistics Report Interpretation for every Selection Sequence, using an Options Template containing the following Information Elements:
The packetsObserved Information Element [RFC5477] MUST contain the number of packets seen at the Observation Point, and as a consequence passed to the first Selector in the Selection Sequence.
The packetsSelected Information Element [RFC5477] contains the number of packets selected by a Selector in the Selection Sequence.
The Attained Selection Fraction for the Selection Sequence is calculated by dividing the number of selected packets (packetsSelected Information Element) for the last Selector by the number of observed packets (packetsObserved Information Element).
The Attained Selection Fraction can be calculated for each Selector by dividing the number of packets selected for that Selector by the value for the previous Selector.
The statistics for the whole sequence SHOULD be taken at a single logical point in time; the input value for a Selector MUST equal the output value of the previous Selector.
The Selection Sequence Statistics Report Interpretation MUST be exported periodically.
Example of Selection Sequence Statistics Report Interpretation:
Random one out of ten)
Selection Sequence 9 (Sampling Filtering)
Observed   100  (observationPointId  1, Interface 5)
Random one out of ten)
IPV4SourceAddress 192.0.2.1) IPFIX Options Template Record:
Example of the Selection Sequence Statistics Report
The Attained Selection Fractions for Selection Sequence 7 are: Filter 10: 50/100 Sampler 5:
6/50 Number of samples selected: 6   The Attained Selection Fractions for Selection Sequence 9 are: Sampler 5: 10/100 Filter 10:
3/10 Number of samples selected: 3 6.5.4.
In order for the Collecting Process to determine the inherent accuracy of the reported quantities (for example, timestamps), the PSAMP Device SHOULD send an Accuracy Report Interpretation.
The Accuracy Report Interpretation MUST be exported by an Options Template Record with a scope that contains the Information Element for which the accuracy is required.
In case the accuracy is specific to a template, a second scope containing the templateId value MUST be added to the Options Template Record.
The accuracy SHOULD be reported either with the absoluteError Information Element [RFC5477] or with the relativeError Information Element [RFC5477].
absoluteError Accuracy Report Interpretation using the absoluteError Information Element and a double scope:
relativeError Accuracy Report Interpretation using the relativeError Information Element and a double scope:
For example, the accuracy of an Information Element whose Abstract Data Type is
dateTimeMilliseconds [RFC5102], for which the unit is specified as milliseconds, can be specified with the absoluteError Information Element with the milliseconds units.
In this case, the error interval is the Information Element value  /
the value reported in the absoluteError.
For example, the accuracy of an Information Element to estimate the accuracy of a sampled flow, for which the unit would be specified in octets, can be specified with the relativeError Information Element with the octet units.
In this case, the error interval is the Information Element value  /
the value reported in the relativeError times the reported Information Element value.
An alternative to reporting either the absoluteError Information Element or the relativeError Information Element in the Accuracy Report Interpretation, is to report both.
For this case whatever is least accurate for the reported value should be used.
If the accuracy of a reported quantity changes on the Metering Process, a new Accuracy Report Interpretation MUST be generated.
The Collecting Process MUST keep the accuracy of the latest Accuracy Report Interpretation.
2 ms IPFIX Options Template Record:
Figure O: Example of the Selection Sequence Statistics Report Interpretation Notes:
absoluteError is of type float64 but is compressed down to a float32 here.
The second example displays an Accuracy Report Interpretation using the relativeError Information Element and a single scope: the timeMicroseconds has an error of 5%, represented by the proportionalAccuracy Information Element.
relativeError   0.05 IPFIX Options Template Record:
Figure P: Example of the Selection Sequence Statistics Report
relativeError is of type float64 but is compressed down to a float32 here.
Security Considerations As IPFIX has been selected as the PSAMP export protocol and as the PSAMP security requirements are not stricter than the IPFIX security requirements, refer to the IPFIX export protocol [RFC5101] for the security considerations.
In the basic Packet Report, a PSAMP Device exports some number of contiguous bytes from the start of the packet, including the packet header (which includes link layer, network layer, and other encapsulation headers) and some subsequent bytes of the packet payload.
The PSAMP Device SHOULD NOT export the full payload of conversations, as this would mean wiretapping [RFC2804].
The PSAMP Device MUST respect local privacy laws.
The PSAMP protocol, as set out in this document, has two sets of assigned numbers.
Considerations for assigning them are discussed in this section, using the example policies as set out in [RFC5226], "Guidelines for IANA Considerations".
As the PSAMP protocol uses the IPFIX protocol, refer to the IANA considerations section in [RFC5101] for the assignments of numbers used in the protocol and for the numbers used in the information model.
Each new selection method MUST be assigned a unique value for the selectorAlgorithm Information Element [RFC5477].
Initial contents of this registry are found in Section 8.2.1 in [RFC5477].
Its configuration parameter(s), along with the way to report them with an Options Template, MUST be clearly specified.
New assignments for the PSAMP selection method will be administered by IANA, on a First Come First Served basis [RFC5226], subject to Expert Review [RFC5226].
The group of experts must double check the Information Elements definitions with already defined Information Elements for completeness, accuracy, and redundancy.
These experts will initially be drawn from the Working Group Chairs and document editors of the IPFIX and PSAMP Working Groups.
