- title: __initial_text__
  contents:
  - '                 NAT Behavioral Requirements for ICMP

    '
- title: Status of This Memo
  contents:
  - "Status of This Memo\n   This document specifies an Internet Best Current Practices\
    \ for the\n   Internet Community, and requests discussion and suggestions for\n\
    \   improvements.  Distribution of this memo is unlimited.\n"
- title: Copyright Notice
  contents:
  - "Copyright Notice\n   Copyright (c) 2009 IETF Trust and the persons identified\
    \ as the\n   document authors.  All rights reserved.\n   This document is subject\
    \ to BCP 78 and the IETF Trust's Legal\n   Provisions Relating to IETF Documents\
    \ in effect on the date of\n   publication of this document (http://trustee.ietf.org/license-info).\n\
    \   Please review these documents carefully, as they describe your rights\n  \
    \ and restrictions with respect to this document.\n   This document may contain\
    \ material from IETF Documents or IETF\n   Contributions published or made publicly\
    \ available before November\n   10, 2008.  The person(s) controlling the copyright\
    \ in some of this\n   material may not have granted the IETF Trust the right to\
    \ allow\n   modifications of such material outside the IETF Standards Process.\n\
    \   Without obtaining an adequate license from the person(s) controlling\n   the\
    \ copyright in such materials, this document may not be modified\n   outside the\
    \ IETF Standards Process, and derivative works of it may\n   not be created outside\
    \ the IETF Standards Process, except to format\n   it for publication as an RFC\
    \ or to translate it into languages other\n   than English.\n"
- title: Abstract
  contents:
  - "Abstract\n   This document specifies the behavioral properties required of the\n\
    \   Network Address Translator (NAT) devices in conjunction with the\n   Internet\
    \ Control Message Protocol (ICMP).  The objective of this memo\n   is to make\
    \ NAT devices more predictable and compatible with diverse\n   application protocols\
    \ that traverse the devices.  Companion documents\n   provide behavioral recommendations\
    \ specific to TCP, UDP, and other\n   protocols.\n"
- title: Table of Contents
  contents:
  - "Table of Contents\n   1. Introduction and Scope ..........................................3\n\
    \   2. Terminology .....................................................4\n  \
    \ 3. ICMP Query Handling .............................................6\n    \
    \  3.1. ICMP Query Mapping .........................................6\n      3.2.\
    \ ICMP Query Session Timeouts ................................7\n   4. ICMP Error\
    \ Forwarding ...........................................8\n      4.1. ICMP Error\
    \ Payload Validation ..............................8\n      4.2. ICMP Error Packet\
    \ Translation .............................10\n           4.2.1. ICMP Error Packet\
    \ Received from the External Realm .11\n           4.2.2. ICMP Error Packet Received\
    \ from the Private Realm ..13\n      4.3. NAT Sessions Pertaining to ICMP Error\
    \ Payload .............15\n   5. Hairpinning Support for ICMP Packets ...........................16\n\
    \   6. Rejection of Outbound Flows Disallowed by NAT ..................17\n  \
    \ 7. Conformance to RFC 1812 ........................................17\n    \
    \  7.1. IP Packet Fragmentation ...................................19\n      \
    \     7.1.1.  Generating \"Packet Too Big\" ICMP Error Message ....19\n      \
    \     7.1.2.  Forwarding \"Packet Too Big\" ICMP Error Message ....20\n      7.2.\
    \ Time Exceeded Message .....................................20\n      7.3. Source\
    \ Route Options ......................................20\n      7.4. Address Mask\
    \ Request/Reply Messages .......................20\n      7.5. Parameter Problem\
    \ Message .................................21\n      7.6. Router Advertisement\
    \ and Solicitations ....................21\n      7.7. DS Field Usage ............................................21\n\
    \   8. Non-QueryError ICMP Messages ...................................22\n  \
    \ 9. Summary of Requirements ........................................22\n   10.\
    \ Security Considerations .......................................25\n   11. Acknowledgements\
    \ ..............................................26\n   12. References ....................................................27\n\
    \      12.1. Normative References .....................................27\n  \
    \    12.2. Informative References ...................................27\n"
- title: 1.  Introduction and Scope
  contents:
  - "1.  Introduction and Scope\n   As pointed out in RFC 3424 [UNSAF], NAT implementations\
    \ vary widely\n   in terms of how they handle different traffic.  The purpose\
    \ of this\n   document is to define a specific set of requirements for NAT behavior\n\
    \   with regard to ICMP messages.  The objective is to reduce the\n   unpredictability\
    \ and brittleness the NAT devices (NATs) introduce.\n   This document is an adjunct\
    \ to [BEH-UDP], [BEH-TCP], and other\n   protocol-specific BEHAVE document(s)\
    \ in the future that define\n   requirements for NATs when handling protocol-specific\
    \ traffic.\n   The requirements of this specification apply to traditional NATs\
    \ as\n   described in [NAT-TRAD].  A traditional NAT has two variations,\n   namely\
    \ Basic NAT and Network Address Port Translator (NAPT).  Of\n   these, NAPT is\
    \ by far the most commonly deployed NAT device.  NAPT\n   allows multiple private\
    \ hosts to share a single public IP address\n   simultaneously.\n   This document\
    \ only covers the ICMP aspects of NAT traversal,\n   specifically the traversal\
    \ of ICMP Query messages and ICMP Error\n   messages.  Traditional NAT inherently\
    \ mandates firewall-like\n   filtering behavior [BEH-UDP].  However, firewall\
    \ functionality in\n   general or any other middlebox functionality is out of\
    \ the scope of\n   this document.\n   In some cases, ICMP message traversal behavior\
    \ on a NAT device may be\n   overridden by local administrative policies.  Some\
    \ administrators may\n   choose to entirely prohibit forwarding of ICMP Error\
    \ messages across\n   a NAT device.  Some others may choose to prohibit ICMP-Query-based\n\
    \   applications across a NAT device.  These are local policies and not\n   within\
    \ the scope of this document.  For this reason, some of the ICMP\n   requirements\
    \ listed in the document are preceded with a constraint of\n   local policy permitting.\n\
    \   This document focuses strictly on the behavior of the NAT device, and\n  \
    \ not on the behavior of applications that traverse NATs.  Application\n   designers\
    \ may refer to [BEH-APP] and [ICE] for recommendations and\n   guidelines on how\
    \ to make applications work robustly over NATs that\n   follow the requirements\
    \ specified here and the adjunct protocol-\n   specific BEHAVE documents.\n  \
    \ Per [RFC1812], ICMP is a control protocol that is considered to be an\n   integral\
    \ part of IP, although it is architecturally layered upon IP\n   -- it uses IP\
    \ to carry its data end-to-end.  As such, many of the\n   ICMP behavioral requirements\
    \ discussed in this document apply to all\n   IP protocols.\n   In case a requirement\
    \ in this document conflicts with protocol-\n   specific BEHAVE requirement(s),\
    \ protocol-specific BEHAVE documents\n   will take precedence.  The authors are\
    \ not aware of any conflicts\n   between this and any other IETF document at the\
    \ time of this writing.\n   Section 2 describes the terminology used throughout\
    \ the document.\n   Section 3 is focused on requirements concerning ICMP-Query-based\n\
    \   applications traversing a NAT device.  Sections 4 and 5 describe\n   requirements\
    \ concerning ICMP Error messages traversing a NAT device.\n   Sections 6 describes\
    \ requirements concerning ICMP Error messages\n   generated by a NAT device. \
    \ Section 7 reviews RFC 1812 conformance\n   requirements and applicability to\
    \ NATs when handling ICMP messages.\n   Section 8 reviews a requirement for ICMP\
    \ messages that are neither\n   ICMP Query nor ICMP Error kind.  Section 9 summarizes\
    \ all the\n   requirements in one place.  Section 10 has a discussion on security\n\
    \   considerations.\n"
- title: 2.  Terminology
  contents:
  - "2.  Terminology\n   Definitions for the majority of the NAT terms used throughout\
    \ the\n   document may be found in [NAT-TERM] and [BEH-UDP].\n   The key words\
    \ \"MUST\", \"MUST NOT\", \"REQUIRED\", \"SHALL\", \"SHALL NOT\",\n   \"SHOULD\"\
    , \"SHOULD NOT\", \"RECOMMENDED\", \"MAY\", and \"OPTIONAL\" in this\n   document\
    \ are to be interpreted as described in RFC 2119 [RFC2119].\n   The term \"Realm\"\
    \ is adapted from [NAT-TERM] and is defined as\n   follows.  \"Realm\" is often\
    \ interchanged for \"network domain\" or\n   simply \"network\" throughout the\
    \ document.\n   Address realm or Realm - An address realm is a network domain\
    \ in\n   which the network addresses are uniquely assigned to entities such\n\
    \   that datagrams can be routed to them.  Routing protocols used within\n   the\
    \ network domain are responsible for finding routes to entities\n   given their\
    \ network addresses.  Note that this document is limited to\n   describing NAT\
    \ in the IPv4 environment and does not address the use\n   of NAT in other types\
    \ of environments (e.g., the IPV6 environment).\n   The term \"NAT Session\" is\
    \ adapted from [NAT-MIB] and is defined as\n   follows:\n   NAT Session - A NAT\
    \ session is an association between a session as\n   seen in the private realm\
    \ and a session as seen in the public realm,\n   by virtue of NAT translation.\
    \  If a session in the private realm were\n   to be represented as (PrivateSrcAddr,\
    \ PrivateDstAddr,\n   TransportProtocol, PrivateSrcPort, PrivateDstPort) and the\
    \ same\n   session in the public realm were to be represented as (PublicSrcAddr,\n\
    \   PublicDstAddr, TransportProtocol, PublicSrcPort, PublicDstPort), the\n   NAT\
    \ session would provide the translation glue between the two\n   session representations.\
    \  NAT sessions in the document are restricted\n   to sessions based on TCP, UDP,\
    \ and ICMP.  In the future, NAT sessions\n   may be extended to be based on other\
    \ transport protocols such as\n   Stream Control Transmission Protocol (SCTP),\
    \ UDP-lite, and Datagram\n   Congestion Control Protocol (DCCP).\n   ICMP Message\
    \ Classification - Section 3.2.2 of [RFC1122] and Section\n   4.3.1 of [RFC1812]\
    \ broadly group ICMP messages into two main\n   categories, namely \"ICMP Query\"\
    \ messages and \"ICMP Error\" messages.\n   All ICMP Error messages listed in\
    \ RFC 1122 and RFC 1812 contain part\n   of the Internet datagram that elicited\
    \ the ICMP error.  All the ICMP\n   Query messages listed in RFC 1122 and RFC\
    \ 1812 contain an\n   \"Identifier\" field, which is referred to in this document\
    \ as the\n   \"Query Identifier\".  There are however ICMP messages that do not\
    \ fall\n   into either of these two categories.  We refer to them as \"Non-\n\
    \   QueryError ICMP Messages\".  All three ICMP message classes are\n   described\
    \ as follows:\n   o ICMP Query Messages - ICMP Query messages are characterized\
    \ by an\n     Identifier field in the ICMP header.  The Identifier field used\
    \ by\n     the ICMP Query messages is also referred to as \"Query Identifier\"\
    \n     or \"Query Id\", for short throughout the document.  A Query Id is\n  \
    \   used by Query senders and responders as the equivalent of a TCP/UDP\n    \
    \ port to identify an ICMP Query session.  ICMP Query messages\n     include ICMP\
    \ messages defined after RFC 1122 or RFC 1812 (for\n     example, Domain Name\
    \ Request/Reply ICMP messages defined in RFC\n     1788), as they include request/response\
    \ pairs and contain an\n     \"Identifier\" field.\n   o ICMP Error Messages -\
    \ ICMP Error messages provide signaling for IP.\n     All ICMP Error messages\
    \ are characterized by the fact that they\n     embed the original datagram that\
    \ triggered the ICMP Error message.\n     The original datagram embedded within\
    \ the ICMP Error payload is\n     also referred to as the \"Embedded packet\"\
    \ throughout the document.\n     Unlike ICMP Query messages, ICMP Error messages\
    \ do not have a Query\n     Id in the ICMP header.\n   o Non-QueryError ICMP Messages\
    \ - ICMP messages that do not fall under\n     either of the above two classes\
    \ are referred to as \"Non-QueryError\n     ICMP Messages\" throughout the document.\
    \  For example, Router\n     Discovery ICMP messages [RFC1256] are \"request/response\"\
    \ type ICMP\n     messages.  However, they are not characterized as ICMP Query\n\
    \     messages in this document as they do not have an \"Identifier\" field\n\
    \     within the messages.  Likewise, there are other ICMP messages\n     defined\
    \ in [RFC4065] that do not fall in either of the ICMP Query\n     or ICMP Error\
    \ message categories, but will be referred to as Non-\n     QueryError ICMP messages.\n\
    \   The reason for categorizing ICMP messages for NAT behavioral\n   properties\
    \ is that each category has different characteristics used\n   for mapping (i.e.,\
    \ the Query Id and the Embedded datagram), which\n   leaves the Non-QueryError\
    \ ICMP messages in a separate, distinctive\n   group.\n"
- title: 3.  ICMP Query Handling
  contents:
  - "3.  ICMP Query Handling\n   This section lists the behavioral requirements for\
    \ a NAT device when\n   processing ICMP Query packets.  The following subsections\
    \ discuss\n   requirements specific to ICMP Query handling in detail.\n"
- title: 3.1.  ICMP Query Mapping
  contents:
  - "3.1.  ICMP Query Mapping\n   Unless explicitly overridden by local policy, a\
    \ NAT device MUST\n   permit ICMP Queries and their associated responses, when\
    \ the Query is\n   initiated from a private host to the external hosts.  ICMP\
    \ Query\n   mapping by NAT devices is necessary for current ICMP-Query-based\n\
    \   applications to work.  This entails a NAT device to transparently\n   forward\
    \ ICMP Query packets initiated from the nodes behind NAT, and\n   the responses\
    \ to these Query packets in the opposite direction.  As\n   specified in [NAT-TRAD],\
    \ this requires translating the IP header.  A\n   NAPT device further translates\
    \ the ICMP Query Id and the associated\n   checksum in the ICMP header prior to\
    \ forwarding.\n   NAT mapping of ICMP Query Identifiers SHOULD be external-host\n\
    \   independent.  Say, an internal host A sent an ICMP Query out to an\n   external\
    \ host B using Query Id X.  And, say, the NAT assigned this an\n   external mapping\
    \ of Query Id X' on the NAT's public address.  If host\n   A reused the Query\
    \ Id X to send ICMP Queries to the same or different\n   external host, the NAT\
    \ device SHOULD reuse the same Query Id mapping\n   (i.e., map the private host's\
    \ Query Id X to Query Id X' on NAT's\n   public IP address) instead of assigning\
    \ a different mapping.  This is\n   similar to the \"endpoint independent mapping\"\
    \ requirement specified\n   in the TCP and UDP requirement documents [BEH-UDP],\
    \ [BEH-TCP].\n   Below is justification for making the endpoint-independent mapping\n\
    \   for ICMP Query Id a SHOULD [RFC2119] requirement.  ICMP Ping\n   [RFC1470]\
    \ and ICMP traceroute [MS-TRCRT] are two most commonly known\n   legacy applications\
    \ built on top of ICMP Query messages.  Neither of\n   these applications require\
    \ the ICMP Query Id to be retained across\n   different sessions with external\
    \ hosts.  But, that may not be the\n   case with future applications.  In the\
    \ future, when an end host\n   application reuses the same Query Identifier in\
    \ sessions with\n   different target hosts, the end host application might require\
    \ that\n   the endpoint identity (i.e., the tuple of IP address and Query\n  \
    \ Identifier) appears the same across all its target hosts.  In an IP\n   network\
    \ without NAT requirements, such a requirement will be valid.\n   In a world with\
    \ NAT devices, the above assumption will be valid when\n   NAT devices enforce\
    \ endpoint mapping that is external-host\n   independent.  Given the dichotomy\
    \ between legacy applications not\n   requiring endpoint-independent mapping and\
    \ future applications that\n   might require it, the requirement level is kept\
    \ at SHOULD [RFC2119].\n   REQ-1: Unless explicitly overridden by local policy,\
    \ a NAT device\n          MUST permit ICMP Queries and their associated responses,\
    \ when\n          the Query is initiated from a private host to the external\n\
    \          hosts.\n          a) NAT mapping of ICMP Query Identifiers SHOULD be\
    \ external-\n             host independent.\n"
- title: 3.2.  ICMP Query Session Timeouts
  contents:
  - "3.2.  ICMP Query Session Timeouts\n   NATs maintain a mapping timeout for the\
    \ ICMP Queries that traverse\n   them.  The mapping timeout is the time a mapping\
    \ will stay active\n   without packets traversing the NAT.  There is great variation\
    \ in the\n   values used by different NATs.  The ICMP Query session timeout\n\
    \   requirement is necessary for current ICMP Query applications to work.\n  \
    \ Query response times can vary.  ICMP-Query-based applications are\n   primarily\
    \ request/response driven.\n   Ideally, the timeout should be set to Maximum Round\
    \ Trip Time\n   (Maximum RTT).  For the purposes of constraining the maximum RTT,\
    \ the\n   Maximum Segment Lifetime (MSL), defined in [RFC793], could be\n   considered\
    \ a guideline to set packet lifetime.  Per [RFC793], MSL is\n   the maximum amount\
    \ of time a TCP segment can exist in a network\n   before being delivered to the\
    \ intended recipient.  This is the\n   maximum duration an IP packet can be assumed\
    \ to take to reach the\n   intended destination node before declaring that the\
    \ packet will no\n   longer be delivered.  For an application initiating an ICMP\
    \ Query\n   message and waiting for a response for the Query, the Maximum RTT\n\
    \   could in practice be constrained to be the sum total of MSL for the\n   Query\
    \ message and MSL for the response message.  In other words,\n   Maximum RTT could\
    \ be constrained to no more than 2x MSL.  The\n   recommended value for MSL in\
    \ [RFC793] is 120 seconds, even though\n   several implementations set this to\
    \ 60 seconds or 30 seconds.  When\n   MSL is 120 seconds, the Maximum RTT (2x\
    \ MSL) would be 240 seconds.\n   In practice, ICMP Ping [RFC1470] and ICMP traceroute\
    \ [MS-TRCRT], the\n   two most commonly known legacy applications built on top\
    \ of ICMP\n   Query messages, take less than 10 seconds to complete a round trip\n\
    \   when the target node is operational on the network.\n   Setting the ICMP NAT\
    \ session timeout to a very large duration (say,\n   240 seconds) could potentially\
    \ tie up precious NAT resources such as\n   Query mappings and NAT Sessions for\
    \ the whole duration.  On the other\n   hand, setting the timeout very low can\
    \ result in premature freeing of\n   NAT resources and applications failing to\
    \ complete gracefully.  The\n   ICMP Query session timeout needs to be a balance\
    \ between the two\n   extremes.  A 60-second timeout is a balance between the\
    \ two extremes.\n   An ICMP Query session timer MUST NOT expire in less than 60\
    \ seconds.\n   It is RECOMMENDED that the ICMP Query session timer be made\n \
    \  configurable.\n   REQ-2: An ICMP Query session timer MUST NOT expire in less\
    \ than 60\n          seconds.\n          a) It is RECOMMENDED that the ICMP Query\
    \ session timer be made\n             configurable.\n"
- title: 4.  ICMP Error Forwarding
  contents:
  - "4.  ICMP Error Forwarding\n   Many applications make use of ICMP Error messages\
    \ from end hosts and\n   intermediate devices to shorten application timeouts.\
    \  Some\n   applications will not operate correctly without the receipt of ICMP\n\
    \   Error messages.  The following sub-sections discuss the requirements\n   a\
    \ NAT device must conform to in order to ensure reliable forwarding.\n"
- title: 4.1.  ICMP Error Payload Validation
  contents:
  - "4.1.  ICMP Error Payload Validation\n   An ICMP Error message checksum covers\
    \ the entire ICMP message,\n   including the payload.  When an ICMP Error packet\
    \ is received, if the\n   ICMP checksum fails to validate, the NAT SHOULD silently\
    \ drop the\n   ICMP Error packet.  This is because NAT uses the embedded IP and\n\
    \   transport headers for forwarding and translating the ICMP Error\n   message\
    \ (described in Section 4.2).  When the ICMP checksum is\n   invalid, the embedded\
    \ IP and transport headers, which are covered by\n   the ICMP checksum, are also\
    \ suspect.\n   [RFC1812] and [RFC1122] require a router or an end host that receives\n\
    \   an IP packet with an invalid IP header checksum to silently drop the\n   IP\
    \ packet.  As such, end hosts and routers do not generate an ICMP\n   Error message\
    \ in response to IP packets with invalid IP header\n   checksums.  For this reason,\
    \ if the IP checksum of the embedded\n   packet within an ICMP Error message fails\
    \ to validate, the NAT SHOULD\n   silently drop the Error packet.\n   When the\
    \ IP packet embedded within the ICMP Error message includes IP\n   options, the\
    \ NAT device must not assume that the transport header of\n   the embedded packet\
    \ is at a fixed offset (as would be the case when\n   there are no IP options\
    \ associated with the packet) from the start of\n   the embedded packet.  Specifically,\
    \ if the embedded packet includes\n   IP options, the NAT device MUST traverse\
    \ past the IP options to\n   locate the start of transport header for the embedded\
    \ packet.\n   It is possible to compute the transport checksum of the embedded\n\
    \   packet within an ICMP Error message when the ICMP Error message\n   contains\
    \ the entire transport segment.  However, ICMP Error messages\n   do not contain\
    \ the entire transport segment in many cases.  This is\n   because [ICMP] stipulates\
    \ that an ICMP Error message should embed an\n   IP header and only a minimum\
    \ of 64 bits of the IP payload.  Even\n   though Section 4.3.2.3 of [RFC1812]\
    \ recommends an ICMP Error\n   originator include as much of the original packet\
    \ as possible in the\n   payload, the length of the resulting ICMP datagram cannot\
    \ exceed 576\n   bytes.  ICMP Error originators truncate IP packets that do not\
    \ fit\n   within the stipulations.\n   A NAT device SHOULD NOT validate the transport\
    \ checksum of the\n   embedded packet within an ICMP Error message, even when\
    \ it is\n   possible to do so.  This is because a NAT dropping an ICMP Error\n\
    \   message due to an invalid transport checksum will make it harder for\n   end\
    \ hosts to receive error reporting for certain types of corruption.\n   End-to-end\
    \ validation of ICMP Error messages is best left to end\n   hosts.  Many newer\
    \ revision end host TCP/IP stacks implement the\n   improvements in [TCP-SOFT]\
    \ and do not accept ICMP Error messages with\n   a mismatched IP or TCP checksum\
    \ in the embedded packet, if the\n   embedded datagram contains a full IP packet\
    \ and the TCP checksum can\n   be calculated.\n   In the case that the ICMP Error\
    \ payload includes ICMP extensions\n   [ICMP-EXT], the NAT device MUST exclude\
    \ the optional zero-padding and\n   the ICMP extensions when evaluating transport\
    \ checksum for the\n   embedded packet.  Readers are urged to refer to [ICMP-EXT]\
    \ for\n   information on identifying the presence of ICMP extensions in an ICMP\n\
    \   message.\n   REQ-3: When an ICMP Error packet is received, if the ICMP checksum\n\
    \          fails to validate, the NAT SHOULD silently drop the ICMP Error\n  \
    \        packet.  If the ICMP checksum is valid, do the following:\n         \
    \ a) If the IP checksum of the embedded packet fails to\n             validate,\
    \ the NAT SHOULD silently drop the Error packet;\n             and\n         \
    \ b) If the embedded packet includes IP options, the NAT device\n            \
    \ MUST traverse past the IP options to locate the start of\n             the transport\
    \ header for the embedded packet; and\n          c) The NAT device SHOULD NOT\
    \ validate the transport checksum\n             of the embedded packet within\
    \ an ICMP Error message, even\n             when it is possible to do so; and\n\
    \          d) If the ICMP Error payload contains ICMP extensions\n           \
    \  [ICMP-EXT], the NAT device MUST exclude the optional zero-\n             padding\
    \ and the ICMP extensions when evaluating transport\n             checksum for\
    \ the embedded packet.\n"
- title: 4.2.  ICMP Error Packet Translation
  contents:
  - "4.2.  ICMP Error Packet Translation\n   Section 4.3 of [NAT-TRAD] describes the\
    \ fields of an ICMP Error\n   message that a NAT device translates.  In this section,\
    \ we describe\n   the requirements a NAT device must conform to while performing\
    \ the\n   translations.  Requirements identified in this section are necessary\n\
    \   for the current applications to work correctly.\n   Consider the following\
    \ scenario in Figure 1.  Say, NAT-xy is a NAT\n   device connecting hosts in private\
    \ and external networks.  Router-x\n   and Host-x are in the external network.\
    \  Router-y and Host-y are in\n   the private network.  The subnets in the external\
    \ network are\n   routable from the private as well as the external domains. \
    \ By\n   contrast, the subnets in the private network are only routable within\n\
    \   the private domain.  When Host-y initiated a session to Host-x, let\n   us\
    \ say that the NAT device mapped the endpoint on Host-y into Host-y'\n   in the\
    \ external network.  The following subsections describe the\n   processing of\
    \ ICMP Error messages on the NAT device(NAT-xy) when the\n   NAT device receives\
    \ an ICMP Error message in response to a packet\n   pertaining to this session.\n\
    \                               Host-x\n                                  |\n\
    \                          ---------------+-------------------\n             \
    \                            |\n                                  +-------------+\n\
    \                                  |  Router-x   |\n                         \
    \         +-------------+\n            External Network             |\n      \
    \      --------------------+--------+-------------------\n                   \
    \             |   ^\n                                |   | (Host-y', Host-x)\n\
    \                                |   |\n                          +-------------+\n\
    \                          |    NAT-xy   |\n                          +-------------+\n\
    \                                |\n    Private Network             |\n   ----------------+------------+----------------\n\
    \                   |\n            +-------------+\n            | Router-y   \
    \ |\n            +-------------+\n                   |\n   ----------------+-------+--------\n\
    \                           | ^\n                           | | (Host-y, Host-x)\n\
    \                           | |\n                         Host-y\n     Figure\
    \ 1.  A Session from a Private Host Traversing a NAT Device\n"
- title: 4.2.1.  ICMP Error Packet Received from the External Realm
  contents:
  - "4.2.1.  ICMP Error Packet Received from the External Realm\n   Say, a packet\
    \ from Host-y to Host-x triggered an ICMP Error message\n   from one of Router-x\
    \ or Host-x (both of which are in the external\n   domain).  Such an ICMP Error\
    \ packet will have one of Router-x or\n   Host-x as the source IP address and\
    \ Host-y' as the destination IP\n   address as described in Figure 2 below.\n\
    \                               Host-x\n                                  |\n\
    \                          ---------------+-------------------\n             \
    \                            |\n                                  +-------------+\n\
    \                                  |  Router-x   |\n                         \
    \         +-------------+\n            External Network             |\n      \
    \      --------------------+--------+-------------------\n                   \
    \             |\n                                |  | ICMP Error Packet to Host-y'\n\
    \                                |  v\n                          +-------------+\n\
    \                          |    NAT-xy   |\n                          +-------------+\n\
    \    Private Network             |\n   ----------------+------------+----------------\n\
    \                   |\n            +-------------+\n            | Router-y   \
    \ |\n            +-------------+\n                   |\n   ----------------+-------+--------\n\
    \                           |\n                         Host-y\n        Figure\
    \ 2.  ICMP Error Packet Received from External Network\n   When the NAT device\
    \ receives the ICMP Error packet, the NAT device\n   uses the packet embedded\
    \ within the ICMP Error message (i.e., the IP\n   packet from Host-y' to Host-x)\
    \ to look up the NAT Session to which\n   the embedded packet belongs.  If the\
    \ NAT device does not have an\n   active mapping for the embedded packet, the\
    \ NAT SHOULD silently drop\n   the ICMP Error packet.  Otherwise, the NAT device\
    \ MUST use the\n   matching NAT Session to translate the embedded packet; that\
    \ is,\n   translate the source IP address of the embedded packet (e.g., Host-y'\n\
    \   -> Host-y) and transport headers.\n   The ICMP Error payload may contain ICMP\
    \ extension objects [ICMP-EXT].\n   NATs are encouraged to support ICMP extension\
    \ objects.  At the time\n   of this writing, the authors are not aware of any\
    \ standard ICMP\n   extension objects containing realm-specific information.\n\
    \   The NAT device MUST also use the matching NAT Session to translate\n   the\
    \ destination IP address in the outer IP header.  In the outer\n   header, the\
    \ source IP address will remain unchanged because the\n   originator of the ICMP\
    \ Error message (Host-x or Router-x) is in an\n   external domain and is routable\
    \ from the private domain.\n   REQ-4: If a NAT device receives an ICMP Error packet\
    \ from an external\n          realm, and the NAT device does not have an active\
    \ mapping for\n          the embedded payload, the NAT SHOULD silently drop the\
    \ ICMP\n          Error packet.  If the NAT has active mapping for the embedded\n\
    \          payload, then the NAT MUST do the following prior to\n          forwarding\
    \ the packet, unless explicitly overridden by local\n          policy:\n     \
    \     a) Revert the IP and transport headers of the embedded IP\n            \
    \ packet to their original form, using the matching mapping;\n             and\n\
    \          b) Leave the ICMP Error type and code unchanged; and\n          c)\
    \ Modify the destination IP address of the outer IP header to\n             be\
    \ the same as the source IP address of the embedded packet\n             after\
    \ translation.\n"
- title: 4.2.2.  ICMP Error Packet Received from the Private Realm
  contents:
  - "4.2.2.  ICMP Error Packet Received from the Private Realm\n   Now, say, a packet\
    \ from Host-x to Host-y triggered an ICMP Error\n   message from one of Router-y\
    \ or Host-y (both of which are in the\n   private domain).  Such an ICMP Error\
    \ packet will have one of Router-y\n   or Host-y as the source IP address and\
    \ Host-x as the destination IP\n   address as specified in Figure 3 below.\n \
    \                              Host-x\n                                  |\n \
    \                         ---------------+-------------------\n              \
    \                           |\n                                  +-------------+\n\
    \                                  |  Router-x   |\n                         \
    \         +-------------+\n            External Network             |\n      \
    \      --------------------+--------+-------------------\n                   \
    \             |\n                                |\n                         \
    \ +-------------+\n                          |    NAT-xy   |\n               \
    \           +-------------+\n                                |  ^\n          \
    \                      |  | ICMP Error Packet to Host-x\n    Private Network \
    \            |\n   ----------------+------------+----------------\n          \
    \         |\n            +-------------+\n            | Router-y    |\n      \
    \      +-------------+\n                   |\n   ----------------+-------+--------\n\
    \                           |\n                         Host-y\n        Figure\
    \ 3.  ICMP Error Packet Received from Private Network\n   When the NAT device\
    \ receives the ICMP Error packet, the NAT device\n   MUST use the packet embedded\
    \ within the ICMP Error message (i.e., the\n   IP packet from Host-x to Host-y)\
    \ to look up the NAT Session to which\n   the embedded packet belongs.  If the\
    \ NAT device does not have an\n   active mapping for the embedded packet, the\
    \ NAT SHOULD silently drop\n   the ICMP Error packet.  Otherwise, the NAT device\
    \ MUST use the\n   matching NAT Session to translate the embedded packet.\n  \
    \ The ICMP Error payload may contain ICMP extension objects [ICMP-EXT].\n   NATs\
    \ are encouraged to support ICMP extension objects.  At the time\n   of this writing,\
    \ the authors are not aware of any standard ICMP\n   extension objects containing\
    \ realm-specific information.\n   In the outer header, the destination IP address\
    \ will remain\n   unchanged, as the IP address for Host-x is already in the external\n\
    \   domain.  If the ICMP Error message is generated by Host-y, the NAT\n   device\
    \ must simply use the NAT Session to translate the source IP\n   address Host-y\
    \ to Host-y'.  If the ICMP Error message is originated\n   by the intermediate\
    \ node Router-y, translation of the source IP\n   address varies depending on\
    \ whether the Basic NAT or NAPT function\n   [NAT-TRAD] is enforced by the NAT\
    \ device.  A NAT device enforcing the\n   Basic NAT function has a pool of public\
    \ IP addresses and enforces\n   address mapping (which is different from the endpoint\
    \ mapping\n   enforced by NAPT) when a private node initiates an outgoing session\n\
    \   via the NAT device.  So, if the NAT device has active mapping for the\n  \
    \ IP address of the intermediate node Router-y, the NAT device MUST\n   translate\
    \ the source IP address of the ICMP Error packet with the\n   public IP address\
    \ in the mapping.  In all other cases, the NAT device\n   MUST simply use its\
    \ own IP address in the external domain to\n   translate the source IP address.\n\
    \   REQ-5: If a NAT device receives an ICMP Error packet from the private\n  \
    \        realm, and the NAT does not have an active mapping for the\n        \
    \  embedded payload, the NAT SHOULD silently drop the ICMP Error\n          packet.\
    \  If the NAT has active mapping for the embedded\n          payload, then the\
    \ NAT MUST do the following prior to\n          forwarding the packet, unless\
    \ explicitly overridden by local\n          policy:\n          a) Revert the IP\
    \ and transport headers of the embedded IP\n             packet to their original\
    \ form, using the matching mapping;\n             and\n          b) Leave the\
    \ ICMP Error type and code unchanged; and\n          c) If the NAT enforces Basic\
    \ NAT function ([NAT-TRAD]), and\n             the NAT has active mapping for\
    \ the IP address that sent the\n             ICMP Error, translate the source\
    \ IP address of the ICMP\n             Error packet with the public IP address\
    \ in the mapping.  In\n             all other cases, translate the source IP address\
    \ of the\n             ICMP Error packet with its own public IP address.\n"
- title: 4.3.  NAT Sessions Pertaining to ICMP Error Payload
  contents:
  - "4.3.  NAT Sessions Pertaining to ICMP Error Payload\n   While processing an ICMP\
    \ Error packet pertaining to an ICMP Query or\n   Query response message, a NAT\
    \ device MUST NOT refresh or delete the\n   NAT Session that pertains to the embedded\
    \ payload within the ICMP\n   Error packet.  This is in spite of the fact that\
    \ the NAT device uses\n   the NAT Session to translate the embedded payload. \
    \ This ensures that\n   the NAT Session will not be modified if someone is able\
    \ to spoof ICMP\n   Error messages for the session.  [ICMP-ATK] lists a number\
    \ of\n   potential ICMP attacks that may be attempted by malicious users on\n\
    \   the network.  This requirement is necessary for current applications\n   to\
    \ work correctly.\n   REQ-6: While processing an ICMP Error packet pertaining\
    \ to an ICMP\n          Query or Query response message, a NAT device MUST NOT\
    \ refresh\n          or delete the NAT Session that pertains to the embedded\n\
    \          payload within the ICMP Error packet.\n"
- title: 5.  Hairpinning Support for ICMP Packets
  contents:
  - "5.  Hairpinning Support for ICMP Packets\n   [BEH-UDP] and [BEH-TCP] mandate\
    \ support for hairpinning for UDP and\n   TCP sessions, respectively, on NAT devices.\
    \  A NAT device needs to\n   support hairpinning for ICMP Query sessions as well.\
    \  Specifically,\n   NAT devices enforcing Basic NAT [NAT-TRAD] MUST support the\
    \ traversal\n   of hairpinned ICMP Query sessions.  Say, for example, individual\n\
    \   private hosts register their NAT assigned external IP address with a\n   rendezvous\
    \ server.  Other hosts that wish to initiate ICMP Query\n   sessions to the registered\
    \ hosts might do so using the public address\n   registered with the rendezvous\
    \ server.  For this reason, Basic NAT\n   devices are required to support the\
    \ traversal of hairpinned ICMP\n   Query sessions.  This requirement is necessary\
    \ for current\n   applications to work correctly.\n   Packets belonging to any\
    \ of the hairpinned sessions could, in turn,\n   trigger ICMP Error messages directed\
    \ to the source of hairpinned IP\n   packets.  Such hairpinned ICMP Error messages\
    \ will traverse the NAT\n   devices en route.  All NAT devices (i.e., Basic NAT\
    \ as well as NAPT\n   devices) MUST support the traversal of hairpinned ICMP Error\n\
    \   messages.  Specifically, the NAT device must translate not only the\n   embedded\
    \ hairpinned packet, but also the outer IP header that is\n   hairpinned.  This\
    \ requirement is necessary for current applications\n   to work correctly.\n \
    \  A hairpinned ICMP Error message is received from a node in a private\n   network.\
    \  As such, the ICMP Error processing requirement specified in\n   Req-5 is applicable\
    \ in its entirety in processing the ICMP Error\n   message.  In addition, the\
    \ NAT device MUST translate the destination\n   IP address of the outer IP header\
    \ to be same as the source IP address\n   of the embedded IP packet after the\
    \ translation.\n   REQ-7: NAT devices enforcing Basic NAT [NAT-TRAD] MUST support\
    \ the\n          traversal of hairpinned ICMP Query sessions.  All NAT devices\n\
    \          (i.e., Basic NAT as well as NAPT devices) MUST support the\n      \
    \    traversal of hairpinned ICMP Error messages:\n          a) When forwarding\
    \ a hairpinned ICMP Error message, the NAT\n             device MUST translate\
    \ the destination IP address of the\n             outer IP header to be same as\
    \ the source IP address of the\n             embedded IP packet after the translation.\n"
- title: 6.  Rejection of Outbound Flows Disallowed by NAT
  contents:
  - "6.  Rejection of Outbound Flows Disallowed by NAT\n   A NAT device typically\
    \ permits all outbound sessions.  However, a NAT\n   device may disallow some\
    \ outbound sessions due to resource\n   constraints or administration considerations.\
    \  For example, a NAT\n   device may not permit the first packet of a new outbound\
    \ session if\n   the NAT device is out of resources (out of addresses or TCP/UDP\n\
    \   ports, or NAT Session resources) to set up a state for the session,\n   or,\
    \ if the specific session is administratively restricted by the NAT\n   device.\n\
    \   When a NAT device is unable to establish a NAT Session for a new\n   transport-layer\
    \ (TCP, UDP, ICMP, etc.) flow due to resource\n   constraints or administrative\
    \ restrictions, the NAT device SHOULD\n   send an ICMP destination unreachable\
    \ message, with a code of 13\n   (Communication administratively prohibited) to\
    \ the sender, and drop\n   the original packet.  This requirement is meant primarily\
    \ for future\n   use.  Current applications do not require this for them to work\n\
    \   correctly.  The justification for using ICMP code 13 in the ICMP\n   Error\
    \ message is as follows: Section 5.2.7.1 of [RFC1812] recommends\n   routers use\
    \ ICMP code 13 (Communication administratively prohibited)\n   when they administratively\
    \ filter packets.  ICMP code 13 is a soft\n   error and is on par with other soft\
    \ error codes generated in response\n   to transient events such as \"network\
    \ unreachable\" (ICMP type=3,\n   code=0).\n   Some NAT designers opt to never\
    \ reject an outbound flow.  When a NAT\n   runs short of resources, they prefer\
    \ to steal a resource from an\n   existing NAT Session rather than reject the\
    \ outbound flow.  Such a\n   design choice may appear conformant to REQ-8 below.\
    \  However, the\n   design choice is in violation of the spirit of both REQ-8\
    \ and REQ-2.\n   Such a design choice is strongly discouraged.\n   REQ-8: When\
    \ a NAT device is unable to establish a NAT Session for a\n   new transport-layer\
    \ (TCP, UDP, ICMP, etc.) flow due to resource\n   constraints or administrative\
    \ restrictions, the NAT device SHOULD\n   send an ICMP destination unreachable\
    \ message, with a code of 13\n   (Communication administratively prohibited) to\
    \ the sender, and drop\n   the original packet.\n"
- title: 7.  Conformance to RFC 1812
  contents:
  - "7.  Conformance to RFC 1812\n   This document specifies NATs to have a behavior\
    \ that is consistent\n   with the way routers handle ICMP messages, as specified\
    \ in Section\n   4.3 of [RFC1812].  However, since the publication of [RFC1812],\
    \ some\n   of its requirements are no longer best current practices.  Thus, the\n\
    \   following requirements are derived from [RFC1812] and apply to NATs\n   compliant\
    \ with this specification:\n   REQ-9: A NAT device MAY implement a policy control\
    \ that prevents ICMP\n          messages being generated toward certain interface(s).\n\
    \          Implementation of such a policy control overrides the MUSTs\n     \
    \     and SHOULDs in REQ-10.\n   REQ-10: Unless overridden by REQ-9's policy,\
    \ a NAT device needs to\n           support ICMP messages as below, some conforming\
    \ to Section\n           4.3 of [RFC1812] and some superseding the requirements\
    \ of\n           Section 4.3 of [RFC1812]:\n          a. MUST support:\n     \
    \        1. Destination Unreachable Message, as described in Section\n       \
    \         7.1 of this document.\n             2. Time Exceeded Message, as described\
    \ in Section 7.2 of\n                this document.\n             3. Echo Request/Reply\
    \ Messages, as described in REQ-1.\n          b. MAY support:\n             1.\
    \ Redirect Message, as described in Section 4.3.3.2 of\n                [RFC1812].\n\
    \             2. Timestamp and Timestamp Reply Messages, as described in\n   \
    \             Section 4.3.3.8 of [RFC1812].\n             3. Source Route Options,\
    \ as described in Section 7.3 of\n                this document.\n           \
    \  4. Address Mask Request/Reply Message, as described in\n                Section\
    \ 7.4 of this document.\n             5. Parameter Problem Message, as described\
    \ in Section 7.5\n                of this document.\n             6. Router Advertisement\
    \ and Solicitations, as described in\n                Section 7.6 of this document.\n\
    \          c. SHOULD NOT support:\n             1. Source Quench Message, as described\
    \ in Section 4.3.3.3\n                of [RFC1812].\n             2. Information\
    \ Request/reply, as described in Section\n                4.3.3.7 of [RFC1812].\n\
    \          In addition, a NAT device is RECOMMENDED to conform to the\n      \
    \    following implementation considerations:\n          d. DS Field Usage, as\
    \ described in Section 7.7 of this\n             document.\n          e. When\
    \ Not to Send ICMP Errors, as described in Section\n             4.3.2.7 of [RFC1812].\n\
    \          f. Rate Limiting, as described in Section 4.3.2.8 of\n            \
    \ [RFC1812].\n"
- title: 7.1.  IP Packet Fragmentation
  contents:
  - "7.1.  IP Packet Fragmentation\n   Many networking applications (which include\
    \ TCP- as well as UDP-based\n   applications) depend on ICMP Error messages from\
    \ the network to\n   perform end-to-end path MTU discovery [PMTU].  Once the path\
    \ MTU is\n   discovered, an application that chooses to avoid fragmentation may\
    \ do\n   so by originating IP packets that fit within the path MTU en route\n\
    \   and setting the DF (Don't Fragment) bit in the IP header, so the\n   intermediate\
    \ nodes en route do not fragment the IP packets.  The\n   following sub-sections\
    \ discuss the need for NAT devices to honor the\n   DF bit in the IP header and\
    \ be able to generate \"Packet Too Big\" ICMP\n   Error message when they cannot\
    \ forward the IP packet without\n   fragmentation.  Also discussed is the need\
    \ to seamlessly forward ICMP\n   Error messages generated by other intermediate\
    \ devices.\n"
- title: 7.1.1.  Generating "Packet Too Big" ICMP Error Message
  contents:
  - "7.1.1.  Generating \"Packet Too Big\" ICMP Error Message\n   When a router is\
    \ unable to forward a datagram because it exceeds the\n   MTU of the next-hop\
    \ network and its Don't Fragment (DF) bit is set,\n   the router is required by\
    \ [RFC1812] to return an ICMP Destination\n   Unreachable message to the source\
    \ of the datagram, with the code\n   indicating \"fragmentation needed and DF\
    \ set\".  Further, [PMTU] states\n   that the router MUST include the MTU of that\
    \ next-hop network in the\n   low-order 16 bits of the ICMP header field that\
    \ is labeled \"unused\"\n   in the ICMP specification [ICMP].\n   A NAT device\
    \ MUST honor the DF bit in the IP header of the packets\n   that transit the device.\
    \  The NAT device may not be able to forward\n   an IP packet without fragmentation\
    \ if the MTU on the forwarding\n   interface of the NAT device is not adequate\
    \ for the IP packet.  If\n   the DF bit is set on a transit IP packet and the\
    \ NAT device cannot\n   forward the packet without fragmentation, the NAT device\
    \ MUST send a\n   \"Packet Too Big\" ICMP message (ICMP type 3, code 4) with the\
    \ next-hop\n   MTU back to the sender and drop the original IP packet.  The sender\n\
    \   will usually resend after taking the appropriate corrective action.\n   If\
    \ the DF bit is not set and the MTU on the forwarding interface of\n   the NAT\
    \ device mandates fragmentation, the NAT device MUST fragment\n   the packet and\
    \ forward the fragments [RFC1812].\n"
- title: 7.1.2.  Forwarding "Packet Too Big" ICMP Error Message
  contents:
  - "7.1.2.  Forwarding \"Packet Too Big\" ICMP Error Message\n   This is the flip\
    \ side of the argument for the above section.  By\n   virtue of the address translation\
    \ NAT performs, NAT may end up being\n   the recipient of \"Packet Too Big\" messages.\n\
    \   When the NAT device is the recipient of a \"Packet Too Big\" ICMP\n   message\
    \ from the network, the NAT device MUST forward the ICMP\n   message back to the\
    \ intended recipient, pursuant to the previously\n   stated requirements (REQ-3,\
    \ REQ-4, and REQ-5).\n"
- title: 7.2.  Time Exceeded Message
  contents:
  - "7.2.  Time Exceeded Message\n   A NAT device MUST generate a \"Time Exceeded\"\
    \ ICMP Error message when\n   it discards a packet due to an expired Time to Live\
    \ (TTL) field.  A\n   NAT device MAY have a per-interface option to disable origination\
    \ of\n   these messages on that interface, but that option MUST default to\n \
    \  allowing the messages to be originated.\n   When a NAT device conforms to the\
    \ above requirement, it ensures that\n   legacy applications such as Traceroute\
    \ [RFC1470], [MS-TRCRT], which\n   depend upon the \"Time Exceeded\" ICMP Error\
    \ message, will continue to\n   operate even as NAT devices are en route.\n"
- title: 7.3.  Source Route Options
  contents:
  - "7.3.  Source Route Options\n   A NAT device MAY support modifying IP addresses\
    \ in the source route\n   option so the IP addresses in the source route option\
    \ are realm\n   relevant.  If a NAT device does not support forwarding packets\
    \ with\n   the source route option, the NAT device SHOULD NOT forward outbound\n\
    \   ICMP messages that contain the source route option in the outer or\n   inner\
    \ IP header.  This is because such messages could reveal private\n   IP addresses\
    \ to the external realm.\n"
- title: 7.4.  Address Mask Request/Reply Messages
  contents:
  - "7.4.  Address Mask Request/Reply Messages\n   Section 4.3.3.9 of [RFC1812] says\
    \ an IP router MUST implement support\n   for receiving ICMP Address Mask Request\
    \ messages and responding with\n   ICMP Address Mask Reply messages.  However,\
    \ several years (more than\n   13 years at the time of this document) have elapsed\
    \ since the text in\n   RFC 1812 was written.  In the intervening time, DHCP [DHCP]\
    \ has\n   replaced the use of address mask request/reply.  At the current time,\n\
    \   there is rarely any host that does not meet host requirements\n   [RFC1122]\
    \ and needs a NAT device to support address mask\n   request/reply.\n   For this\
    \ reason, a NAT device is not required to support this ICMP\n   message.\n   A\
    \ NAT device MAY support address mask request/reply messages.\n"
- title: 7.5.  Parameter Problem Message
  contents:
  - "7.5.  Parameter Problem Message\n   Section 4.3.3.5 of [RFC1812] says an IP router\
    \ MUST generate a\n   Parameter Problem message for any error not specifically\
    \ covered by\n   another ICMP message.  However, this message is rarely used in\n\
    \   practice in networks where IPv4 NATs are deployed.\n   For this reason, a\
    \ NAT device is not required to support this ICMP\n   message.\n   A NAT device\
    \ MAY support parameter problem messages.\n"
- title: 7.6.  Router Advertisement and Solicitations
  contents:
  - "7.6.  Router Advertisement and Solicitations\n   Section 4.3.3.10 of [RFC1812]\
    \ says an IP router MUST support the\n   router part of the ICMP Router Discovery\
    \ Protocol on all connected\n   networks on which the router supports either IP\
    \ multicast or IP\n   broadcast addressing.  However, this message is rarely used\
    \ in\n   practice in networks where IPv4 NATs are deployed.\n   For this reason,\
    \ a NAT device is not required to support this ICMP\n   message.\n   A NAT device\
    \ MAY support Router Advertisement and Solicitations.\n"
- title: 7.7.  DS Field Usage
  contents:
  - "7.7.  DS Field Usage\n   [RFC1812] refers to the Type of Service (TOS) octet\
    \ in the IP header,\n   which contains the TOS and IP precedence fields.  However,\
    \ the TOS\n   and IP precedence fields are no longer in use today.  [RFC2474]\n\
    \   renamed the TOS octet as the DS field and defined diffserv classes\n   within\
    \ the DS field.\n   When generating an ICMP message, a NAT device SHOULD copy\
    \ the\n   diffserv class of the message that causes the sending of the ICMP\n\
    \   error message.  A NAT device MAY allow configuration of the diffserv\n   class\
    \ to be used for the different types of ICMP messages.\n"
- title: 8.  Non-QueryError ICMP Messages
  contents:
  - "8.  Non-QueryError ICMP Messages\n   In the preceding sections, ICMP requirements\
    \ were identified for NAT\n   devices, with a primary focus on ICMP Query and\
    \ ICMP Error messages,\n   as defined in the Terminology Section (see Section\
    \ 2).  This document\n   provides no guidance on the handling of Non-QueryError\
    \ ICMP messages\n   by the NAT devices.  A NAT MAY drop or appropriately handle\
    \ Non-\n   QueryError ICMP messages.\n       REQ-11: A NAT MAY drop or appropriately\
    \ handle Non-QueryError\n           ICMP messages.  The semantics of Non-QueryError\
    \ ICMP messages\n           is defined in Section 2.\n"
- title: 9.  Summary of Requirements
  contents:
  - "9.  Summary of Requirements\n   Below is a summary of all the requirements.\n\
    \   REQ-1: Unless explicitly overridden by local policy, a NAT device\n      \
    \    MUST permit ICMP Queries and their associated responses, when\n         \
    \ the Query is initiated from a private host to the external\n          hosts.\n\
    \          a) NAT mapping of ICMP Query Identifiers SHOULD be external\n     \
    \        host independent.\n   REQ-2: An ICMP Query session timer MUST NOT expire\
    \ in less than 60\n          seconds.\n          a) It is RECOMMENDED that the\
    \ ICMP Query session timer be made\n             configurable.\n   REQ-3: When\
    \ an ICMP Error packet is received, if the ICMP checksum\n          fails to validate,\
    \ the NAT SHOULD silently drop the ICMP Error\n          packet.  If the ICMP\
    \ checksum is valid, do the following:\n          a) If the IP checksum of the\
    \ embedded packet fails to\n             validate, the NAT SHOULD silently drop\
    \ the Error packet;\n             and\n          b) If the embedded packet includes\
    \ IP options, the NAT device\n             MUST traverse past the IP options to\
    \ locate the start of\n             the transport header for the embedded packet;\
    \ and\n          c) The NAT device SHOULD NOT validate the transport checksum\n\
    \             of the embedded packet within an ICMP Error message, even\n    \
    \         when it is possible to do so; and\n          d) If the ICMP Error payload\
    \ contains ICMP extensions\n             [ICMP-EXT], the NAT device MUST exclude\
    \ the optional zero-\n             padding and the ICMP extensions when evaluating\
    \ transport\n             checksum for the embedded packet.\n   REQ-4: If a NAT\
    \ device receives an ICMP Error packet from an external\n          realm, and\
    \ the NAT device does not have an active mapping for\n          the embedded payload,\
    \ the NAT SHOULD silently drop the ICMP\n          Error packet.  If the NAT has\
    \ active mapping for the embedded\n          payload, then the NAT MUST do the\
    \ following prior to\n          forwarding the packet, unless explicitly overridden\
    \ by local\n          policy:\n          a) Revert the IP and transport headers\
    \ of the embedded IP\n             packet to their original form, using the matching\
    \ mapping;\n             and\n          b) Leave the ICMP Error type and code\
    \ unchanged; and\n          c) Modify the destination IP address of the outer\
    \ IP header to\n             be same as the source IP address of the embedded\
    \ packet\n             after translation.\n   REQ-5: If a NAT device receives\
    \ an ICMP Error packet from the private\n          realm, and the NAT does not\
    \ have an active mapping for the\n          embedded payload, the NAT SHOULD silently\
    \ drop the ICMP Error\n          packet.  If the NAT has active mapping for the\
    \ embedded\n          payload, then the NAT MUST do the following prior to\n \
    \         forwarding the packet, unless explicitly overridden by local\n     \
    \     policy.\n          a) Revert the IP and transport headers of the embedded\
    \ IP\n             packet to their original form, using the matching mapping;\n\
    \             and\n          b) Leave the ICMP Error type and code unchanged;\
    \ and\n          c) If the NAT enforces Basic NAT function [NAT-TRAD], and the\n\
    \             NAT has active mapping for the IP address that sent the\n      \
    \       ICMP Error, translate the source IP address of the ICMP\n            \
    \ Error packet with the public IP address in the mapping.  In\n             all\
    \ other cases, translate the source IP address of the\n             ICMP Error\
    \ packet with its own public IP address.\n   REQ-6: While processing an ICMP Error\
    \ packet pertaining to an ICMP\n          Query or Query response message, a NAT\
    \ device MUST NOT refresh\n          or delete the NAT Session that pertains to\
    \ the embedded\n          payload within the ICMP Error packet.\n   REQ-7: NAT\
    \ devices enforcing Basic NAT ([NAT-TRAD]) MUST support the\n          traversal\
    \ of hairpinned ICMP Query sessions.  All NAT devices\n          (i.e., Basic\
    \ NAT as well as NAPT devices) MUST support the\n          traversal of hairpinned\
    \ ICMP Error messages.\n          a) When forwarding a hairpinned ICMP Error message,\
    \ the NAT\n             device MUST translate the destination IP address of the\n\
    \             outer IP header to be same as the source IP address of the\n   \
    \          embedded IP packet after the translation.\n   REQ-8: When a NAT device\
    \ is unable to establish a NAT Session for a\n          new transport-layer (TCP,\
    \ UDP, ICMP, etc.) flow due to\n          resource constraints or administrative\
    \ restrictions, the NAT\n          device SHOULD send an ICMP destination unreachable\
    \ message,\n          with a code of 13 (Communication administratively prohibited)\n\
    \          to the sender, and drop the original packet.\n   REQ-9: A NAT device\
    \ MAY implement a policy control that prevents ICMP\n          messages being\
    \ generated toward certain interface(s).\n          Implementation of such a policy\
    \ control overrides the MUSTs\n          and SHOULDs in REQ-10.\n   REQ-10: Unless\
    \ overridden by REQ-9's policy, a NAT device needs to\n           support ICMP\
    \ messages as below, some conforming to Section\n           4.3 of [RFC1812] and\
    \ some superseding the requirements of\n           Section 4.3 of [RFC1812]:\n\
    \          a. MUST support:\n             1. Destination Unreachable Message,\
    \ as described in Section\n                7.1 of this document.\n           \
    \  2. Time Exceeded Message, as described in Section 7.2 of\n                this\
    \ document.\n             3. Echo Request/Reply Messages, as described in REQ-1.\n\
    \          b. MAY support:\n             1. Redirect Message, as described in\
    \ Section 4.3.3.2 of\n                [RFC1812].\n             2. Timestamp and\
    \ Timestamp Reply Messages, as described in\n                Section 4.3.3.8 of\
    \ [RFC1812].\n             3. Source Route Options, as described in Section 7.3\
    \ of\n                this document.\n             4. Address Mask Request/Reply\
    \ Message, as described in\n                Section 7.4 of this document.\n  \
    \           5. Parameter Problem Message, as described in Section 7.5\n      \
    \          of this document.\n             6. Router Advertisement and Solicitations,\
    \ as described in\n                Section 7.6 of this document.\n          c.\
    \ SHOULD NOT support:\n             1. Source Quench Message, as described in\
    \ Section 4.3.3.3\n                of [RFC1812].\n             2. Information\
    \ Request/reply, as described in Section\n                4.3.3.7 of [RFC1812].\n\
    \          In addition, a NAT device is RECOMMENDED to conform to the\n      \
    \    following implementation considerations:\n          d. DS Field Usage, as\
    \ described in Section 7.7 of this\n             document.\n          e. When\
    \ Not to Send ICMP Errors, as described in Section\n             4.3.2.7 of [RFC1812].\n\
    \          f. Rate Limiting, as described in Section 4.3.2.8 of\n            \
    \ [RFC1812].\n   REQ-11: A NAT MAY drop or appropriately handle Non-QueryError\
    \ ICMP\n           messages.  The semantics of Non-QueryError ICMP messages is\n\
    \           defined in Section 2.\n"
- title: 10.  Security Considerations
  contents:
  - "10.  Security Considerations\n   This document does not introduce any new security\
    \ concerns related to\n   ICMP message handling in the NAT devices.  However,\
    \ the requirements\n   in the document do mitigate some security concerns known\
    \ to exist\n   with ICMP messages.\n   [ICMP-ATK] lists a number of ICMP attacks\
    \ that can be directed\n   against end host TCP stacks.  For example, a rogue\
    \ entity could\n   bombard the NAT device with a large number of ICMP Errors.\
    \  If the\n   NAT device did not validate the legitimacy of the ICMP Error packets,\n\
    \   the ICMP Errors would be forwarded directly to the end nodes.  End\n   hosts\
    \ not capable of defending themselves against such bogus ICMP\n   Error attacks\
    \ could be adversely impacted by such attacks.  Req-3\n   recommends validating\
    \ the ICMP checksum and the IP checksum of the\n   embedded payload prior to forwarding.\
    \  These checksum validations by\n   themselves do not protect end hosts from\
    \ attacks.  However, checksum\n   validation mitigates end hosts from malformed\
    \ ICMP Error attacks.\n   Req-4 and Req-5 further mandate that when a NAT device\
    \ does not find\n   a mapping selection for the embedded payload, the NAT should\
    \ drop the\n   ICMP Error packets, without forwarding.\n   A rogue source could\
    \ also try to send bogus ICMP Error messages for\n   the active NAT sessions,\
    \ with intent to destroy the sessions.  Req-6\n   averts such an attack by ensuring\
    \ that an ICMP Error message does not\n   affect the state of a session on the\
    \ NAT device.\n   Req-8 recommends a NAT device sending an ICMP Error message\
    \ when the\n   NAT device is unable to create a NAT session due to lack of\n \
    \  resources.  Some administrators may choose not to have the NAT device\n   send\
    \ an ICMP Error message, as doing so could confirm to a malicious\n   attacker\
    \ that the attack has succeeded.  For this reason, sending of\n   the specific\
    \ ICMP Error message stated in REQ-8 is left to the\n   discretion of the NAT\
    \ device administrator.\n   Unfortunately, ICMP messages are sometimes blocked\
    \ at network\n   boundaries due to local security policy.  Thus, some of the\n\
    \   requirements in this document allow local policy to override the\n   recommendations\
    \ of this document.  Blocking such ICMP messages is\n   known to break some protocol\
    \ features (most notably path MTU\n   Discovery) and some applications (e.g.,\
    \ ping, traceroute), and such\n   blocking is NOT RECOMMENDED.\n"
- title: 11.  Acknowledgements
  contents:
  - "11.  Acknowledgements\n   The authors wish to thank Fernando Gont, Dan Wing,\
    \ Carlos Pignataro,\n   Philip Matthews, and members of the BEHAVE working group\
    \ for doing a\n   thorough review of early versions of the document and providing\n\
    \   valuable input and offering generous amounts of their time in shaping\n  \
    \ the ICMP requirements.  Their valuable feedback made this document a\n   better\
    \ read.  Dan Wing and Fernando Gont were a steady source of\n   encouragement.\
    \  Fernando Gont spent many hours preparing slides and\n   presenting the document\
    \ in an IETF meeting on behalf of the authors.\n   The authors wish to thank Carlos\
    \ Pignataro and Dan Tappan, authors of\n   the [ICMP-EXT] document, for their\
    \ feedback concerning ICMP\n   extensions.  The authors wish to thank Philip Matthews\
    \ for agreeing\n   to be a technical reviewer for the document.  Lastly, the authors\n\
    \   highly appreciate the rigorous feedback from the IESG members.\n"
- title: 12.  References
  contents:
  - '12.  References

    '
- title: 12.1.  Normative References
  contents:
  - "12.1.  Normative References\n   [BEH-UDP]  Audet, F., Ed., and C. Jennings, \"\
    Network Address\n              Translation (NAT) Behavioral Requirements for Unicast\n\
    \              UDP\", BCP 127, RFC 4787, January 2007.\n   [ICMP]     Postel,\
    \ J., \"Internet Control Message Protocol\", STD 5,\n              RFC 792, September\
    \ 1981.\n   [ICMP-EXT] Bonica, R., Gan, D., Tappan, D., and C. Pignataro,\n  \
    \            \"Extended ICMP to Support Multi-Part Messages\", RFC 4884,\n   \
    \           April 2007.\n   [NAT-TRAD] Srisuresh, P. and K. Egevang, \"Traditional\
    \ IP Network\n              Address Translator (Traditional NAT)\", RFC 3022,\
    \ January\n              2001.\n   [RFC793]   Postel, J., \"Transmission Control\
    \ Protocol\", STD 7, RFC\n              793, September 1981.\n   [RFC1812]  Baker,\
    \ F., Ed., \"Requirements for IP Version 4 Routers\",\n              RFC 1812,\
    \ June 1995.\n   [RFC2119]  Bradner, S., \"Key words for use in RFCs to Indicate\n\
    \              Requirement Levels\", BCP 14, RFC 2119, March 1997.\n"
- title: 12.2.  Informative References
  contents:
  - "12.2.  Informative References\n   [BEH-APP]  Ford, B., Srisuresh, P., and D.\
    \ Kegel, \"Application Design\n              Guidelines for Traversal through\
    \ Network Address\n              Translators\", Work in Progress, March 2007.\n\
    \   [BEH-TCP]  Guha, S., Ed., Biswas, K., Ford, B., Sivakumar, S., and P.\n  \
    \            Srisuresh, \"NAT Behavioral Requirements for TCP\", BCP 142,\n  \
    \            RFC 5382, October 2008.\n   [DHCP]     Droms, R., \"Dynamic Host\
    \ Configuration Protocol\", RFC\n              2131, March 1997.\n   [ICE]   \
    \   Rosenberg, J., \"Interactive Connectivity Establishment\n              (ICE):\
    \ A Protocol for Network Address Translator (NAT)\n              Traversal for\
    \ Offer/Answer Protocols\", Work in Progress,\n              October 2007.\n \
    \  [ICMP-ATK] Gont, F., \"ICMP Attacks against TCP\", Work in Progress,\n    \
    \          October 2008.\n   [MS-TRCRT] Microsoft Support, \"How to use the Tracert\
    \ command-line\n              utility to troubleshoot TCP/IP problems in Windows\"\
    ,\n              http://support.microsoft.com/kb/162326, October, 2006.\n   [NAT-MIB]\
    \  Rohit, R., Srisuresh, P., Raghunarayan, R., Pai, N., and\n              C.\
    \ Wang, \"Definitions of Managed Objects for Network\n              Address Translators\
    \ (NAT)\", RFC 4008, March 2005.\n   [NAT-TERM] Srisuresh, P. and M. Holdrege,\
    \ \"IP Network Address\n              Translator (NAT) Terminology and Considerations\"\
    , RFC\n              2663, August 1999.\n   [PMTU]     Mogul, J. and S. Deering,\
    \ \"Path MTU discovery\", RFC 1191,\n              November 1990.\n   [RFC1122]\
    \  Braden, R., Ed., \"Requirements for Internet Hosts -\n              Communication\
    \ Layers\", STD 3, RFC 1122, October 1989.\n   [RFC1256]  Deering, S., Ed., \"\
    ICMP Router Discovery Messages\", RFC\n              1256, September 1991.\n \
    \  [RFC1470]  Enger, R. and J. Reynolds, \"FYI on a Network Management\n     \
    \         Tool Catalog: Tools for Monitoring and Debugging TCP/IP\n          \
    \    Internets and Interconnected Devices\", FYI 2, RFC 1470,\n              June\
    \ 1993.\n   [RFC2474]  Nichols, K., Blake, S., Baker, F., and D. Black,\n    \
    \          \"Definition of the Differentiated Services Field (DS\n           \
    \   Field) in the IPv4 and IPv6 Headers\", RFC 2474, December\n              1998.\n\
    \   [RFC4065]  Kempf, J., \"Instructions for Seamoby and Experimental\n      \
    \        Mobility Protocol IANA Allocations\", RFC 4065, July 2005.\n   [TCP-SOFT]\
    \ Gont, F., \"TCP's Reaction to Soft Errors\", RFC 5461,\n              February\
    \ 2009.\n   [UNSAF]    Daigle, L., Ed., and IAB, \"IAB Considerations for\n  \
    \            UNilateral Self-Address Fixing (UNSAF) Across Network\n         \
    \     Address Translation\", RFC 3424, November 2002.\n"
- title: Authors' Addresses
  contents:
  - "Authors' Addresses\n   Pyda Srisuresh\n   Kazeon Systems, Inc.\n   1161 San Antonio\
    \ Rd.\n   Mountain View, CA 94043\n   U.S.A.\n   Phone: +1 408 836 4773\n   EMail:\
    \ srisuresh@yahoo.com\n   Bryan Ford\n   Max Planck Institute for Software Systems\n\
    \   Campus Building E1 4\n   D-66123 Saarbruecken\n   Germany\n   Phone: +49-681-9325657\n\
    \   EMail: baford@mpi-sws.org\n   Senthil Sivakumar\n   Cisco Systems, Inc.\n\
    \   7100-8 Kit Creek Road\n   PO Box 14987\n   Research Triangle Park, NC  27709-4987\n\
    \   U.S.A.\n   Phone: +1 919 392 5158\n   EMail: ssenthil@cisco.com\n   Saikat\
    \ Guha\n   Cornell University\n   331 Upson Hall\n   Ithaca, NY  14853\n   U.S.A.\n\
    \   Phone: +1 607 255 1008\n   EMail: saikat@cs.cornell.edu\n"
